<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>自动化测试 | Peanut</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="为什么需要自动化测试？ 项目经过不断的开发，最终肯定会趋于稳定，在适当的时机下引入自动化测试能及早发现问题，保证产品的质量。 测试作为完整的开发流程中最后的一环，是保证产品质量重要的一环。而前端测试一般在产品开发流程中属于偏后的环节，在整个开发架构中属于较高层次，前端测试更加偏向于 GUI 的特性，因此前端的测试难度很大。 测试的目的：  有利于写出高质量的代码，尽早发现问题 有利于代码的扩展 有">
<meta property="og:type" content="article">
<meta property="og:title" content="自动化测试">
<meta property="og:url" content="https://supertinypeanut.github.io/blog/2021/01/25/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/index.html">
<meta property="og:site_name" content="Peanut">
<meta property="og:description" content="为什么需要自动化测试？ 项目经过不断的开发，最终肯定会趋于稳定，在适当的时机下引入自动化测试能及早发现问题，保证产品的质量。 测试作为完整的开发流程中最后的一环，是保证产品质量重要的一环。而前端测试一般在产品开发流程中属于偏后的环节，在整个开发架构中属于较高层次，前端测试更加偏向于 GUI 的特性，因此前端的测试难度很大。 测试的目的：  有利于写出高质量的代码，尽早发现问题 有利于代码的扩展 有">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://supertinypeanut.github.io/blog/.io//16415de723a8d411.png">
<meta property="og:image" content="https://supertinypeanut.github.io/blog/.io//v2-af09ebe8167f63a49ea49287fe04526f_hd-20190706122102737.jpg">
<meta property="og:image" content="https://supertinypeanut.github.io/blog/.io//image-20190706101634263.png">
<meta property="og:image" content="https://supertinypeanut.github.io/blog/.io//image-20190706100636750.png">
<meta property="og:image" content="https://supertinypeanut.github.io/blog/.io//image-20190707212821248.png">
<meta property="og:image" content="https://supertinypeanut.github.io/blog/.io//image-20190707212923919.png">
<meta property="og:image" content="https://supertinypeanut.github.io/blog/.io//w80140jb42.jpg">
<meta property="og:image" content="https://supertinypeanut.github.io/blog/.io//8u3cp5kz2s.png">
<meta property="og:image" content="https://supertinypeanut.github.io/blog/.io//tap-reporter.png">
<meta property="og:image" content="https://supertinypeanut.github.io/blog/.io//mini-reporter.gif">
<meta property="og:image" content="https://supertinypeanut.github.io/blog/.io//verbose-reporter.png">
<meta property="og:image" content="https://supertinypeanut.github.io/blog/.io//tap-reporter-20190709154342692.png">
<meta property="og:image" content="https://supertinypeanut.github.io/blog/.io//TB13X9xLXXXXXXoaXXXDUoU9pXX-902-329.png">
<meta property="og:image" content="https://supertinypeanut.github.io/blog/.io//TB1jTKwLXXXXXX.aXXX0KhCSFXX-619-472.png">
<meta property="og:image" content="https://supertinypeanut.github.io/blog/.io//TB1XXuILXXXXXcAXFXX.hdJKpXX-918-179.png">
<meta property="og:image" content="https://supertinypeanut.github.io/blog/.io//TB1PvisLXXXXXcqaXXXEHlCNpXX-896-103.png">
<meta property="article:published_time" content="2021-01-25T00:11:00.000Z">
<meta property="article:modified_time" content="2021-03-23T16:40:13.813Z">
<meta property="article:author" content="Super Peanut">
<meta property="article:tag" content="前端工程化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://supertinypeanut.github.io/blog/.io//16415de723a8d411.png">
  
    <link rel="alternate" href="/blog/atom.xml" title="Peanut" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/blog/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">Peanut</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://supertinypeanut.github.io/blog"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-自动化测试" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2021/01/25/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" class="article-date">
  <time datetime="2021-01-25T00:11:00.000Z" itemprop="datePublished">2021-01-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      自动化测试
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>为什么需要自动化测试？</strong></p>
<p>项目经过不断的开发，最终肯定会趋于稳定，在<strong>适当的时机下</strong>引入自动化测试能及早发现问题，<strong>保证产品的质量</strong>。</p>
<p>测试作为完整的开发流程中最后的一环，是保证产品质量重要的一环。而前端测试一般在产品开发流程中属于偏后的环节，在整个开发架构中属于较高层次，前端测试更加偏向于 GUI 的特性，因此前端的测试难度很大。</p>
<p>测试的目的：</p>
<ul>
<li>有利于写出高质量的代码，尽早发现问题</li>
<li>有利于代码的扩展</li>
<li>有利于代码的维护</li>
</ul>
<h2 id="前端自动化测试"><a href="#前端自动化测试" class="headerlink" title="前端自动化测试"></a>前端自动化测试</h2><p>测试是一个庞大的主题，包括各种分类的测试，诸如黑盒测试/白盒测试、单元测试/集成测试/端到端测试等。通常程序员在测试自己的代码的时候用得最多的便是单元测试，但是因为测试也是需要代价，很多人是不喜欢写测试的，甚至是一点都不写。</p>
<p>那么是什么原因让大家不愿意写呢？</p>
<ol>
<li>不熟悉</li>
<li>浪费时间</li>
<li>知识不成体系</li>
<li>团队氛围</li>
<li>缺少实践</li>
</ol>
<p>我们要从基础的东西学起，打消对测试的恐惧。</p>
<h3 id="测试的分类"><a href="#测试的分类" class="headerlink" title="测试的分类"></a>测试的分类</h3><p>在多浏览器的自动化测试，我们多半是进行端到端的测试工作，一小部分是大粒度的单元测试。端到端测试测试模拟用户的行为。在 Web 应用程序中，他们会启动服务器，打开浏览器，模拟用户的行为进行点击、输入、提交等动作，断言浏览器中发生了特定的事情或者是得到了期待的结果，从而让我们相信功能可以正常的运行。</p>
<p>而单元测试根据代码单元的公共 API 运行它们。这些测试需要创建一个类的实例，使用特定的输入调用它的方法，断言被调用的方法达到了预期的效果。在下文中我们会看到这两种测试的实践，当然有时候区分度并不大，可能无法明显地区分哪些是端对端测试哪些是单元测试，有时候他们是混合起来的，不过只要记住我们的目标是保证功能可以正常运行救足够了。</p>
<p>按照软件工程自底而上的概念，前端测试一般分为单元测试（Unit Testing ）、集成测试（Integration Testing）和端到端测试（E2E Testing）。从下面的图可以看出，从底向上测试的复杂度将不断提高，另一方面测试的收益反而不断降低的。</p>
<p><img src="/blog/.io//16415de723a8d411.png" alt="img"></p>
<blockquote>
<p>关于软件测试分类，可见<a href="#软件测试的分类">软件测试的分类</a></p>
</blockquote>
<h3 id="测试工具对比"><a href="#测试工具对比" class="headerlink" title="测试工具对比"></a>测试工具对比</h3><p>在进行项目实践前，很重要的一项工作是选择合适的技术栈。好比在前端开发时应该选择 React，Vue 还是 Angular 作为框架一样，前端的测试工作也需要选择一套技术栈。很多时候大家在制定技术栈时容易走偏，在选择技术框架时不是选择最合适的框架，而是选择最热门的框架。当然一定程度上热门的框架能反应其受欢迎程度，可能是因为其出众的优点，如较高的开发效率、高效的渲染特性或者是活跃的社区。在前端开发中，很容易有这样的感受，就是只要半个月没有关注业界的最新动态，就感觉恍若隔世，新的解决方案层出不穷，让人喘不过气。</p>
<p>经过几年的前端洗礼之后，就已经过了慌乱的年纪，再也不会盲目地追寻新技术，而转向关注技术背后解决的痛点，原理等。</p>
<p><img src="/blog/.io//v2-af09ebe8167f63a49ea49287fe04526f_hd-20190706122102737.jpg" alt="img"></p>
<h4 id="如何选择测试框架"><a href="#如何选择测试框架" class="headerlink" title="如何选择测试框架"></a>如何选择测试框架</h4><p>测试框架基本上都做了一件事儿：</p>
<ul>
<li>描述你要测试的东西</li>
<li>对其进行测试</li>
<li>判断是否符合预期</li>
</ul>
<p>选择框架会考虑下面的点：</p>
<ul>
<li><p>测试框架是否有简明的语法与文档。</p>
<p>Mocha、Jasmine、Jest、AVA、Karma、Nightmare</p>
</li>
<li><p>断言(Assertions)：用于判断结果是否符合预期。有些框架需要单独的断言库。</p>
<p>Should.js、chai、expect.js 等等，断言库提供了很多语义化的方法来对值做各种各样的判断。当然也可以不用断言库，Node.js 中也可以直接使用原生 assert 库。</p>
</li>
<li><p>适合 TDD / BDD：是否适合 测试驱动型 / 行为驱动型 的测试风格。</p>
<blockquote>
<p>BDD(Bebavior Driven Developement，行为驱动测试)和 TDD(Testing Driven Developement，测试驱动开发)</p>
</blockquote>
<p>BDD 和 TDD 均有各自的适用场景，BDD 一般更偏向于系统功能和业务逻辑的自动化测试设计，而 TDD 在快速开发并测试功能模块的过程中则更加高效，以快速完成开发为目的。下面我们看下 BDD 和 TDD 具体的特点：</p>
<p>BDD 的特点：</p>
<ul>
<li>从业务逻辑的角度定义具体的输入与预期输出，以及可衡量的目标；</li>
<li>尽可能覆盖所有的测试用例情况；</li>
<li>描述一系列可执行的行为，根据业务的分析来定义预期输出。例如，expect, should, assert；</li>
<li>设定关键的测试通过节点输出提示，便于测试人员理解；</li>
<li>最大程度的交付出符合用户期望的产品，避免输出不一致带来的问题。</li>
</ul>
<p>TDD 的特点：</p>
<ul>
<li>需求分析，快速编写对应的输入输出测试脚本；</li>
<li><strong>仅在自动测试失败时才编写新代码</strong>。</li>
<li>重构去除不必要的依赖关系，然后重复测试，最终让程序符合所有要求。</li>
</ul>
</li>
<li><p>异步测试：有些框架对异步测试支持良好。</p>
</li>
<li><p>使用的语言：大部分 js 测试框架使用 js。</p>
</li>
<li><p>用于特定目的：每个框架可能会擅长处理不同的问题。</p>
<p>是要测试单个功能、单个组件、还是集成化测试？</p>
<p>是要测试 GUI 逻辑、交互？</p>
<p>是要测试非功能性指标？兼容性？</p>
</li>
<li><p>社区是否活跃。</p>
</li>
</ul>
<h4 id="测试工具的类型"><a href="#测试工具的类型" class="headerlink" title="测试工具的类型"></a>测试工具的类型</h4><p>测试工具可分为以下功能。有些只为我们提供了一种功能，有些功能为我们提供了一种组合。</p>
<p>为了实现最灵活的集合功能，通常使用多种工具的组合。</p>
<ul>
<li><p>提供 UI 界面或者 CLI 工具：（<a href="https://karma-runner.github.io/" target="_blank" rel="noopener">Karma</a>，<a href="http://jasmine.github.io/" target="_blank" rel="noopener">Jasmine</a>，<a href="https://facebook.github.io/jest/" target="_blank" rel="noopener">Jest</a>，<a href="https://github.com/DevExpress/testcafe" target="_blank" rel="noopener">TestCafe</a>，<a href="https://www.cypress.io/" target="_blank" rel="noopener">Cypress</a>）</p>
<p><strong>CLI 工具</strong>会给出一系列测试，以及运行这些测试所需的各种配置和脚手架（运行什么浏览器，使用什么 babel 插件，如何格式化输出等）</p>
</li>
<li><p>提供测试框架（形成文件目录）：(<a href="https://mochajs.org/" target="_blank" rel="noopener">Mocha</a>, <a href="http://jasmine.github.io/" target="_blank" rel="noopener">Jasmine</a>, <a href="https://facebook.github.io/jest/" target="_blank" rel="noopener">Jest</a>, <a href="https://github.com/cucumber/cucumber-js" target="_blank" rel="noopener">Cucumber</a>, <a href="https://github.com/DevExpress/testcafe" target="_blank" rel="noopener">TestCafe</a>, <a href="https://www.cypress.io/" target="_blank" rel="noopener">Cypress</a>)</p>
</li>
<li><p>提供断言：（<a href="http://chaijs.com/" target="_blank" rel="noopener">Chai</a>，<a href="http://jasmine.github.io/" target="_blank" rel="noopener">Jasmine</a>，<a href="https://facebook.github.io/jest/" target="_blank" rel="noopener">Jest</a>，<a href="http://unexpected.js.org/" target="_blank" rel="noopener">Unexpected</a>，<a href="https://github.com/DevExpress/testcafe" target="_blank" rel="noopener">TestCafe</a>，<a href="https://www.cypress.io/" target="_blank" rel="noopener">Cypress</a>）</p>
<p><strong>断言函数</strong>检查测试返回的结果是否符合预期</p>
</li>
<li><p>生成，展示测试结果（<a href="https://mochajs.org/" target="_blank" rel="noopener">Mocha</a>，<a href="http://jasmine.github.io/" target="_blank" rel="noopener">Jasmine</a>，<a href="https://facebook.github.io/jest/" target="_blank" rel="noopener">Jest</a>，<a href="https://karma-runner.github.io/" target="_blank" rel="noopener">Karma</a>，<a href="https://github.com/DevExpress/testcafe" target="_blank" rel="noopener">TestCafe</a>，<a href="https://www.cypress.io/" target="_blank" rel="noopener">Cypress</a>）</p>
</li>
<li><p>快照测试（<a href="https://facebook.github.io/jest/" target="_blank" rel="noopener">Jest</a>，<a href="https://github.com/avajs/ava" target="_blank" rel="noopener">Ava</a>）</p>
<p>快照测试(snapshot testing)，测试 UI 或数据结构是否和之前完全一致，通常 UI 测试不在单元测试中</p>
</li>
<li><p>提供仿真（<a href="http://sinonjs.org/" target="_blank" rel="noopener">Sinon</a>，<a href="http://jasmine.github.io/" target="_blank" rel="noopener">Jasmine</a>，<a href="http://airbnb.io/enzyme/docs/api/" target="_blank" rel="noopener">enzyme</a>，<a href="https://facebook.github.io/jest/" target="_blank" rel="noopener">Jest</a>，<a href="https://testdouble.com/" target="_blank" rel="noopener">testdouble</a>）</p>
<p>仿真(mocks, spies, and stubs)：获取方法的调用信息，模拟方法，模块，甚至服务器</p>
</li>
<li><p>生成测试覆盖率报告 (<a href="https://gotwarlost.github.io/istanbul/" target="_blank" rel="noopener">Istanbul</a>, <a href="https://facebook.github.io/jest/" target="_blank" rel="noopener">Jest</a>, <a href="http://blanketjs.org/" target="_blank" rel="noopener">Blanket</a>)</p>
</li>
<li><p>提供类浏览器环境(<a href="http://nightwatchjs.org/" target="_blank" rel="noopener">Nightwatch</a>, <a href="http://www.nightmarejs.org/" target="_blank" rel="noopener">Nightmare</a>, <a href="http://phantomjs.org/" target="_blank" rel="noopener">Phantom</a><strong>,</strong> <a href="https://github.com/GoogleChrome/puppeteer" target="_blank" rel="noopener">Puppeteer</a>, <a href="https://github.com/DevExpress/testcafe" target="_blank" rel="noopener">TestCafe</a>, <a href="https://www.cypress.io/" target="_blank" rel="noopener">Cypress</a>)</p>
</li>
<li><p>可视化回归工具(<a href="https://applitools.com/" target="_blank" rel="noopener">Applitools</a>, <a href="https://percy.io/" target="_blank" rel="noopener">Percy</a>, <a href="http://bbc-news.github.io/wraith/" target="_blank" rel="noopener">Wraith</a>, <a href="https://github.com/webdriverio-boneyard/webdrivercss" target="_blank" rel="noopener">WebdriverCSS</a>)</p>
</li>
</ul>
<h4 id="单元测试类工具"><a href="#单元测试类工具" class="headerlink" title="单元测试类工具"></a>单元测试类工具</h4><p>npm trends: <a href="https://www.npmtrends.com/mocha-vs-jest-vs-ava-vs-jasmine-core" target="_blank" rel="noopener">点击链接</a></p>
<p><img src="/blog/.io//image-20190706101634263.png" alt="image-20190706101634263"></p>
<p><strong>Karma</strong></p>
<p>Karma 是一个 Runner（即运行环境），具体详细的介绍见 <a href="#测试环境&帮手Karma">后面的章节 Karma</a></p>
<blockquote>
<p>A test runner is the library or tool that picks up an assembly (or a source code directory) that contains unit tests, and a bunch of settings, and then executes them and writes the test results to the console or log files.<br>there are many runners for different languages. See Nunit and MSTest for C#, or Junit for Java.</p>
</blockquote>
<p>karma 设计目标主要有下面四点：</p>
<blockquote>
<p>高效<br>扩展性<br>运行在真实设备<br>无缝的使用流程</p>
</blockquote>
<p>karma 是一个典型的 C/S 程序，包含 client 和 server ，通讯方式基于 Http ，通常情况下，客户端和服务端基本都运行在开发者本地机器上。</p>
<p>一个服务端实例对应一个项目，假如想同时运行多个项目，得同时开启多个服务端实例。</p>
<p>Karma 的<strong>优点</strong>是能通过插件和配置的方式集成大部分的主流的测试框架和前端库，能方便的一次在多浏览器环境执行测试用例，并集成了测试覆盖率生成功能，生成页面形式覆盖率报告并能导出不同形式的覆盖率报告数据。</p>
<p>它的<strong>缺点</strong>是，对测试页面环境的搭建和资源文件的加载不是常见的形式，最开始搭建环境时会有很多跟预期不一致的情况，配置不直观。</p>
<p><strong>Jasmine</strong></p>
<p>Jasmine 带有 assertions(断言)，spies (用来模拟函数的执行环境)和 mocks (mock 工具)，Jasmine 初始化设置简单，同时，如果你需要一些单元功能的时候你仍然可以加一些库进来。</p>
<p><strong>Mocha</strong></p>
<p>Mocha 是一个灵活的库，提供给开发者的只有一个基础测试结构。然后，其它功能性的功能如 assertions， spies 和 mocks，这些功能<strong>需要引用添加其它库</strong>/插件来完成。</p>
<p><strong>Jest</strong></p>
<p>被 Facebook 和各种 React 应用推荐和使用，Jest 得到了很好的支持。Jest 也被发现是一个非常快速的测试库在平行测试报告中。</p>
<p>对于小型项目来说你可能在开始的时候不用过多担心，而性能的提高，对于希望全天持续部署的大型应用 app 来说是非常之好的。</p>
<p>而开发人员主要是用 Jest 去测试 React 应用，Jest 可以很容易地集成到其它应用程序中充许你使用更独特的特性在其它地方</p>
<p>快照测试是一个非常好用的工具，去确保你的应用 UI 不会有超出预期的错误，在产品发布替换的期间发生。虽然大部分功能，专门设计都是使用在 React 上。</p>
<p>Jest 有着很广阔的 API 。</p>
<p><strong>AVA</strong></p>
<p>AVA 它的优势是 JavaScript 的异步特性和并发运行测试.</p>
<p>利用了 JavaScript 的异步特性优势，优化了在部署的时间等待</p>
<p>保留了简单的 API 为你提供你所需要的功能。</p>
<p>如果搭配 mocking 来使用它会显得更加友好，但是必须安装一个单独的库。</p>
<h4 id="E2E-测试类工具"><a href="#E2E-测试类工具" class="headerlink" title="E2E 测试类工具"></a>E2E 测试类工具</h4><p>npm trends: <a href="https://www.npmtrends.com/cypress-vs-nightmare-vs-nightwatch-vs-testcafe-vs-webdriverio" target="_blank" rel="noopener">点击链接</a></p>
<p><img src="/blog/.io//image-20190706100636750.png" alt="image-20190706100636750"></p>
<h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><p>测试有很多好处，但不代表一上来就要写出 100%场景覆盖的测试用例。</p>
<p><strong>最佳的实践：基于投入产出比来做测试</strong></p>
<p>由于维护测试用例也是一大笔开销（毕竟没有多少测试会专门帮前端写业务测试用例，而前端使用的流程自动化工具更是没有测试参与了）。</p>
<p>对于像基础组件、基础模型之类的不常变更且复用较多的部分，可以考虑去写测试用例来保证质量。个</p>
<p>先写少量的测试用例覆盖到 80%+的场景，保证覆盖主要使用流程。</p>
<p>一些极端场景出现的 bug 可以在迭代中形成测试用例沉淀，场景覆盖也将逐渐趋近 100%。</p>
<p>但对于迭代较快的业务逻辑以及生存时间不长的活动页面之类的就别花时间写测试用例了，维护测试用例的时间大了去了，成本太高。</p>
<p>大型项目，可以使用 Jest 快速形成配置并且开始单元测试。</p>
<p>需要测试快照，则可以选择 Jest 或者 Ava。</p>
<p>对于配置性要求高，对测试框架性能有要求的可以选择 mocha。</p>
<p>对模拟还原浏览器业务操作有很大的需求的，可以选择 nightmare</p>
<p>配合 CI 工具完成自动化测试、测试覆盖率、测试结果推送。</p>
<h2 id="喜欢简单，选择-Mocha"><a href="#喜欢简单，选择-Mocha" class="headerlink" title="喜欢简单，选择 Mocha"></a>喜欢简单，选择 Mocha</h2><p><a href="https://mochajs.org/" target="_blank" rel="noopener"><code>Mocha</code></a>（发音”摩卡”）诞生于 2011 年，是现在最流行的 JavaScript 测试框架之一，在浏览器和 Node 环境都可以使用。所谓”测试框架”，就是运行测试的工具。通过它，可以为 JavaScript 应用添加测试，从而保证代码的质量。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>全局安装 Mocha</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g mocha</span><br></pre></td></tr></table></figure>

<p>项目中也安装 Mocha</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev mocha</span><br></pre></td></tr></table></figure>

<p>在 package.json 中加入下面脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"test"</span>: <span class="string">"mocha"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Chai 是一个针对 Node.js 和浏览器的行为驱动测试和测试驱动测试的<strong>断言库</strong>，可与任何 JavaScript 测试框架集成。它是 Mocha 的好帮手~~</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev chai</span><br></pre></td></tr></table></figure>

<p>在 package.json 中加入下面脚本：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">    "test": "mocha"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="关于断言"><a href="#关于断言" class="headerlink" title="关于断言"></a>关于断言</h3><p><code>expect</code>断言的优点是很接近自然语言，下面是一些例子。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 相等或不相等</span></span><br><span class="line">expect(<span class="number">4</span> + <span class="number">5</span>).to.be.equal(<span class="number">9</span>);</span><br><span class="line">expect(<span class="number">4</span> + <span class="number">5</span>).to.be.not.equal(<span class="number">10</span>);</span><br><span class="line">expect(foo).to.be.deep.equal(&#123; <span class="attr">bar</span>: <span class="string">"baz"</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 布尔值为true</span></span><br><span class="line">expect(<span class="string">"everthing"</span>).to.be.ok;</span><br><span class="line">expect(<span class="literal">false</span>).to.not.be.ok;</span><br><span class="line"></span><br><span class="line"><span class="comment">// typeof</span></span><br><span class="line">expect(<span class="string">"test"</span>).to.be.a(<span class="string">"string"</span>);</span><br><span class="line">expect(&#123; <span class="attr">foo</span>: <span class="string">"bar"</span> &#125;).to.be.an(<span class="string">"object"</span>);</span><br><span class="line">expect(foo).to.be.an.instanceof(Foo);</span><br><span class="line"></span><br><span class="line"><span class="comment">// include</span></span><br><span class="line">expect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]).to.include(<span class="number">2</span>);</span><br><span class="line">expect(<span class="string">"foobar"</span>).to.contain(<span class="string">"foo"</span>);</span><br><span class="line">expect(&#123; <span class="attr">foo</span>: <span class="string">"bar"</span>, <span class="attr">hello</span>: <span class="string">"universe"</span> &#125;).to.include.keys(<span class="string">"foo"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// empty</span></span><br><span class="line">expect([]).to.be.empty;</span><br><span class="line">expect(<span class="string">""</span>).to.be.empty;</span><br><span class="line">expect(&#123;&#125;).to.be.empty;</span><br><span class="line"></span><br><span class="line"><span class="comment">// match</span></span><br><span class="line">expect(<span class="string">"foobar"</span>).to.match(<span class="regexp">/^foo/</span>);</span><br></pre></td></tr></table></figure>

<p>两种使用方式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// commonjs</span></span><br><span class="line"><span class="keyword">const</span> expect = <span class="built_in">require</span>(<span class="string">"chai"</span>).expect;</span><br><span class="line"></span><br><span class="line"><span class="comment">// es6</span></span><br><span class="line"><span class="keyword">import</span> &#123; expect &#125; <span class="keyword">from</span> <span class="string">"chai"</span>;</span><br></pre></td></tr></table></figure>

<h3 id="测试案例"><a href="#测试案例" class="headerlink" title="测试案例"></a>测试案例</h3><p>其中 index.js 为我们的被测试代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加法函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;第一个数&#125;</span> <span class="variable">a</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;第二个数&#125;</span> <span class="variable">b</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addNum</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = addNum;</span><br></pre></td></tr></table></figure>

<p>新建测试脚本<code>test/demo.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> expect = <span class="built_in">require</span>(<span class="string">'chai'</span>).expect;</span><br><span class="line"><span class="keyword">const</span> addNum = <span class="built_in">require</span>(<span class="string">'../src/index'</span>)</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'测试index.js'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  describe(<span class="string">'测试addNum函数'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    it(<span class="string">'两数相加结果为两个数字的和'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      expect(addNum(<span class="number">1</span>,<span class="number">2</span>)).to.be.equal(<span class="number">3</span>);</span><br><span class="line">      <span class="comment">// 以上语法为chai的expect语法，它还有should语法和asset语法。</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 等价的意思</span></span><br><span class="line"><span class="keyword">var</span> addNum=<span class="built_in">require</span>(<span class="string">'../src/index'</span>)</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'测试index.js'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  describe(<span class="string">'测试addNum函数'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    it(<span class="string">'两数相加结果为两个数字的和'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(addNum(<span class="number">1</span>,<span class="number">2</span>)!==<span class="number">3</span>)&#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"两数相加结果不为两个数字的和"</span>)；</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="Mocha-测试命令"><a href="#Mocha-测试命令" class="headerlink" title="Mocha 测试命令"></a>Mocha 测试命令</h3><p>如果想测试单一的测试 js，可以用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mocha <span class="built_in">test</span>/index.test.js</span><br></pre></td></tr></table></figure>

<p>或者多个 js</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mocha <span class="built_in">test</span>/index.test.js <span class="built_in">test</span>/add.test.js</span><br></pre></td></tr></table></figure>

<p>当然也可以用通配符测试某个文件夹下所有的 js 和 jsx：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># node 通配符</span></span><br><span class="line">mocha <span class="string">'test/some/*.@(js|jsx)'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># shell 通配符</span></span><br><span class="line">mocha <span class="built_in">test</span>/unit/*.js</span><br><span class="line"></span><br><span class="line">mocha spec/&#123;my,awesome&#125;.js</span><br></pre></td></tr></table></figure>

<h3 id="ES6-语法支持"><a href="#ES6-语法支持" class="headerlink" title="ES6 语法支持"></a>ES6 语法支持</h3><p>在上面我们用的并非是 ES6 的语法，那么让我们把其中的代码都改为 ES6 的语法。<br>其中 index.js 为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加法函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;第一个数&#125;</span> <span class="variable">a</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;第二个数&#125;</span> <span class="variable">b</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addNum</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; addNum &#125;;</span><br></pre></td></tr></table></figure>

<p>而 index.test.js 为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; expect &#125; <span class="keyword">from</span> <span class="string">"chai"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; addNum &#125; <span class="keyword">from</span> <span class="string">"../src/index"</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"测试index.js"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  describe(<span class="string">"测试addNum函数"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    it(<span class="string">"两个参数相加结果为两个数字的和"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      expect(addNum(<span class="number">1</span>, <span class="number">2</span>)).to.be.equal(<span class="number">3</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    it(<span class="string">"两个参数相加结果不为和以外的数"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      expect(addNum(<span class="number">1</span>, <span class="number">2</span>)).to.be.not.equal(<span class="number">4</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>此时直接运行 mocha 肯定是不行的，我们现需要安装一下 babel：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev @babel/cli @babel/core @babel/node @babel/register @babel/preset-env chai mocha nodemon</span><br></pre></td></tr></table></figure>

<p>然后，在项目目录下面，新建一个.babelrc 文件：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>: [<span class="string">"@babel/preset-env"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着讲 package.json 中的脚本改为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "test": "mocha --require @babel/register"</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>命令变得更加简单了</p>
<h3 id="更多用法"><a href="#更多用法" class="headerlink" title="更多用法"></a>更多用法</h3><h4 id="超时"><a href="#超时" class="headerlink" title="超时"></a>超时</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--timeout, -t, --timeouts  Specify <span class="built_in">test</span> timeout threshold (<span class="keyword">in</span> milliseconds)</span><br><span class="line">                                                      [number] [default: 2000]</span><br></pre></td></tr></table></figure>

<p>官方默认的超时是 2000 毫秒，即 2s。</p>
<p>有三种方式来修改超时：</p>
<p><code>--no-timeout</code>参数或者<code>debug</code>模式中，全局禁用了超时；</p>
<p><code>--timeout</code>后面接时间（毫秒），全局修改了本次执行测试用例的超时时间；</p>
<p>在测试用例里面，使用<code>this.timeout</code>方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">"should take less than 500ms"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.timeout(<span class="number">500</span>);</span><br><span class="line">  setTimeout(done, <span class="number">300</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在<a href="#钩子方法（生命周期函数）">钩子方法</a>里面使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">"a suite of tests"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  beforeEach(<span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.timeout(<span class="number">3000</span>); <span class="comment">// A very long environment setup.</span></span><br><span class="line">    setTimeout(done, <span class="number">2500</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>同样，可以使用``this.timeout(0)<code></code>去禁用超时。</p>
</blockquote>
<h4 id="钩子方法（生命周期函数）"><a href="#钩子方法（生命周期函数）" class="headerlink" title="钩子方法（生命周期函数）"></a>钩子方法（生命周期函数）</h4><p>Mocha 在 describe 块之中，提供测试用例的四个钩子：before()、after()、beforeEach()和 afterEach()。它们会在指定时间执行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">"测试index.js"</span>, () =&gt; &#123;</span><br><span class="line">  before(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.info(<span class="string">"在本区块的所有测试用例之前执行"</span>));</span><br><span class="line"></span><br><span class="line">  after(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.info(<span class="string">"在本区块的所有测试用例之后执行"</span>));</span><br><span class="line"></span><br><span class="line">  beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.info(<span class="string">"在本区块的每个测试用例之前执行"</span>));</span><br><span class="line"></span><br><span class="line">  afterEach(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.info(<span class="string">"在本区块的每个测试用例之后执行"</span>));</span><br><span class="line"></span><br><span class="line">  describe(<span class="string">"测试addNum函数"</span>, () =&gt; &#123;</span><br><span class="line">    it(<span class="string">"两数相加结果为两个数字的和"</span>, () =&gt; &#123;</span><br><span class="line">      assert.equal(addNum(<span class="number">1</span>, <span class="number">2</span>), <span class="number">3</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="异步测试"><a href="#异步测试" class="headerlink" title="异步测试"></a>异步测试</h4><p>Mocha 本身是支持异步测试的。只需要为<code>describe</code>回调函数添加一个<code>done</code>参数， 成功时调用<code>done()</code>，失败时调用<code>done(err)</code>。例如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> expect = <span class="built_in">require</span>(<span class="string">"chai"</span>).expect;</span><br><span class="line">describe(<span class="string">"db"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  it(<span class="string">"#get"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</span><br><span class="line">    db.get(<span class="string">"foo"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, foo</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) done(err);</span><br><span class="line">      expect(foo).to.equal(<span class="string">"bar"</span>);</span><br><span class="line">      done();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>如果未调用<code>done</code>函数，Mocha 会一直等待直到超时。</li>
<li>如果未添加<code>done</code>参数，Mocha 会直接返回成功，不会捕获到异步的断言失败。例如：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">"#get"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">2</span>);</span><br><span class="line">  &#125;, <span class="number">100</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>运行上述测试<a href="https://mochajs.org/" target="_blank" rel="noopener">Mocha</a>总会提示 Passing。</p>
<blockquote>
<p>Mocha 怎么知道是否要等待异步断言呢？因为 JavaScript 中的<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank" rel="noopener">Function</a>有一个<code>length</code>属性， 通过它可以获得该函数的形参个数。Mocha 通过传入回调的<code>length</code>来判断是否需要等待。</p>
</blockquote>
<p>或者，<code>done()</code>您可以返回<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank" rel="noopener">Promise</a>，而不是使用回调。如果您正在测试的 API 返回 promises 而不是回调，可以这样进行使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> db.clear().then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> db.save([tobi, loki, jane]);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"#find()"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  it(<span class="string">"respond with matching records"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> db.find(&#123; <span class="attr">type</span>: <span class="string">"User"</span> &#125;).should.eventually.have.length(<span class="number">3</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>同样，可以使用<a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Statements/async_function" target="_blank" rel="noopener">async / await</a>，您还可以编写如下的异步测试：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">await</span> db.clear();</span><br><span class="line">  <span class="keyword">await</span> db.save([tobi, loki, jane]);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"#find()"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  it(<span class="string">"responds with matching records"</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> users = <span class="keyword">await</span> db.find(&#123; <span class="attr">type</span>: <span class="string">"User"</span> &#125;);</span><br><span class="line">    users.should.have.length(<span class="number">3</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>需要 Babel 支持<del>~</del></p>
</blockquote>
<h3 id="示例项目"><a href="#示例项目" class="headerlink" title="示例项目"></a>示例项目</h3><h4 id="创建项目-amp-安装依赖"><a href="#创建项目-amp-安装依赖" class="headerlink" title="创建项目&amp;安装依赖"></a>创建项目&amp;安装依赖</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 初始化一个nodejs项目</span><br><span class="line">npm init -y</span><br><span class="line"></span><br><span class="line">// 安装依赖</span><br><span class="line">npm install --save-dev @babel/cli @babel/core @babel/node @babel/register @babel/preset-env chai mocha nodemon</span><br></pre></td></tr></table></figure>

<p>形成 package.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"projects"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"index.js"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">"keywords"</span>: [],</span><br><span class="line">  <span class="attr">"author"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="attr">"license"</span>: <span class="string">"ISC"</span>,</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"@babel/cli"</span>: <span class="string">"^7.5.0"</span>,</span><br><span class="line">    <span class="attr">"@babel/core"</span>: <span class="string">"^7.5.0"</span>,</span><br><span class="line">    <span class="attr">"@babel/node"</span>: <span class="string">"^7.5.0"</span>,</span><br><span class="line">    <span class="attr">"@babel/preset-env"</span>: <span class="string">"^7.5.0"</span>,</span><br><span class="line">    <span class="attr">"@babel/register"</span>: <span class="string">"^7.4.4"</span>,</span><br><span class="line">    <span class="attr">"chai"</span>: <span class="string">"^4.2.0"</span>,</span><br><span class="line">    <span class="attr">"mocha"</span>: <span class="string">"^6.1.4"</span>,</span><br><span class="line">    <span class="attr">"nodemon"</span>: <span class="string">"^1.19.1"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试过程"><a href="#测试过程" class="headerlink" title="测试过程"></a>测试过程</h4><p>新建一个待测试的方法<code>./src/index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sayHello = <span class="function"><span class="params">()</span> =&gt;</span> <span class="string">"Hello world!!!"</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(sayHello());</span><br><span class="line"></span><br><span class="line"><span class="comment">// ES6语法</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> sayHello;</span><br></pre></td></tr></table></figure>

<p>测试脚本<code>./test/index.spec.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; expect &#125; <span class="keyword">from</span> <span class="string">"chai"</span>;</span><br><span class="line"><span class="keyword">import</span> sayHello <span class="keyword">from</span> <span class="string">"../src/index"</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"index test"</span>, () =&gt; &#123;</span><br><span class="line">  describe(<span class="string">"sayHello function"</span>, () =&gt; &#123;</span><br><span class="line">    it(<span class="string">"should say Hello guys!"</span>, () =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> str = sayHello();</span><br><span class="line">      expect(str).to.equal(<span class="string">"Hello guys!"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><code>package.json</code>中的脚本：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  <span class="comment">// "start": "nodemon ./src/index.js",  // 针对ES5语法</span></span><br><span class="line">  "start:babel": "nodemon --exec babel-node ./src/index.js",</span><br><span class="line">  "test:watch": "mocha --require @babel/register --watch",</span><br><span class="line">  "test": "mocha --require @babel/register",</span><br><span class="line">  "build": "babel src --out-dir ./dist --source-maps",</span><br><span class="line">  "serve": "node ./dist/index.js",</span><br><span class="line">  "debug": "node --inspect-brk ./dist/index.js"</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>开始测试：<code>npm run test</code></p>
<p>报错了，因为期望的值与实际值不一致。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Hello world!!!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  index <span class="built_in">test</span></span><br><span class="line">    sayHello <span class="keyword">function</span></span><br><span class="line">      1) should say Hello guys!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  0 passing (9ms)</span><br><span class="line">  1 failing</span><br><span class="line"></span><br><span class="line">  1) index <span class="built_in">test</span></span><br><span class="line">       sayHello <span class="keyword">function</span></span><br><span class="line">         should say Hello guys!:</span><br><span class="line"></span><br><span class="line">      AssertionError: expected <span class="string">'Hello world!!!'</span> to equal <span class="string">'Hello guys!'</span></span><br><span class="line">      + expected - actual</span><br><span class="line"></span><br><span class="line">      -Hello world!!!</span><br><span class="line">      +Hello guys!</span><br><span class="line"></span><br><span class="line">      at Context.equal (<span class="built_in">test</span>/index.spec.js:9:22)</span><br></pre></td></tr></table></figure>

<p>修改测试脚本，或者修改 index.js 文件：</p>
<p>修改<code>./test/index.spec.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; expect &#125; <span class="keyword">from</span> <span class="string">"chai"</span>;</span><br><span class="line"><span class="keyword">import</span> sayHello <span class="keyword">from</span> <span class="string">"../src/index"</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"index test"</span>, () =&gt; &#123;</span><br><span class="line">  describe(<span class="string">"sayHello function"</span>, () =&gt; &#123;</span><br><span class="line">    it(<span class="string">"should say Hello world!!!"</span>, () =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> str = sayHello();</span><br><span class="line">      expect(str).to.equal(<span class="string">"Hello world!!!"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>再次测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; mocha --require @babel/register</span><br><span class="line"></span><br><span class="line">Hello world!!!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  index <span class="built_in">test</span></span><br><span class="line">    sayHello <span class="keyword">function</span></span><br><span class="line">      ✓ should say Hello world!!!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  1 passing (6ms)</span><br></pre></td></tr></table></figure>

<p>使用<code>mochawesome</code>展示你的测试结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev mochawesome</span><br></pre></td></tr></table></figure>

<p>然后在<code>package.json</code>的<code>scripts</code>中添加如下内容，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"report"</span>: <span class="string">"mocha --require @babel/register --reporter mochawesome"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run report</span><br></pre></td></tr></table></figure>

<p>形成出来的报告在浏览器中打开：</p>
<p><img src="/blog/.io//image-20190707212821248.png" alt="image-20190707212821248"></p>
<p>在 Vscode 中可以安装 Live Server 这个插件快速打开：</p>
<p><img src="/blog/.io//image-20190707212923919.png" alt="image-20190707212923919"></p>
<h2 id="开箱即用-Jest"><a href="#开箱即用-Jest" class="headerlink" title="开箱即用 Jest"></a>开箱即用 Jest</h2><p>Jest 是由 Facebook 发布的开源的、基于<a href="http://jasmine.github.io/" target="_blank" rel="noopener">Jasmine</a>的 JavaScript 单元测试框架。Jest 源于 Facebook 的构想，用于快速、可靠地测试 Web 聊天应用。它吸引了公司内部的兴趣，Facebook 的一名软件工程师 Jeff Morrison 半年前又重拾这个项目，改善它的性能，并将其开源。Jest 的目标是减少开始测试一个项目所要花费的时间和认知负荷，因此它提供了大部分你需要的现成工具：快速的命令行接口、Mock 工具集以及它的自动模块 Mock 系统。此外，如果你在寻找隔离工具例如 Mock 库，大部分其它工具将让你在测试中（甚至经常在你的主代码中）写一些不尽如人意的样板代码，以使其生效。Jest 与 Jasmine 框架的区别是在后者之上增加了一些层。最值得注意的是，运行测试时，Jest 会自动模拟依赖。Jest 自动为每个依赖的模块生成 Mock，并默认提供这些 Mock，这样就可以很容易地隔离模块的依赖。</p>
<p>Jest 支持 Babel，我们将很轻松的使用 ES6 的高级语法</p>
<p>Jest 支持 webpack，非常方便的使用它来管理我们的项目</p>
<p>Jest 支持 TypeScript，书写测试用例更加严谨</p>
<ol>
<li><p>简化 API</p>
<p>Jest 既简单又强大，内置支持以下功能：</p>
<ul>
<li>灵活的配置：比如，可以用文件名通配符来检测测试文件。</li>
<li>测试的事前步骤(Setup)和事后步骤(Teardown)，同时也包括测试范围。</li>
<li>匹配表达式(Matchers)：能使用期望<code>expect</code>句法来验证不同的内容。</li>
<li>测试异步代码：支持承诺(promise)数据类型和异步等待<code>async</code> / <code>await</code>功能。</li>
<li>模拟函数：可以修改或监查某个函数的行为。</li>
<li>手动模拟：测试代码时可以忽略模块的依存关系。</li>
<li>虚拟计时：帮助控制时间推移。</li>
</ul>
</li>
<li><p>性能与隔离</p>
<p>Jest 文档里写道：</p>
<p>Jest 能运用所有的工作部分，并列运行测试，使性能最大化。终端上的信息经过缓冲，最后与测试结果一起打印出来。沙盒中生成的测试文件，以及自动全局状态在每个测试里都会得到重置，这样就不会出现两个测试冲突的情况。</p>
<p>Mocha 用一个进程运行所有的测试，和它比较起来，Jest 则完全不同。要在测试之间模拟出隔离效果，我们必须要引入几个测试辅助函数来妥善管理清除工作。这种做法虽然不怎么理想，但 99%的情况都可以用，因为测试是按顺序进行的。</p>
</li>
<li><p>沉浸式监控模式</p>
<p>快速互动式监控模式可以监控到哪些测试文件有过改动，只运行与改动过的文件相关的测试，并且由于优化作用，能迅速放出监控信号。设置起来非常简单，而且还有一些别的选项，可以用文件名或测试名来过滤测试。我们用 Mocha 时也有监控模式，不过没有那么强大，要运行某个特定的测试文件夹或文件，就不得不自己创造解决方法，而这些功能 Jest 本身就已经提供了，不用花力气。</p>
</li>
<li><p>代码覆盖率&amp;测试报告</p>
<p>Jest 内置有代码覆盖率报告功能，设置起来易如反掌。可以在整个项目范围里收集代码覆盖率信息，包括未经受测试的文件。</p>
<p>要使完善 Circle CI 整合，只需要一个自定义报告功能。有了 Jest，用<a href="https://github.com/michaelleeallen/jest-junit-reporter" target="_blank" rel="noopener">jest-junit-reporter</a>就可以做到，其用法和 Mocha 几乎相同。</p>
</li>
<li><p>快照功能</p>
<p>快照测试的目的不是要替换现有的单元测试，而是要使之更有价值，让测试更轻松。在某些情况下，某些功能比如 React 组件功能，有了快照测试意味着无需再做单元测试，但同样这两者不是非此即彼。</p>
</li>
</ol>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><p>新建文件夹然后通过 npm 命令安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev jest</span><br></pre></td></tr></table></figure>

<p>或者通过 yarn 来安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add --dev jest</span><br></pre></td></tr></table></figure>

<p>然后就可以开始测试了</p>
<p>也可用<code>npm install -g jest</code>进行全局安装；并在 package.json 中指定 test 脚本：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"jest"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Jest 的测试脚本名形如<code>.test.js</code>，不论 Jest 是全局运行还是通过<code>npm test</code>运行，它都会执行当前目录下所有的<code>*.test.js</code> 或 <code>*.spec.js</code> 文件、完成测试。</p>
<p>ES6 语法支持：</p>
<ol>
<li>安装依赖</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add --dev babel-jest @babel/core @babel/preset-env</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置<code>.babelrc</code></li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>: [</span><br><span class="line">    [</span><br><span class="line">      <span class="string">"@babel/preset-env"</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"targets"</span>: &#123;</span><br><span class="line">          <span class="attr">"node"</span>: <span class="string">"current"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来就可以使用 ES6 的语法了<del>~</del></p>
<p>更多高阶的 ES6/7/8…语法，可以参见：<a href="https://babeljs.io/" target="_blank" rel="noopener">babel 官网</a></p>
<p>关于 Typescript 的支持，可以参见 ：<a href="https://jestjs.io/docs/en/getting-started#using-typescript" target="_blank" rel="noopener">Using Typescript</a></p>
<h3 id="举个例子"><a href="#举个例子" class="headerlink" title="举个例子"></a>举个例子</h3><p>关于 test suite 与 test case：</p>
<p><img src="/blog/.io//w80140jb42.jpg" alt="img"></p>
<p>describe 属于 test suite 的描述，而每个 test 或者 it 则描述了每个 test case。</p>
<p>例如：<code>math.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> add = <span class="function">(<span class="params">a, b</span>) =&gt;</span> a + b;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> multiple = <span class="function">(<span class="params">a, b</span>) =&gt;</span> a * b;</span><br></pre></td></tr></table></figure>

<p>测试脚本：<code>math.test.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> math = <span class="built_in">require</span>(<span class="string">"./src/math"</span>);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"math"</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> a;</span><br><span class="line">  <span class="keyword">let</span> b;</span><br><span class="line"></span><br><span class="line">  beforeEach(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    a = <span class="number">2</span>;</span><br><span class="line">    b = <span class="number">3</span>;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  test(<span class="string">"#should return result as a+b"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="comment">// test code</span></span><br><span class="line">    <span class="keyword">const</span> result = math.add(a, b);</span><br><span class="line">    expect(result).toEqual(<span class="number">5</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">"#should return result as a*b"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="comment">//test code</span></span><br><span class="line">    <span class="keyword">const</span> result = math.multiple(a, b);</span><br><span class="line">    expect(result).toEqual(<span class="number">6</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>test suite 可以进行嵌套：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">"foo"</span>, () =&gt; &#123;</span><br><span class="line">  describe(<span class="string">"bar"</span>, () =&gt; &#123;</span><br><span class="line">    it(<span class="string">"foo bar"</span>, () =&gt; &#123;</span><br><span class="line">      <span class="comment">//test code</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>test case 也可以脱离 test suite 独立运行：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hello.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">()</span> =&gt;</span> <span class="string">"Hello world"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// hello.test.js</span></span><br><span class="line"><span class="keyword">let</span> hello = <span class="built_in">require</span>(<span class="string">"hello.js"</span>);</span><br><span class="line"></span><br><span class="line">test(<span class="string">'should get "Hello world"'</span>, () =&gt; &#123;</span><br><span class="line">  expect(hello()).toBe(<span class="string">"Hello world"</span>); <span class="comment">// 测试成功</span></span><br><span class="line">  <span class="comment">// expect(hello()).toBe('Hello') // 测试失败</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="Mock-与-Spy"><a href="#Mock-与-Spy" class="headerlink" title="Mock 与 Spy"></a>Mock 与 Spy</h3><p><strong>mock</strong>测试就是在测试过程中，对于某些不容易构造或者不容易获取的对象，用一个虚拟的对象来创建以便测试的测试方法。</p>
<p>Mock 是单元测试中经常使用的一种技术。单元测试，顾名思义测试的重点是某个具体单元。但是在实际代码中，代码与代码之间，模块与模块之间总是会存在着相互引用。这个时候，剥离出这种单元的依赖，让测试更加独立，使用到的技术就是 Mock。</p>
<p><strong>为什么要使用 Mock 函数？</strong></p>
<p>在项目中，一个模块的方法内常常会去调用另外一个模块的方法。在单元测试中，我们可能并不需要关心内部调用的方法的执行过程和结果，只想知道它是否被正确调用即可，甚至会指定该函数的返回值。此时，使用 Mock 函数是十分有必要。</p>
<p>Mock 函数提供的以下三种特性，在我们写测试代码时十分有用：</p>
<ul>
<li>捕获函数调用情况</li>
<li>设置函数返回值</li>
<li>改变函数的内部实现</li>
</ul>
<p><img src="/blog/.io//8u3cp5kz2s.png" alt="img"></p>
<p>举个例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// math.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getFooResult = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// foo logic here</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getBarResult = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// bar logic here</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// caculate.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; getFooResult, getBarResult &#125; <span class="keyword">from</span> <span class="string">"./math"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getFooBarResult = <span class="function"><span class="params">()</span> =&gt;</span> getFooResult() + getBarResult();</span><br></pre></td></tr></table></figure>

<p>此时，getFooResult() 和 getBarResult() 就是 getFooBarResult 这个函数的依赖。如果我们关注的点是 getFooBarResult 这个函数，我们就应该把 getFooResult 和 getBarResult Mock 掉，剥离这种依赖。下面是一个使用 Jest 进行 Mock 的例子。</p>
<p><code>jest.fn()</code>是  创建 Mock 函数最简单的方式，如果没有定义函数内部的实现，<code>jest.fn()</code>会返回<code>undefined</code>作为返回值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">test(<span class="string">"测试jest.fn()调用"</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> mockFn = jest.fn();</span><br><span class="line">  <span class="keyword">let</span> result = mockFn(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 断言mockFn的执行后返回undefined</span></span><br><span class="line">  expect(result).toBeUndefined();</span><br><span class="line">  <span class="comment">// 断言mockFn被调用</span></span><br><span class="line">  expect(mockFn).toBeCalled();</span><br><span class="line">  <span class="comment">// 断言mockFn被调用了一次</span></span><br><span class="line">  expect(mockFn).toBeCalledTimes(<span class="number">1</span>);</span><br><span class="line">  <span class="comment">// 断言mockFn传入的参数为1, 2, 3</span></span><br><span class="line">  expect(mockFn).toHaveBeenCalledWith(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>情景一：设置函数 的返回值</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// calculate.test.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; getFooBarResult &#125; <span class="keyword">from</span> <span class="string">"./calculate"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> fooBar <span class="keyword">from</span> <span class="string">"./math"</span>;</span><br><span class="line"></span><br><span class="line">test(<span class="string">"getResult should return result getFooResult() + getBarResult()"</span>, () =&gt; &#123;</span><br><span class="line">  <span class="comment">// mock add方法和multiple方法</span></span><br><span class="line">  fooBar.getFooBarResult = jest.fn(<span class="function"><span class="params">()</span> =&gt;</span> <span class="number">10</span>);</span><br><span class="line">  fooBar.getBarResult = jest.fn(<span class="function"><span class="params">()</span> =&gt;</span> <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> result = getFooBarResult();</span><br><span class="line"></span><br><span class="line">  expect(result).toEqual(<span class="number">15</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Mock 其实就是一种 Spies，在 Jest 中使用 spies 来“spy”(窥探)一个函数的行为。</p>
<p><a href="https://jestjs.io/docs/en/mock-function-api.html#content" target="_blank" rel="noopener">Jest 文档</a>对于 spies 的解释:</p>
<blockquote>
<p>Mock 函数也称为“spies”，因为它们让你窥探一些由其他代码间接调用的函数的行为，而不仅仅是测试输出。你可以通过使用 <code>jest.fn()</code> 创建一个 mock 函数。</p>
</blockquote>
<p>简单来说，一个 spy 是另一个内置的能够记录对其调用细节的函数：调用它的次数，使用什么参数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// calculate.test.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; getFooBarResult &#125; <span class="keyword">from</span> <span class="string">"./calculate"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> fooBar <span class="keyword">from</span> <span class="string">"./math"</span>;</span><br><span class="line"></span><br><span class="line">test(<span class="string">"getResult should return result getFooResult() + getBarResult()"</span>, () =&gt; &#123;</span><br><span class="line">  <span class="comment">// mock add方法和multiple方法</span></span><br><span class="line">  fooBar.getFooResult = jest.fn(<span class="function"><span class="params">()</span> =&gt;</span> <span class="number">10</span>);</span><br><span class="line">  fooBar.getBarResult = jest.fn(<span class="function"><span class="params">()</span> =&gt;</span> <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> result = getFooBarResult();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 监控getFooResult和getBarResult的调用情况.</span></span><br><span class="line">  expect(fooBar.getFooResult).toHaveBeenCalled();</span><br><span class="line">  expect(fooBar.getBarResult).toHaveBeenCalled();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>情景二：捕获函数调用情况</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bot method</span></span><br><span class="line"><span class="keyword">const</span> bot = &#123;</span><br><span class="line">  sayHello: <span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Hello <span class="subst">$&#123;name&#125;</span>!`</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// test.js</span></span><br><span class="line">describe(<span class="string">"bot"</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">"should say hello"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> spy = jest.spyOn(bot, <span class="string">"sayHello"</span>);</span><br><span class="line"></span><br><span class="line">    bot.sayHello(<span class="string">"Michael"</span>);</span><br><span class="line"></span><br><span class="line">    expect(spy).toHaveBeenCalledWith(<span class="string">"Michael"</span>);</span><br><span class="line"></span><br><span class="line">    spy.mockRestore();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>我们通过 <code>jest.spyOn</code> 创建了一个监听 <code>bot</code> 对象的 <code>sayHello</code> 方法的 spy。它就像间谍一样监听了所有对 <code>bot#sayHello</code> 方法的调用。由于创建 spy 时，Jest 实际上修改了 <code>bot</code> 对象的 <code>sayHello</code> 属性，所以在断言完成后，我们还要通过 <code>mockRestore</code> 来恢复 <code>bot</code> 对象原本的 <code>sayHello</code>方法。</p>
<p>Jest 的<a href="https://jestjs.io/docs/en/jest-object#jestspyonobject-methodname" target="_blank" rel="noopener">spyOn 介绍</a></p>
<p><strong>情景三：修改函数的内容实现</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bot = &#123;</span><br><span class="line">  sayHello: <span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Hello <span class="subst">$&#123;name&#125;</span>!`</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"bot"</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">"should say hello"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> spy = jest.spyOn(bot, <span class="string">"sayHello"</span>).mockImplementation(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`Hello mix <span class="subst">$&#123;name&#125;</span>`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    bot.sayHello(<span class="string">"Michael"</span>);</span><br><span class="line"></span><br><span class="line">    expect(spy).toHaveBeenCalledWith(<span class="string">"Michael"</span>);</span><br><span class="line"></span><br><span class="line">    spy.mockRestore();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>使用 spyOn 方法，还可以去修改 Math.random 这样的函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jest.spyOn(<span class="built_in">Math</span>, <span class="string">"random"</span>).mockImplementation(<span class="function"><span class="params">()</span> =&gt;</span> <span class="number">0.9</span>);</span><br></pre></td></tr></table></figure>

<p>举个例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// getNum.js</span></span><br><span class="line"><span class="keyword">const</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getNum = <span class="function">(<span class="params">index</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (index) &#123;</span><br><span class="line">    <span class="keyword">return</span> arr[index % <span class="number">6</span>];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> arr[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">6</span>)];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// num.test.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; getNum &#125; <span class="keyword">from</span> <span class="string">"../src/getNum"</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"getNum"</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">"should select numbber based on index if provided"</span>, () =&gt; &#123;</span><br><span class="line">    expect(getNum(<span class="number">1</span>)).toBe(<span class="number">2</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">"should select a random number based on Math.random if skuId not available"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> spy = jest.spyOn(<span class="built_in">Math</span>, <span class="string">"random"</span>).mockImplementation(<span class="function"><span class="params">()</span> =&gt;</span> <span class="number">0.9</span>);</span><br><span class="line"></span><br><span class="line">    expect(getNum()).toBe(<span class="number">6</span>);</span><br><span class="line">    expect(spy).toHaveBeenCalled();</span><br><span class="line"></span><br><span class="line">    spy.mockRestore();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="CLI-命令"><a href="#CLI-命令" class="headerlink" title="CLI 命令"></a>CLI 命令</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">➜ npx jest <span class="comment">--help</span></span><br><span class="line">Usage: jest [<span class="comment">--config=&lt;pathToConfigFile&gt;] [TestPathPattern]</span></span><br><span class="line"></span><br><span class="line">选项：</span><br><span class="line">  <span class="comment">--help, -h                    显示帮助信息                              [布尔]</span></span><br><span class="line">  <span class="comment">--version, -v                 Print the version and exit                [布尔]</span></span><br><span class="line">  <span class="comment">--config, -c                  The path to a jest config file specifying how to</span></span><br><span class="line">                                find and <span class="keyword">execute</span> tests. <span class="keyword">If</span> <span class="keyword">no</span> rootDir <span class="keyword">is</span> <span class="keyword">set</span> <span class="keyword">in</span></span><br><span class="line">                                the config, the <span class="keyword">directory</span> containing the config</span><br><span class="line">                                <span class="keyword">file</span> <span class="keyword">is</span> assumed <span class="keyword">to</span> be the rootDir <span class="keyword">for</span> the</span><br><span class="line">                                project.This can also be a <span class="keyword">JSON</span> encoded <span class="keyword">value</span></span><br><span class="line">                                which Jest will <span class="keyword">use</span> <span class="keyword">as</span> configuration.   [字符串]</span><br><span class="line">  <span class="comment">--coverage                    Indicates that test coverage information should</span></span><br><span class="line">                                be collected <span class="keyword">and</span> reported <span class="keyword">in</span> the output.  [布尔]</span><br><span class="line">  <span class="comment">--timers                      Setting this value to fake allows the use of</span></span><br><span class="line">                                fake timers <span class="keyword">for</span> functions such <span class="keyword">as</span> setTimeout.</span><br><span class="line">                                                                        [字符串]</span><br><span class="line">  <span class="comment">--verbose                     Display individual test results with the test</span></span><br><span class="line">                                suite hierarchy.                          [布尔]</span><br><span class="line">  <span class="comment">--watch                       Watch files for changes and rerun tests related</span></span><br><span class="line">                                <span class="keyword">to</span> <span class="keyword">changed</span> files. <span class="keyword">If</span> you want <span class="keyword">to</span> re-run <span class="keyword">all</span></span><br><span class="line">                                tests <span class="keyword">when</span> a <span class="keyword">file</span> has <span class="keyword">changed</span>, <span class="keyword">use</span> the</span><br><span class="line">                                <span class="string">`--watchAll`</span> option.                      [布尔]</span><br><span class="line">  <span class="comment">--watchAll                    Watch files for changes and rerun all tests. If</span></span><br><span class="line">                                you want <span class="keyword">to</span> re-run <span class="keyword">only</span> the tests related <span class="keyword">to</span> the</span><br><span class="line">                                <span class="keyword">changed</span> files, <span class="keyword">use</span> the <span class="string">`--watch`</span> option.  [布尔]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>常见使用：</p>
<p><code>--verbose</code>显示详细的测试信息，包括测试 suite 和 case：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">➜ npx jest --verbose</span><br><span class="line"> PASS  <span class="built_in">test</span>/mock.test.js</span><br><span class="line">  bot</span><br><span class="line">    ✓ should say hello (7ms)</span><br><span class="line"></span><br><span class="line">  console.log <span class="built_in">test</span>/mock.test.js:10</span><br><span class="line">    Hello mix Michael</span><br><span class="line"></span><br><span class="line"> PASS  <span class="built_in">test</span>/domain.test.js</span><br><span class="line">  getImageDomain</span><br><span class="line">    ✓ should select domain based on skuId <span class="keyword">if</span> provided (1ms)</span><br><span class="line">    ✓ should select a random domain based on Math.random <span class="keyword">if</span> skuId not available (1ms)</span><br><span class="line"></span><br><span class="line">  console.log <span class="built_in">test</span>/sayhello.test.js:3</span><br><span class="line">    Hello Michael!</span><br><span class="line"></span><br><span class="line"> PASS  <span class="built_in">test</span>/sayhello.test.js</span><br><span class="line">  bot</span><br><span class="line">    ✓ should say hello (6ms)</span><br><span class="line"></span><br><span class="line"> PASS  <span class="built_in">test</span>/num.test.js</span><br><span class="line">  getNum</span><br><span class="line">    ✓ should select numbber based on index <span class="keyword">if</span> provided (1ms)</span><br><span class="line">    ✓ should select a random number based on Math.random <span class="keyword">if</span> skuId not available</span><br><span class="line"></span><br><span class="line"> PASS  <span class="built_in">test</span>/math.test.js</span><br><span class="line">  math</span><br><span class="line">    ✓ <span class="comment">#should return result as a+b (1ms)</span></span><br><span class="line">    ✓ <span class="comment">#should return result as a*b (4ms)</span></span><br><span class="line"></span><br><span class="line">Test Suites: 5 passed, 5 total</span><br><span class="line">Tests:       8 passed, 8 total</span><br><span class="line">Snapshots:   0 total</span><br><span class="line">Time:        1.075s</span><br><span class="line">Ran all <span class="built_in">test</span> suites.</span><br></pre></td></tr></table></figure>

<p><code>--watch</code>和<code>--watchAll</code>用来监听测试文件的变化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Ran all <span class="built_in">test</span> suites.</span><br><span class="line"></span><br><span class="line">Watch Usage</span><br><span class="line"> › Press f to run only failed tests.</span><br><span class="line"> › Press o to only run tests related to changed files.</span><br><span class="line"> › Press p to filter by a filename regex pattern.</span><br><span class="line"> › Press t to filter by a <span class="built_in">test</span> name regex pattern.</span><br><span class="line"> › Press q to quit watch mode.</span><br><span class="line"> › Press Enter to trigger a <span class="built_in">test</span> run.</span><br></pre></td></tr></table></figure>

<p><code>--coverage</code>用来形成测试覆盖率报告</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-----------|----------|----------|----------|----------|-------------------|</span><br><span class="line">File       |  % Stmts | % Branch |  % Funcs |  % Lines | Uncovered Line <span class="comment">#s |</span></span><br><span class="line">-----------|----------|----------|----------|----------|-------------------|</span><br><span class="line">All files  |      100 |      100 |      100 |      100 |                   |</span><br><span class="line"> getNum.js |      100 |      100 |      100 |      100 |                   |</span><br><span class="line"> math.js   |      100 |      100 |      100 |      100 |                   |</span><br><span class="line">-----------|----------|----------|----------|----------|-------------------|</span><br><span class="line"></span><br><span class="line">Test Suites: 5 passed, 5 total</span><br><span class="line">Tests:       8 passed, 8 total</span><br><span class="line">Snapshots:   0 total</span><br><span class="line">Time:        1.497s</span><br></pre></td></tr></table></figure>

<h3 id="Jest-在-React、Vue-项目中的应用"><a href="#Jest-在-React、Vue-项目中的应用" class="headerlink" title="Jest 在 React、Vue 项目中的应用"></a>Jest 在 React、Vue 项目中的应用</h3><p>在<code>create-react-app</code>中的应用：</p>
<p>安装对应的依赖：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span> react-<span class="keyword">test</span>-renderer enzyme enzyme-adapter-react-<span class="number">16</span></span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/airbnb/enzyme" target="_blank" rel="noopener">Enzyme</a>是一个非常棒的 React 组件测试测试库。</p>
<blockquote>
<p>Enzyme is a JavaScript Testing utility for React that makes it easier to test your React Components’ output. You can also manipulate, traverse, and in some ways simulate runtime given the output.</p>
<p>Enzyme’s API is meant to be intuitive and flexible by mimicking jQuery’s API for DOM manipulation and traversal</p>
</blockquote>
<p>需要注意的两点是：</p>
<ul>
<li>需要配置 Adapter，不同的 React 的 Adapter 不同</li>
</ul>
<p>| Enzyme Adapter Package      | React semver compatibility |<br>| ————————— | ————————– | — | —— |<br>| <code>enzyme-adapter-react-16</code>   | <code>^16.4.0-0</code>                |<br>| <code>enzyme-adapter-react-16.3</code> | <code>~16.3.0-0</code>                |<br>| <code>enzyme-adapter-react-16.2</code> | <code>~16.2</code>                    |<br>| <code>enzyme-adapter-react-16.1</code> | <code>~16.0.0-0                 |     | ~16.1</code> |<br>| <code>enzyme-adapter-react-15</code>   | <code>^15.5.0</code>                  |<br>| <code>enzyme-adapter-react-15.4</code> | <code>15.0.0-0 - 15.4.x</code>        |<br>| <code>enzyme-adapter-react-14</code>   | <code>^0.14.0</code>                  |<br>| <code>enzyme-adapter-react-13</code>   | <code>^0.13.0</code>                  |</p>
<ul>
<li><p>需要初始化配置<code>setUpTests.js</code></p>
<p>官方文档在 Package.json 中设置 jest 配置，已经过时，Jest 框架最新会默认加载文件<code>src/setUpTests.js</code></p>
</li>
<li><pre><code class="react">import { configure } from &apos;enzyme&apos;;
import Adapter from &apos;enzyme-adapter-react-16&apos;

configure({ adapter: new Adapter() })
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">在 vue 工程化项目中：</span><br><span class="line"></span><br><span class="line">```json</span><br><span class="line"><span class="string">"devDependencies"</span>: &#123;</span><br><span class="line">  <span class="string">"@vue/cli-plugin-unit-jest"</span>: <span class="string">"^3.9.0"</span>,</span><br><span class="line">  <span class="string">"@vue/test-utils"</span>: <span class="string">"1.0.0-beta.29"</span>,</span><br><span class="line">  <span class="string">"babel-core"</span>: <span class="string">"7.0.0-bridge.0"</span>,</span><br><span class="line">  <span class="string">"babel-eslint"</span>: <span class="string">"^10.0.1"</span>,</span><br><span class="line">  <span class="string">"babel-jest"</span>: <span class="string">"^23.6.0"</span>,</span><br><span class="line">  <span class="string">"babel-preset-env"</span>: <span class="string">"^1.7.0"</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<p>添加如上依赖，</p>
<p>配置 scripts:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"scripts"</span>: &#123;</span><br><span class="line">  <span class="string">"test"</span>: <span class="string">"vue-cli-service test:unit"</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>配置<code>jest.config.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 处理vue结尾的文件</span></span><br><span class="line">  moduleFileExtensions: [<span class="string">"js"</span>, <span class="string">"jsx"</span>, <span class="string">"json"</span>, <span class="string">"vue"</span>],</span><br><span class="line">  <span class="comment">// es6转义</span></span><br><span class="line">  transform: &#123;</span><br><span class="line">    <span class="string">"^.+\\.vue$"</span>: <span class="string">"vue-jest"</span>,</span><br><span class="line">    <span class="string">".+\\.(css|styl|less|sass|scss|svg|png|jpg|ttf|woff|woff2)$"</span>:</span><br><span class="line">      <span class="string">"jest-transform-stub"</span>,</span><br><span class="line">    <span class="string">"^.+\\.jsx?$"</span>: <span class="string">"babel-jest"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  transformIgnorePatterns: [<span class="string">"/node_modules/"</span>],</span><br><span class="line">  <span class="comment">// cli配置了webpack别名</span></span><br><span class="line">  moduleNameMapper: &#123;</span><br><span class="line">    <span class="string">"^@/(.*)$"</span>: <span class="string">"&lt;rootDir&gt;/src/$1"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  snapshotSerializers: [<span class="string">"jest-serializer-vue"</span>],</span><br><span class="line">  testMatch: [</span><br><span class="line">    <span class="string">"**/tests/unit/**/*.spec.(js|jsx|ts|tsx)|**/__tests__/*.(js|jsx|ts|tsx)"</span>,</span><br><span class="line">  ],</span><br><span class="line">  testURL: <span class="string">"http://localhost/"</span>,</span><br><span class="line">  watchPlugins: [</span><br><span class="line">    <span class="string">"jest-watch-typeahead/filename"</span>,</span><br><span class="line">    <span class="string">"jest-watch-typeahead/testname"</span>,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>写一个测试用例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="简约之美-AVA"><a href="#简约之美-AVA" class="headerlink" title="简约之美 AVA"></a>简约之美 AVA</h2><p>简单的说 ava 是 mocha 的替代品：</p>
<ul>
<li>es6 语法支持更好，对 aysnc/await 有支持</li>
<li>执行效率更高，使用 io 并发，就必须保证测试的原子性</li>
<li>语义上更简单，集众家之长</li>
</ul>
<p>虽然 JavaScript 是单线程，但在 Node.js 里由于其异步的特性使得 IO 可以并行。AVA 利用这个优点让你的测试可以并发执行，这对于 IO 繁重的测试特别有用。另外，测试文件可以在不同的进程里并行运行，让每一个测试文件可以获得更好的性能和独立的环境。</p>
<h3 id="AVA-特点"><a href="#AVA-特点" class="headerlink" title="AVA 特点"></a>AVA 特点</h3><ul>
<li><p>轻量和高效</p>
</li>
<li><p>简单的测试语法</p>
</li>
<li><p>并发运行测试</p>
</li>
<li><p>强制编写<strong>原子测试</strong></p>
<p>一旦开始，就一直运行到结束，中间不会切换到另一个测试</p>
</li>
<li><p>没有隐藏的全局变量</p>
</li>
<li><p>为每个测试文件隔离环境</p>
</li>
<li><p><strong>用 ES2015 编写测试</strong></p>
</li>
<li><p>支持 Promise</p>
</li>
<li><p>支持 Generator</p>
</li>
<li><p>支持 Async</p>
</li>
<li><p>支持 Observable</p>
</li>
<li><p>强化断言信息</p>
</li>
<li><p>可选的 TAP 输出显示</p>
<p><img src="/blog/.io//tap-reporter.png" alt="img"></p>
</li>
<li><p>简明的堆栈跟踪</p>
</li>
</ul>
<h3 id="安装-amp-开始"><a href="#安装-amp-开始" class="headerlink" title="安装&amp;开始"></a>安装&amp;开始</h3><p>情景一：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 创建一个ava项目</span><br><span class="line">npm init ava</span><br></pre></td></tr></table></figure>

<p>形成 package.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"awesome-package"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"ava"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"ava"</span>: <span class="string">"^1.0.0"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>情景二：（推荐）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm init -y</span><br><span class="line"></span><br><span class="line">// npm &amp; cnpm</span><br><span class="line">npm install -D ava</span><br><span class="line"></span><br><span class="line">// yarn</span><br><span class="line">yarn add ava -D</span><br></pre></td></tr></table></figure>

<p>测试 ava 正常安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜ npx ava --version</span><br><span class="line">2.2.0</span><br></pre></td></tr></table></figure>

<h3 id="第一个-ava-测试例子"><a href="#第一个-ava-测试例子" class="headerlink" title="第一个 ava 测试例子"></a>第一个 ava 测试例子</h3><p>流程：</p>
<ol>
<li>引用 ava 的测试 API</li>
<li>执行测试</li>
<li>使用断言</li>
</ol>
<p>创建<code>test.js</code>文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> test <span class="keyword">from</span> <span class="string">"ava"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> testfn = <span class="function">(<span class="params">a, b</span>) =&gt;</span> a + b;</span><br><span class="line"></span><br><span class="line">test(<span class="string">"hello ava"</span>, (t) =&gt; &#123;</span><br><span class="line">  t.pass();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">test(<span class="string">"my first test"</span>, <span class="keyword">async</span> (t) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> str = <span class="string">"hello ava!!!!"</span>;</span><br><span class="line">  t.is(str, <span class="string">"hello ava!!!!"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">test(<span class="string">"add method"</span>, <span class="keyword">async</span> (t) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> result = testfn(<span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line">  t.is(result, <span class="number">7</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>ava 自动搜索如下文件结尾的文件：</p>
<ul>
<li><code>**/test.js</code></li>
<li><code>**/test-*.js</code></li>
<li><code>**/*.spec.js</code></li>
<li><code>**/*.test.js</code></li>
<li><code>**/test/**/*.js</code></li>
<li><code>**/tests/**/*.js</code></li>
<li><code>**/__tests__/**/*.js</code></li>
</ul>
<p>ava 中的断言：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.pass([message])</span><br><span class="line">.fail([message])</span><br><span class="line">.assert(value, [message])</span><br><span class="line">.truthy(value, [message])</span><br><span class="line">.falsy(value, [message])</span><br><span class="line">.true(value, [message])</span><br><span class="line">.false(value, [message])</span><br><span class="line">.is(value, expected, [message])</span><br><span class="line">.not(value, expected, [message])</span><br><span class="line">.deepEqual(value, expected, [message])</span><br><span class="line">.notDeepEqual(value, expected, [message])</span><br><span class="line">.deepEqual()。</span><br><span class="line">.throws(fn, [expected, [message]])</span><br><span class="line">.throwsAsync(thrower, [expected, [message]])</span><br><span class="line">.notThrows(fn, [message])</span><br><span class="line">.notThrowsAsync(nonThrower, [message])</span><br><span class="line">.regex(contents, regex, [message])</span><br><span class="line">.notRegex(contents, regex, [message])</span><br><span class="line">.snapshot(expected, [message])</span><br><span class="line">.snapshot(expected, [options], [message])</span><br></pre></td></tr></table></figure>

<h3 id="CLI-命令-1"><a href="#CLI-命令-1" class="headerlink" title="CLI 命令"></a>CLI 命令</h3><p>使用<code>--help</code>命令去查看 ava 支持的 cli 参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">➜ npx ava --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">  Testing can be a drag. AVA helps you get it <span class="keyword">done</span>.</span><br><span class="line"></span><br><span class="line">  Usage</span><br><span class="line">    ava [&lt;file&gt; ...]</span><br><span class="line"></span><br><span class="line">  Options</span><br><span class="line">    --watch, -w             Re-run tests when tests and <span class="built_in">source</span> files change</span><br><span class="line">    --match, -m             Only run tests with matching title (Can be repeated)</span><br><span class="line">    --update-snapshots, -u  Update snapshots</span><br><span class="line">    --fail-fast             Stop after first <span class="built_in">test</span> failure</span><br><span class="line">    --timeout, -T           Set global timeout (milliseconds or human-readable, e.g. 10s, 2m)</span><br><span class="line">    --serial, -s            Run tests serially</span><br><span class="line">    --concurrency, -c       Max number of <span class="built_in">test</span> files running at the same time (Default: CPU cores)</span><br><span class="line">    --verbose, -v           Enable verbose output</span><br><span class="line">    --tap, -t               Generate TAP output</span><br><span class="line">    --color                 Force color output</span><br><span class="line">    --no-color              Disable color output</span><br><span class="line">    --reset-cache           Reset AVA<span class="string">'s compilation cache and exit</span></span><br><span class="line"><span class="string">    --config                JavaScript file for AVA to read its config from, instead of using package.json</span></span><br><span class="line"><span class="string">                            or ava.config.js files</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  Examples</span></span><br><span class="line"><span class="string">    ava</span></span><br><span class="line"><span class="string">    ava test.js test2.js</span></span><br><span class="line"><span class="string">    ava test-*.js</span></span><br><span class="line"><span class="string">    ava test</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  The above relies on your shell expanding the glob patterns.</span></span><br><span class="line"><span class="string">  Without arguments, AVA uses the following patterns:</span></span><br><span class="line"><span class="string">    **/test.js **/test-*.js **/*.spec.js **/*.test.js **/test/**/*.js **/tests/**/*.js **/__tests__/**/*.js</span></span><br></pre></td></tr></table></figure>

<h4 id="文件匹配"><a href="#文件匹配" class="headerlink" title="文件匹配"></a>文件匹配</h4><p>使用<code>match</code>指令，匹配对应需要测试的文件：</p>
<p>匹配标题以<code>foo</code>：结尾</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">npx </span><span class="string">ava </span><span class="built_in">--match</span> =<span class="string">'* foo'</span></span><br></pre></td></tr></table></figure>

<p>匹配标题以<code>foo</code>：</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">npx </span><span class="string">ava </span><span class="built_in">--match</span> =<span class="string">'foo *'</span></span><br></pre></td></tr></table></figure>

<p>匹配标题包含<code>foo</code>：</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">npx </span><span class="string">ava </span><span class="built_in">--match</span> =<span class="string">'* foo *'</span></span><br></pre></td></tr></table></figure>

<p>匹配是完全相同 <code>foo</code>：</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">npx </span><span class="string">ava </span><span class="built_in">--match</span> =<span class="string">'foo'</span></span><br></pre></td></tr></table></figure>

<p>匹配标题不包含<code>foo</code>：</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">npx </span><span class="string">ava </span><span class="built_in">--match</span> =<span class="string">'！* foo *'</span></span><br></pre></td></tr></table></figure>

<p>匹配以下<code>foo</code>结尾的标题<code>bar</code>：</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">npx </span><span class="string">ava </span><span class="built_in">--match</span> =<span class="string">'foo * bar'</span></span><br></pre></td></tr></table></figure>

<p>匹配<code>foo</code>以<code>bar</code>：开头或结尾的标题：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx ava --<span class="keyword">match</span> =<span class="string">'foo *'</span> -  <span class="keyword">match</span> =<span class="string">'* bar'</span></span><br></pre></td></tr></table></figure>

<h4 id="关于-reporter"><a href="#关于-reporter" class="headerlink" title="关于 reporter"></a>关于 reporter</h4><p>默认情况下，AVA 使用最小的报告：</p>
<p><a href="https://github.com/avajs/ava/blob/master/media/mini-reporter.gif" target="_blank" rel="noopener"><img src="/blog/.io//mini-reporter.gif" alt="img"></a></p>
<p>使用该<code>--verbose</code>标志启用详细的报告者。除非启用 TAP 报告，否则始终在 CI 环境中使用此选项。</p>
<p><a href="https://github.com/avajs/ava/blob/master/media/verbose-reporter.png" target="_blank" rel="noopener"><img src="/blog/.io//verbose-reporter.png" alt="img"></a></p>
<p><strong>TAP 报告（推荐）</strong></p>
<p>AVA 支持 TAP 格式，因此与任何 TAP 报告器兼容。使用该<code>--tap</code>标志启用 TAP 输出。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npx ava --tap | npx tap-nyan</span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/avajs/ava/blob/master/media/tap-reporter.png" target="_blank" rel="noopener"><img src="/blog/.io//tap-reporter-20190709154342692.png" alt="img"></a></p>
<p>这里有一些格式：</p>
<ul>
<li><a href="https://github.com/scottcorgan/tap-dot" target="_blank" rel="noopener">tap-dot</a> - Dotted output.</li>
<li><a href="https://github.com/scottcorgan/tap-spec" target="_blank" rel="noopener">tap-spec</a> - Mocha-like spec reporter.</li>
<li><a href="https://github.com/calvinmetcalf/tap-nyan" target="_blank" rel="noopener">tap-nyan</a> - Nyan cat.</li>
<li><a href="https://github.com/gummesson/tap-min" target="_blank" rel="noopener">tap-min</a> - Minimal output.</li>
<li><a href="https://github.com/namuol/tap-difflet" target="_blank" rel="noopener">tap-difflet</a> - Minimal output with diffing.</li>
<li><a href="https://github.com/axross/tap-diff" target="_blank" rel="noopener">tap-diff</a> - Human-friendly output with diffing.</li>
<li><a href="https://github.com/joeybaker/tap-simple" target="_blank" rel="noopener">tap-simple</a> - Simple output.</li>
<li><a href="https://github.com/substack/faucet" target="_blank" rel="noopener">faucet</a> - Human-readable summarizer.</li>
<li><a href="https://github.com/isaacs/tap-mocha-reporter" target="_blank" rel="noopener">tap-mocha-reporter</a> - Use any of the <a href="https://github.com/isaacs/tap-mocha-reporter/tree/master/lib/reporters" target="_blank" rel="noopener">Mocha reporters</a>.</li>
<li><a href="https://github.com/zoubin/tap-summary" target="_blank" rel="noopener">tap-summary</a> - Summarized output.</li>
<li><a href="https://github.com/clux/tap-pessimist" target="_blank" rel="noopener">tap-pessimist</a> - Only shows failed tests.</li>
<li><a href="https://github.com/toolness/tap-prettify" target="_blank" rel="noopener">tap-prettify</a> - Nice readable output with diffing.</li>
<li><a href="https://github.com/substack/tap-colorize" target="_blank" rel="noopener">tap-colorize</a> - Colorize the output while preserving machine-readability.</li>
<li><a href="https://github.com/juliangruber/tap-bail" target="_blank" rel="noopener">tap-bail</a> - Bail out when the first test fails.</li>
<li><a href="https://github.com/axross/tap-notify" target="_blank" rel="noopener">tap-notify</a> - Notifier for macOS, Linux and Windows.</li>
<li><a href="https://github.com/gummesson/tap-json" target="_blank" rel="noopener">tap-json</a> - JSON output.</li>
<li><a href="https://github.com/yovasx2/ava-tap-json" target="_blank" rel="noopener">ava-tap-json</a> - JSON output with AVA compatibility.</li>
<li><a href="https://github.com/aghassemi/tap-xunit" target="_blank" rel="noopener">tap-xunit</a> - xUnit output.</li>
<li><a href="https://github.com/smockle/tap-teamcity" target="_blank" rel="noopener">tap-teamcity</a> - Output for TeamCity.</li>
</ul>
<h4 id="快照功能"><a href="#快照功能" class="headerlink" title="快照功能"></a>快照功能</h4><p>ava 自动进行项目测试快照，如果文件放置在<code>test</code>或者<code>tests</code>目录，则快照会放置在<code>snapshots</code>目录。如果测试放置在<code>__test__</code>目录，则快照放置在<code>__snapshots__</code>目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ava --update-snapshots</span><br></pre></td></tr></table></figure>

<p>可以指定一个固定位置，以便在 AVA 的<code>package.json</code>配置中存储快照文件：</p>
<p><strong>package.json：</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	 "ava"：&#123;</span><br><span class="line">		 "snapshotDir"："自定义目录"</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="设置超时"><a href="#设置超时" class="headerlink" title="设置超时"></a>设置超时</h4><p>AVA 中的超时行为与其他测试框架中的行为不同。AVA 在每次测试后重置计时器，如果在指定的超时内没有收到新的测试结果，则强制测试退出。这可用于处理停滞的测试。</p>
<p><em>没有默认超时。</em></p>
<p>您可以配置使用超时<code>--timeout</code> 命令行选项，或配置文件中设置。它们可以以人类可读的方式设置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 10秒</span></span><br><span class="line">npx ava --timeout = 10s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2分钟</span></span><br><span class="line">npx ava --timeout = 2m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 100毫秒</span></span><br><span class="line">npx ava --timeout = 100</span><br></pre></td></tr></table></figure>

<p>还可以为每个测试单独设置超时。每次进行断言时都会重置这些超时。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">test(<span class="string">"foo"</span>, (t) =&gt; &#123;</span><br><span class="line">  t.timeout(<span class="number">100</span>); <span class="comment">// 100 milliseconds</span></span><br><span class="line">  <span class="comment">// Write your assertions here</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="其他-ava-设置相关"><a href="#其他-ava-设置相关" class="headerlink" title="其他 ava 设置相关"></a>其他 ava 设置相关</h3><h4 id="ESLint"><a href="#ESLint" class="headerlink" title="ESLint"></a>ESLint</h4><p>如果使用了 ESLint，请添加<a href="https://github.com/avajs/eslint-plugin-ava" target="_blank" rel="noopener">eslint-plugin-ava</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"plugins"</span>: [<span class="string">"ava"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="异步相关"><a href="#异步相关" class="headerlink" title="异步相关"></a>异步相关</h4><p>如果异步操作使用 promises，则应返回 promise：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">test(<span class="string">"fetches foo"</span>, (t) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> fetch().then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    t.is(data, <span class="string">"foo"</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>更好的是，使用<code>async</code>/ <code>await</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">test(<span class="string">"fetches foo"</span>, <span class="keyword">async</span> (t) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> fetch();</span><br><span class="line">  t.is(data, <span class="string">"foo"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="测试环境-amp-帮手-Karma"><a href="#测试环境-amp-帮手-Karma" class="headerlink" title="测试环境&amp;帮手 Karma"></a>测试环境&amp;帮手 Karma</h2><p>Karma 是一个基于 Node.js 的 JavaScript 测试执行过程管理工具（Test Runner）。该工具可用于测试所有主流 Web 浏览器，也可以集成到 CI（Continuous integration）工具，还可以和其他代码编辑器一起使用。</p>
<p>Karma 会监控配置文件中所指定的每一个文件，每当文件发生改变，它都会向测试服务器发送信号，来通知所有的浏览器再次运行测试代码。此时，浏览器会重新加载源文件，并执行测试代码。其结果会传递回服务器，并以某种形式显示给开发者。</p>
<p>访问浏览器执行结果，可通过以下的方式</p>
<ul>
<li>手工方式 - 通过浏览器</li>
<li>自动方式 - 让 karma 来启动对应的浏览器</li>
</ul>
<h3 id="工作原理简介"><a href="#工作原理简介" class="headerlink" title="工作原理简介"></a>工作原理简介</h3><p><code>karma</code> 是一个典型的 <code>C/S</code> 程序，包含 client 和 server ，通讯方式基于 <code>Http</code> ，通常情况下，客户端和服务端基本都运行在开发者本地机器上。</p>
<p>一个服务端实例对应一个项目，假如想同时运行多个项目，得同时开启多个服务端实例。</p>
<p><strong>Server</strong></p>
<p><code>Server</code> 是框架的主要组成部分之一，它内部保存了所有的程序运行状态，比如 client 连接，当前运行的单测文件，根据这些数据状态，它提供了下面几个功能， 下图是 server 的结构</p>
<p><img src="/blog/.io//TB13X9xLXXXXXXoaXXXDUoU9pXX-902-329.png" alt="karma_server"></p>
<ul>
<li>监听文件</li>
<li>与 client 进行通讯</li>
<li>向开发者输出测试结果</li>
<li>提供 client 端所需的资源文件</li>
</ul>
<p><strong>Client</strong></p>
<p>client 是单测最终运行的地方，类似一个 web app ， 跟 server 端通讯利用 <code>socket.io</code>， 执行单测在一个独立的 <code>iframe</code> 中。下面是它的结构图</p>
<p><img src="/blog/.io//TB1jTKwLXXXXXX.aXXX0KhCSFXX-619-472.png" alt="karma_impl_client"></p>
<p>client 和 server 端通讯采用 <code>socket.io</code></p>
<ul>
<li>client 端会发送这些消息</li>
</ul>
<p><img src="/blog/.io//TB1XXuILXXXXXcAXFXX.hdJKpXX-918-179.png" alt="karma_impl_client_message_c"></p>
<ul>
<li>server 端会发送这些消息</li>
</ul>
<p><img src="/blog/.io//TB1PvisLXXXXXcqaXXXEHlCNpXX-896-103.png" alt="karma_impl_client_message_s"></p>
<h3 id="安装-Karma"><a href="#安装-Karma" class="headerlink" title="安装 Karma"></a>安装 Karma</h3><p>对于 Nodejs 版本的要求：</p>
<blockquote>
<p>Karma currently works on Node.js <strong>6.x</strong>, <strong>8.x</strong>, and <strong>10.x</strong>. See <a href="https://karma-runner.github.io/4.0/intro/faq.html" target="_blank" rel="noopener">FAQ</a> for more info.</p>
</blockquote>
<ol>
<li><p>全局安装</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">$npm</span> install -g karma</span></span><br></pre></td></tr></table></figure>

<p>安装 Karma 命令会到全局的 <code>node_modules</code> 目录下，我们可以在任何位置直接运行 karma 命令。</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g karma-<span class="keyword">cli</span></span><br></pre></td></tr></table></figure>

<p>此命令用来安装 <code>karma-cli</code>，它会在当前目录下寻找 karma 的可执行文件。这样我们就可以在一个系统内运行多个版本的 Karma。</p>
</li>
<li><p>本地安装</p>
<figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install karma --<span class="built_in">save</span>-<span class="built_in">dev</span></span><br></pre></td></tr></table></figure>

<p>安装 Karma 命令到当前 <code>node_modules</code> 目录下，此时，如果需要执行 karma 命令，就需要这样</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./node_modules/.bin/karma</span></span><br><span class="line"></span><br><span class="line">npx karma <span class="params">--version</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="配置-Karma"><a href="#配置-Karma" class="headerlink" title="配置 Karma"></a>配置 Karma</h3><p>karma 配置文件可以用 JavaScript，CoffeeScript 或 TypeScript 编写，并作为常规 Node.js 模块加载。</p>
<p>除非作为参数提供，否则 Karma CLI 将在以下位置以该顺序(从上至下)查找配置文件</p>
<ul>
<li><code>./karma.conf.js</code></li>
<li><code>./karma.conf.coffee</code></li>
<li><code>./karma.conf.ts</code></li>
<li><code>./.config/karma.conf.js</code></li>
<li><code>./.config/karma.conf.coffee</code></li>
<li><code>./.config/karma.conf.ts</code></li>
</ul>
<p>在配置文件中，配置代码通过设置<code>module.exports</code>指向一个接受一个参数的函数：配置对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// karma.conf.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">config</span>) </span>&#123;</span><br><span class="line">  config.set(&#123;</span><br><span class="line">    basePath: <span class="string">'../..'</span>,</span><br><span class="line">    frameworks: [<span class="string">'jasmine'</span>],</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"># karma.conf.coffee</span><br><span class="line"><span class="built_in">module</span>.exports = (config) -&gt;</span><br><span class="line">  config.set</span><br><span class="line">    basePath: <span class="string">'../..'</span></span><br><span class="line">    frameworks: [<span class="string">'jasmine'</span>]</span><br><span class="line">    # ...</span><br><span class="line"><span class="comment">// karma.conf.ts</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">config</span>) =&gt;</span> &#123;</span><br><span class="line">  config.set(&#123;</span><br><span class="line">    basePath: <span class="string">'../..'</span>,</span><br><span class="line">    frameworks: [<span class="string">'jasmine'</span>],</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>关于 typescript 的支持，需要使用到<code>ts-node</code>，配置 ts-node 以使用<code>commonjs</code>模块格</p>
</blockquote>
<p>配置文件中的基本的属性介绍：<a href="https://karma-runner.github.io/4.0/config/configuration-file.html" target="_blank" rel="noopener">Overview</a></p>
<p>使用 CLI 工具，快速创建配置</p>
<p>开始配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">~/Downloads/Demo is 📦 v1.0.0 via ⬢ v10.16.0</span><br><span class="line">➜ npx karma init</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果在应用中用到了其它的测试框架，那就需要我们安装它们所对应的插件，并在配置文件中标注它们（详见 karma.conf.js 中的 plugins 项）</span></span><br><span class="line">Which testing framework <span class="keyword">do</span> you want to use ?</span><br><span class="line">Press tab to list possible options. Enter to move to the next question.</span><br><span class="line">&gt; jasmine</span><br><span class="line"><span class="comment"># mocha</span></span><br><span class="line"><span class="comment"># qunit</span></span><br><span class="line"><span class="comment"># nodeunit</span></span><br><span class="line"><span class="comment"># nunit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Require.js 是异步加载规范（AMD）的实现。常被作为基础代码库，应用在了很多的项目与框架之中，例如 Dojo, AngularJs 等</span></span><br><span class="line">Do you want to use Require.js ?</span><br><span class="line">This will add Require.js plugin.</span><br><span class="line">Press tab to list possible options. Enter to move to the next question.</span><br><span class="line">&gt; no</span><br><span class="line"><span class="comment"># yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 选择需要运行测试用例的浏览器。需要注意的就是，必须保证所对应的浏览器插件已经安装成功。</span></span><br><span class="line">Do you want to capture any browsers automatically ?</span><br><span class="line">Press tab to list possible options. Enter empty string to move to the next question.</span><br><span class="line">&gt; Chrome</span><br><span class="line"><span class="comment"># ChromeHeadless</span></span><br><span class="line"><span class="comment"># ChromeCanary</span></span><br><span class="line"><span class="comment"># Firefox</span></span><br><span class="line"><span class="comment"># Safari</span></span><br><span class="line"><span class="comment"># PhantomJS</span></span><br><span class="line"><span class="comment"># Opera</span></span><br><span class="line"><span class="comment"># IE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 选择测试用例所在的目录位置。Karma 支持通配符的方式配置文件或目录，例如 *.js, test/**/*.js 等。如果目录或文件使用相对位置，要清楚地是，此时的路径是相对于当前运行 karma 命令时所在的目录。</span></span><br><span class="line">What is the location of your <span class="built_in">source</span> and <span class="built_in">test</span> files ?</span><br><span class="line">You can use glob patterns, eg. <span class="string">"js/*.js"</span> or <span class="string">"test/**/*Spec.js"</span>.</span><br><span class="line">Enter empty string to move to the next question.</span><br><span class="line">&gt; src/*js</span><br><span class="line"></span><br><span class="line"><span class="comment"># 目录中不包括的那些文件。</span></span><br><span class="line">Should any of the files included by the previous patterns be excluded ?</span><br><span class="line">You can use glob patterns, eg. <span class="string">"**/*.swp"</span>.</span><br><span class="line">Enter empty string to move to the next question.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否需要 Karma 自动监听文件？并且文件一旦被修改，就重新运行测试用例？</span></span><br><span class="line">Do you want Karma to watch all the files and run the tests on change ?</span><br><span class="line">Press tab to list possible options.</span><br><span class="line">&gt; yes</span><br></pre></td></tr></table></figure>

<p>生成了一个<code>karma.conf.js</code>文件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Karma configuration</span></span><br><span class="line"><span class="comment">// Generated on Wed Jul 10 2019 22:46:32 GMT+0800 (GMT+08:00)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">config</span>) </span>&#123;</span><br><span class="line">  config.set(&#123;</span><br><span class="line">    <span class="comment">// base path that will be used to resolve all patterns (eg. files, exclude)</span></span><br><span class="line">    basePath: <span class="string">""</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// frameworks to use</span></span><br><span class="line">    <span class="comment">// available frameworks: https://npmjs.org/browse/keyword/karma-adapter</span></span><br><span class="line">    frameworks: [<span class="string">"mocha"</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// list of files / patterns to load in the browser</span></span><br><span class="line">    files: [<span class="string">"src/*js"</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// list of files / patterns to exclude</span></span><br><span class="line">    exclude: [],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// preprocess matching files before serving them to the browser</span></span><br><span class="line">    <span class="comment">// available preprocessors: https://npmjs.org/browse/keyword/karma-preprocessor</span></span><br><span class="line">    preprocessors: &#123;&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// test results reporter to use</span></span><br><span class="line">    <span class="comment">// possible values: 'dots', 'progress'</span></span><br><span class="line">    <span class="comment">// available reporters: https://npmjs.org/browse/keyword/karma-reporter</span></span><br><span class="line">    reporters: [<span class="string">"progress"</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// web server port</span></span><br><span class="line">    port: <span class="number">9876</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// enable / disable colors in the output (reporters and logs)</span></span><br><span class="line">    colors: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// level of logging</span></span><br><span class="line">    <span class="comment">// possible values: config.LOG_DISABLE || config.LOG_ERROR || config.LOG_WARN || config.LOG_INFO || config.LOG_DEBUG</span></span><br><span class="line">    logLevel: config.LOG_INFO,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// enable / disable watching file and executing tests whenever any file changes</span></span><br><span class="line">    autoWatch: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// start these browsers</span></span><br><span class="line">    <span class="comment">// available browser launchers: https://npmjs.org/browse/keyword/karma-launcher</span></span><br><span class="line">    browsers: [<span class="string">"Chrome"</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Continuous Integration mode</span></span><br><span class="line">    <span class="comment">// if true, Karma captures browsers, runs the tests and exits</span></span><br><span class="line">    singleRun: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Concurrency level</span></span><br><span class="line">    <span class="comment">// how many browser should be started simultaneous</span></span><br><span class="line">    concurrency: <span class="literal">Infinity</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="karma-示例"><a href="#karma-示例" class="headerlink" title="karma 示例"></a>karma 示例</h3><p>目标 ：</p>
<ul>
<li>babel 支持，ES6 语法支持</li>
<li>mocha 与 chai 支持</li>
<li>karma 与 chrome、webpack 对接</li>
</ul>
<p>说明：</p>
<p>Karma 对 babel 支持的，一个可选项：<a href="https://github.com/babel/karma-babel-preprocessor" target="_blank" rel="noopener">karma-babel-preprocessor</a>，但是：</p>
<blockquote>
<p>babel and karma-babel-preprocessor only convert ES6 modules to CommonJS/AMD/SystemJS/UMD<strong>. If you choose CommonJS, you still need to resolve and concatenate CommonJS modules on your own</strong>. We recommend <strong>karma-browserify + babelify</strong> or <strong>webpack + babel-loader</strong> in such cases.</p>
</blockquote>
<p>所以，我们选择了 webpack</p>
<ol>
<li><p>安装依赖</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install </span>@<span class="keyword">babel/core </span>@<span class="keyword">babel/preset-env </span>chai mocha webpack webpack-cli <span class="keyword">babel-loader </span>-D</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装 karma 的适配器</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span> karma-webpack karma-chrome-launcher karma-mocha karma-chai -D</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置<code>karma.config.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Karma configuration</span></span><br><span class="line"><span class="comment">// Generated on Thu Jul 11 2019 23:23:44 GMT+0800 (GMT+08:00)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">config</span>) </span>&#123;</span><br><span class="line">  config.set(&#123;</span><br><span class="line">    <span class="comment">// base path that will be used to resolve all patterns (eg. files, exclude)</span></span><br><span class="line">    basePath: <span class="string">""</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// frameworks to use</span></span><br><span class="line">    <span class="comment">// available frameworks: https://npmjs.org/browse/keyword/karma-adapter</span></span><br><span class="line">    frameworks: [<span class="string">"mocha"</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// list of files / patterns to load in the browser</span></span><br><span class="line">    files: [<span class="string">"src/**/*.js"</span>, <span class="string">"test/**/*.js"</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// preprocess matching files before serving them to the browser</span></span><br><span class="line">    <span class="comment">// available preprocessors: https://npmjs.org/browse/keyword/karma-preprocessor</span></span><br><span class="line">    preprocessors: &#123;</span><br><span class="line">      <span class="string">"src/**/*.js"</span>: [<span class="string">"webpack"</span>],</span><br><span class="line">      <span class="string">"test/**/*.js"</span>: [<span class="string">"webpack"</span>],</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    webpack: &#123;</span><br><span class="line">      mode: <span class="string">"none"</span>,</span><br><span class="line">      node: &#123;</span><br><span class="line">        fs: <span class="string">"empty"</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="built_in">module</span>: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">          &#123;</span><br><span class="line">            test: <span class="regexp">/\.js?$/</span>,</span><br><span class="line">            loader: <span class="string">"babel-loader"</span>,</span><br><span class="line">            options: &#123; <span class="attr">presets</span>: [<span class="string">"@babel/env"</span>] &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line"></span><br><span class="line">    plugins: [</span><br><span class="line">      <span class="string">"karma-mocha"</span>,</span><br><span class="line">      <span class="string">"karma-chai"</span>,</span><br><span class="line">      <span class="string">"karma-chrome-launcher"</span>,</span><br><span class="line">      <span class="string">"karma-webpack"</span>,</span><br><span class="line">    ],</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>书写测试用例<code>test.js</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; describe &#125; <span class="keyword">from</span> <span class="string">"mocha"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; expect &#125; <span class="keyword">from</span> <span class="string">"chai"</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"first test"</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">"hello mocha and karma"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"hello mocha"</span>);</span><br><span class="line">    expect(<span class="literal">true</span>).to.be.equal(<span class="literal">true</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>开始测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx karma start</span><br></pre></td></tr></table></figure>

<p>添加到<code>package.json</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "karma": "karma start"</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>然后使用，<code>npm run karma</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">➜ npx karma start</span><br><span class="line">ℹ ｢wdm｣: Hash: 9d2c943b68425fd58dd0</span><br><span class="line">Version: webpack 4.35.3</span><br><span class="line">Time: 53ms</span><br><span class="line">Built at: 2019-07-12 5:07:49 PM</span><br><span class="line">ℹ ｢wdm｣: Compiled successfully.</span><br><span class="line">ℹ ｢wdm｣: Compiling...</span><br><span class="line">⚠ ｢wdm｣: Hash: cca8316f4bd5855fc4de</span><br><span class="line">Version: webpack 4.35.3</span><br><span class="line">Time: 2414ms</span><br><span class="line">Built at: 2019-07-12 5:07:52 PM</span><br><span class="line">       Asset      Size  Chunks             Chunk Names</span><br><span class="line">src/index.js  3.62 KiB       0  [emitted]  src/index</span><br><span class="line"><span class="built_in">test</span>/test.js  1010 KiB       1  [emitted]  <span class="built_in">test</span>/<span class="built_in">test</span></span><br><span class="line">Entrypoint src/index = src/index.js</span><br><span class="line">Entrypoint <span class="built_in">test</span>/<span class="built_in">test</span> = <span class="built_in">test</span>/test.js</span><br><span class="line">  [0] ./src/index.js 27 bytes &#123;0&#125; [built]</span><br><span class="line">  [1] ./<span class="built_in">test</span>/test.js 223 bytes &#123;1&#125; [built]</span><br><span class="line">  [2] ./node_modules/mocha/browser-entry.js 4.19 KiB &#123;1&#125; [built]</span><br><span class="line">  [3] ./node_modules/process/browser.js 4.96 KiB &#123;1&#125; [built]</span><br><span class="line">  [4] (webpack)/buildin/global.js 878 bytes &#123;1&#125; [built]</span><br><span class="line">  [5] ./node_modules/browser-stdout/index.js 662 bytes &#123;1&#125; [built]</span><br><span class="line">  [6] ./node_modules/stream-browserify/index.js 3.53 KiB &#123;1&#125; [built]</span><br><span class="line"> [36] ./node_modules/util/util.js 19 KiB &#123;1&#125; [built]</span><br><span class="line"> [38] ./node_modules/mocha/lib/mocha.js 21.8 KiB &#123;1&#125; [built]</span><br><span class="line"> [39] (webpack)/buildin/module.js 552 bytes &#123;1&#125; [built]</span><br><span class="line"> [40] ./node_modules/escape-string-regexp/index.js 230 bytes &#123;1&#125; [built]</span><br><span class="line"> [41] path (ignored) 15 bytes &#123;1&#125; [built]</span><br><span class="line"> [42] ./node_modules/mocha/lib/reporters/index.js 945 bytes &#123;1&#125; [built]</span><br><span class="line">[105] ./node_modules/chai/index.js 39 bytes &#123;1&#125; [built]</span><br><span class="line">[106] ./node_modules/chai/lib/chai.js 1.22 KiB &#123;1&#125; [built]</span><br><span class="line">    + 128 hidden modules</span><br><span class="line"></span><br><span class="line">WARNING <span class="keyword">in</span> ./node_modules/mocha/lib/mocha.js 217:20-37</span><br><span class="line">Critical dependency: the request of a dependency is an expression</span><br><span class="line"> @ ./node_modules/mocha/browser-entry.js</span><br><span class="line"> @ ./<span class="built_in">test</span>/test.js</span><br><span class="line"></span><br><span class="line">WARNING <span class="keyword">in</span> ./node_modules/mocha/lib/mocha.js 222:24-70</span><br><span class="line">Critical dependency: the request of a dependency is an expression</span><br><span class="line"> @ ./node_modules/mocha/browser-entry.js</span><br><span class="line"> @ ./<span class="built_in">test</span>/test.js</span><br><span class="line"></span><br><span class="line">WARNING <span class="keyword">in</span> ./node_modules/mocha/lib/mocha.js 266:24-35</span><br><span class="line">Critical dependency: the request of a dependency is an expression</span><br><span class="line"> @ ./node_modules/mocha/browser-entry.js</span><br><span class="line"> @ ./<span class="built_in">test</span>/test.js</span><br><span class="line"></span><br><span class="line">WARNING <span class="keyword">in</span> ./node_modules/mocha/lib/mocha.js 313:35-48</span><br><span class="line">Critical dependency: the request of a dependency is an expression</span><br><span class="line"> @ ./node_modules/mocha/browser-entry.js</span><br><span class="line"> @ ./<span class="built_in">test</span>/test.js</span><br><span class="line"></span><br><span class="line">WARNING <span class="keyword">in</span> ./node_modules/mocha/lib/mocha.js 329:23-44</span><br><span class="line">Critical dependency: the request of a dependency is an expression</span><br><span class="line"> @ ./node_modules/mocha/browser-entry.js</span><br><span class="line"> @ ./<span class="built_in">test</span>/test.js</span><br><span class="line">ℹ ｢wdm｣: Compiled with warnings.</span><br><span class="line">12 07 2019 17:07:52.761:WARN [karma]: No captured browser, open http://localhost:9876/</span><br><span class="line">12 07 2019 17:07:52.770:INFO [karma-server]: Karma v4.1.0 server started at http://0.0.0.0:9876/</span><br><span class="line">12 07 2019 17:07:52.770:INFO [launcher]: Launching browsers Chrome with concurrency unlimited</span><br><span class="line">12 07 2019 17:07:52.773:INFO [launcher]: Starting browser Chrome</span><br><span class="line">12 07 2019 17:07:54.135:INFO [Chrome 75.0.3770 (Mac OS X 10.14.5)]: Connected on socket R9R31QB1GtR_kayNAAAA with id 55412577</span><br><span class="line">Chrome 75.0.3770 (Mac OS X 10.14.5) LOG: <span class="string">'hello karma'</span></span><br><span class="line"></span><br><span class="line">LOG: <span class="string">'hello mocha'</span></span><br><span class="line">Chrome 75.0.3770 (Mac OS X 10.14.5): Executed 1 of 1 SUCCESS (0 secs / 0.001 secs</span><br><span class="line">~/Downloads/karma-demo is 📦 v1.0.0 via ⬢ v10.16.0</span><br><span class="line">➜ npm run karma</span><br><span class="line"></span><br><span class="line">&gt; karma-demo@1.0.0 karma /Users/huasheng/Downloads/karma-demo</span><br><span class="line">&gt; karma start</span><br><span class="line"></span><br><span class="line">ℹ ｢wdm｣: Hash: 9d2c943b68425fd58dd0</span><br><span class="line">Version: webpack 4.35.3</span><br><span class="line">Time: 48ms</span><br><span class="line">Built at: 2019-07-12 5:24:02 PM</span><br><span class="line">ℹ ｢wdm｣: Compiled successfully.</span><br><span class="line">ℹ ｢wdm｣: Compiling...</span><br><span class="line">⚠ ｢wdm｣: Hash: cca8316f4bd5855fc4de</span><br><span class="line">Version: webpack 4.35.3</span><br><span class="line">Time: 2307ms</span><br><span class="line">Built at: 2019-07-12 5:24:04 PM</span><br><span class="line">       Asset      Size  Chunks             Chunk Names</span><br><span class="line">src/index.js  3.62 KiB       0  [emitted]  src/index</span><br><span class="line"><span class="built_in">test</span>/test.js  1010 KiB       1  [emitted]  <span class="built_in">test</span>/<span class="built_in">test</span></span><br><span class="line">Entrypoint src/index = src/index.js</span><br><span class="line">Entrypoint <span class="built_in">test</span>/<span class="built_in">test</span> = <span class="built_in">test</span>/test.js</span><br><span class="line">  [0] ./src/index.js 27 bytes &#123;0&#125; [built]</span><br><span class="line">  [1] ./<span class="built_in">test</span>/test.js 223 bytes &#123;1&#125; [built]</span><br><span class="line">  [2] ./node_modules/mocha/browser-entry.js 4.19 KiB &#123;1&#125; [built]</span><br><span class="line">  [3] ./node_modules/process/browser.js 4.96 KiB &#123;1&#125; [built]</span><br><span class="line">  [4] (webpack)/buildin/global.js 878 bytes &#123;1&#125; [built]</span><br><span class="line">  [5] ./node_modules/browser-stdout/index.js 662 bytes &#123;1&#125; [built]</span><br><span class="line">  [6] ./node_modules/stream-browserify/index.js 3.53 KiB &#123;1&#125; [built]</span><br><span class="line"> [36] ./node_modules/util/util.js 19 KiB &#123;1&#125; [built]</span><br><span class="line"> [38] ./node_modules/mocha/lib/mocha.js 21.8 KiB &#123;1&#125; [built]</span><br><span class="line"> [39] (webpack)/buildin/module.js 552 bytes &#123;1&#125; [built]</span><br><span class="line"> [40] ./node_modules/escape-string-regexp/index.js 230 bytes &#123;1&#125; [built]</span><br><span class="line"> [41] path (ignored) 15 bytes &#123;1&#125; [built]</span><br><span class="line"> [42] ./node_modules/mocha/lib/reporters/index.js 945 bytes &#123;1&#125; [built]</span><br><span class="line">[105] ./node_modules/chai/index.js 39 bytes &#123;1&#125; [built]</span><br><span class="line">[106] ./node_modules/chai/lib/chai.js 1.22 KiB &#123;1&#125; [built]</span><br><span class="line">    + 128 hidden modules</span><br><span class="line"></span><br><span class="line">WARNING <span class="keyword">in</span> ./node_modules/mocha/lib/mocha.js 217:20-37</span><br><span class="line">Critical dependency: the request of a dependency is an expression</span><br><span class="line"> @ ./node_modules/mocha/browser-entry.js</span><br><span class="line"> @ ./<span class="built_in">test</span>/test.js</span><br><span class="line"></span><br><span class="line">WARNING <span class="keyword">in</span> ./node_modules/mocha/lib/mocha.js 222:24-70</span><br><span class="line">Critical dependency: the request of a dependency is an expression</span><br><span class="line"> @ ./node_modules/mocha/browser-entry.js</span><br><span class="line"> @ ./<span class="built_in">test</span>/test.js</span><br><span class="line"></span><br><span class="line">WARNING <span class="keyword">in</span> ./node_modules/mocha/lib/mocha.js 266:24-35</span><br><span class="line">Critical dependency: the request of a dependency is an expression</span><br><span class="line"> @ ./node_modules/mocha/browser-entry.js</span><br><span class="line"> @ ./<span class="built_in">test</span>/test.js</span><br><span class="line"></span><br><span class="line">WARNING <span class="keyword">in</span> ./node_modules/mocha/lib/mocha.js 313:35-48</span><br><span class="line">Critical dependency: the request of a dependency is an expression</span><br><span class="line"> @ ./node_modules/mocha/browser-entry.js</span><br><span class="line"> @ ./<span class="built_in">test</span>/test.js</span><br><span class="line"></span><br><span class="line">WARNING <span class="keyword">in</span> ./node_modules/mocha/lib/mocha.js 329:23-44</span><br><span class="line">Critical dependency: the request of a dependency is an expression</span><br><span class="line"> @ ./node_modules/mocha/browser-entry.js</span><br><span class="line"> @ ./<span class="built_in">test</span>/test.js</span><br><span class="line">ℹ ｢wdm｣: Compiled with warnings.</span><br><span class="line">12 07 2019 17:24:04.905:WARN [karma]: No captured browser, open http://localhost:9876/</span><br><span class="line">12 07 2019 17:24:04.914:INFO [karma-server]: Karma v4.1.0 server started at http://0.0.0.0:9876/</span><br><span class="line">12 07 2019 17:24:04.914:INFO [launcher]: Launching browsers Chrome with concurrency unlimited</span><br><span class="line">12 07 2019 17:24:04.922:INFO [launcher]: Starting browser Chrome</span><br><span class="line">12 07 2019 17:24:06.289:INFO [Chrome 75.0.3770 (Mac OS X 10.14.5)]: Connected on socket EbCCSbQRPbxHbq3OAAAA with id 92342032</span><br><span class="line">Chrome 75.0.3770 (Mac OS X 10.14.5) LOG: <span class="string">'hello karma'</span></span><br><span class="line"></span><br><span class="line">LOG: <span class="string">'hello mocha'</span></span><br><span class="line">Chrome 75.0.3770 (Mac OS X 10.14.5): Executed 1 of 1 SUCCESS (0 secs / 0.001 secs</span><br><span class="line">Chrome 75.0.3770 (Mac OS X 10.14.5): Executed 1 of 1 SUCCESS (0.006 secs / 0.001</span><br><span class="line">secs)</span><br><span class="line">TOTAL: 1 SUCCESS</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="UI-测试利器-Nightmare"><a href="#UI-测试利器-Nightmare" class="headerlink" title="UI 测试利器 Nightmare"></a>UI 测试利器 Nightmare</h2><p>Nightmare 是<a href="https://segment.com/" target="_blank" rel="noopener">Segment</a>的高级浏览器自动化库。</p>
<p>目标是公开一些模仿用户操作（例如<code>goto</code>，<code>type</code>和<code>click</code>）的简单方法，使用对每个脚本块感觉同步的 API，而不是深层嵌套的回调。它最初设计用于在没有 API 的站点之间自动执行任务，但最常用于 UI 测试和爬网。</p>
<p>它使用<a href="http://electron.atom.io/" target="_blank" rel="noopener">Electron</a>，它与<a href="http://phantomjs.org/" target="_blank" rel="noopener">PhantomJS</a>类似，但大约<a href="https://github.com/segmentio/nightmare/issues/484#issuecomment-184519591" target="_blank" rel="noopener">快两倍</a>，更现代。</p>
<h3 id="安装与起步"><a href="#安装与起步" class="headerlink" title="安装与起步"></a>安装与起步</h3><ol>
<li><p>安装<code>nightmare</code></p>
</li>
<li><pre><code>// 初始化项目
npm init -y

npm install --save-dev nightmare

<figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">npm install --<span class="built_in">save</span>-<span class="built_in">dev</span> mocha</span><br></pre></td></tr></table></figure></code></pre></li>
<li><p>淘宝源加速</p>
</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 使用淘宝源加速 electron 的安装</span></span><br><span class="line"><span class="keyword">export</span> ELECTRON_MIRROR=<span class="string">"https://npm.taobao.org/mirrors/electron/"</span></span><br><span class="line"></span><br><span class="line">`</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>起步测试：</li>
</ol>
<p>​```js<br>const Nightmare = require(‘nightmare’)<br>const assert = require(‘assert’)</p>
<p>describe(‘Load a Page’, function () {<br>  // Recommended: 5s locally, 10s to remote server, 30s from airplane ¯_(ツ)_/¯<br>  this.timeout(‘30s’)</p>
<p>  let nightmare = null<br>  beforeEach(() =&gt; {<br>    nightmare = new Nightmare()<br>  })</p>
<p>  describe(‘/ (Home Page)’, () =&gt; {<br>    it(‘should load without error’, done =&gt; {<br>      // your actual testing urls will likely be <code>http://localhost:port/path</code><br>      nightmare.goto(‘<a href="https://www.baidu.com&#39;" target="_blank" rel="noopener">https://www.baidu.com&#39;</a>)<br>        .end()<br>        .then(function (result) {<br>          done()<br>        })<br>        .catch(done)<br>    })<br>  })<br>})</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### nightmare 配合 mocha 测试</span><br><span class="line"></span><br><span class="line">nightmare 可以进行网页的抓取，配合 mocha 进行页面的测试：</span><br><span class="line"></span><br><span class="line">安装&#96;mocha&#96;</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;bash</span><br><span class="line">npm install --save-dev mocha</span><br></pre></td></tr></table></figure>

<blockquote>
<p>还可以安装一些断言库，如：<code>chai</code></p>
</blockquote>
<p>新建测试：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Nightmare = <span class="built_in">require</span>(<span class="string">"nightmare"</span>);</span><br><span class="line"><span class="keyword">const</span> assert = <span class="built_in">require</span>(<span class="string">"assert"</span>);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"Search nightmare"</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">this</span>.timeout(<span class="string">"30s"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> nightmare = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    nightmare = <span class="keyword">new</span> Nightmare();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">"should load with result nightmare"</span>, (done) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> selector = <span class="string">"em"</span>;</span><br><span class="line">    nightmare</span><br><span class="line">      .goto(<span class="string">"https://www.baidu.com"</span>)</span><br><span class="line">      .type(<span class="string">"#kw"</span>, <span class="string">"nightmare"</span>)</span><br><span class="line">      .click(<span class="string">"#su"</span>)</span><br><span class="line">      .wait(<span class="string">"em"</span>)</span><br><span class="line">      .evaluate(<span class="function">(<span class="params">selector</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// now we're executing inside the browser scope.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">document</span>.querySelector(selector).innerText;</span><br><span class="line">      &#125;, selector) <span class="comment">// &lt;-- that's how you pass parameters from Node scope to browser scope</span></span><br><span class="line">      .end()</span><br><span class="line">      .then(<span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(result);</span><br><span class="line">        assert.equal(result, <span class="string">"nightmare"</span>);</span><br><span class="line">        done();</span><br><span class="line">      &#125;)</span><br><span class="line">      .catch(done);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>将 mocha 作为测试脚本添加到您的 <code>package.json</code>：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "test": "mocha"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="API-介绍"><a href="#API-介绍" class="headerlink" title="API 介绍"></a>API 介绍</h3><h4 id="nightmare-的配置项"><a href="#nightmare-的配置项" class="headerlink" title="nightmare 的配置项"></a>nightmare 的配置项</h4><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">waitTimeout</span> (<span class="attribute">default</span>: <span class="number">30s</span>)</span><br><span class="line"><span class="selector-tag">gotoTimeout</span> (<span class="attribute">default</span>: <span class="number">30s</span>)</span><br><span class="line"><span class="selector-tag">loadTimeout</span> (<span class="attribute">default</span>: infinite)</span><br><span class="line"><span class="selector-tag">executionTimeout</span> (<span class="attribute">default</span>: <span class="number">30s</span>)</span><br><span class="line"><span class="selector-tag">paths</span></span><br><span class="line"><span class="selector-tag">switches</span></span><br><span class="line"><span class="selector-tag">electronPath</span></span><br><span class="line"><span class="selector-tag">dock</span></span><br><span class="line"><span class="selector-tag">openDevTools</span></span><br><span class="line"><span class="selector-tag">typeInterval</span> (<span class="attribute">default</span>: <span class="number">100ms</span>)</span><br><span class="line"><span class="selector-tag">pollInterval</span> (<span class="attribute">default</span>: <span class="number">250ms</span>)</span><br><span class="line"><span class="selector-tag">maxAuthRetries</span> (<span class="attribute">default</span>: <span class="number">3</span>)</span><br><span class="line"><span class="selector-tag">certificateSubjectName</span></span><br><span class="line"><span class="selector-class">.engineVersions</span>()</span><br><span class="line"><span class="selector-class">.useragent</span>(useragent)</span><br><span class="line"><span class="selector-class">.authentication</span>(user, password)</span><br><span class="line"><span class="selector-class">.authentication</span>(user, password)</span><br><span class="line"><span class="selector-class">.halt</span>(error, done)</span><br></pre></td></tr></table></figure>

<p>配置链接：<a href="https://github.com/segmentio/nightmare#nightmareoptions" target="_blank" rel="noopener">https://github.com/segmentio/nightmare#nightmareoptions</a></p>
<h4 id="页面交互相关"><a href="#页面交互相关" class="headerlink" title="页面交互相关"></a>页面交互相关</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.back</span>()</span><br><span class="line"><span class="selector-class">.forward</span>()</span><br><span class="line"><span class="selector-class">.refresh</span>()</span><br><span class="line"><span class="selector-class">.click</span>(<span class="selector-tag">selector</span>)</span><br><span class="line"><span class="selector-class">.mousedown</span>(<span class="selector-tag">selector</span>)</span><br><span class="line"><span class="selector-class">.mouseup</span>(<span class="selector-tag">selector</span>)</span><br><span class="line"><span class="selector-class">.mouseover</span>(<span class="selector-tag">selector</span>)</span><br><span class="line"><span class="selector-class">.mouseout</span>(<span class="selector-tag">selector</span>)</span><br><span class="line"><span class="selector-class">.type</span>(<span class="selector-tag">selector</span><span class="selector-attr">[, text]</span>)</span><br><span class="line"><span class="selector-class">.insert</span>(<span class="selector-tag">selector</span><span class="selector-attr">[, text]</span>)</span><br><span class="line"><span class="selector-class">.check</span>(<span class="selector-tag">selector</span>)</span><br><span class="line"><span class="selector-class">.uncheck</span>(<span class="selector-tag">selector</span>)</span><br><span class="line"><span class="selector-class">.select</span>(<span class="selector-tag">selector</span>, <span class="selector-tag">option</span>)</span><br><span class="line"><span class="selector-class">.scrollTo</span>(<span class="selector-tag">top</span>, <span class="selector-tag">left</span>)</span><br><span class="line"><span class="selector-class">.viewport</span>(<span class="selector-tag">width</span>, <span class="selector-tag">height</span>)</span><br><span class="line"><span class="selector-class">.inject</span>(<span class="selector-tag">type</span>, <span class="selector-tag">file</span>)</span><br><span class="line"><span class="selector-class">.evaluate</span>(<span class="selector-tag">fn</span><span class="selector-attr">[, arg1, arg2,...]</span>)</span><br><span class="line"><span class="selector-class">.wait</span>(<span class="selector-tag">ms</span>)</span><br><span class="line"><span class="selector-class">.wait</span>(<span class="selector-tag">selector</span>)</span><br><span class="line"><span class="selector-class">.wait</span>(<span class="selector-tag">fn</span><span class="selector-attr">[, arg1, arg2,...]</span>)</span><br><span class="line"><span class="selector-class">.header</span>(<span class="selector-tag">header</span>, <span class="selector-tag">value</span>)</span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/segmentio/nightmare#interact-with-the-page" target="_blank" rel="noopener">配置参考链接</a></p>
<h4 id="页面提取"><a href="#页面提取" class="headerlink" title="页面提取"></a>页面提取</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.exists</span>(<span class="selector-tag">selector</span>)</span><br><span class="line"><span class="selector-class">.visible</span>(<span class="selector-tag">selector</span>)</span><br><span class="line"><span class="selector-class">.on</span>(<span class="selector-tag">event</span>, <span class="selector-tag">callback</span>)</span><br><span class="line"><span class="selector-class">.once</span>(<span class="selector-tag">event</span>, <span class="selector-tag">callback</span>)</span><br><span class="line"><span class="selector-class">.removeListener</span>(<span class="selector-tag">event</span>, <span class="selector-tag">callback</span>)</span><br><span class="line"><span class="selector-class">.screenshot</span>(<span class="selector-attr">[path]</span><span class="selector-attr">[, clip]</span>)</span><br><span class="line"><span class="selector-class">.html</span>(<span class="selector-tag">path</span>, <span class="selector-tag">saveType</span>)</span><br><span class="line"><span class="selector-class">.pdf</span>(<span class="selector-tag">path</span>, <span class="selector-tag">options</span>)</span><br><span class="line"><span class="selector-class">.title</span>()</span><br><span class="line"><span class="selector-class">.url</span>()</span><br><span class="line"><span class="selector-class">.path</span>()</span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/segmentio/nightmare#extract-from-the-page" target="_blank" rel="noopener">配置参考链接</a></p>
<h2 id="其他相关"><a href="#其他相关" class="headerlink" title="其他相关"></a>其他相关</h2><h3 id="补充资料"><a href="#补充资料" class="headerlink" title="补充资料"></a>补充资料</h3><h4 id="软件测试的分类"><a href="#软件测试的分类" class="headerlink" title="软件测试的分类"></a>软件测试的分类</h4><p><strong>第一部分：软件测试的分类</strong></p>
<ul>
<li><p>按测试执行阶段划分</p>
<p>单元测试、集成测试、系统测试、验收测试（正式验收测试、Alpha 测试、Beta 测试）</p>
</li>
<li><p>按测试技术划分</p>
<p>白盒测试、黑盒测试、灰盒测试</p>
</li>
<li><p>被测试对象是否运行划分</p>
<p>动态测试、静态测试（文档检查、代码走查、界面检查）</p>
</li>
<li><p>按不同的测试手段划分</p>
<p>手工测试、自动化测试</p>
</li>
<li><p>按测试包含的内容划分</p>
<p>功能测试、界面测试、安全测试、兼容性测试、易用性测试、性能测试、压力测试、负载测试、恢复测试</p>
</li>
<li><p>其他测试</p>
<p>冒烟测试、回归测试、探索性测试/自由测试（测试思维）</p>
</li>
</ul>
<p><strong>第二部分：接下来对软件测试分类进行一个说明</strong></p>
<p><strong>第三部分：测试工具</strong></p>
<p>SVN，Git——&gt;版本控制管理工具</p>
<p>禅道——&gt;Bug 管理工具</p>
<p>Fiddler——&gt;抓包，定位问题你</p>
<p>postman，jmeter，soapui——&gt;接口测试</p>
<p>Loadrunner，Jmeter——&gt;性能，压力测试</p>
<h4 id="2019-年-Javascript-测试概览"><a href="#2019-年-Javascript-测试概览" class="headerlink" title="2019 年 Javascript 测试概览"></a>2019 年 Javascript 测试概览</h4><p><a href="https://medium.com/welldone-software/an-overview-of-javascript-testing-in-2019-264e19514d0a" target="_blank" rel="noopener">https://medium.com/welldone-software/an-overview-of-javascript-testing-in-2019-264e19514d0a</a></p>
<p>这是一篇非常好的国外的博文，同时也是 2018 年 Javascript 测试概览的作者。这里有 2018 年的译文：</p>
<p><a href="https://zhuanlan.zhihu.com/p/32702421" target="_blank" rel="noopener">展望 2018 年 JavaScript Testing</a></p>
<p>在文中很好介绍到了测试类型，并举了大量的例子，非常全面。</p>
<h4 id="什么是-TDD？"><a href="#什么是-TDD？" class="headerlink" title="什么是 TDD？"></a>什么是 TDD？</h4><p><a href="https://juejin.im/post/5c3e73876fb9a049d37f5db1" target="_blank" rel="noopener">测试驱动开发（TDD）总结——原理篇</a></p>
<p>TDD （Test Driven Development） 在不同的圈子、不同的角色的认知中可能会有不同的理解，有人可能会理解成 ATDD（Acceptance Test Driven Development），也有人可能会理解成 UTDD（Unit Test Driven Development），为了避免产生歧义，<strong>文章涉及到 TDD 专指 UTDD（Unit Test Driven Development），即 「单元测试驱动开发」</strong>。</p>
<p>TDD 的目标</p>
<blockquote>
<p>Kent Beck 在他的著作《Test-Driven Development》一书中提到：“<strong>代码简洁可用</strong>这句言简意赅的话，正是 TDD 所追求的目标”。</p>
</blockquote>
<p><strong>对于如何保证“代码简洁可用”可以使用分而治之的方法，先达到“可用”目标，再追求“简洁”目标。</strong></p>
<p><strong>可用：</strong> 保证代码通过自动化测试。</p>
<p><strong>代码简洁：</strong> 在不同阶段人们对简洁的理解程度也不一样，不过遵循的原则差不多，例如 OOD 的 SOLID 原则，Kent Beck 的 Simple Design 原则等。</p>
<p>虽然有很多因素妨碍我们得到整洁的代码，甚至可用的代码，无需征求太多意见，只需要采用 TDD 的开发方式来驱动出简洁可用的代码。</p>
<h4 id="Karma-的前世今生"><a href="#Karma-的前世今生" class="headerlink" title="Karma 的前世今生"></a>Karma 的前世今生</h4><p>2016 年的文章，由淘宝前端团队书写：<a href="http://taobaofed.org/blog/2016/01/08/karma-origin/" target="_blank" rel="noopener">http://taobaofed.org/blog/2016/01/08/karma-origin/</a></p>
<p>通篇介绍了 karma 的工作原理及实现原理，非常有价值的文章。</p>
<h3 id="ava-框架的配置文件"><a href="#ava-框架的配置文件" class="headerlink" title="ava 框架的配置文件"></a>ava 框架的配置文件</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"ava"</span>: &#123;</span><br><span class="line">    <span class="attr">"files"</span>: [</span><br><span class="line">      <span class="string">"test/**/*"</span>,</span><br><span class="line">      <span class="string">"!test/exclude-files-in-this-directory"</span>,</span><br><span class="line">      <span class="string">"!**/exclude-files-with-this-name.*"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"helpers"</span>: [<span class="string">"**/helpers/**/*"</span>],</span><br><span class="line">    <span class="attr">"sources"</span>: [<span class="string">"src/**/*"</span>],</span><br><span class="line">    <span class="attr">"match"</span>: [<span class="string">"*oo"</span>, <span class="string">"!foo"</span>],</span><br><span class="line">    <span class="attr">"cache"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"concurrency"</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">"failFast"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"failWithoutAssertions"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"environmentVariables"</span>: &#123;</span><br><span class="line">      <span class="attr">"MY_ENVIRONMENT_VARIABLE"</span>: <span class="string">"some value"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"tap"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"verbose"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"compileEnhancements"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"require"</span>: [<span class="string">"@babel/register"</span>],</span><br><span class="line">    <span class="attr">"babel"</span>: &#123;</span><br><span class="line">      <span class="attr">"extensions"</span>: [<span class="string">"js"</span>, <span class="string">"jsx"</span>],</span><br><span class="line">      <span class="attr">"testOptions"</span>: &#123;</span><br><span class="line">        <span class="attr">"babelrc"</span>: <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>files</code>：用于选择测试文件的 glob 模式数组。带有下划线前缀的文件将被忽略。默认情况下，仅选择具有<code>js</code>扩展名的文件，即使该模式与其他文件匹配。指定<code>extensions</code>并<code>babel.extensions</code>允许其他文件扩展名</li>
<li><code>helpers</code>：用于选择帮助文件的 glob 模式数组。这里匹配的文件永远不会被视为测试。默认情况下，仅选择具有<code>js</code>扩展名的文件，即使该模式与其他文件匹配。指定<code>extensions</code>并<code>babel.extensions</code>允许其他文件扩展名</li>
<li><code>sources</code>：一组 glob 模式，用于匹配文件，这些文件在更改时会导致重新运行测试（在监视模式下）。有关详细信息，<a href="https://github.com/avajs/ava/blob/master/docs/recipes/watch-mode.md#source-files-and-test-files" target="_blank" rel="noopener">请参阅</a></li>
<li><code>match</code>：通常在<code>package.json</code>配置中没用，但等同于在 CLI 上指定<code>--match</code></li>
<li><code>cache</code>：缓存编译的测试和帮助文件<code>node_modules/.cache/ava</code>。如果<code>false</code>，文件缓存在临时目录中</li>
<li><code>failFast</code>：一旦测试失败，停止运行进一步的测试</li>
<li><code>failWithoutAssertions</code>：如果设置成<code>false</code>，那么如果没有运行断言，则测试失败</li>
<li><code>environmentVariables</code>：指定要供测试使用的环境变量。此处定义的环境变量会覆盖其中的环境变量<code>process.env</code></li>
<li><code>tap</code>：设置成 <code>true</code>，启用 TAP 报告</li>
<li><code>verbose</code>：设置成 <code>true</code>，启用详细输出</li>
<li><code>snapshotDir</code>：指定用于存储快照文件的固定位置。如果快照最终位于错误的位置，请使用此选项</li>
<li><code>compileEnhancements</code>：设置成 <code>false</code>，禁用了 <a href="https://github.com/avajs/ava/blob/master/docs/03-assertions.md#enhanced-assertion-messages" target="_blank" rel="noopener"><code>power-assert</code></a>，否则有助于提供更具描述性的错误消息， 并检测<code>t.throws()</code>断言的不当使用</li>
<li><code>extensions</code>：未使用 AVA 的 Babel 预设进行预编译的测试文件的扩展名。请注意，文件仍然会被编译为启用<code>power-assert</code>和其他功能，因此您可能还需要设置<code>compileEnhancements</code>为<code>false</code>文件是否为有效的 JavaScript。设置此<code>&quot;js&quot;</code>值会覆盖默认值，因此请确保在列表中包含该扩展名，只要它不包含在内<code>babel.extensions</code></li>
<li><code>require</code>：在运行测试之前需要额外的模块。工作进程中需要模块</li>
<li><code>babel</code>：测试文件特定的 Babel 选项。有关详细信息，请参阅<a href="https://github.com/avajs/ava/blob/master/docs/recipes/babel.md#configuring-babel" target="_blank" rel="noopener">Babel 配置</a></li>
<li><code>babel.extensions</code>：将使用 AVA 的 Babel 预设进行预编译的测试文件的扩展。设置此选项会覆盖默认<code>&quot;js&quot;</code>值，因此请确保在列表中包含该扩展名。</li>
<li><code>timeout</code>：AVA 中的超时行为与其他测试框架中的行为不同。AVA 在每次测试后重置计时器，如果在指定的超时内没有收到新的测试结果，则强制测试退出。这可用于处理停滞的测试。请参阅我们的<a href="https://github.com/avajs/ava/blob/master/docs/07-test-timeouts.md" target="_blank" rel="noopener">超时文档</a>以获取更多选</li>
</ul>
<p>请注意，在 CLI 上提供文件会覆盖该<code>files</code>选项。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://zhuanlan.zhihu.com/p/47009664" target="_blank" rel="noopener">使用 Jest 测试 JavaScript(Mock 篇)</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://supertinypeanut.github.io/blog/2021/01/25/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" data-id="ckmm8vad1002q85qsapqx5nxy" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96/" rel="tag">前端工程化</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/blog/2021/03/03/ES6%E9%9D%A2%E8%AF%95%E9%A2%98/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          ES6面试题
        
      </div>
    </a>
  
  
    <a href="/blog/2020/12/27/async-validator%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">async-validator基本使用</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/ECMAScript-6/" rel="tag">ECMAScript 6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Git/" rel="tag">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Lint/" rel="tag">Lint</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/React/" rel="tag">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/TypeScript/" rel="tag">TypeScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Vue/" rel="tag">Vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Webpack/" rel="tag">Webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/npm/" rel="tag">npm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/web-%E5%AE%89%E5%85%A8/" rel="tag">web 安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96/" rel="tag">前端工程化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/" rel="tag">问题解决</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/ECMAScript-6/" style="font-size: 12.5px;">ECMAScript 6</a> <a href="/blog/tags/Git/" style="font-size: 15px;">Git</a> <a href="/blog/tags/JavaScript/" style="font-size: 20px;">JavaScript</a> <a href="/blog/tags/Lint/" style="font-size: 10px;">Lint</a> <a href="/blog/tags/React/" style="font-size: 12.5px;">React</a> <a href="/blog/tags/TypeScript/" style="font-size: 12.5px;">TypeScript</a> <a href="/blog/tags/Vue/" style="font-size: 17.5px;">Vue</a> <a href="/blog/tags/Webpack/" style="font-size: 10px;">Webpack</a> <a href="/blog/tags/npm/" style="font-size: 10px;">npm</a> <a href="/blog/tags/web-%E5%AE%89%E5%85%A8/" style="font-size: 15px;">web 安全</a> <a href="/blog/tags/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96/" style="font-size: 12.5px;">前端工程化</a> <a href="/blog/tags/%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/" style="font-size: 15px;">问题解决</a> <a href="/blog/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 12.5px;">面试</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/01/">一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/12/">十二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/04/">四月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/11/">十一月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2021/03/23/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E4%B8%8E%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2/">持续集成与持续部署</a>
          </li>
        
          <li>
            <a href="/blog/2021/03/07/Promise%E5%AE%9E%E7%8E%B0/">Promise实现</a>
          </li>
        
          <li>
            <a href="/blog/2021/03/03/ES6%E9%9D%A2%E8%AF%95%E9%A2%98/">ES6面试题</a>
          </li>
        
          <li>
            <a href="/blog/2021/01/25/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/">自动化测试</a>
          </li>
        
          <li>
            <a href="/blog/2020/12/27/async-validator%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/">async-validator基本使用</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Super Peanut<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">

  
<script src="/blog/fancybox/jquery.fancybox.pack.js"></script>




<script src="/blog/js/script.js"></script>




  </div>
</body>
</html>