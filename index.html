<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Peanut</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Peanut">
<meta property="og:url" content="https://supertinypeanut.github.io/blog/index.html">
<meta property="og:site_name" content="Peanut">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Super Peanut">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/blog/atom.xml" title="Peanut" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/blog/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">Peanut</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://supertinypeanut.github.io/blog"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-持续集成与持续部署" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2021/03/23/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E4%B8%8E%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2/" class="article-date">
  <time datetime="2021-03-23T22:11:00.000Z" itemprop="datePublished">2021-03-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2021/03/23/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E4%B8%8E%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2/">持续集成与持续部署</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="为什么需要CI-CD"><a href="#为什么需要CI-CD" class="headerlink" title="为什么需要CI/CD"></a>为什么需要CI/CD</h2><p><strong>传统的开发过程中的坑：</strong></p>
<ul>
<li>BUG总是在最后才发现</li>
<li>越到项目后期，加班越严重</li>
<li>交付无法保障</li>
<li>变更频繁导致效率低下</li>
<li>无效的等待多，用户满足度低</li>
</ul>
<p><img src="/blog/.io//1460000014924499.png" alt="img"></p>
<p><strong>持续集成解决了什么问题？</strong></p>
<ul>
<li>提高软件质量</li>
<li>效率迭代</li>
<li>便捷部署</li>
<li>快速交付、便于管理</li>
</ul>
<h2 id="持续集成"><a href="#持续集成" class="headerlink" title="持续集成"></a>持续集成</h2><h3 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h3><p><strong>集成，就是一些孤立的事物或元素通过某种方式集中在一起，产生联系，从而构成一个有机整体的过程</strong>。知识经济的社会，集成已经成了很重要的一个名词。各行各业基本都会用到集成。比如汽车行业，那么复杂的一台跑车愣是通过一大堆零件组装起来。对于这些传统行业，它们在研发成功以后，可以通过流水线的方法批量生产进行集成。而在软件行业中，集成并不是一个简单的“搬箱子”的过程。因为软件工业是一个知识生产活动，其内在逻辑非常复杂，需求又很难一次性确定，完成的产品与最初的设计往往相差很远。敏捷宣言中就有一条是说响应变化重于遵循计划。而且由于软件行业的迅猛发展，软件变的越来越复杂，单靠个人是根本无法完成。大型软件为了重用及解耦，往往还需要分成好几个模块，这样集成就成了软件开发中不可或缺的一部分。</p>
<p>持续，不言而喻，就是指<strong>长期的对项目代码进行集成。</strong></p>
<h4 id="持续集成-1"><a href="#持续集成-1" class="headerlink" title="持续集成"></a>持续集成</h4><p>持续集成（英文：Continuous Integration，简称CI）</p>
<p>在软件工程中，持续集成是指将所有开发者工作副本每天多次合并到主干的做法。 </p>
<blockquote>
<p>Grady Booch 在1991年的 Booch method 中首次命名并提出了 CI 的概念，尽管在当时他并不主张每天多次集成。而 XP（Extreme programming，极限编程）采用了 CI 的概念，并提倡每天不止一次集成。</p>
<p>在《持续集成》一书中，对持续集成的定义如下：<code>持续集成</code>是一种软件开发实践。在持续集成中，团队成员频繁集成他们的工作成果，一般每人每天至少集成一次,也可以多次。每次集成会经过自动构建(包括自动测试)的检验，以尽快发现集成错误。自从在团队中引入这样的实践之后，<code>Martin Fowler</code>发现这种方法可以显著减少集成引起的问题，并可以加快团队合作软件开发的速度。</p>
</blockquote>
<p><img src="/blog/.io//c5c8e6f40c7c133e22402c00bb7e1a25_hd-6510245.jpg" alt="img"></p>
<p>持续集成强调开发人员提交了新代码之后，立刻进行构建、（单元）测试。根据测试结果，我们可以确定新代码和原有代码能否正确地集成在一起。</p>
<p>对于一天需要集成多少次数，并没有一个明确的定义。一般就是按照自己项目的实际需要来设置一定的频率，少则可能几次，多则可能达几十次。可以设置按照代码的变更来触发集成，或者设置一个固定时间周期来集成，也可以手工点击集成的按钮来“一键集成”。</p>
<h4 id="持续交付"><a href="#持续交付" class="headerlink" title="持续交付"></a>持续交付</h4><p>持续交付（英文：Continuous Delivery，简称CD）</p>
<p>完成 CI 中构建及单元测试和集成测试的自动化流程后，持续交付可自动将已验证的代码发布到存储库。为了实现高效的持续交付流程，务必要确保 CI 已内置于开发管道。持续交付的目标是拥有一个可随时部署到生产环境的代码库。</p>
<p><img src="/blog/.io//db7198e3c39e4656e18efcb4bd1b20b1_hd-6510245.jpg" alt="img"></p>
<p>在持续交付中，每个阶段（从代码更改的合并，到生产就绪型构建版本的交付）都涉及测试自动化和代码发布自动化。在流程结束时，运维团队可以快速、轻松地将应用部署到生产环境中。</p>
<p>比如，我们完成单元测试后，可以把代码部署到连接数据库的 Staging 环境中更多的测试。如果代码没有问题，可以继续<code>手动</code>部署到生产环境中。</p>
<h4 id="持续部署"><a href="#持续部署" class="headerlink" title="持续部署"></a>持续部署</h4><p>持续部署（英文：Continuous Deployment，简称CD）</p>
<p>对于一个成熟的 CI/CD 管道来说，最后的阶段是持续部署。作为持续交付——自动将生产就绪型构建版本发布到代码存储库——的延伸，持续部署可以自动将应用发布到生产环境。由于在生产之前的管道阶段没有手动门控，因此持续部署在很大程度上都得依赖精心设计的测试自动化。</p>
<p><img src="/blog/.io//f96f19e4d567aad5006d841963a86e41_hd-6510245.jpg" alt="img"></p>
<p>实际上，持续部署意味着开发人员对应用的更改在编写后的几分钟内就能生效（假设它通过了自动化测试）。这更加便于持续接收和整合用户反馈。总而言之，所有这些 CI/CD 的关联步骤都有助于降低应用的部署风险，因此更便于以小件的方式（而非一次性）发布对应用的更改。不过，由于还需要编写自动化测试以适应 CI/CD 管道中的各种测试和发布阶段，因此前期投资还是会很大。</p>
<p>持续部署则是在持续交付的基础上，把部署到生产环境的过程<code>自动化</code>。</p>
<h3 id="持续集成组成要素"><a href="#持续集成组成要素" class="headerlink" title="持续集成组成要素"></a>持续集成组成要素</h3><p><strong>一个最小化的持续集成系统需要包含以下几个要素：</strong></p>
<ol>
<li><strong>版本管理系统：</strong>项目的源代码需要托管到适合的版本管理系统中，一般我们使用git作为版本控制库，版本管理软件可以使用github、<code>gitlab</code>、stash等。</li>
<li><strong>构建脚本&amp;工具：</strong>每个项目都需要有构建脚本来实现对整个项目的自动化构建。比如Java的项目就可以使用gradle作为构建工具。通过构建工具实现对编译、静态扫描、运行测试、样式检查、打包、发布等活动串起来，可以通过命令行自动执行。</li>
<li><strong>CI服务器：</strong>CI服务器可以检测项目中的代码变动，并及时的通过构建机器运行构建脚本，并将集成结果通过某种方式反馈给团队成员。</li>
</ol>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><ul>
<li><p>打包平台</p>
<p>常见的打包，Java应用（Gradle/Maven）、Nodejs前端应用(npm/yarn)</p>
<p>移动端打包：Android/iOS</p>
</li>
<li><p>测试平台</p>
<p>接口测试</p>
<p>自动化测试Robotium、Testlink</p>
<p>单元测试junit</p>
<p>性能测试Jmeter</p>
</li>
<li><p>自动部署</p>
<p>FTP</p>
<p>Shell</p>
<p>Tomcat/Dokcer</p>
<p>Kubernetes/Rancher/Cluster</p>
</li>
<li><p>持续集成</p>
<p>Git: gitlab github gitee等</p>
<p>Jenkins/TravisCi/CircleCI</p>
<p>Docker</p>
</li>
</ul>
<h3 id="工作流"><a href="#工作流" class="headerlink" title="工作流"></a>工作流</h3><h4 id="传统的工作流"><a href="#传统的工作流" class="headerlink" title="传统的工作流"></a>传统的工作流</h4><p>参与人员：开发、项目经理、测试</p>
<p>主要流程：</p>
<ul>
<li>项目一开始是先划分好模块，<code>分配模块</code>给相应的开发人员；</li>
<li>开发人员<code>开发好</code>一个模块就进行<code>单元测试</code>；</li>
<li>等所有的模块都开发完成之后，由项目经理对<code>所有代码进行集成</code>；</li>
<li>集成后的项目由项目经理<code>部署到测试服务器</code>上，被交由测试人员进行集成测试；</li>
<li>测试过程中出现 Bug 就提把问题<code>记录</code>进行 <code>Bug</code> 列表中；</li>
<li><code>项目经理分配 Bug</code> 给相应的责任人进行修改；</li>
<li>修改完成后，项目经理<code>再次</code>对项目进行集成，并<code>部署</code>到测试服务器上；</li>
<li>测试人员在下一次的集成测试中进行<code>回归测试</code>；</li>
<li>通过通过之后就<code>部署到生产环境</code>中；</li>
<li>如果测试不通过，则重复上述“分配 Bug -&gt; 修改 Bug -&gt; 集成代码 -&gt; 部署到测试服务器上 -&gt; 集成测试”工作。</li>
</ul>
<blockquote>
<p>这也是传统的瀑布式开发模型，请参考：<a href="https://www.cnblogs.com/-OYK/archive/2012/10/08/2714669.html" target="_blank" rel="noopener">软件开发模式对比(瀑布、迭代、螺旋、敏捷)</a></p>
</blockquote>
<p>带来的问题：</p>
<ol>
<li><p><strong>重复性劳动，无效的等待变多</strong></p>
<p>重复的进行发布部署。</p>
<p>流程上：有可能开发在等集成其他人的模块；测试人员在等待开发人员修复 Bug；产品经理在等待新版本上线好给客户做演示；项目经理在等待其他人提交代码。不管怎么样，等待意味低效。</p>
<p>自动化部署工作可以解放了集成、测试、部署等重复性劳动，而且机器集成的频率明显可以比手工的高很多。</p>
</li>
<li><p><strong>很晚才发现缺陷，并且难以修复</strong>。</p>
<p>实践证明，缺陷发现的越晚，需要修复的时间和精力也就越大。从上一个可工作的软件到发现缺陷之间可能存在很多次提交，而要从这些提交中找出问题并修复的成本会很大，因为开发人员需要回忆每个提交的上下文来评估影响点。</p>
</li>
<li><p><strong>低品质的软件，软件交付时机无法保障</strong></p>
<p>由于集成时每次包含的代码很多，所以大家的关注点主要都是如何保证编译通过、自动化测试通过，而往往很容易忽略代码是否遵守了编码规范、是否包含有重复代码、是否有重构的空间等问题。而这些问题又反过来会影响今后的开发和集成，久而久之集成变得越来越困难，软件的质量可想而知。</p>
</li>
<li><p><strong>项目缺少可见性</strong></p>
<p>某些项目，程序会经常需要变更，特别是敏捷开发的实践者。由于产品经理在与客户交流过程中，往往实际的软件就是最好的原型，所以软件会被当作原型作为跟客户交流的工具。当然，客户最希望的当然是客户的想法能够马上反映到原型上，这会导致程序会经常被修改的。那么也就意味着“分配 Bug -&gt; 修改 Bug -&gt; 集成代码 -&gt; 部署到测试服务器上 -&gt; 集成测试”工作无形又爆增了。</p>
</li>
</ol>
<h4 id="常见的工作流"><a href="#常见的工作流" class="headerlink" title="常见的工作流"></a>常见的工作流</h4><p><img src="/blog/.io//DevOps.png" alt="DevOps"></p>
<p>该系统的各个组成部分是按如下顺序来发挥作用的：</p>
<ol>
<li><p>开发者检入代码到源代码仓库。</p>
</li>
<li><p>CI系统会为每一个项目创建了一个单独的工作区。当预设或请求一次新的构建时，它将把源代码仓库的源码存放到对应的工作区。</p>
</li>
<li><p>CI系统会在对应的工作区内执行构建过程。</p>
</li>
<li><p>配置如果存在）构建完成后，CI系统会在一个新的构件中执行定义的一套测试。完成后触发通知(Email,RSS等等)给相关的当事人。</p>
</li>
<li><p>配置如果存在）如果构建成功，这个构件会被打包并转移到一个部署目标(如应用服务器)或存储为软件仓库中的一个新版本。软件仓库可以是CI系统的一部分，也可以是一个外部的仓库，诸如一个文件服务器或者像Java.net、SourceForge之类的网站。</p>
</li>
<li><p>CI系统通常会根据请求发起相应的操作，诸如即时构建、生成报告，或者检索一些构建好的构件。</p>
</li>
</ol>
<blockquote>
<p>“You build it, you run it”，这是 Amazon 一年可以完成 5000 万次部署，平均每个工程师每天部署超过 50 次的核心秘籍。</p>
</blockquote>
<h4 id="解决的问题"><a href="#解决的问题" class="headerlink" title="解决的问题"></a>解决的问题</h4><ul>
<li><p>高效率</p>
<p>高效率的发布，避免了重复性的劳动；</p>
<p>更快的修复BUG，更快的交付成果，减少了等待时间。</p>
</li>
<li><p>高质量</p>
<p>只有在完成集成测试、系统测试后，才能得到可用的软件，整个过程中只有最后时刻才能拿到可运行软件。集成活动不一定在一个标准的构建机器上生成，而是在某个开发人员的机器上构建的，那么可能存在在其他机器上无法运行的问题。</p>
<p>人与机器的一个最大的区别是，在重复性动作上，人容易犯错，而机器犯错的几率几乎为零。所以，当我们搭建完成集成服务器后，以后的事就交给集成服务器来打理吧。</p>
</li>
<li><p>高产出</p>
<p>快速开发和上市一个新产品，并快速取得预期的投资回报是每个企业孜孜以求的目标。</p>
<p>便捷的部署+项目的可预期，使得团队的开发变成了一种开心的事情。</p>
<p>持续集成可以让你在任何时间发布可以部署的软件。在外界看来，这是持续集成最明显的好处，对客户来说，可以部署的软件产品是最实际的资产。利用持续集成，你可以经常对源代码进行一些小改动，并将这些改动和其他代码进行集成。</p>
</li>
</ul>
<h4 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h4><ol>
<li><p>思维转变后，新技术抵触</p>
<ul>
<li>无法接受新事物：不管怎么样，求稳心态的人还是多。总是有人认为老的技术代表稳定，新的事物往往会带来问题。</li>
<li>认为手工集成也没有多少工作量：不是所有的人都参与到了整个持续集成的环节，所以没有办法认识到问题全貌。</li>
</ul>
<p><strong>针对这个问题，可以通过设置一定的持续集成技术培训、宣讲得到改观</strong></p>
</li>
<li><p>管理层的抵触</p>
<ul>
<li>培训持续集成需要投入资金啊，没钱。</li>
<li>持续集成服务器要增加软硬件成本啊，没钱。</li>
<li>开发人员领了那么高的工资，多干活多加班应该啊。</li>
</ul>
<p><strong>针对这一点，可以从开发人员的成本和持续集成的投入（软硬件）的成本上两者做下估算。</strong></p>
<blockquote>
<p>硬件参考：</p>
<p>Jenkins主服务器一般2C4G，slave服务器根据生产需要进行选购。</p>
<p>git服务器一般2C4G(10人团队)</p>
<p>Docker服务器8C32G(Rancher + harbor)</p>
</blockquote>
</li>
<li><p>生产环境的复杂</p>
<ul>
<li>比如部署的生成环境是在政务外网，无法从互联网直接访问等。</li>
<li>构建效率低下，任务多 </li>
</ul>
<p>目前，这个是最麻烦的，还在研究中。初步设想是让政务外网开辟一个白名单，给持续集成服务器设置一个单独的通道。只是思路，未验证。</p>
</li>
</ol>
<h4 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h4><p>实施持续集成的开发人员可以尽早并经常提交。这允许他们尽早发现冲突。并且，如果存在任何问题，则使用较小的提交可以更轻松地对代码进行故障排除。每天或甚至更频繁地提交软件对于持续集成是必要的，但还不够。</p>
<p>要成功使用持续集成，团队必须：</p>
<ul>
<li><p>使测试成为开发过程中不可或缺的一部分。应该在创建代码时编写测试。</p>
<p>公司成功持续整合所需的最重要因素是严格的测试文化。为了将新代码自信地集成到主线中，团队需要确信代码是健全的。这是通过测试来实现的，这应该定期进行。工程师应该在开发每个功能时编写测试。</p>
</li>
<li><p>确保测试环境反映生产一致。</p>
<p>为了支持您严格的测试文化，测试环境必须反映生产环境。否则，您无法保证您正在测试的内容将在生产中起作用。这意味着测试环境应使用相同版本的数据库，Web服务器配置，工件等。</p>
</li>
<li><p>使用编码最佳实践，例如结对编程。</p>
<p>软件开发的另一个最佳实践是在编码期间进行配对。对于更复杂的功能，团队在编写单行代码之前讨论体系结构方法。在将任何代码合并到生产环境之前，其他开发人员始终会检查代码。这有助于确保使用编码最佳实践，代码不会与其他开发人员正在处理的现有代码或代码冲突，并且新功能是可扩展的。</p>
<blockquote>
<p><strong>Pair programming</strong> is an <a href="https://en.wikipedia.org/wiki/Agile_software_development" target="_blank" rel="noopener">agile software development</a> technique in which two <a href="https://en.wikipedia.org/wiki/Computer_programmer" target="_blank" rel="noopener">programmers</a> work together at one workstation. One, the <em>driver</em>, writes <a href="https://en.wikipedia.org/wiki/Source_code" target="_blank" rel="noopener">code</a> while the other, the <em>observer</em> or <em>navigator</em>,<a href="https://en.wikipedia.org/wiki/Pair_programming#cite_note-1" target="_blank" rel="noopener">[1]</a> <a href="https://en.wikipedia.org/wiki/Code_review" target="_blank" rel="noopener">reviews</a> each line of code as it is typed in. The two programmers switch roles frequently.</p>
<p>While reviewing, the observer also considers the “strategic” direction of the work, coming up with ideas for improvements and likely future problems to address. This is intended to free the driver to focus all of their attention on the “tactical” aspects of completing the current task, using the observer as a safety net and guide.</p>
</blockquote>
</li>
<li><p>自动化部署工作流程。</p>
<p>最后，为确保整个软件开发流程快速高效，构建需要快速，部署工作流程应自动化。代码构建的每一分钟都浪费了一分钟。通过自动化部署工作流程，团队可以更快地将完成的代码生成。因为，毕竟，如果没有接触到客户，那么快速开发软件有什么意义呢？</p>
</li>
</ul>
<h3 id="效率工具对比"><a href="#效率工具对比" class="headerlink" title="效率工具对比"></a>效率工具对比</h3><p><a href="#复杂的DevOps相关工具">点击查看</a>效率工具</p>
<p><strong>1. Jenkins</strong></p>
<blockquote>
<p>Jenkins，原名Hudson，2011年改为现在的名字，它 是一个开源的实现持续集成的软件工具。官方网站：<a href="http://jenkins-ci.org/" target="_blank" rel="noopener">http://jenkins-ci.org/</a>。</p>
<p>Jenkins 能实时<strong>监控集成中存在的错误</strong>，提供<strong>详细的日志文件和提醒</strong>功能，还能用图表的形式形象地展示<strong>项目构建的趋势和稳定性</strong>。</p>
</blockquote>
<p><strong>Jenkins特点:</strong></p>
<ul>
<li><strong>易安装</strong>：Jenkins是一个独立的基于Java的程序，随时可以运行，包含Windows，Mac OS X和其他类Unix操作系统的软件包。仅仅一个 java -jar jenkins.war，从官网下载该文件后，直接运行，无需额外的安装，更无需安装数据库；</li>
<li><strong>易配置</strong>：提供友好的GUI配置界面；</li>
<li><strong>变更支持</strong>：Jenkins能从代码仓库（Subversion/CVS）中获取并产生代码更新列表并输出到编译输出信息中；</li>
<li><strong>支持永久链接</strong>：用户是通过web来访问Jenkins的，而这些web页面的链接地址都是永久链接地址，因此，你可以在各种文档中直接使用该链接；</li>
<li><strong>集成E-Mail/RSS/IM：</strong>当完成一次集成时，可通过这些工具实时告诉你集成结果（据我所知，构建一次集成需要花费一定时间，有了这个功能，你就可以在等待结果过程中，干别的事情）；</li>
<li><strong>JUnit/TestNG测试报告</strong>：也就是用以图表等形式提供详细的测试报表功能；</li>
<li><strong>支持分布式构建</strong>：Jenkins可以把<strong>集成构建等工作分发到多台计算机中完成</strong>；</li>
<li><strong>文件指纹信息</strong>：Jenkins会保存哪次集成构建产生了哪些jars文件，哪一次集成构建使用了哪个版本的jars文件等构建记录；</li>
<li><strong>支持第三方插件</strong>：使得 Jenkins 变得越来越强大；凭借更新中心中的数百个插件，Jenkins几乎集成了持续集成和持续交付工具链中的所有工具。</li>
<li><strong>Rest API</strong> - 可以访问控制您获取的数据量，获取/更新config.xml，删除作业，检索所有构建，获取/更新作业说明，执行构建，禁用/启用作业</li>
</ul>
<p><strong>Jenkins优点：</strong></p>
<ul>
<li>价格（免费）</li>
<li>定制</li>
<li>插件系统</li>
<li>完全控制系统</li>
</ul>
<p><strong>Jenkins缺点：</strong></p>
<ul>
<li>需要专用服务器（或多个服务器）。这导致额外的费用。对于服务器本身，DevOps等…</li>
<li>配置/定制所需的时间</li>
</ul>
<p><strong>2. Travis CI</strong></p>
<p><strong>Travis CI</strong>是一个托管的持续集成服务，用于构建和测试在GitHub上托管的软件项目。</p>
<blockquote>
<p><strong>Travis CI</strong> is a hosted continuous integration service used to build and test software projects hosted at GitHub</p>
</blockquote>
<p><strong>Travis CI的特点：</strong></p>
<ul>
<li><p>基于云：TravisCI是一个<strong>基于云</strong>的系统 - 不需要专用服务器，您无需管理它。</p>
</li>
<li><p>支持Docker运行测试</p>
</li>
<li><p>使用YAML文件进行配置</p>
</li>
<li><p>可选择Linux和Mac OSX上同时运行测试</p>
</li>
<li><p>开箱即用的支持的语言</p>
<p>Android，C，C＃，C ++，Clojure，Crystal，D，Dart，Erlang，Elixir，F＃，Go，Groovy，Haskell，Haxe，Java，JavaScript（使用Node.js），Julia，Objective-C，Perl，Perl6， PHP，Python，R，Ruby，Rust，Scala，Smalltalk，Visual Basic</p>
</li>
<li><p><strong>支持多环境构建矩阵</strong>：如Python 2.7 , 3.4, 3.5 +  Django 1.8, 1.9, 1.10</p>
<p>构建矩阵是一种工具，可以使用不同版本的语言和包运行测试。您可以以不同的方式自定义它。例如，某些环境的失败可以触发通知但不会使所有构建失败（这对包的开发版本有帮助）</p>
</li>
</ul>
<p><strong>Travis CI优点：</strong></p>
<ul>
<li>开箱即用构建矩阵</li>
<li>快速启动</li>
<li>轻量级YAML配置</li>
<li>开源项目的免费计划</li>
<li>无需专用服务器</li>
</ul>
<p><strong>Travis CI缺点：</strong></p>
<ul>
<li>与CircleCI相比，价格更高，没有免费的企业计划</li>
<li>定制（对于某些你需要第三方的东西）</li>
</ul>
<p><strong>3. Circle CI</strong></p>
<p>在GitHub或Bitbucket上的软件存储库被授权并作为项目添加到<a href="https://circleci.com/" target="_blank" rel="noopener">circleci.com之后</a>，每个代码更改都会在干净的容器或VM中触发自动化测试。</p>
<p>CircleCI在2017年被Forrester评为持续集成领导者，并被命名为多个最佳DevOps工具列表。CircleCI成立于2011年，总部位于旧金山，拥有全球性的远程员工队伍，由Scale Venture Partners，DFJ，Baseline Ventures，Top Tier Capital，Industry Ventures，Heavybit和Harrison Metal Capital提供风险投资。</p>
<p><strong>Circle CI的特点：</strong></p>
<ul>
<li><strong>云&amp;本地化</strong>：CircleCI是一个<strong>基于云</strong>的系统 - 不需要专用服务器，您无需管理它。 但是，它还<strong>提供了一个本地解决方案</strong>，允许您在私有云或数据中心中运行它。</li>
<li><strong>商业&amp;免费</strong>：即使是商业帐户，它也<strong>有免费计划</strong></li>
<li><strong>Rest API</strong> - 您可以访问项目，构建和工件（artifacts）。构建的结果将是工件或工件组。 工件可以是已编译的应用程序或可执行文件（例如，android APK）或元数据（例如，关于测试`成功的信息）</li>
<li><strong>按需安装</strong>：CircleCI 缓存<strong>必要的安装</strong>（requirements installation）。 它会检查第三方依赖项，而不是持续安装所需的环境</li>
<li><strong>SSH模式</strong>：您可以触发<strong>SSH模式</strong>访问容器并进行自己的调查（如果出现任何问题）</li>
<li><strong>最小化配置</strong>：这是一个完整的开箱即用解决方案，需要<strong>最少的配置\调整</strong></li>
</ul>
<p><strong>CircleCI优点：</strong></p>
<ul>
<li>快速启动</li>
<li>CircleCI有一个免费的企业项目计划</li>
<li>这很容易，也很快开始</li>
<li>轻量级，易读的YAML配置</li>
<li>您不需要任何专用服务器来运行CircleCI</li>
</ul>
<p><strong>CircleCI缺点：</strong></p>
<ul>
<li><p>CircleCI仅支持2个版本的Ubuntu免费（12.04和14.04）和MacOS作为付费部分</p>
</li>
<li><p>尽管CircleCI可以使用并运行所有语言，但tt仅支持“开箱即用”的以下编程语言：Go（Golang），Haskell，Java，PHP，Python，Ruby / Rails，Scala</p>
</li>
<li><p>如果您想进行自定义，可能会出现一些问题：您可能需要一些第三方软件来进行这些调整</p>
</li>
<li><p>此外，虽然作为基于云的系统是一方的优势，它也可以停止支持任何软件，你将无法阻止</p>
</li>
</ul>
<p>总结一下：</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>Jenkins</th>
<th>Travis CI</th>
<th>Circle CI</th>
</tr>
</thead>
<tbody><tr>
<td>本地部署</td>
<td>支持</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>REST API</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>配置</td>
<td>复杂，高度可配置</td>
<td>YAML文件</td>
<td>YAML文件</td>
</tr>
<tr>
<td>按需安装</td>
<td>是</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>跨平台支持</td>
<td>是</td>
<td>Linux + MacOS</td>
<td>Linux + MacOS(付费)</td>
</tr>
<tr>
<td>多服务器</td>
<td>是</td>
<td>按需</td>
<td>否</td>
</tr>
<tr>
<td>快速构建</td>
<td>手动配置复杂</td>
<td>快(需要写配置文件)</td>
<td>最快</td>
</tr>
<tr>
<td>基本环境</td>
<td>Java</td>
<td>云环境</td>
<td>云环境</td>
</tr>
<tr>
<td>费用</td>
<td>免费</td>
<td>特定免费(69$/c)</td>
<td>特定免费(50$/c)</td>
</tr>
</tbody></table>
<p>Travis CI的价格（非常感人）：</p>
<p><img src="/blog/.io//image-20190611100501785.png" alt="image-20190611100501785"></p>
<p>CirCle CI的价格：</p>
<p><img src="/blog/.io//image-20190611100534676.png" alt="image-20190611100534676"></p>
<p>其他的一些持续集成的工具：CruiseControl，TeamCity，Continuum等</p>
<ul>
<li>AnthillPro：商业的构建管理服务器，提供C功能</li>
<li>Bamboo：商业的CI服务器，对于开源项目免费</li>
<li>Build Forge：多功能商业构建管理工具，特点：高性能、分布式构建</li>
<li>Cruise Control：基于java实现的持续集成构建工具</li>
<li>CruiseControl.NET：基于C#实现的持续集成构建工具</li>
<li>Lunt build：开源的自动化构建工具</li>
<li>Para Build：商业的自动化软件构建管理服务器</li>
</ul>
<h2 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h2><h3 id="使用简介"><a href="#使用简介" class="headerlink" title="使用简介"></a>使用简介</h3><p>Jenkins是开源CI&amp;CD软件领导者， 提供超过1000个插件来支持构建、部署、自动化， 满足任何项目的需要。</p>
<p><img src="/blog/.io//image-20190611103941326.png" alt="image-20190611103941326"></p>
<p>相关概念：</p>
<ul>
<li><p>流水线：<strong>Jenkins Pipeline</strong>（或简称为 “Pipeline”）是一套插件，将持续交付的实现和实施集成到 Jenkins 中。</p>
<p>Jenkins Pipeline 提供了一套可扩展的工具，用于将“简单到复杂”的交付流程实现为“持续交付即代码”。Jenkins Pipeline 的定义通常被写入到一个文本文件（称为 <code>Jenkinsfile</code> ）中，该文件可以被放入项目的源代码控制库中。</p>
</li>
<li><p>节点：节点是一个机器，主要用于执行jenkins任务</p>
</li>
<li><p>阶段：定义不同的执行任务，比如：构建、测试、发布(部署)</p>
</li>
<li><p>步骤：相当于告诉Jenkins现在要做些什么，比如shell命令。</p>
</li>
</ul>
<p><img src="/blog/.io//image-20190611163108298.png" alt="image-20190611163108298"></p>
<p>Jenkins的界面</p>
<p><img src="/blog/.io//image-20190611163727975.png" alt="image-20190611163727975"></p>
<p>任务详情页面</p>
<p><img src="/blog/.io//image-20190611163855257.png" alt="image-20190611163855257"></p>
<p>Jenkins任务日志</p>
<h3 id="安装方式"><a href="#安装方式" class="headerlink" title="安装方式"></a>安装方式</h3><ol>
<li><p>环境要求</p>
<ul>
<li>机器要求：<ul>
<li>256 MB 内存，建议大于 512 MB</li>
<li>10 GB 的硬盘空间（用于 Jenkins 和 Docker 镜像）</li>
</ul>
</li>
<li>需要安装以下软件：<ul>
<li>Java 8 ( JRE 或者 JDK 都可以)</li>
<li><a href="https://www.docker.com/" target="_blank" rel="noopener">Docker</a> （导航到网站顶部的Get Docker链接以访问适合您平台的Docker下载）</li>
</ul>
</li>
</ul>
</li>
<li><p>常规安装</p>
<ul>
<li><p>安装JDK</p>
<p><a href="https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="noopener">官方地址</a></p>
<p>下载对应的操作系统的JDK，然后解压进行安装。以Linux为例：</p>
<p>下载最新版本，上传到Linux服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 上传到 /opt/jdk8目录下</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># tar解压JDK安装包</span></span><br><span class="line">mkdir -p /opt/jdk8</span><br><span class="line">tar zxvf jdk-8u211-linux-x64.tar.gz -C /opt/jdk8 --strip-components 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># vi /etc/profile</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/opt/jdk8</span><br><span class="line"><span class="built_in">export</span> JRE_HOME=<span class="variable">$&#123;JAVA_HOME&#125;</span>/jre</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$&#123;JAVA_HOME&#125;</span>/lib:<span class="variable">$&#123;JRE_HOME&#125;</span>/lib</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$&#123;JAVA_HOME&#125;</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Jenkins</p>
<p>下载Jenkins最新的war包：<a href="http://mirrors.jenkins.io/war-stable/latest/jenkins.war" target="_blank" rel="noopener">Latest</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/jenkins &amp;&amp; <span class="built_in">cd</span> /opt/jenkins</span><br><span class="line"></span><br><span class="line">wget -O /opt/jenkins/jenkins.war http://mirrors.jenkins.io/war-stable/latest/jenkins.war</span><br><span class="line"></span><br><span class="line">java -jar jenkins.war --httpPort=8080</span><br></pre></td></tr></table></figure>

<p>就嗯可以打开，<a href="http://localhost:8080了">http://localhost:8080了</a></p>
<p>注意一段这样的话：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">*************************************************************</span><br><span class="line">*************************************************************</span><br><span class="line">*************************************************************</span><br><span class="line"></span><br><span class="line">Jenkins initial setup is required. An admin user has been created and a password generated.</span><br><span class="line">Please use the following password to proceed to installation:</span><br><span class="line"></span><br><span class="line">63196690ae7d47c49506480ee0e1af4a</span><br><span class="line"></span><br><span class="line">This may also be found at: /root/.jenkins/secrets/initialAdminPassword</span><br><span class="line"></span><br><span class="line">*************************************************************</span><br><span class="line">*************************************************************</span><br><span class="line">*************************************************************</span><br></pre></td></tr></table></figure>

<p>这里的<code>63196690ae7d47c49506480ee0e1af4a</code>就是初始的安装的管理员密码。</p>
</li>
</ul>
</li>
<li><p>使用Docker安装</p>
<ul>
<li><p>安装Docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># From https://get.docker.com:</span></span><br><span class="line">curl -fsSL https://get.docker.com -o get-docker.sh</span><br><span class="line">sh get-docker.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#From https://test.docker.com:</span></span><br><span class="line">curl -fsSL https://test.docker.com -o <span class="built_in">test</span>-docker.sh</span><br><span class="line">sh <span class="built_in">test</span>-docker.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># From the source repo (This will install latest from the test channel):</span></span><br><span class="line">sh install.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置Docker镜像加速，使用阿里云<a href="https://cr.console.aliyun.com/?spm=a2c4e.11153940.blogcont29941.9.52027e29w2jv9P" target="_blank" rel="noopener">容器加速服务</a></p>
<p>左侧的加速器帮助页面就会显示为你独立分配的加速地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">例如：</span><br><span class="line">公网Mirror：[系统分配前缀].mirror.aliyuncs.com</span><br></pre></td></tr></table></figure>

<p>使用配置文件 <code>/etc/docker/daemon.json</code>（没有时新建该文件）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"registry-mirrors"</span>: [<span class="string">"&lt;your accelerate address&gt;"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启Docker Daemon就可以了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<p><code>docker ps</code> 查看容器运行状态</p>
<p><code>docker logs 容器ID/容器名称</code> 查看管理员初始密码</p>
</li>
<li><p>安装Docker-compose.yml文件(可选)</p>
<p><strong>安装方法：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载</span></span><br><span class="line">sudo curl -L https://github.com/docker/compose/releases/download/1.20.0/docker-compose-`uname -s`-`uname -m` -o /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line"><span class="comment">#安装</span></span><br><span class="line">chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line"><span class="comment">#查看版本</span></span><br><span class="line">docker-compose --version</span><br></pre></td></tr></table></figure>



</li>
</ul>
</li>
</ol>
<ul>
<li><p>安装Jenkins</p>
<p><strong>版本选择：</strong></p>
<p>Jenkins: <a href="https://hub.docker.com/r/jenkins/jenkins/" target="_blank" rel="noopener">https://hub.docker.com/r/jenkins/jenkins/</a></p>
<p>Jenkins with Blue Ocean: <a href="https://hub.docker.com/r/jenkinsci/blueocean" target="_blank" rel="noopener">https://hub.docker.com/r/jenkinsci/blueocean</a></p>
<blockquote>
<p>Blue Ocean 重新思考Jenkins的用户体验，从头开始设计<a href="https://jenkins.io/zh/doc/book/pipeline/" target="_blank" rel="noopener">Jenkins Pipeline</a>, 但仍然与自由式作业兼容，Blue Ocean减少了混乱而且进一步明确了团队中每个成员 Blue Ocean 的主要特性包括：</p>
<ul>
<li>持续交付(CD)Pipeline的 <strong>复杂可视化</strong> ，可以让您快速直观地理解管道状态。</li>
<li><strong>Pipeline 编辑器</strong> - 引导用户通过直观的、可视化的过程来创建Pipeline，从而使Pipeline的创建变得平易近人。</li>
<li><strong>个性化</strong> 以适应团队中每个成员不同角色的需求。</li>
<li>在需要干预和/或出现问题时 <strong>精确定位</strong> 。 Blue Ocean 展示 Pipeline中需要关注的地方， 简化异常处理，提高生产力</li>
<li><strong>本地集成分支和合并请求</strong>, 在与GitHub 和 Bitbucket中的其他人协作编码时实现最大程度的开发人员生产力。****</li>
</ul>
</blockquote>
<p><strong>安装命令：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Jenkins</span></span><br><span class="line">docker run \</span><br><span class="line">  -itd \</span><br><span class="line">  -u root \</span><br><span class="line">  -p 8080:8080 \</span><br><span class="line">  -v jenkins-data:/var/jenkins_home \</span><br><span class="line">  -v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">  -v /usr/bin/docker:/usr/bin/docker \</span><br><span class="line">  --name jenkins-master \</span><br><span class="line">  jenkins/jenkins</span><br><span class="line">  </span><br><span class="line"><span class="comment"># Jenkins blueocean</span></span><br><span class="line">docker run \</span><br><span class="line">  -itd \</span><br><span class="line">  -u root \</span><br><span class="line">  -p 8080:8080 \</span><br><span class="line">  -v jenkins-data:/var/jenkins_home \ </span><br><span class="line">  -v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">  -v /usr/bin/docker:/usr/bin/docker \</span><br><span class="line">  --name jenkins-master \</span><br><span class="line">  jenkinsci/blueocean</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ol start="4">
<li><p>配置Jenkins插件加速</p>
<p>进入jenkins系统管理-&gt;插件管理中-&gt;高级选项卡-&gt;升级站点，使用清华源：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/current/update-center.json</span><br></pre></td></tr></table></figure>

<p><img src="/blog/.io//70.png" alt="ç³»ç»ç®¡ç"></p>
<p><img src="/blog/.io//70-20190611152837311.png" alt="æä»¶ç®¡ç"></p>
<p>关于官方所有的镜像列表：</p>
<p><a href="http://mirrors.jenkins-ci.org/status.html" target="_blank" rel="noopener">http://mirrors.jenkins-ci.org/status.html</a></p>
</li>
<li><p>环境配置</p>
<ul>
<li>Jenkins 的URL路径</li>
<li>全局工具的配置：Docker, JDK(JAVA)…</li>
</ul>
</li>
<li><p>用户权限配置</p>
<ul>
<li>矩阵权限的配置</li>
<li>添加管理员用户所有的权限</li>
<li>添加<a href="https://wiki.jenkins-ci.org/display/JENKINS/Authorize+Project+plugin" target="_blank" rel="noopener">Authorize Project</a>插件，并且在系统管理中进行配置。配置逻辑，就给用户当前项目的矩阵权限！</li>
</ul>
</li>
<li><p>与gitlab进行联接</p>
<ul>
<li>设置一个SSH Key，方便Jenkins去拉取Gitlab中的项目</li>
<li>GItlab项目中去配置SSH Key的Deploy权限。<code>Settings -&gt; Repository -&gt; Deploy keys -&gt; Public Deploy Keys</code></li>
<li>Jenkins添加SSH的私钥</li>
</ul>
<p>这样就完成了Jenkins可以访问gitlab的联接的过程。</p>
<p>Jenkins层面，需要去安装Gitlab相关插件。</p>
</li>
</ol>
<h3 id="插件介绍"><a href="#插件介绍" class="headerlink" title="插件介绍"></a>插件介绍</h3><ul>
<li><p>Publish over SSH</p>
<p>这个是一个远程Shell工具，可以远程去执行一些shell命令</p>
</li>
<li><p>HTTP Request Plugin</p>
<p>跨平台调用，在构建前后可以通过该插件以http形式调用各种api接口实现和内部系统的联动</p>
</li>
<li><p>Publish Over FTP</p>
<p>用于远程使用FTP发布，比较合适于静态资源的发布。</p>
<p><img src="/blog/.io//20181225153134962.jpeg" alt="img"></p>
</li>
<li><p>Performance Plugin</p>
</li>
</ul>
<p>​        该插件可以读取和解析测试框架输出的报告，并且在 Jenkins 上绘制性能和稳定性相关的图表。Performance Plugin 支持的测试框架有 JUnit、JMeter, Twitter 的 Lago 和 Taurus。下图是该插件输出的示例图：</p>
<p><img src="/blog/.io//3dee2f58ccdf7cf25fa86074c5485184a9f.jpg" alt="img"></p>
<p>​        <a href="https://plugins.jenkins.io/performance" target="_blank" rel="noopener">https://plugins.jenkins.io/performance</a></p>
<ul>
<li>Gitlab Merge Request Builder Plugin</li>
</ul>
<p>​        Gitlab Merge Request Builder Plugin 可以方便的自动发起代码审查，它在创建 pull request 的时候，会自动带上关联任务的运行结果，以方便代码审查着确认改动的正确性。</p>
<p>​        同时，这款插件还支持自动合并，既在代码审查通过后自动合并该 pull request 内容。</p>
<p>​        <a href="https://github.com/timols/jenkins-gitlab-merge-request-builder-plugin" target="_blank" rel="noopener">https://github.com/timols/jenkins-gitlab-merge-request-builder-plugin</a></p>
<ul>
<li>JIRA Plugin</li>
</ul>
<p>​        JIRA Plugin 可以让 Jenkins 任务和 JIRA 集成起来，这样项目管理者可以通过 JIRA 了解项目进度，开发者也可以通过该插件直接更改 JIRA 上的 issue 状态。</p>
<p>​        <a href="https://plugins.jenkins.io/jira" target="_blank" rel="noopener">https://plugins.jenkins.io/jira</a></p>
<ul>
<li>Kubernetes Plugin</li>
</ul>
<p>​        和最近大热的容器编排框架 Kubernetes 集成当然不能落下了。另外，Jenkins 对执行机的管理一直比较弱，无法做到快速的扩容和缩容。Kubernetes Plugin 通过引入 Kubernetes 的容器编排能力，让 Jenkins 执行机运行在 Kubernetes 环境中。</p>
<p>​        <a href="https://github.com/jenkinsci/kubernetes-plugin" target="_blank" rel="noopener">https://github.com/jenkinsci/kubernetes-plugin</a></p>
<ul>
<li>Build Pipeline plugin</li>
</ul>
<p>​        对一个系统的持续集成会包含很多个方面，如果将它们都杂糅在一个 Jenkins 任务中，会提高排查成本，也不利于整个持续集成的运作。Build Pipeline plugin 可以让项目管理员针对系统持续集成步骤设置一系列关联的任务，任务之间可以设置不同的触发条件，以确认何时需要人工介入。该插件可以让整个持续集成流程变得非常直观：</p>
<p><img src="/blog/.io//abf7ec185c847b72cd61181562f940557a2.jpg" alt="img"></p>
<p>​        <a href="https://github.com/jenkinsci/build-pipeline-plugin" target="_blank" rel="noopener">https://github.com/jenkinsci/build-pipeline-plugin</a></p>
<h3 id="配置自动化任务"><a href="#配置自动化任务" class="headerlink" title="配置自动化任务"></a>配置自动化任务</h3><p>两种执行方法：</p>
<ol>
<li>配置自由风格的项目</li>
<li>配置Pipeline使用Jenkinsfile</li>
</ol>
<p>需要注意的地方</p>
<ul>
<li><p>SSH插件：</p>
<p>SSH</p>
<p>SSH Agent</p>
<p>SSH Pipeline Steps</p>
<p>Publish Over SSH</p>
</li>
<li><p>git相关插件：</p>
<p>Gitlab</p>
<p>Github</p>
</li>
<li><p>管理员界面配置：</p>
<p><code>Settings -&gt; network -&gt; Outbound requests</code></p>
<p>Allow requests to the local network from hooks and services 进行勾选</p>
</li>
</ul>
<p>其他的一些用法：</p>
<ul>
<li>使用Jenkins配合Docker Hub，把前端代码打包成镜像，再远程部署</li>
<li>Jenkins配合自建Docker容器服务，把前端代码打包，使用Kubernetes进行发布。</li>
<li>使用Docker进行远程发布(远程服务器上有Docker服务，并且设置了远程连接)</li>
</ul>
<blockquote>
<p>把构建、打包的工作放在Docker容器里面，用于应对不同的开发环境需求(node8，node10等)</p>
</blockquote>
<h3 id="前端项目中的应用"><a href="#前端项目中的应用" class="headerlink" title="前端项目中的应用"></a>前端项目中的应用</h3><p>插件推荐：</p>
<ul>
<li><p>nodejs插件</p>
<p>主要是用于不同版本的Node打包</p>
<p>特别需要注意的是，使用<code>jenkinsci/blueocean</code>镜像的同学，需要重新运行新的容器，以便nodejs插件生效。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">  -itd \</span><br><span class="line">  -u root \</span><br><span class="line">  -p 8080:8080 \</span><br><span class="line">  -v /var/jenkins_home:/var/jenkins_home \</span><br><span class="line">  -v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">  -v /usr/bin/docker:/usr/bin/docker \</span><br><span class="line">  --name jenkins-master \</span><br><span class="line">  jenkins/jenkins</span><br></pre></td></tr></table></figure>

<p>注意：<code>docker stop 容器名称</code> 去停止之前的容器！</p>
</li>
<li><p>Publish Over SSH</p>
<p>用于构建完成之后，推送到远程的web服务器</p>
</li>
</ul>
<p>Jenkins发布到Nginx Docker容器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># !bin/bash</span></span><br><span class="line">node -v</span><br><span class="line">cnpm install</span><br><span class="line">npm run build</span><br><span class="line">ls -la</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$(docker inspect -f '&#123;&#123;.State.Running&#125;&#125;' nginx)</span>"</span> = <span class="string">"true"</span> ]; <span class="keyword">then</span></span><br><span class="line">	docker stop nginx &amp;&amp; docker rm nginx;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">docker run -itd --name nginx -v `<span class="built_in">pwd</span>`/dist:/usr/share/nginx/html -p 20000:80 nginx</span><br></pre></td></tr></table></figure>



<p>Pipleline演示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="string">agent</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="string">docker</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="string">image</span> <span class="string">'node:10'</span></span><br><span class="line">      <span class="string">args</span> <span class="string">'-p 20000:8080'</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="string">&#125;</span></span><br><span class="line">  <span class="string">stages</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="string">stage('Build')</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="string">steps</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">sh</span> <span class="string">'yarn install'</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">    <span class="string">stage('Deploy')</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="string">steps</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">sh</span> <span class="string">'./scripts/deploy.sh'</span></span><br><span class="line">        <span class="string">input</span> <span class="string">'Finished using the web site? (Click "Proceed" to continue)'</span></span><br><span class="line">        <span class="string">sh</span> <span class="string">'./scripts/kill.sh'</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">  <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>deploy.sh</code>文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env sh</span></span><br><span class="line"><span class="built_in">set</span> -x</span><br><span class="line">npm run serve &amp;</span><br><span class="line">sleep 1</span><br><span class="line"><span class="built_in">echo</span> $! &gt; .pidfile</span><br><span class="line"><span class="built_in">set</span> +x</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'Now...'</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'Visit http://localhost:8080 to see your Node.js/Vue application in action.'</span></span><br></pre></td></tr></table></figure>

<p>set命令用法：</p>
<p>set指令能设置所使用shell的执行方式，可依照不同的需求来做设置<br>　<code>-a</code> 　标示已修改的变量，以供输出至环境变量。<br>　<code>-b</code> 　使被中止的后台程序立刻回报执行状态。<br>　<code>-C</code> 　转向所产生的文件无法覆盖已存在的文件。<br>　<code>-d</code> 　Shell预设会用杂凑表记忆使用过的指令，以加速指令的执行。使用-d参数可取消。<br>　<code>-e</code> 　若指令传回值不等于0，则立即退出shell。　　<br>　<code>-f</code>　 　取消使用通配符。<br>　<code>-h</code> 　自动记录函数的所在位置。<br>　<code>-H</code> Shell 　可利用”!”加&lt;指令编号&gt;的方式来执行history中记录的指令。<br>　<code>-k</code> 　指令所给的参数都会被视为此指令的环境变量。<br>　<code>-l</code> 　记录for循环的变量名称。<br>　<code>-m</code> 　使用监视模式。<br>　<code>-n</code> 　只读取指令，而不实际执行。<br>　<code>-p</code> 　启动优先顺序模式。<br>　<code>-P</code> 　启动-P参数后，执行指令时，会以实际的文件或目录来取代符号连接。<br>　<code>-t</code> 　执行完随后的指令，即退出shell。<br>　<code>-u</code> 　当执行时使用到未定义过的变量，则显示错误信息。<br>　<code>-v</code> 　显示shell所读取的输入值。<br>　<code>-x</code> 　执行指令后，会先显示该指令及所下的参数。</p>
<blockquote>
<p><code>+&lt;参数&gt;</code> 　取消某个set曾启动的参数。</p>
</blockquote>
<p><code>kill.sh</code>文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'The following command terminates the "npm run serve" process using its PID'</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'(written to ".pidfile"), all of which were conducted when "deloy.sh"'</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'was executed.'</span></span><br><span class="line"><span class="built_in">set</span> -x</span><br><span class="line"><span class="built_in">kill</span> $(cat .pidfile)</span><br></pre></td></tr></table></figure>



<p>思路：</p>
<ol>
<li>使用一台单独的Nginx服务器发布，使用Publish Over SSH插件上传</li>
<li>使用Docker在本地发布或者远程发布</li>
<li>使用Dockerfile进行镜像内的构建，使用docker镜像进行发布</li>
</ol>
<h2 id="TravisCI"><a href="#TravisCI" class="headerlink" title="TravisCI"></a>TravisCI</h2><h3 id="使用简介-1"><a href="#使用简介-1" class="headerlink" title="使用简介"></a>使用简介</h3><p>Travis CI 只支持 Github，不支持其他代码托管服务。这意味着，你必须满足以下条件，才能使用 Travis CI。</p>
<blockquote>
<ul>
<li>拥有 GitHub 帐号</li>
<li>该帐号下面有一个项目</li>
<li>该项目里面有可运行的代码</li>
<li>该项目还包含构建或测试脚本</li>
</ul>
</blockquote>
<p>Travis简单的使用步骤:</p>
<ul>
<li>github授权及面板</li>
<li>获取github的Tokens</li>
<li>配置项目.travis.yml<ul>
<li>Node项目</li>
<li>Script脚本</li>
<li>部署到github pages</li>
<li>钩子用法</li>
</ul>
</li>
<li>其他</li>
</ul>
<p><strong>github授权及面板</strong></p>
<p>首先，访问官方网站 <a href="https://travis-ci.org/" target="_blank" rel="noopener">travis-ci.org</a>，点击右上角的个人头像，使用 Github 账户登入 Travis CI。</p>
<p>会进入到授权页面，这里跟微博、QQ是一回事，主要是读取你的用户信息。</p>
<p><img src="/blog/.io//image-20190612205411602.png" alt="image-20190612205411602"></p>
<p>这里第二步在，<code>Dashboard</code>这个选项卡中，点击<code>Activate</code>这个按钮</p>
<p><img src="/blog/.io//image-20190612212459194.png" alt="image-20190612212459194"></p>
<p>完了之后，Dashboard会列出所有Github中有<code>.travis.yml</code>配置文件的仓库：</p>
<p><img src="/blog/.io//image-20190612212731186.png" alt="image-20190612212731186"></p>
<p>Travis 会列出 Github 上面你的所有仓库，以及你所属于的组织。此时，选择你需要 Travis 帮你构建的仓库，打开仓库旁边的开关。一旦激活了一个仓库，Travis 会监听这个仓库的所有变化。</p>
<p><img src="/blog/.io//image-20190612213022380.png" alt="image-20190612213022380"></p>
<ul>
<li><p><code>Settings</code>中用于配置项目的构建条件</p>
<p><img src="/blog/.io//image-20190612214434173.png" alt="image-20190612214434173"></p>
</li>
<li><p><code>Requests</code>可以查看构建记录</p>
<p><img src="/blog/.io//image-20190612214519926.png" alt="image-20190612214519926"></p>
</li>
<li><p><code>Caches</code>主要是缓存文件</p>
</li>
<li><p><code>Trigger build</code>手动触发构建</p>
</li>
</ul>
<p><strong>获取github的token</strong></p>
<p>在settings-&gt;Developer settings-&gt;Personal access tokens-&gt;Generate new token</p>
<p><img src="/blog/.io//image-20190612225000955.png" alt="image-20190612225000955"></p>
<p><strong>配置项目的.travis.yml文件</strong></p>
<ul>
<li><p>设置项目语言</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">language:</span> <span class="string">node_js</span></span><br><span class="line"><span class="attr">node_js:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"10"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Script脚本</p>
<p>Travis 的运行流程很简单，任何项目都会经过两个阶段。</p>
<blockquote>
<ul>
<li>install 阶段：安装依赖</li>
<li>script 阶段：运行脚本</li>
</ul>
</blockquote>
<p>配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># S: Build Lifecycle</span></span><br><span class="line"><span class="attr">install:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">yarn</span> <span class="string">install</span></span><br><span class="line"></span><br><span class="line"><span class="string">//</span> <span class="string">钩子方法</span></span><br><span class="line"><span class="attr">before_script:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 无其他依赖项所以执行npm run build 构建就行了</span></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br></pre></td></tr></table></figure>

<p>如果不需要安装，即跳过安装阶段，就直接设为<code>true</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">install: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><code>script</code>字段用来指定构建或测试脚本。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">script: bundle exec thor build</span><br></pre></td></tr></table></figure>

<p>如果有多个脚本，可以写成下面的形式。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">script:</span><br><span class="line">  - command1</span><br><span class="line">  - command2</span><br></pre></td></tr></table></figure>
</li>
<li><p>部署到github pages</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">	<span class="comment"># 其他的一些配置项，可以参考：https://docs.travis-ci.com/user/deployment/pages/</span></span><br><span class="line">  <span class="attr">provider:</span> <span class="string">pages</span></span><br><span class="line">  <span class="attr">skip_cleanup:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">local_dir:</span> <span class="string">dist/</span></span><br><span class="line">  <span class="attr">github_token:</span> <span class="string">$GITHUB_TOKEN</span> <span class="comment"># Set in the settings page of your repository, as a secure variable</span></span><br><span class="line">  <span class="attr">keep_history:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">on:</span></span><br><span class="line">    <span class="attr">branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>钩子用法</p>
<p>Travis 为上面这些阶段提供了7个钩子。</p>
<ul>
<li>before_install：install 阶段之前执行</li>
<li>before_script：script 阶段之前执行</li>
<li>after_failure：script 阶段失败时执行</li>
<li>after_success：script 阶段成功时执行</li>
<li>before_deploy：deploy 步骤之前执行</li>
<li>after_deploy：deploy 步骤之后执行</li>
<li>after_script：script 阶段之后执行</li>
</ul>
</li>
</ul>
<p>  完整的生命周期，从开始到结束是下面的流程。</p>
<ol>
<li>before_install</li>
<li>install</li>
<li>before_script</li>
<li>script</li>
<li>after<em>success or after</em>failure</li>
<li>[OPTIONAL] before_deploy</li>
<li>[OPTIONAL] deploy</li>
<li>[OPTIONAL] after_deploy</li>
<li>after_script</li>
</ol>
<p>参考资料：</p>
<ul>
<li><a href="https://gist.github.com/domenic/ec8b0fc8ab45f39403dd" target="_blank" rel="noopener">Auto-deploying built products to gh-pages with Travis</a></li>
<li><a href="https://oncletom.io/2016/travis-ssh-deploy/" target="_blank" rel="noopener">SSH deploys with Travis CI</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2017/12/travis_ci_tutorial.html" target="_blank" rel="noopener">持续集成服务 Travis CI 教程</a></li>
</ul>
<h3 id="配置Node-js应用"><a href="#配置Node-js应用" class="headerlink" title="配置Node.js应用"></a>配置Node.js应用</h3><p>配置一个Vue实例并发布到github pages</p>
<p>.travis.yml文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">language:</span> <span class="string">node_js</span></span><br><span class="line"><span class="attr">node_js:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"10"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Travis-CI Caching</span></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line">  <span class="attr">directories:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">node_modules</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># S: Build Lifecycle</span></span><br><span class="line"><span class="attr">install:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">yarn</span> <span class="string">install</span></span><br><span class="line"></span><br><span class="line"><span class="attr">before_script:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 无其他依赖项所以执行npm run build 构建就行了</span></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">	<span class="comment"># 其他的一些配置项，可以参考：https://docs.travis-ci.com/user/deployment/pages/</span></span><br><span class="line">  <span class="attr">provider:</span> <span class="string">pages</span></span><br><span class="line">  <span class="attr">skip_cleanup:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">local_dir:</span> <span class="string">dist/</span></span><br><span class="line">  <span class="attr">github_token:</span> <span class="string">$GITHUB_TOKEN</span> <span class="comment"># Set in the settings page of your repository, as a secure variable</span></span><br><span class="line">  <span class="attr">keep_history:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">on:</span></span><br><span class="line">    <span class="attr">branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>

<h2 id="CircleCI"><a href="#CircleCI" class="headerlink" title="CircleCI"></a>CircleCI</h2><h3 id="使用简介-2"><a href="#使用简介-2" class="headerlink" title="使用简介"></a>使用简介</h3><ol>
<li><p>注册 CircleCI</p>
<p>打开 <a href="https://circleci.com/" target="_blank" rel="noopener">CircleCI</a> 官方网站，使用您的GitHub帐户登录。</p>
<p><img src="/blog/.io//image-20190613093550553.png" alt="image-20190613093550553"></p>
<p>进行授权：</p>
<p><img src="/blog/.io//image-20190613093732415.png" alt="image-20190613093732415"></p>
</li>
<li><p>启动存储库</p>
</li>
</ol>
<p>检查要在 CircleCI 上管理的存储库的开关按钮。</p>
<p><img src="/blog/.io//image-20190613094115350.png" alt="image-20190613094115350"></p>
<ol start="3">
<li><p>编写 config.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">docker:</span></span><br><span class="line">      <span class="string">...</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="string">...</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="string">...</span></span><br><span class="line">		<span class="attr">environment:</span></span><br><span class="line">			<span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>官方参考文档：<a href="https://circleci.com/docs/2.0/configuration-reference/#version" target="_blank" rel="noopener">https://circleci.com/docs/2.0/configuration-reference/#version</a></p>
</li>
</ol>
<p>   来看一个完事版的配置</p>
   <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">docker:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">ubuntu:14.04</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">mongo:2.6.8</span></span><br><span class="line">        <span class="attr">command:</span> <span class="string">[mongod,</span> <span class="string">--smallfiles]</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">postgres:9.4.1</span></span><br><span class="line">        <span class="comment"># some containers require setting environment variables</span></span><br><span class="line">        <span class="attr">environment:</span></span><br><span class="line">          <span class="attr">POSTGRES_USER:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">redis@sha256:54057dd7e125ca41afe526a877e8bd35ec2cdd33b9217e022ed37bdcf7d09673</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">rabbitmq:3.5.4</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TEST_REPORTS:</span> <span class="string">/tmp/test-reports</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">working_directory:</span> <span class="string">~/my-project</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">checkout</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span></span><br><span class="line">          <span class="attr">command:</span> <span class="string">echo</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="string">devhost</span> <span class="string">|</span> <span class="string">sudo</span> <span class="string">tee</span> <span class="string">-a</span> <span class="string">/etc/hosts</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># Create Postgres users and database</span></span><br><span class="line">      <span class="comment"># Note the YAML heredoc '|' for nicer formatting</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">sudo</span> <span class="string">-u</span> <span class="string">root</span> <span class="string">createuser</span> <span class="string">-h</span> <span class="string">localhost</span> <span class="string">--superuser</span> <span class="string">ubuntu</span> <span class="string">&amp;&amp;</span></span><br><span class="line">          <span class="string">sudo</span> <span class="string">createdb</span> <span class="string">-h</span> <span class="string">localhost</span> <span class="string">test_db</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">restore_cache:</span></span><br><span class="line">          <span class="attr">keys:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">v1-my-project-&#123;&#123;</span> <span class="string">checksum</span> <span class="string">"project.clj"</span> <span class="string">&#125;&#125;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">v1-my-project-</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span></span><br><span class="line">          <span class="attr">environment:</span></span><br><span class="line">            <span class="attr">SSH_TARGET:</span> <span class="string">"localhost"</span></span><br><span class="line">            <span class="attr">TEST_ENV:</span> <span class="string">"linux"</span></span><br><span class="line">          <span class="attr">command:</span> <span class="string">|</span></span><br><span class="line">            <span class="string">set</span> <span class="string">-xu</span></span><br><span class="line">            <span class="string">mkdir</span> <span class="string">-p</span> <span class="string">$&#123;TEST_REPORTS&#125;</span></span><br><span class="line">            <span class="string">run-tests.sh</span></span><br><span class="line">            <span class="string">cp</span> <span class="string">out/tests/*.xml</span> <span class="string">$&#123;TEST_REPORTS&#125;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">set</span> <span class="string">-xu</span></span><br><span class="line">          <span class="string">mkdir</span> <span class="string">-p</span> <span class="string">/tmp/artifacts</span></span><br><span class="line">          <span class="string">create_jars.sh</span> <span class="string">$&#123;CIRCLE_BUILD_NUM&#125;</span></span><br><span class="line">          <span class="string">cp</span> <span class="string">*.jar</span> <span class="string">/tmp/artifacts</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">save_cache:</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">v1-my-project-&#123;&#123;</span> <span class="string">checksum</span> <span class="string">"project.clj"</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">~/.m2</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># Save artifacts</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">store_artifacts:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/tmp/artifacts</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">build</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># Upload test results</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">store_test_results:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/tmp/test-reports</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">deploy-stage:</span></span><br><span class="line">    <span class="attr">docker:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">ubuntu:14.04</span></span><br><span class="line">    <span class="attr">working_directory:</span> <span class="string">/tmp/my-project</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">if</span> <span class="string">tests</span> <span class="string">pass</span> <span class="string">and</span> <span class="string">branch</span> <span class="string">is</span> <span class="string">Staging</span></span><br><span class="line">          <span class="attr">command:</span> <span class="string">ansible-playbook</span> <span class="string">site.yml</span> <span class="string">-i</span> <span class="string">staging</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">deploy-prod:</span></span><br><span class="line">    <span class="attr">docker:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">ubuntu:14.04</span></span><br><span class="line">    <span class="attr">working_directory:</span> <span class="string">/tmp/my-project</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">if</span> <span class="string">tests</span> <span class="string">pass</span> <span class="string">and</span> <span class="string">branch</span> <span class="string">is</span> <span class="string">Master</span></span><br><span class="line">          <span class="attr">command:</span> <span class="string">ansible-playbook</span> <span class="string">site.yml</span> <span class="string">-i</span> <span class="string">production</span></span><br><span class="line"></span><br><span class="line"><span class="attr">workflows:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">build-deploy:</span></span><br><span class="line">    <span class="attr">jobs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">build:</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="attr">branches:</span></span><br><span class="line">              <span class="attr">ignore:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">develop</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">/feature-.*/</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">deploy-stage:</span></span><br><span class="line">          <span class="attr">requires:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="attr">branches:</span></span><br><span class="line">              <span class="attr">only:</span> <span class="string">staging</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">deploy-prod:</span></span><br><span class="line">          <span class="attr">requires:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="attr">branches:</span></span><br><span class="line">              <span class="attr">only:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>



<ol start="4">
<li><p>设置/查看任务</p>
<p><img src="/blog/.io//image-20190613093327981.png" alt="image-20190613093327981"></p>
</li>
</ol>
<h3 id="配置Node-js应用-1"><a href="#配置Node-js应用-1" class="headerlink" title="配置Node.js应用"></a>配置Node.js应用</h3><p><code>.circleci/config.yml</code>配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">docker:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">circleci/node:10</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="attr">only:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">add_ssh_keys:</span></span><br><span class="line">          <span class="attr">fingerprints:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">"c5:20:8e:79:81:19:fd:c1:6c:c4:fb:41:58:92:9d:4f"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">checkout</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">restore_cache:</span></span><br><span class="line">          <span class="attr">keys:</span></span><br><span class="line">            <span class="comment"># fallback to using the latest cache if no exact match is found</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">dependencies-</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">Install</span></span><br><span class="line">          <span class="attr">command:</span> <span class="string">yarn</span> <span class="string">install</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">save_cache:</span></span><br><span class="line">          <span class="attr">paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">node_modules</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">dependencies-</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">build</span> <span class="string">github</span> <span class="string">pages</span></span><br><span class="line">          <span class="attr">command:</span> <span class="string">yarn</span> <span class="string">build</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">Prepare</span> <span class="string">shell</span> <span class="string">commands</span></span><br><span class="line">          <span class="attr">command:</span> <span class="string">chmod</span> <span class="string">+x</span> <span class="string">scripts/deploy.sh</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">Run</span> <span class="string">deploy</span> <span class="string">scripts</span></span><br><span class="line">          <span class="attr">command:</span> <span class="string">./scripts/deploy.sh</span></span><br></pre></td></tr></table></figure>



<p>这里以发布到github page为示例：</p>
<p>deploy.sh文件的内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment"># ideas used from https://gist.github.com/motemen/8595451</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Based on https://github.com/eldarlabs/ghpages-deploy-script/blob/master/scripts/deploy-ghpages.sh</span></span><br><span class="line"><span class="comment"># Used with their MIT license https://github.com/eldarlabs/ghpages-deploy-script/blob/master/LICENSE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># abort the script if there is a non-zero error</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># show where we are on the machine</span></span><br><span class="line"><span class="built_in">pwd</span></span><br><span class="line">remote=$(git config remote.origin.url)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'remote is: '</span><span class="variable">$remote</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># make a directory to put the gp-pages branch</span></span><br><span class="line">mkdir gh-pages-branch</span><br><span class="line"><span class="built_in">cd</span> gh-pages-branch</span><br><span class="line"><span class="comment"># now lets setup a new repo so we can update the gh-pages branch</span></span><br><span class="line">git config --global user.email <span class="string">"<span class="variable">$GH_EMAIL</span>"</span> &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">git config --global user.name <span class="string">"<span class="variable">$GH_NAME</span>"</span> &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">git init</span><br><span class="line">git remote add --fetch origin <span class="string">"<span class="variable">$remote</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'email is: '</span><span class="variable">$GH_EMAIL</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'name is: '</span><span class="variable">$GH_NAME</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'sitesource is: '</span><span class="variable">$siteSource</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># switch into the the gh-pages branch</span></span><br><span class="line"><span class="keyword">if</span> git rev-parse --verify origin/gh-pages &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    git checkout gh-pages</span><br><span class="line">    <span class="comment"># delete any old site as we are going to replace it</span></span><br><span class="line">    <span class="comment"># Note: this explodes if there aren't any, so moving it here for now</span></span><br><span class="line">    git rm -rf .</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    git checkout --orphan gh-pages</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># copy over or recompile the new site</span></span><br><span class="line">cp -a <span class="string">"../<span class="variable">$&#123;siteSource&#125;</span>/."</span> .</span><br><span class="line"></span><br><span class="line">ls -la</span><br><span class="line"></span><br><span class="line"><span class="comment"># stage any changes and new files</span></span><br><span class="line">git add -A</span><br><span class="line"><span class="comment"># now commit, ignoring branch gh-pages doesn't seem to work, so trying skip</span></span><br><span class="line">git commit --allow-empty -m <span class="string">"Deploy to GitHub pages [ci skip]"</span></span><br><span class="line"><span class="comment"># and push, but send any output to /dev/null to hide anything sensitive</span></span><br><span class="line">git push --force --quiet origin gh-pages</span><br><span class="line"><span class="comment"># go back to where we started and remove the gh-pages git repo we made and used</span></span><br><span class="line"><span class="comment"># for deployment</span></span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">rm -rf gh-pages-branch</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Finished Deployment!"</span></span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p><strong>&gt;/dev/null 2&gt;&amp;1的含义</strong> </p>
<p><strong>文件描述符</strong></p>
<p>当执行shell命令时，会默认打开3个文件，每个文件有对应的文件描述符来方便我们使用：</p>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">文件描述符</th>
<th align="left">默认情况</th>
<th align="left">对应文件句柄位置</th>
</tr>
</thead>
<tbody><tr>
<td align="left">标准输入（standard input）</td>
<td align="left">0</td>
<td align="left">从键盘获得输入</td>
<td align="left">/proc/slef/fd/0</td>
</tr>
<tr>
<td align="left">标准输出（standard output）</td>
<td align="left">1</td>
<td align="left">输出到屏幕（即控制台）</td>
<td align="left">/proc/slef/fd/1</td>
</tr>
<tr>
<td align="left">错误输出（error output）</td>
<td align="left">2</td>
<td align="left">输出到屏幕（即控制台）</td>
<td align="left">/proc/slef/fd/2</td>
</tr>
</tbody></table>
<p><code>&gt;</code> 代表重定向到哪里?</p>
<p>例如：<code>echo &quot;123&quot; &gt; /home/123.txt</code><br><code>1</code> 表示<code>stdout</code>标准输出，系统默认值是<code>1</code>，所以<code>&gt;/dev/null</code>等同于<code>1&gt;/dev/null</code><br><code>2</code> 表示<code>stderr</code>标准错误<br><code>&amp;</code> 表示等同于的意思，<code>2&gt;&amp;1</code>，表示<code>2</code>的输出重定向等同于<code>1</code> </p>
<p>参考资料：</p>
<p><a href="https://www.cnblogs.com/tinywan/p/6025468.html" target="_blank" rel="noopener">Shell脚本———— /dev/null 2&gt;&amp;1详解</a></p>
<p><a href="https://blog.csdn.net/jackyechina/article/details/54582146" target="_blank" rel="noopener">shell中&gt;/dev/null 2&gt;&amp;1</a></p>
<p><a href="https://blog.csdn.net/ithomer/article/details/9288353" target="_blank" rel="noopener">Linux Shell 1&gt;/dev/null 2&gt;&amp;1 含义</a></p>
<h2 id="扩展知识"><a href="#扩展知识" class="headerlink" title="扩展知识"></a>扩展知识</h2><h3 id="自动化流程的发展趋势"><a href="#自动化流程的发展趋势" class="headerlink" title="自动化流程的发展趋势"></a>自动化流程的发展趋势</h3><ol>
<li><p>集中化</p>
<p>以集群为基础，服务采用Saas方式进行交付。所有折构建、测试、发布全集中进行管理。</p>
</li>
<li><p>微服务+无服务的应用模式</p>
<p>应用程序执行环境的管理被新的编程模型和平台取代后，团队的交付生产率得到了进一步的提升。一方面它免去了很多环境管理的工作，包括设备、网络、主机以及对应的软件和配置工作，使得软件运行时环境更加稳定。另一方面，它大大降低了团队采用DevOps的技术门槛。</p>
<p><strong>无服务器风格的架构（Serverless architecture）</strong>把DevOps技术在微服务领域的应用推向极致。当应用程序执行环境的管理被新的编程模型和平台取代后，团队的交付生产率得到了进一步的提升。一方面它免去了很多环境管理的工作，包括设备、网络、主机以及对应的软件和配置工作，使得软件运行时环境更加稳定。另一方面，它大大降低了团队采用DevOps的技术门槛。</p>
<p>在微服务端到端交付流程上，Netflix开源了自家的<a href="http://www.spinnaker.io/" target="_blank" rel="noopener">Spinnaker</a>，Netflix作为微服务实践的先锋，不断推出新的开源工具来弥补社区中微服务技术和最佳实践的缺失。而<a href="http://projects.spring.io/spring-cloud/" target="_blank" rel="noopener">Spring Cloud</a>则为开发者提供了一系列工具，以便他们在所熟悉的Spring技术栈下使用这些服务协调技术(coordination techniques)，如服务发现、负载均衡、熔断和健康检查。</p>
</li>
<li><p>人工智能领域的应用</p>
<p>DevOps的最早实践来自于互联网企业的Web应用，相应的思想被引入企业级应用并促进了一系列工具的发展。在人工智能领域，<a href="https://www.tensorflow.org/" target="_blank" rel="noopener">TensorFlow</a>就是这样一个例子，它可以有多种DevOps友好的安装和部署方式 ，例如采用Docker进行部署。</p>
<p>随着Python在大数据、人工智能、区块链、微服务以及Docker中的发展，可以预见Python在日后的领域仍然会发挥重要的作用。</p>
</li>
<li><p>安全推动DevOps的发展</p>
<p>全是DevOps永远绕不开的话题，也往往是新技术在传统行业（例如金融和电信）应用中的最大阻碍。一方面，组织结构的转型迫使企业要打破原先的部门墙，这意味着很多原先的控制流程不再适用。另一方面，由于大量的DevOps技术来源于开源社区，缺乏强大技术实力的企业在应用相关技术时不免会有所担忧。</p>
</li>
<li><p>Windows平台下.net的技术潜力巨大</p>
<p>长期以来，Windows和.NET平台下的DevOps一直都是一个被低估的领域。一方面，社区缺乏对 Windows Server平台的兴趣。另一方面，<a href="https://community.spiceworks.com/networking/articles/2462-server-virtualization-and-os-trends" target="_blank" rel="noopener">Windows Server却有接近90%的市场占用率</a>，在Web服务器领域则有<a href="https://w3techs.com/technologies/overview/operating_system/all" target="_blank" rel="noopener">33.5%的市场占有率</a>。</p>
</li>
<li><p>非功能性自动化测试工具逐渐完善</p>
<p>自动化测试水平往往是衡量DevOps技术能力高低的重要指标，尤其是针对生产环境应用程序的非功能性自动化测试工具。一直以来，技术雷达都在尝试从不同的角度宣扬自动化测试的重要性，从软件的开发阶段延展到了整个应用生命周期甚至整体IT资产的管理上。</p>
</li>
</ol>
<h3 id="复杂的DevOps相关工具"><a href="#复杂的DevOps相关工具" class="headerlink" title="复杂的DevOps相关工具"></a>复杂的DevOps相关工具</h3><p><img src="/blog/.io//devops-hero-1-87966cfbc9c5713ae047551c7b22985c.png" alt="DevOps"></p>
<h3 id="Jenkins的一些应用场景"><a href="#Jenkins的一些应用场景" class="headerlink" title="Jenkins的一些应用场景"></a>Jenkins的一些应用场景</h3><p>打包平台：</p>
<p>使用Jenkins搭建iOS/Android</p>
<p>测试平台：</p>
<p>jenkins + python + selenium</p>
<p>Jmeter+maven+Jenkins构建云性能测试平台</p>
<p>Jenkins+PMD构建自动化静态代码检测</p>
<p>使用jenkins+Emma统计</p>
<p>客户端单元测试覆盖率</p>
<p>Jenkins+Ant+Java+Junit+SVN执行junit单元测试</p>
<p>jenkins+ant+jmeter搭建持续集成的接口测试平台</p>
<p>自动部署：</p>
<p>Jenkins+GitLab+蒲公英+FTP</p>
<p>jenkins结合ansible用shell实现自动化部署和回滚</p>
<p>持续集成：</p>
<p>Tomcat+Sonar搭建持续集成环境</p>
<p>Maven+Nexus+Jenkins+git/SVN</p>
<h3 id="Jenkins的Docker-compose-yml创建文件"><a href="#Jenkins的Docker-compose-yml创建文件" class="headerlink" title="Jenkins的Docker-compose.yml创建文件"></a>Jenkins的Docker-compose.yml创建文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">'3'</span></span><br><span class="line">services:</span><br><span class="line">  jenkins:</span><br><span class="line">    container_name: <span class="string">'jenkins'</span></span><br><span class="line">    image: jenkins/jenkins</span><br><span class="line">    restart: always</span><br><span class="line">    user: jenkins:&lt;这里填Docker用户组的ID，见下面&gt;</span><br><span class="line">    ports:</span><br><span class="line">    - <span class="string">"8080:8080"</span></span><br><span class="line">    - <span class="string">"50000:50000"</span></span><br><span class="line">    volumes:</span><br><span class="line">    - /home/jenkins/data:/var/jenkins_home</span><br><span class="line">    - /usr/bin/docker:/usr/bin/docker</span><br><span class="line">    - /var/run/docker.sock:/var/run/docker.sock</span><br></pre></td></tr></table></figure>

<p>上面的脚本使用注意：</p>
<ol>
<li><p>创建本地jenkins数据目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/jenkins</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看docker用户组的ID</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/group |grep docker</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行<code>docker-compose up -d</code></p>
</li>
</ol>
<h3 id="gitlab的docker启动配置文件"><a href="#gitlab的docker启动配置文件" class="headerlink" title="gitlab的docker启动配置文件"></a>gitlab的docker启动配置文件</h3><p>项目地址：<a href="https://github.com/sameersbn/docker-gitlab" target="_blank" rel="noopener">https://github.com/sameersbn/docker-gitlab</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">sameersbn/redis:4.0.9-1</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--loglevel</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/srv/docker/gitlab/redis:/var/lib/redis:Z</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">postgresql:</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">sameersbn/postgresql:10</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/srv/docker/gitlab/postgresql:/var/lib/postgresql:Z</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">DB_USER=gitlab</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">DB_PASS=password</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">DB_NAME=gitlabhq_production</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">DB_EXTENSION=pg_trgm</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">gitlab:</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">sameersbn/gitlab:11.11.2</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">postgresql</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"10080:80"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"10022:22"</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/srv/docker/gitlab/gitlab:/home/git/data:Z</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">DEBUG=false</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">DB_ADAPTER=postgresql</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">DB_HOST=postgresql</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">DB_PORT=5432</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">DB_USER=gitlab</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">DB_PASS=password</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">DB_NAME=gitlabhq_production</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">REDIS_HOST=redis</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">REDIS_PORT=6379</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">TZ=Asia/Kolkata</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">GITLAB_TIMEZONE=Kolkata</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">GITLAB_HTTPS=false</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">SSL_SELF_SIGNED=false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这里修改成服务器的IP或者域名</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">GITLAB_HOST=localhost</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">GITLAB_PORT=10080</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">GITLAB_SSH_PORT=10022</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">GITLAB_RELATIVE_URL_ROOT=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">GITLAB_SECRETS_DB_KEY_BASE=long-and-random-alphanumeric-string</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">GITLAB_SECRETS_SECRET_KEY_BASE=long-and-random-alphanumeric-string</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">GITLAB_SECRETS_OTP_KEY_BASE=long-and-random-alphanumeric-string</span></span><br><span class="line"></span><br><span class="line">		<span class="comment"># 这里给一个长度大于8的密码</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">GITLAB_ROOT_PASSWORD=12345678</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">GITLAB_ROOT_EMAIL=itheima@itcast.cn</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">GITLAB_NOTIFY_ON_BROKEN_BUILDS=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">GITLAB_NOTIFY_PUSHER=false</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">GITLAB_EMAIL=notifications@example.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">GITLAB_EMAIL_REPLY_TO=noreply@example.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">GITLAB_INCOMING_EMAIL_ADDRESS=reply@example.com</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">GITLAB_BACKUP_SCHEDULE=daily</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">GITLAB_BACKUP_TIME=01:00</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">SMTP_ENABLED=false</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">SMTP_DOMAIN=www.example.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">SMTP_HOST=smtp.gmail.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">SMTP_PORT=587</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">SMTP_USER=mailer@example.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">SMTP_PASS=password</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">SMTP_STARTTLS=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">SMTP_AUTHENTICATION=login</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">IMAP_ENABLED=false</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">IMAP_HOST=imap.gmail.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">IMAP_PORT=993</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">IMAP_USER=mailer@example.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">IMAP_PASS=password</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">IMAP_SSL=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">IMAP_STARTTLS=false</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_ENABLED=false</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_AUTO_SIGN_IN_WITH_PROVIDER=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_ALLOW_SSO=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_BLOCK_AUTO_CREATED_USERS=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_AUTO_LINK_LDAP_USER=false</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_AUTO_LINK_SAML_USER=false</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_EXTERNAL_PROVIDERS=</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_CAS3_LABEL=cas3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_CAS3_SERVER=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_CAS3_DISABLE_SSL_VERIFICATION=false</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_CAS3_LOGIN_URL=/cas/login</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_CAS3_VALIDATE_URL=/cas/p3/serviceValidate</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_CAS3_LOGOUT_URL=/cas/logout</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_GOOGLE_API_KEY=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_GOOGLE_APP_SECRET=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_GOOGLE_RESTRICT_DOMAIN=</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_FACEBOOK_API_KEY=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_FACEBOOK_APP_SECRET=</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_TWITTER_API_KEY=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_TWITTER_APP_SECRET=</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_GITHUB_API_KEY=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_GITHUB_APP_SECRET=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_GITHUB_URL=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_GITHUB_VERIFY_SSL=</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_GITLAB_API_KEY=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_GITLAB_APP_SECRET=</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_BITBUCKET_API_KEY=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_BITBUCKET_APP_SECRET=</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_SAML_ASSERTION_CONSUMER_SERVICE_URL=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_SAML_IDP_CERT_FINGERPRINT=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_SAML_IDP_SSO_TARGET_URL=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_SAML_ISSUER=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_SAML_LABEL="Our</span> <span class="string">SAML</span> <span class="string">Provider"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_SAML_NAME_IDENTIFIER_FORMAT=urn:oasis:names:tc:SAML:2.0:nameid-format:transient</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_SAML_GROUPS_ATTRIBUTE=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_SAML_EXTERNAL_GROUPS=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_SAML_ATTRIBUTE_STATEMENTS_EMAIL=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_SAML_ATTRIBUTE_STATEMENTS_NAME=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_SAML_ATTRIBUTE_STATEMENTS_USERNAME=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_SAML_ATTRIBUTE_STATEMENTS_FIRST_NAME=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_SAML_ATTRIBUTE_STATEMENTS_LAST_NAME=</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_CROWD_SERVER_URL=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_CROWD_APP_NAME=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_CROWD_APP_PASSWORD=</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_AUTH0_CLIENT_ID=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_AUTH0_CLIENT_SECRET=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_AUTH0_DOMAIN=</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_AZURE_API_KEY=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_AZURE_API_SECRET=</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">OAUTH_AZURE_TENANT_ID=</span></span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过这篇文章大家了解了什么是CI/CD以及它的流程。前端项目怎么结合CI/CD流程，实现快速迭代。Docker的使用，Jenkins+gitlab+nodejs自动化项目。了解了持续集成工具Jenkins、Travis CI、Circle CI。一起学习呀～</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://supertinypeanut.github.io/blog/2021/03/23/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E4%B8%8E%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2/" data-id="ckmm8vac1002l85qs31uahiu8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96/" rel="tag">前端工程化</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Promise实现" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2021/03/07/Promise%E5%AE%9E%E7%8E%B0/" class="article-date">
  <time datetime="2021-03-07T00:53:00.000Z" itemprop="datePublished">2021-03-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2021/03/07/Promise%E5%AE%9E%E7%8E%B0/">Promise实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h4><p>Promise是ES6中的新的异步语法，解决了回调嵌套的问题：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>)=&gt;</span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">    resolve(<span class="number">1</span>)</span><br><span class="line">  &#125;,<span class="number">1000</span>)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">val</span> =&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(val);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>)=&gt;</span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">      resolve(<span class="number">2</span>)</span><br><span class="line">    &#125;,<span class="number">1000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(val);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="实现状态切换"><a href="#实现状态切换" class="headerlink" title="实现状态切换"></a>实现状态切换</h4><ul>
<li>promise实例有三个状态，<code>pending</code>,<code>fulfilled</code>,<code>rejected</code></li>
<li>promise实例在构造是可以传入执行函数，执行函数有两个形参<code>resolve</code>,<code>reject</code>可以改变promise的状态，promise的状态一旦改变后不可再进行改变。</li>
<li>执行函数会在创建promise实例时，同步执行</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PENDING = <span class="string">'PENDING'</span>; <span class="comment">// 初始状态</span></span><br><span class="line"><span class="keyword">const</span> FULFILLED = <span class="string">'FULFILLED'</span>; <span class="comment">// 成功状态</span></span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">'REJECTED'</span>; <span class="comment">// 失败状态</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Promise2</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(executor)&#123;</span><br><span class="line">    <span class="keyword">this</span>.status = PENDING</span><br><span class="line">    <span class="keyword">this</span>.value = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">this</span>.reason = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">const</span> resolve = <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.status === PENDING) &#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.status = FULFILLED;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> reject = <span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.status === PENDING) &#123;</span><br><span class="line">        <span class="keyword">this</span>.reason = reason;</span><br><span class="line">        <span class="keyword">this</span>.status = REJECTED;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      executor(resolve,reject)</span><br><span class="line">    &#125;<span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      reject(e)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> p = <span class="keyword">new</span> Promise2(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;resolve(<span class="number">1</span>)&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="实现then异步执行"><a href="#实现then异步执行" class="headerlink" title="实现then异步执行"></a>实现<code>then</code>异步执行</h4><p>promise实例可以调用<code>then</code>方法并且传入回调：</p>
<p>如果调用<code>then</code>时，Promise实例是<code>fulfilled</code>状态，则马上<strong>异步执行</strong>传入的回调。</p>
<p>如果调用<code>then</code>时，Promise实例是<code>pending</code>状态，传入的回调会等到resolve后再<strong>异步执行</strong></p>
<p>例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">  resolve(<span class="number">2</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">&#125;)</span><br><span class="line">p.then(<span class="function">(<span class="params">val</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(val);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">//3</span></span><br><span class="line"><span class="comment">//2</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>)=&gt;</span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">    resolve(<span class="number">1</span>)</span><br><span class="line">  &#125;,<span class="number">2000</span>)</span><br><span class="line">&#125;)</span><br><span class="line">p.then(<span class="function">(<span class="params">val</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(val);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>思路：需要用回调先保存到队列中，在<code>resolve</code>后异步执行队列里的回调，在<code>then</code>时判断实例的状态再决定是将回调推入队列，还是直接异步执行回调：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PENDING = <span class="string">'PENDING'</span>; <span class="comment">// 初始状态</span></span><br><span class="line"><span class="keyword">const</span> FULFILLED = <span class="string">'FULFILLED'</span>; <span class="comment">// 成功状态</span></span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">'REJECTED'</span>; <span class="comment">// 失败状态</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Promise2</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(executor)&#123;</span><br><span class="line">    <span class="keyword">this</span>.status = PENDING</span><br><span class="line">    <span class="keyword">this</span>.value = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">this</span>.reason = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">this</span>.onFulfilledCallbacks = [];</span><br><span class="line">    <span class="keyword">this</span>.onRejectedCallbacks = [];</span><br><span class="line">    <span class="keyword">const</span> resolve = <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.status === PENDING) &#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.status = FULFILLED;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">          <span class="keyword">this</span>.onFulfilledCallbacks.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn(<span class="keyword">this</span>.value));</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> reject = <span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.status === PENDING) &#123;</span><br><span class="line">        <span class="keyword">this</span>.reason = reason;</span><br><span class="line">        <span class="keyword">this</span>.status = REJECTED;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">          <span class="keyword">this</span>.onFulfilledCallbacks.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn(<span class="keyword">this</span>.reason));</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      executor(resolve,reject)</span><br><span class="line">    &#125;<span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      reject(e)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  then(onFulfilled, onRejected) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.status === FULFILLED) &#123;</span><br><span class="line">      setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">        onFulfilled(<span class="keyword">this</span>.value);</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.status === REJECTED) &#123;</span><br><span class="line">      setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">        onRejected(<span class="keyword">this</span>.reason);</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.status === PENDING) &#123;</span><br><span class="line">      <span class="keyword">this</span>.onFulfilledCallbacks.push(onFulfilled); <span class="comment">// 存储回调函数</span></span><br><span class="line">      <span class="keyword">this</span>.onRejectedCallbacks.push(onRejected); <span class="comment">// 存储回调函数</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="resolve-Promise实例的情况"><a href="#resolve-Promise实例的情况" class="headerlink" title="resolve Promise实例的情况"></a><code>resolve</code> Promise实例的情况</h4><p><code>resolve</code>的值有可能也是个promise实例，这时候就要用前述实例自己<code>resolve</code>的值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>) =&gt;</span>&#123;  <span class="comment">//promise1</span></span><br><span class="line">  resolve(<span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve2,reject2</span>)=&gt;</span>&#123;  <span class="comment">//promise2</span></span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">      resolve2(<span class="number">1</span>)</span><br><span class="line">    &#125;,<span class="number">1000</span>)</span><br><span class="line">  &#125;))</span><br><span class="line">&#125;)</span><br><span class="line">p.then(<span class="function">(<span class="params">val</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(val);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>因此需要在promise1的<code>resolve</code>函数中进行判断，是promise实例则在这个promise实例（promise2）后接一个<code>then</code>，并且将promise1的<code>resolve</code>作为回调传入promise2的<code>then</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PENDING = <span class="string">'PENDING'</span>; <span class="comment">// 初始状态</span></span><br><span class="line"><span class="keyword">const</span> FULFILLED = <span class="string">'FULFILLED'</span>; <span class="comment">// 成功状态</span></span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">'REJECTED'</span>; <span class="comment">// 失败状态</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Promise2</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(executor)&#123;</span><br><span class="line">    <span class="keyword">this</span>.status = PENDING</span><br><span class="line">    <span class="keyword">this</span>.value = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">this</span>.reason = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">this</span>.onFulfilledCallbacks = [];</span><br><span class="line">    <span class="keyword">this</span>.onRejectedCallbacks = [];</span><br><span class="line">    <span class="keyword">const</span> resolve = <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (value <span class="keyword">instanceof</span> <span class="keyword">this</span>.constructor) &#123;</span><br><span class="line">        value.then(resolve, reject); <span class="comment">//resolve reject是箭头函数，this已经绑定到外层Promise</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.status === PENDING) &#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.status = FULFILLED;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">          <span class="keyword">this</span>.onFulfilledCallbacks.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn(<span class="keyword">this</span>.value));</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> reject = <span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.status === PENDING) &#123;</span><br><span class="line">        <span class="keyword">this</span>.reason = reason;</span><br><span class="line">        <span class="keyword">this</span>.status = REJECTED;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">          <span class="keyword">this</span>.onFulfilledCallbacks.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn(<span class="keyword">this</span>.reason));</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      executor(resolve,reject)</span><br><span class="line">    &#125;<span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      reject(e)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  then(onFulfilled, onRejected) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.status === FULFILLED) &#123;</span><br><span class="line">      setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">        onFulfilled(<span class="keyword">this</span>.value);</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.status === REJECTED) &#123;</span><br><span class="line">      setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">        onRejected(<span class="keyword">this</span>.reason);</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.status === PENDING) &#123;</span><br><span class="line">      <span class="keyword">this</span>.onFulfilledCallbacks.push(onFulfilled); <span class="comment">// 存储回调函数</span></span><br><span class="line">      <span class="keyword">this</span>.onRejectedCallbacks.push(onRejected); <span class="comment">// 存储回调函数</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> p = <span class="keyword">new</span> Promise2(<span class="function">(<span class="params">resolve,reject</span>) =&gt;</span>&#123;</span><br><span class="line">  resolve(<span class="keyword">new</span> Promise2(<span class="function">(<span class="params">resolve2,reject2</span>)=&gt;</span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">      resolve2(<span class="number">1</span>)</span><br><span class="line">    &#125;,<span class="number">1000</span>)</span><br><span class="line">  &#125;))</span><br><span class="line">&#125;)</span><br><span class="line">p.then(<span class="function">(<span class="params">val</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(val);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="实现链式调用"><a href="#实现链式调用" class="headerlink" title="实现链式调用"></a>实现链式调用</h4><p><code>then</code>可以链式调用，而且前一个<code>then</code>的回调的返回值，如果不是promise实例，则下一个<code>then</code>回调的传参值就是上一个<code>then</code>回调的返回值，如果是promise实例，则下一个<code>then</code>回调的传参值，是上一个<code>then</code>回调返回的promise实例的解决值(value)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>) =&gt;</span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">      resolve(<span class="number">1</span>)</span><br><span class="line">    &#125;,<span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line">p.then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(val);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">      resolve(<span class="number">2</span>)</span><br><span class="line">    &#125;,<span class="number">1000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(val);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">3</span></span><br><span class="line">&#125;).then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(val);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>既然能够链式调用，那么<code>then</code>方法本身的返回值必定是一个Promise实例。那么返回的promise实例是不是自身呢？答案显而易见：不是。如果一个promise的then方法的返回值是promise自身，在new一个Promise时，调用了resolve方法，因为promise的状态一旦更改便不能再次更改，那么下面的所有then便只能执行成功的回调，无法进行错误处理，这显然并不符合promise的规范和设计promise的初衷。</p>
<p>因此 <code>then</code>方法会返回一个新的promise实例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PENDING = <span class="string">'PENDING'</span>; <span class="comment">// 初始状态</span></span><br><span class="line"><span class="keyword">const</span> FULFILLED = <span class="string">'FULFILLED'</span>; <span class="comment">// 成功状态</span></span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">'REJECTED'</span>; <span class="comment">// 失败状态</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Promise2</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(executor)&#123;</span><br><span class="line">    <span class="keyword">this</span>.status = PENDING</span><br><span class="line">    <span class="keyword">this</span>.value = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">this</span>.reason = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">this</span>.onFulfilledCallbacks = [];</span><br><span class="line">    <span class="keyword">this</span>.onRejectedCallbacks = [];</span><br><span class="line">    <span class="keyword">const</span> resolve = <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (value <span class="keyword">instanceof</span> <span class="keyword">this</span>.constructor) &#123;</span><br><span class="line">        value.then(resolve, reject); <span class="comment">//resolve reject是箭头函数，this已经绑定到外层Promise</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.status === PENDING) &#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.status = FULFILLED;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">          <span class="keyword">this</span>.onFulfilledCallbacks.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn(<span class="keyword">this</span>.value));</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> reject = <span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.status === PENDING) &#123;</span><br><span class="line">        <span class="keyword">this</span>.reason = reason;</span><br><span class="line">        <span class="keyword">this</span>.status = REJECTED;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">          <span class="keyword">this</span>.onFulfilledCallbacks.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn(<span class="keyword">this</span>.reason));</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      executor(resolve,reject)</span><br><span class="line">    &#125;<span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      reject(e)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  then(onFulfilled, onRejected) &#123;</span><br><span class="line">    <span class="keyword">const</span> promise2 = <span class="keyword">new</span> <span class="keyword">this</span>.constructor(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123; <span class="comment">// 待返回的新的promise实例</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.status === FULFILLED) &#123;</span><br><span class="line">          setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">let</span> callbackValue = onFulfilled(<span class="keyword">this</span>.value);</span><br><span class="line">              resolve(callbackValue);</span><br><span class="line">            &#125;<span class="keyword">catch</span>(error) &#123;</span><br><span class="line">              reject(error) <span class="comment">// 如果出错此次的then方法的回调函数出错，在将错误传递给promise2</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.status === REJECTED) &#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> callbackValue= onRejected(<span class="keyword">this</span>.reason);</span><br><span class="line">            resolve(callbackValue);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            reject(error);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.status === PENDING) &#123;</span><br><span class="line">        <span class="keyword">this</span>.onFulfilledCallbacks.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> callbackValue = onFulfilled(<span class="keyword">this</span>.value);</span><br><span class="line">            resolve(callbackValue);</span><br><span class="line">          &#125;<span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            reject(error)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">this</span>.onRejectedCallbacks.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> callbackValue = onRejected(<span class="keyword">this</span>.reason);</span><br><span class="line">            resolve(callbackValue);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            reject(error);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> promise2;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="实现其他方法"><a href="#实现其他方法" class="headerlink" title="实现其他方法"></a>实现其他方法</h4><ul>
<li>catch</li>
<li>resolve</li>
<li>reject</li>
<li>all</li>
<li>race</li>
</ul>
<p>方法演示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*catch方法*/</span></span><br><span class="line"><span class="keyword">let</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  reject(<span class="number">1</span>)</span><br><span class="line">&#125;)</span><br><span class="line">p.catch(<span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(reason);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Promise.resolve*/</span></span><br><span class="line"><span class="keyword">let</span> p = <span class="built_in">Promise</span>.resolve(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Promise.resolve*/</span></span><br><span class="line"><span class="keyword">let</span> p = <span class="built_in">Promise</span>.reject(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Promise.all*/</span></span><br><span class="line"><span class="keyword">let</span> p = <span class="built_in">Promise</span>.all([</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve(<span class="number">1</span>)</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve(<span class="number">2</span>)</span><br><span class="line">    &#125;, <span class="number">2000</span>)</span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve(<span class="number">3</span>)</span><br><span class="line">    &#125;, <span class="number">3000</span>)</span><br><span class="line">  &#125;),</span><br><span class="line">])</span><br><span class="line">p.then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(val);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">/*Promise.race*/</span></span><br><span class="line"><span class="keyword">let</span> p = <span class="built_in">Promise</span>.race([</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve(<span class="number">1</span>)</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve(<span class="number">2</span>)</span><br><span class="line">    &#125;, <span class="number">2000</span>)</span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve(<span class="number">3</span>)</span><br><span class="line">    &#125;, <span class="number">3000</span>)</span><br><span class="line">  &#125;),</span><br><span class="line">])</span><br><span class="line">p.then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(val);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PENDING = <span class="string">'PENDING'</span>; <span class="comment">// 初始状态</span></span><br><span class="line"><span class="keyword">const</span> FULFILLED = <span class="string">'FULFILLED'</span>; <span class="comment">// 成功状态</span></span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">'REJECTED'</span>; <span class="comment">// 失败状态</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Promise2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> resolve(value) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> <span class="keyword">this</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">this</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        resolve(value);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> reject(reason) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">this</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> reject(reason))</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">static</span> all(promises)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">this</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> resolvedCounter = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">let</span> promiseNum = promises.length;</span><br><span class="line">      <span class="keyword">let</span> resolvedValues = <span class="keyword">new</span> <span class="built_in">Array</span>(promiseNum);</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; promiseNum; i += <span class="number">1</span>) &#123;</span><br><span class="line">        Promise2.resolve(promises[i]).then(</span><br><span class="line">          value =&gt; &#123;</span><br><span class="line">            resolvedCounter++;</span><br><span class="line">            resolvedValues[i] = value;</span><br><span class="line">            <span class="keyword">if</span> (resolvedCounter === promiseNum) &#123;</span><br><span class="line">              <span class="keyword">return</span> resolve(resolvedValues);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          reason =&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> reject(reason);</span><br><span class="line">          &#125;,</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">static</span> race(promises)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">this</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (promises.length === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = promises.length; i &lt; l; i += <span class="number">1</span>) &#123;</span><br><span class="line">          Promise2.resolve(promises[i]).then(</span><br><span class="line">            data =&gt; &#123;</span><br><span class="line">              resolve(data);</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">            &#125;,</span><br><span class="line">            err =&gt; &#123;</span><br><span class="line">              reject(err);</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">            &#125;,</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">constructor</span>(executor) &#123;</span><br><span class="line">    <span class="keyword">this</span>.status = PENDING</span><br><span class="line">    <span class="keyword">this</span>.value = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">this</span>.reason = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">this</span>.onFulfilledCallbacks = [];</span><br><span class="line">    <span class="keyword">this</span>.onRejectedCallbacks = [];</span><br><span class="line">    <span class="keyword">const</span> resolve = <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (value <span class="keyword">instanceof</span> <span class="keyword">this</span>.constructor) &#123;</span><br><span class="line">        value.then(resolve, reject); <span class="comment">//resolve reject是箭头函数，this已经绑定到外层Promise</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.status === PENDING) &#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.status = FULFILLED;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.onFulfilledCallbacks.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn(<span class="keyword">this</span>.value));</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> reject = <span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.status === PENDING) &#123;</span><br><span class="line">        <span class="keyword">this</span>.reason = reason;</span><br><span class="line">        <span class="keyword">this</span>.status = REJECTED;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.onFulfilledCallbacks.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn(<span class="keyword">this</span>.reason));</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      executor(resolve, reject)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      reject(e)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  then(onFulfilled, onRejected) &#123;</span><br><span class="line">    <span class="keyword">const</span> promise2 = <span class="keyword">new</span> <span class="keyword">this</span>.constructor(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123; <span class="comment">// 待返回的新的promise实例</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.status === FULFILLED) &#123;</span><br><span class="line"></span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> callbackValue = onFulfilled(<span class="keyword">this</span>.value);</span><br><span class="line">            resolve(callbackValue);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            reject(error) <span class="comment">// 如果出错此次的then方法的回调函数出错，在将错误传递给promise2</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.status === REJECTED) &#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> x = onRejected(<span class="keyword">this</span>.reason);</span><br><span class="line">            resolve(x);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            reject(error);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.status === PENDING) &#123;</span><br><span class="line">        <span class="keyword">this</span>.onFulfilledCallbacks.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> callbackValue = onFulfilled(<span class="keyword">this</span>.value);</span><br><span class="line">            resolve(callbackValue);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            reject(error)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">this</span>.onRejectedCallbacks.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> callbackValue = onRejected(<span class="keyword">this</span>.reason);</span><br><span class="line">            resolve(callbackValue);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            reject(error);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> promise2;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">catch</span>(onRejected) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.then(<span class="literal">null</span>, onRejected);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="macrotask和mirotask"><a href="#macrotask和mirotask" class="headerlink" title="macrotask和mirotask"></a>macrotask和mirotask</h4><p>所谓<code>macroTask</code>（宏任务）是指将任务排到下一个事件循环，<code>microTask</code>（微任务）是指将任务排到当前事件循环的队尾，执行时机会被宏任务更早。Promise的标准里没有规定Promise里的异步该使用哪种，但在node和浏览器的实现里都是使用的<code>miroTask</code>（微任务）</p>
<p>![](../../../../Downloads/进阶/阶段1：基础进阶/1-7 常规面试题/resource/笔记/.\img\2.png)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">let</span> p = <span class="built_in">Promise</span>.resolve(<span class="number">2</span>)</span><br><span class="line">p.then(<span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(val);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>宏任务api包括：<code>setTimeout</code>,<code>setInterval</code>,<code>setImmediate(Node)</code>,<code>requestAnimationFrame(浏览器)</code>,<code>各种IO操作，网络请求</code></p>
<p>微任务api包括：<code>process.nextTick(Node)</code>,<code>MutationObserver（浏览器）</code></p>
<p><code>MutaionObserver</code>演示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> observer = <span class="keyword">new</span> MutationObserver(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">let</span> node = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>)</span><br><span class="line">observer.observe(node, &#123; <span class="comment">// 监听节点</span></span><br><span class="line">  childList: <span class="literal">true</span> <span class="comment">// 一旦改变则触发回调函数 nextTickHandler</span></span><br><span class="line">&#125;)</span><br><span class="line">node.innerHTML = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>利用<code>MutaionObserver</code>封装一个微任务执行函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> nextTick = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> callbacks = []</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">nextTickHandler</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> copies = callbacks.slice(<span class="number">0</span>)</span><br><span class="line">    callbacks = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; copies.length; i++) &#123;</span><br><span class="line">      copies[i]()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> counter = <span class="number">1</span></span><br><span class="line">  <span class="keyword">let</span> observer = <span class="keyword">new</span> MutationObserver(nextTickHandler) <span class="comment">// 声明 MO 和回调函数</span></span><br><span class="line">  <span class="keyword">let</span> node = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>)</span><br><span class="line">  observer.observe(node, &#123; <span class="comment">// 监听节点</span></span><br><span class="line">    childList: <span class="literal">true</span> <span class="comment">// 一旦改变则触发回调函数 nextTickHandler</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    callbacks.push(cb)</span><br><span class="line">    counter = (counter + <span class="number">1</span>) % <span class="number">2</span> <span class="comment">//让节点内容文本在 1 和 0 间切换</span></span><br><span class="line">    node.innerHTML = counter</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="https://supertinypeanut.github.io/blog/2021/03/07/Promise%E5%AE%9E%E7%8E%B0/" data-id="ckmm8va6v001j85qs45n5ctnr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ES6面试题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2021/03/03/ES6%E9%9D%A2%E8%AF%95%E9%A2%98/" class="article-date">
  <time datetime="2021-03-03T22:10:10.000Z" itemprop="datePublished">2021-03-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2021/03/03/ES6%E9%9D%A2%E8%AF%95%E9%A2%98/">ES6面试题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="ES6是什么，为什么要学习它，不学习ES6会怎么样"><a href="#ES6是什么，为什么要学习它，不学习ES6会怎么样" class="headerlink" title="ES6是什么，为什么要学习它，不学习ES6会怎么样?"></a>ES6是什么，为什么要学习它，不学习ES6会怎么样?</h3><p>答：</p>
<p><strong>ES6</strong>是新一代的JS语言标准，对分JS语言核心内容做了<strong>升级优化</strong>，规范了JS使用标准，<strong>新增了JS原生方法</strong>，使得JS使用更加规范，更加优雅，更适合大型应用的开发。</p>
<p>学习ES6是成为专业前端正规军的必经之路。不学习ES6也可以写代码打鬼子，但是最多只能当个游击队长。</p>
<h3 id="ES5、ES6、ES2015的区别"><a href="#ES5、ES6、ES2015的区别" class="headerlink" title="ES5、ES6、ES2015的区别"></a>ES5、ES6、ES2015的区别</h3><p>答：</p>
<p>ES2015特指在2015年发布的新一代JS语言标准，</p>
<p>ES6泛指下一代JS语言标准，包含ES2015、ES2016、ES2017、ES2018等。现阶段在绝大部分场景下，ES2015默认等同ES6。</p>
<p>ES5泛指上一代语言标准。ES2015可以理解为ES5和ES6的时间分界线。<strong>babel是什么，有什么作用?</strong></p>
<p>答：</p>
<p>babel是一个 ES6 转码器，可以将 ES6 代码转为 ES5 代码，以便兼容那些还没支持ES6的平台。</p>
<h3 id="let有什么用，有了var为什么还要用let？"><a href="#let有什么用，有了var为什么还要用let？" class="headerlink" title="let有什么用，有了var为什么还要用let？"></a>let有什么用，有了var为什么还要用let？</h3><p>答：</p>
<p><strong>在ES6之前，声明变量只能用var</strong>，var方式声明变量其实是很不合理的，准确的说，是因为<strong>ES5里面没有块级作用域</strong>是很不合理的，甚至可以说是一个语言层面的bug。</p>
<p>没有块级作用域回来带很多难以理解的问题，比如<strong>for循环var变量泄露，变量覆盖</strong>等问题。</p>
<p><strong>let</strong> 声明的变量拥有自己的<strong>块级作用域</strong>，且修复了<strong>var</strong>声明变量带来的<strong>变量提升</strong>问题。</p>
<h3 id="问：举一些ES6对String字符串类型做的常用升级优化"><a href="#问：举一些ES6对String字符串类型做的常用升级优化" class="headerlink" title="问：举一些ES6对String字符串类型做的常用升级优化?"></a>问：举一些ES6对String字符串类型做的常用升级优化?</h3><p>答：</p>
<p><strong>优化部分：</strong></p>
<p>ES6新增了<code>字符串模板</code>，在拼接大段字符串时，用反斜杠(`)取代以往的字符串相加的形式，能保留所有空格和换行，使得字符串拼接看起来更加直观，更加优雅。</p>
<p><strong>升级部分:</strong></p>
<p>ES6在<code>String</code>原型上新增了<code>includes()</code>方法，用于取代传统的只能用<code>indexOf</code>查找包含字符的方法(indexOf返回-1表示没查到不如includes方法返回false更明确，语义更清晰)</p>
<p>此外还新增了startsWith(), endsWith(), padStart(),padEnd(),repeat()等方法，可方便的用于查找，补全字符串。</p>
<h3 id="举一些ES6对Array数组类型做的常用升级优化"><a href="#举一些ES6对Array数组类型做的常用升级优化" class="headerlink" title="举一些ES6对Array数组类型做的常用升级优化?"></a>举一些ES6对Array数组类型做的常用升级优化?</h3><p>答：</p>
<p><strong>优化部分：</strong></p>
<p><code>数组解构赋值</code>：ES6可以直接以let [a,b,c] = [1,2,3]形式进行变量赋值，在声明较多变量时，不用再写很多let(var),且<code>映射关系清晰</code>，且<code>支持赋默认值</code>。</p>
<p><code>扩展运算符</code>：ES6新增的扩展运算符(…)(重要),可以轻松的<code>实现数组和松散序列的相互转化</code>，可以<code>取代</code>arguments对象和<code>apply方法</code>，轻松获取未知参数个数情况下的参数集合。</p>
<p>（尤其是在ES5中，arguments并不是一个真正的数组，而是一个类数组的对象，但是扩展运算符的逆运算却可以返回一个真正的数组）。</p>
<p>扩展运算符还可以轻松方便的实现数组的复制和解构赋值（let a = [2,3,4]; let b = […a]）。</p>
<p><strong>升级部分:</strong></p>
<p>ES6在Array原型上新增了<code>find()</code>方法，用于取代传统的只能用<code>indexOf</code>查找包含数组项目的方法，且修复了<code>indexOf</code>查找不到NaN的bug([NaN].indexOf(NaN) === -1)，</p>
<p>此外还新增了copyWithin(), includes(), fill(),flat()等方法，可方便的用于字符串的查找，补全,转换等。</p>
<h3 id="举一些ES6对Number数字类型做的常用升级优化"><a href="#举一些ES6对Number数字类型做的常用升级优化" class="headerlink" title="举一些ES6对Number数字类型做的常用升级优化?"></a>举一些ES6对Number数字类型做的常用升级优化?</h3><p>答：</p>
<p><strong>优化部分：</strong></p>
<p>ES6在Number原型上新增了<code>isFinite()</code>, <code>isNaN\()</code>方法，用来取代传统的全局<code>isFinite()</code>, <code>isNaN()</code>方法检测数值是否有限、是否是NaN。</p>
<p>ES5的<code>isFinite()</code>, <code>isNaN()</code>方法都会先将非数值类型的参数转化为<code>Number</code>类型再做判断 这其实是不合理的</p>
<blockquote>
<p>最造成isNaN(‘NaN’) === true的奇怪行为–’NaN’是一个字符串，但是isNaN却说这就是NaN。</p>
</blockquote>
<p>而<code>Number.isFinite()</code>和<code>Number.isNaN()</code>则不会有此类问题(<code>Number.isNaN(&#39;NaN&#39;) === false</code>)。（isFinite()同上）</p>
<p><strong>升级部分:</strong></p>
<p>ES6在Math对象上新增了Math.cbrt()，trunc()，hypot()等等较多的科学计数法运算方法，可以更加全面的进行立方根、求和立方根等等科学计算。</p>
<h3 id="举一些ES6对Object类型做的常用升级优化-重要"><a href="#举一些ES6对Object类型做的常用升级优化-重要" class="headerlink" title="举一些ES6对Object类型做的常用升级优化?(重要)"></a>举一些ES6对Object类型做的常用升级优化?(重要)</h3><p>答：</p>
<p><strong>优化部分：</strong></p>
<p>1.对象属性变量式声明：ES6可以直接以变量形式声明对象属性或者方法，比传统的键值对形式声明更加简洁，更加方便，语义更加清晰。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">let</span> [apple, orange] = [<span class="string">'red appe'</span>, <span class="string">'yellow orange'</span>];</span><br><span class="line"><span class="built_in">let</span> myFruits = &#123;apple, orange&#125;;    // <span class="built_in">let</span> myFruits = &#123;apple: <span class="string">'red appe'</span>, orange: <span class="string">'yellow orange'</span>&#125;;</span><br></pre></td></tr></table></figure>

<p>尤其在对象解构赋值(见优化部分2.)或者模块输出变量时，这种写法的好处体现的最为明显:</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let &#123;<span class="keyword">keys</span>, <span class="keyword">values</span>, entries&#125; = Object;</span><br><span class="line">let MyOwnMethods = &#123;<span class="keyword">keys</span>, <span class="keyword">values</span>, entries&#125;; <span class="regexp">//</span> let MyOwnMethods = &#123;<span class="keyword">keys</span>: <span class="keyword">keys</span>, <span class="keyword">values</span>: <span class="keyword">values</span>, entries: entries&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到属性变量式声明属性看起来更加简洁明了。方法也可以采用简洁写法：</p>
<figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">let es5Fun = &#123;</span><br><span class="line">  <span class="function"><span class="keyword">method</span>:</span> <span class="function"><span class="keyword">function</span>(</span>)&#123;&#125;</span><br><span class="line">&#125;; </span><br><span class="line">let es6Fun = &#123;</span><br><span class="line">  <span class="function"><span class="keyword">method</span>(</span>)&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.对象的解构赋值：ES6对象也可以像数组解构赋值那样，进行变量的解构赋值：</p>
<figure class="highlight sml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123;apple, orange&#125; = &#123;apple: <span class="symbol">'red</span> appe', orange: <span class="symbol">'yellow</span> orange'&#125;;</span><br></pre></td></tr></table></figure>

<p>3.对象的扩展运算符(…)：ES6对象的扩展运算符和数组扩展运算符用法本质上差别不大，毕竟数组也就是特殊的对象。</p>
<p>对象的扩展运算符一个最常用也最好用的用处就在于可以轻松的取出一个目标对象内部全部或者部分的可遍历属性，从而进行对象的合并和分解。</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123;apple, orange, <span class="params">...</span>otherFruits&#125; = &#123;apple: <span class="string">'red apple'</span>, orange: <span class="string">'yellow orange'</span>, grape: <span class="string">'purple grape'</span>, peach: <span class="string">'sweet peach'</span>&#125;; </span><br><span class="line"><span class="comment">// otherFruits  &#123;grape: 'purple grape', peach: 'sweet peach'&#125;</span></span><br><span class="line"><span class="comment">// 注意: 对象的扩展运算符用在解构赋值时，扩展运算符只能用在最有一个参数(otherFruits后面不能再跟其他参数)</span></span><br><span class="line"><span class="keyword">let</span> moreFruits = &#123;watermelon: <span class="string">'nice watermelon'</span>&#125;;</span><br><span class="line"><span class="keyword">let</span> allFruits = &#123;apple, orange, <span class="params">...</span>otherFruits, <span class="params">...</span>moreFruits&#125;;</span><br></pre></td></tr></table></figure>

<p>4.super 关键字：ES6在Class类里新增了类似this的关键字super。同this总是指向当前函数所在的对象不同，super关键字总是指向当前函数所在对象的原型对象。</p>
<p><strong>升级部分:</strong></p>
<p>1.ES6在Object原型上新增了<code>is()</code>方法，做两个目标对象的相等比较，用来完善’<code>===</code>‘方法。</p>
<blockquote>
<p>‘===’方法中NaN === NaN //false其实是不合理的，Object.is修复了这个小bug。(Object.is(NaN, NaN) // true)</p>
</blockquote>
<p>2.ES6在Object原型上新增了assign()方法，用于对象新增属性或者多个对象合并。</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> target = &#123; a: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> source1 = &#123; b: <span class="number">2</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> source2 = &#123; c: <span class="number">3</span> &#125;;</span><br><span class="line">Object.assign(target, source1, source2);</span><br><span class="line">target <span class="comment">// &#123;a:1, b:2, c:3&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>注意:</strong></p>
<p><code>assign</code>合并的对象<code>target</code>只能合并<code>source1</code>、<code>source2</code>中的自身属性。</p>
<p>并不会合并<code>source1、source2</code>中的继承属性，也不会合并不可枚举的属性，且无法正确复制<code>get</code>和<code>set</code>属性（会直接执行get/set函数，取return的值）。</p>
<p>3.ES6在Object原型上新增了<code>getOwnPropertyDescriptors()</code>方法，此方法增强了ES5中<code>getOwnPropertyDescriptor()</code>方法，可以获取指定对象所有自身属性的描述对象。</p>
<p>结合<code>defineProperties()</code>方法，可以完美复制对象，包括复制get和set属性。</p>
<p>4.ES6在Object原型上新增了<code>getPrototypeOf()</code>和<code>setPrototypeOf()</code>方法，用来获取或设置当前对象的<code>prototype</code>对象。</p>
<p>这个方法存在的意义在于，ES5中获取设置prototype对像是通过<strong>proto</strong>属性来实现的，</p>
<p>然而<strong>proto</strong>属性并不是ES规范中的明文规定的属性，只是浏览器各大产商“私自”加上去的属性，只不过因为适用范围广而被默认使用了，再非浏览器环境中并不一定就可以使用.</p>
<p>所以为了稳妥起见，获取或设置当前对象的prototype对象时，都应该采用ES6新增的标准用法。</p>
<p>5.ES6在Object原型上还新增了<code>Object.keys()，Object.values()，Object.entries()</code>方法，用来获取对象的所有键、所有值和所有键值对数组。</p>
<h3 id="举一些ES6对Function函数类型做的常用升级优化-重要"><a href="#举一些ES6对Function函数类型做的常用升级优化-重要" class="headerlink" title="举一些ES6对Function函数类型做的常用升级优化?(重要)"></a>举一些ES6对Function函数类型做的常用升级优化?(重要)</h3><p>答：</p>
<p>1.箭头函数(核心)：箭头函数是ES6核心的升级项之一，箭头函数里没有自己的this,这改变了以往JS函数中最让人难以理解的this运行机制。</p>
<p><strong>主要优化点:</strong></p>
<p><strong>箭头函数内的this指向的是函数定义时所在的对象，而不是函数执行时所在的对象</strong>。</p>
<p><strong>ES5函数里的this总是指向函数执行时所在的对象</strong>，这使得在很多情况下this的指向变得很难理解，尤其是非严格模式情况下，this有时候会指向全局对象，这甚至也可以归结为语言层面的bug之一。</p>
<p><strong>ES6的箭头函数优化了这一点，它的内部没有自己的this,这也就导致了this总是指向上一层的this，如果上一层还是箭头函数，则继续向上指，直到指向到有自己this的函数为止，并作为自己的this；</strong></p>
<p><strong>箭头函数不能用作构造函数，因为它没有自己的this，无法实例化；</strong>也是<strong>因为箭头函数没有自己的this,所以箭头函数 内也不存在arguments对象</strong>。（可以用扩展运算符代替）</p>
<p>2.<strong>函数默认赋值</strong>：ES6之前，函数的形参是无法给默认值得，只能在函数内部通过变通方法实现。ES6以更简洁更明确的方式进行函数默认赋值。</p>
<figure class="highlight gml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function es6Fuc (<span class="symbol">x</span>, <span class="symbol">y</span> = <span class="string">'default'</span>) &#123;</span><br><span class="line">    console.log(<span class="symbol">x</span>, <span class="symbol">y</span>);</span><br><span class="line">&#125;</span><br><span class="line">es6Fuc(<span class="number">4</span>) <span class="comment">// 4, default</span></span><br></pre></td></tr></table></figure>

<p><strong>升级部分:</strong></p>
<p>ES6新增了双冒号运算符，用来取代以往的bind，call,和apply。(浏览器暂不支持，Babel已经支持转码)</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">foo</span>::bar;</span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line"><span class="selector-tag">bar</span><span class="selector-class">.bind</span>(foo);</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">foo</span><span class="selector-pseudo">::bar(...arguments)</span>;</span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line"><span class="selector-tag">bar</span><span class="selector-class">.apply</span>(foo, arguments);</span><br></pre></td></tr></table></figure>

<h3 id="Symbol是什么，有什么作用？"><a href="#Symbol是什么，有什么作用？" class="headerlink" title="Symbol是什么，有什么作用？"></a>Symbol是什么，有什么作用？</h3><p>答：</p>
<p>Symbol是ES6引入的<code>第七种</code>原始数据类型（说法不准确，应该是第七种数据类型，Object不是原始数据类型之一，已更正），<br>所有Symbol()生成的值都是独一无二的，可以从根本上解决对象属性太多导致属性名冲突覆盖的问题。<br>对象中Symbol()属性不能被for…in遍历，但是也不是私有属性。</p>
<h3 id="Set是什么，有什么作用？"><a href="#Set是什么，有什么作用？" class="headerlink" title="Set是什么，有什么作用？"></a>Set是什么，有什么作用？</h3><p>答：</p>
<p><code>Set</code>是ES6引入的一种类似Array的新的数据结构，Set实例的成员类似于数组item成员</p>
<p><code>区别</code>是Set实例的成员都是唯一，不重复的。这个特性可以轻松地实现数组去重。</p>
<h3 id="Map是什么，有什么作用？"><a href="#Map是什么，有什么作用？" class="headerlink" title="Map是什么，有什么作用？"></a>Map是什么，有什么作用？</h3><p>答：</p>
<p><code>Map</code>是ES6引入的一种类似<code>Object</code>的新的数据结构。<br><code>Map</code>可以理解为是<code>Object</code>的超集，<strong>打破了以传统键值对形式定义对象，对象的key不再局限于字符串，也可以是Object</strong>。可以更加全面的描述对象的属性。</p>
<h3 id="Proxy是什么，有什么作用？"><a href="#Proxy是什么，有什么作用？" class="headerlink" title="Proxy是什么，有什么作用？"></a>Proxy是什么，有什么作用？</h3><p>答：</p>
<p><code>Proxy</code>是ES6新增的一个构造函数，可以理解为JS语言的一个代理，<strong>用来改变JS默认的一些语言行为</strong>，包括拦截默认的<strong>get/set</strong>等底层方法，使得JS的使用自由度更高，可以最大限度的满足开发者的需求。</p>
<p>比如通过拦截对象的<strong>get/set</strong>方法，可以轻松地定制自己想要的<strong>key或者value</strong>。<br>下面的例子可以看到，随便定义一个myOwnObj的key,都可以变成自己想要的函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createMyOwnObj</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//想把所有的key都变成函数，或者Promise,或者anything</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line">    <span class="keyword">get</span>(target, propKey, receiver) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">let</span> randomBoolean = <span class="built_in">Math</span>.random() &gt; <span class="number">0.5</span>;</span><br><span class="line">          <span class="keyword">let</span> Message;</span><br><span class="line">          <span class="keyword">if</span> (randomBoolean) &#123;</span><br><span class="line">            Message = <span class="string">`你的<span class="subst">$&#123;propKey&#125;</span>运气不错，成功了`</span>;</span><br><span class="line">            resolve(Message);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Message = <span class="string">`你的<span class="subst">$&#123;propKey&#125;</span>运气不行，失败了`</span>;</span><br><span class="line">            reject(Message);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myOwnObj = createMyOwnObj();</span><br><span class="line"></span><br><span class="line">myOwnObj.hahaha.then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(result) <span class="comment">//你的hahaha运气不错，成功了</span></span><br><span class="line">&#125;).catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(error) <span class="comment">//你的hahaha运气不行，失败了</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">myOwnObj.wuwuwu.then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(result) <span class="comment">//你的wuwuwu运气不错，成功了</span></span><br><span class="line">&#125;).catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(error) <span class="comment">//你的wuwuwu运气不行，失败了</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="Reflect是什么，有什么作用？"><a href="#Reflect是什么，有什么作用？" class="headerlink" title="Reflect是什么，有什么作用？"></a>Reflect是什么，有什么作用？</h3><p>答：</p>
<p><code>Reflect</code>是ES6引入的一个新的对象，他的主要作用有两点：</p>
<ul>
<li>一是将原生的一些零散分布在Object、Function或者全局函数里的方法(如apply、delete、get、set等等)，统一整合到Reflect上，这样可以更加方便更加统一的管理一些原生API；</li>
<li>二就是因为Proxy可以改写默认的原生API，如果一旦原生API别改写可能就找不到了，<br>所以Reflect也可以起到备份原生API的作用，使得即使原生API被改写了之后，也可以在被改写之后的API用上默认的API。</li>
</ul>
<h3 id="Promise是什么，有什么作用？"><a href="#Promise是什么，有什么作用？" class="headerlink" title="Promise是什么，有什么作用？"></a>Promise是什么，有什么作用？</h3><p>答：</p>
<p>Promise是ES6引入的一个新的对象，他的主要作用是用来解决JS异步机制里，回调机制产生的“回调地狱”。</p>
<p>它并不是什么突破性的API，只是封装了异步回调形式，使得异步回调可以写的更加优雅，可读性更高，而且可以链式调用。</p>
<h3 id="Iterator是什么，有什么作用？-重要"><a href="#Iterator是什么，有什么作用？-重要" class="headerlink" title="Iterator是什么，有什么作用？(重要)"></a>Iterator是什么，有什么作用？(重要)</h3><p>答：</p>
<p><code>Iterator</code>是ES6中一个很重要概念，它并不是对象，也不是任何一种数据类型。</p>
<p>因为ES6新增了<code>Set、Map</code>类型，他们和Array、Object类型很像，Array、Object都是可以遍历的，但是Set、Map都不能用for循环遍历，解决这个问题有两种方案：</p>
<p>一种是为Set、Map单独新增一个用来遍历的API。</p>
<p>另一种是为Set、Map、Array、Object新增一个统一的遍历API。</p>
<p>显然，第二种更好，ES6也就顺其自然的需要一种设计标准，来统一所有可遍历类型的遍历方式。</p>
<p><code>Iterator</code>正是这样一种标准。或者说是一种规范理念。<br>就好像JavaScript是ECMAScript标准的一种具体实现一样，Iterator标准的具体实现是Iterator遍历器。</p>
<p><code>Iterator</code>标准规定，所有部署了key值为[Symbol.iterator]，且[Symbol.iterator]的value是标准的Iterator接口函数(标准的Iterator接口函数:</p>
<p>该函数必须返回一个对象，且对象中包含next方法，且执行next()能返回包含value/done属性的Iterator对象)的对象，都称之为可遍历对象，next()后返回的Iterator对象也就是Iterator遍历器。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// obj就是可遍历的，因为它遵循了Iterator标准，且包含[Symbol.iterator]方法，方法函数也符合标准的Iterator接口规范。</span><br><span class="line">// obj.[<span class="string">Symbol.iterator</span>](<span class="link"></span>) 就是Iterator遍历器</span><br><span class="line">let obj = &#123;</span><br><span class="line">  data: [ 'hello', 'world' ],</span><br><span class="line">  [<span class="string">Symbol.iterator</span>](<span class="link"></span>) &#123;</span><br><span class="line"><span class="code">    const self = this;</span></span><br><span class="line"><span class="code">    let index = 0;</span></span><br><span class="line"><span class="code">    return &#123;</span></span><br><span class="line"><span class="code">      next() &#123;</span></span><br><span class="line"><span class="code">        if (index &lt; self.data.length) &#123;</span></span><br><span class="line"><span class="code">          return &#123;</span></span><br><span class="line"><span class="code">            value: self.data[index++],</span></span><br><span class="line"><span class="code">            done: false</span></span><br><span class="line"><span class="code">          &#125;;</span></span><br><span class="line"><span class="code">        &#125; else &#123;</span></span><br><span class="line"><span class="code">          return &#123; value: undefined, done: true &#125;;</span></span><br><span class="line"><span class="code">        &#125;</span></span><br><span class="line"><span class="code">      &#125;</span></span><br><span class="line"><span class="code">    &#125;;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ES6给Set、Map、Array、String都加上了[Symbol.iterator]方法，</p>
<p>且[Symbol.iterator]方法函数也符合标准的Iterator接口规范，<br>所以Set、Map、Array、String默认都是可以遍历的。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// Array</span><br><span class="line">let array = ['red', 'green', 'blue'];</span><br><span class="line">array[<span class="string">Symbol.iterator</span>](<span class="link"></span>) //Iterator遍历器</span><br><span class="line">array[<span class="string">Symbol.iterator</span>](<span class="link"></span>).next() //&#123;value: "red", done: false&#125;</span><br><span class="line"></span><br><span class="line">// String</span><br><span class="line">let string = '1122334455';</span><br><span class="line">string[<span class="string">Symbol.iterator</span>](<span class="link"></span>) //Iterator遍历器</span><br><span class="line">string[<span class="string">Symbol.iterator</span>](<span class="link"></span>).next() //&#123;value: "1", done: false&#125;</span><br><span class="line"></span><br><span class="line">// set</span><br><span class="line">let set = new Set(['red', 'green', 'blue']);</span><br><span class="line">set[<span class="string">Symbol.iterator</span>](<span class="link"></span>) //Iterator遍历器</span><br><span class="line">set[<span class="string">Symbol.iterator</span>](<span class="link"></span>).next() //&#123;value: "red", done: false&#125;</span><br><span class="line"></span><br><span class="line">// Map</span><br><span class="line">let map = new Map();</span><br><span class="line">let obj= &#123;map: 'map'&#125;;</span><br><span class="line">map.set(obj, 'mapValue');</span><br><span class="line">map[<span class="string">Symbol.iterator</span>](<span class="link"></span>).next()  &#123;value: Array(2), done: false&#125;</span><br></pre></td></tr></table></figure>

<h3 id="for…in-和for…of有什么区别？"><a href="#for…in-和for…of有什么区别？" class="headerlink" title="for…in 和for…of有什么区别？"></a>for…in 和for…of有什么区别？</h3><p>答：</p>
<p>如果看到上个问题，那么就很好回答。<br>问题十六提到了ES6统一了遍历标准，制定了可遍历对象，那么用什么方法去遍历呢？</p>
<p>答案就是用for…of。ES6规定，有所部署了载了Iterator接口的对象(可遍历对象)都可以通过for…of去遍历，而for..in仅仅可以遍历对象。</p>
<p>这也就意味着，<strong>数组也可以用for…of遍历</strong>，这极大地方便了数组的取值，且避免了很多程序用for..in去遍历数组的恶习。</p>
<p>上面提到的扩展运算符本质上也就是for..of循环的一种实现。</p>
<h3 id="Generator函数是什么，有什么作用？"><a href="#Generator函数是什么，有什么作用？" class="headerlink" title="Generator函数是什么，有什么作用？"></a>Generator函数是什么，有什么作用？</h3><p>答：</p>
<p>如果说JavaScript是ECMAScript标准的一种具体实现、<code>Iterator</code>遍历器是<code>Iterator</code>的具体实现，那么<code>Generator</code>函数可以说是Iterator接口的具体实现方式。</p>
<p>执行Generator函数会返回一个遍历器对象，每一次<code>Generator</code>函数里面的yield都相当一次遍历器对象的<code>next()</code>方法，并且可以通过<code>next(value)</code>方法传入自定义的<code>value</code>,来改变<code>Generator</code>函数的行为。</p>
<p>Generator函数可以通过配合Thunk 函数更轻松更优雅的实现异步编程和控制流管理。</p>
<h3 id="async函数是什么，有什么作用？"><a href="#async函数是什么，有什么作用？" class="headerlink" title="async函数是什么，有什么作用？"></a>async函数是什么，有什么作用？</h3><p>答：</p>
<p>async函数可以理解为内置自动执行器的Generator函数语法糖，它配合ES6的Promise近乎完美的实现了异步编程解决方案。</p>
<h3 id="Class、extends是什么，有什么作用？"><a href="#Class、extends是什么，有什么作用？" class="headerlink" title="Class、extends是什么，有什么作用？"></a>Class、extends是什么，有什么作用？</h3><p>答：</p>
<p>ES6 的class可以看作只是一个ES5生成实例对象的构造函数的语法糖。</p>
<p>它参考了java语言，定义了一个类的概念，让对象原型写法更加清晰，对象实例化更像是一种面向对象编程。Class类可以通过extends实现继承。</p>
<p>它和ES5构造函数的不同点：<br>类的内部定义的所有方法，都是不可枚举的；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// ES5</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ES5Fun</span> (<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.x = x;</span><br><span class="line">  <span class="keyword">this</span>.y = y;</span><br><span class="line">&#125;</span><br><span class="line">ES5Fun.prototype.toString = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="string">'('</span> + <span class="keyword">this</span>.x + <span class="string">', '</span> + <span class="keyword">this</span>.y + <span class="string">')'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> p = <span class="keyword">new</span> ES5Fun(<span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line">p.toString();</span><br><span class="line"><span class="built_in">Object</span>.keys(ES5Fun.prototype); <span class="comment">//['toString']</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ES6</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ES6Fun</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> (x, y) &#123;</span><br><span class="line">    <span class="keyword">this</span>.x = x;</span><br><span class="line">    <span class="keyword">this</span>.y = y;</span><br><span class="line">  &#125;</span><br><span class="line">  toString () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'('</span> + <span class="keyword">this</span>.x + <span class="string">', '</span> + <span class="keyword">this</span>.y + <span class="string">')'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.keys(ES6Fun.prototype); <span class="comment">//[]</span></span><br></pre></td></tr></table></figure>

<p>ES6的class类必须用new命令操作，而ES5的构造函数不用new也可以执行；</p>
<p>ES6的class类不存在变量提升，必须先定义class之后才能实例化，不像ES5中可以将构造函数写在实例化之后；</p>
<p>ES5 的继承，实质是先创造子类的实例对象this，然后再将父类的方法添加到this上面。</p>
<p>ES6 的继承机制完全不同，实质是先将父类实例对象的属性和方法，加到this上面（所以必须先调用super方法），然后再用子类的构造函数修改this。</p>
<h3 id="module、export、import是什么，有什么作用？"><a href="#module、export、import是什么，有什么作用？" class="headerlink" title="module、export、import是什么，有什么作用？"></a>module、export、import是什么，有什么作用？</h3><p>答：</p>
<p>module、export、import是ES6用来统一前端模块化方案的设计思路和实现方案。</p>
<p>export、import的出现统一了前端模块化的实现方案，整合规范了浏览器/服务端的模块化方法，</p>
<p>之后用来取代传统的AMD/CMD、requireJS、seaJS、commondJS等等一系列前端模块不同的实现方案，使前端模块化更加统一规范，JS也能更加能实现大型的应用程序开发。</p>
<blockquote>
<p>import引入的模块是静态加载（编译阶段加载）而不是动态加载（运行时加载）。</p>
</blockquote>
<blockquote>
<p>import引入export导出的接口值是动态绑定关系，即通过该接口，可以取到模块内部实时的值。</p>
</blockquote>
<h3 id="日常前端代码开发中，有哪些值得用ES6去改进的编程优化或者规范？"><a href="#日常前端代码开发中，有哪些值得用ES6去改进的编程优化或者规范？" class="headerlink" title="日常前端代码开发中，有哪些值得用ES6去改进的编程优化或者规范？"></a>日常前端代码开发中，有哪些值得用ES6去改进的编程优化或者规范？</h3><p>答：</p>
<p>常用箭头函数来取代的做法；</p>
<ol>
<li><p>常用let取代var命令；</p>
<p>常用数组/对象的结构赋值来命名变量，结构更清晰，语义更明确，可读性更好；</p>
<p>在长字符串多变量组合场合，用模板字符串来取代字符串累加，能取得更好地效果和阅读体验；</p>
<p>用Class类取代传统的构造函数，来生成实例化对象；</p>
<p>在大型应用开发中，要保持module模块化开发思维，分清模块之间的关系，常用import、export方法。</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://supertinypeanut.github.io/blog/2021/03/03/ES6%E9%9D%A2%E8%AF%95%E9%A2%98/" data-id="ckmm8va91002485qsc7kn2xm7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/ECMAScript-6/" rel="tag">ECMAScript 6</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-自动化测试" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2021/01/25/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" class="article-date">
  <time datetime="2021-01-25T00:11:00.000Z" itemprop="datePublished">2021-01-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2021/01/25/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/">自动化测试</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>为什么需要自动化测试？</strong></p>
<p>项目经过不断的开发，最终肯定会趋于稳定，在<strong>适当的时机下</strong>引入自动化测试能及早发现问题，<strong>保证产品的质量</strong>。</p>
<p>测试作为完整的开发流程中最后的一环，是保证产品质量重要的一环。而前端测试一般在产品开发流程中属于偏后的环节，在整个开发架构中属于较高层次，前端测试更加偏向于 GUI 的特性，因此前端的测试难度很大。</p>
<p>测试的目的：</p>
<ul>
<li>有利于写出高质量的代码，尽早发现问题</li>
<li>有利于代码的扩展</li>
<li>有利于代码的维护</li>
</ul>
<h2 id="前端自动化测试"><a href="#前端自动化测试" class="headerlink" title="前端自动化测试"></a>前端自动化测试</h2><p>测试是一个庞大的主题，包括各种分类的测试，诸如黑盒测试/白盒测试、单元测试/集成测试/端到端测试等。通常程序员在测试自己的代码的时候用得最多的便是单元测试，但是因为测试也是需要代价，很多人是不喜欢写测试的，甚至是一点都不写。</p>
<p>那么是什么原因让大家不愿意写呢？</p>
<ol>
<li>不熟悉</li>
<li>浪费时间</li>
<li>知识不成体系</li>
<li>团队氛围</li>
<li>缺少实践</li>
</ol>
<p>我们要从基础的东西学起，打消对测试的恐惧。</p>
<h3 id="测试的分类"><a href="#测试的分类" class="headerlink" title="测试的分类"></a>测试的分类</h3><p>在多浏览器的自动化测试，我们多半是进行端到端的测试工作，一小部分是大粒度的单元测试。端到端测试测试模拟用户的行为。在 Web 应用程序中，他们会启动服务器，打开浏览器，模拟用户的行为进行点击、输入、提交等动作，断言浏览器中发生了特定的事情或者是得到了期待的结果，从而让我们相信功能可以正常的运行。</p>
<p>而单元测试根据代码单元的公共 API 运行它们。这些测试需要创建一个类的实例，使用特定的输入调用它的方法，断言被调用的方法达到了预期的效果。在下文中我们会看到这两种测试的实践，当然有时候区分度并不大，可能无法明显地区分哪些是端对端测试哪些是单元测试，有时候他们是混合起来的，不过只要记住我们的目标是保证功能可以正常运行救足够了。</p>
<p>按照软件工程自底而上的概念，前端测试一般分为单元测试（Unit Testing ）、集成测试（Integration Testing）和端到端测试（E2E Testing）。从下面的图可以看出，从底向上测试的复杂度将不断提高，另一方面测试的收益反而不断降低的。</p>
<p><img src="/blog/.io//16415de723a8d411.png" alt="img"></p>
<blockquote>
<p>关于软件测试分类，可见<a href="#软件测试的分类">软件测试的分类</a></p>
</blockquote>
<h3 id="测试工具对比"><a href="#测试工具对比" class="headerlink" title="测试工具对比"></a>测试工具对比</h3><p>在进行项目实践前，很重要的一项工作是选择合适的技术栈。好比在前端开发时应该选择 React，Vue 还是 Angular 作为框架一样，前端的测试工作也需要选择一套技术栈。很多时候大家在制定技术栈时容易走偏，在选择技术框架时不是选择最合适的框架，而是选择最热门的框架。当然一定程度上热门的框架能反应其受欢迎程度，可能是因为其出众的优点，如较高的开发效率、高效的渲染特性或者是活跃的社区。在前端开发中，很容易有这样的感受，就是只要半个月没有关注业界的最新动态，就感觉恍若隔世，新的解决方案层出不穷，让人喘不过气。</p>
<p>经过几年的前端洗礼之后，就已经过了慌乱的年纪，再也不会盲目地追寻新技术，而转向关注技术背后解决的痛点，原理等。</p>
<p><img src="/blog/.io//v2-af09ebe8167f63a49ea49287fe04526f_hd-20190706122102737.jpg" alt="img"></p>
<h4 id="如何选择测试框架"><a href="#如何选择测试框架" class="headerlink" title="如何选择测试框架"></a>如何选择测试框架</h4><p>测试框架基本上都做了一件事儿：</p>
<ul>
<li>描述你要测试的东西</li>
<li>对其进行测试</li>
<li>判断是否符合预期</li>
</ul>
<p>选择框架会考虑下面的点：</p>
<ul>
<li><p>测试框架是否有简明的语法与文档。</p>
<p>Mocha、Jasmine、Jest、AVA、Karma、Nightmare</p>
</li>
<li><p>断言(Assertions)：用于判断结果是否符合预期。有些框架需要单独的断言库。</p>
<p>Should.js、chai、expect.js 等等，断言库提供了很多语义化的方法来对值做各种各样的判断。当然也可以不用断言库，Node.js 中也可以直接使用原生 assert 库。</p>
</li>
<li><p>适合 TDD / BDD：是否适合 测试驱动型 / 行为驱动型 的测试风格。</p>
<blockquote>
<p>BDD(Bebavior Driven Developement，行为驱动测试)和 TDD(Testing Driven Developement，测试驱动开发)</p>
</blockquote>
<p>BDD 和 TDD 均有各自的适用场景，BDD 一般更偏向于系统功能和业务逻辑的自动化测试设计，而 TDD 在快速开发并测试功能模块的过程中则更加高效，以快速完成开发为目的。下面我们看下 BDD 和 TDD 具体的特点：</p>
<p>BDD 的特点：</p>
<ul>
<li>从业务逻辑的角度定义具体的输入与预期输出，以及可衡量的目标；</li>
<li>尽可能覆盖所有的测试用例情况；</li>
<li>描述一系列可执行的行为，根据业务的分析来定义预期输出。例如，expect, should, assert；</li>
<li>设定关键的测试通过节点输出提示，便于测试人员理解；</li>
<li>最大程度的交付出符合用户期望的产品，避免输出不一致带来的问题。</li>
</ul>
<p>TDD 的特点：</p>
<ul>
<li>需求分析，快速编写对应的输入输出测试脚本；</li>
<li><strong>仅在自动测试失败时才编写新代码</strong>。</li>
<li>重构去除不必要的依赖关系，然后重复测试，最终让程序符合所有要求。</li>
</ul>
</li>
<li><p>异步测试：有些框架对异步测试支持良好。</p>
</li>
<li><p>使用的语言：大部分 js 测试框架使用 js。</p>
</li>
<li><p>用于特定目的：每个框架可能会擅长处理不同的问题。</p>
<p>是要测试单个功能、单个组件、还是集成化测试？</p>
<p>是要测试 GUI 逻辑、交互？</p>
<p>是要测试非功能性指标？兼容性？</p>
</li>
<li><p>社区是否活跃。</p>
</li>
</ul>
<h4 id="测试工具的类型"><a href="#测试工具的类型" class="headerlink" title="测试工具的类型"></a>测试工具的类型</h4><p>测试工具可分为以下功能。有些只为我们提供了一种功能，有些功能为我们提供了一种组合。</p>
<p>为了实现最灵活的集合功能，通常使用多种工具的组合。</p>
<ul>
<li><p>提供 UI 界面或者 CLI 工具：（<a href="https://karma-runner.github.io/" target="_blank" rel="noopener">Karma</a>，<a href="http://jasmine.github.io/" target="_blank" rel="noopener">Jasmine</a>，<a href="https://facebook.github.io/jest/" target="_blank" rel="noopener">Jest</a>，<a href="https://github.com/DevExpress/testcafe" target="_blank" rel="noopener">TestCafe</a>，<a href="https://www.cypress.io/" target="_blank" rel="noopener">Cypress</a>）</p>
<p><strong>CLI 工具</strong>会给出一系列测试，以及运行这些测试所需的各种配置和脚手架（运行什么浏览器，使用什么 babel 插件，如何格式化输出等）</p>
</li>
<li><p>提供测试框架（形成文件目录）：(<a href="https://mochajs.org/" target="_blank" rel="noopener">Mocha</a>, <a href="http://jasmine.github.io/" target="_blank" rel="noopener">Jasmine</a>, <a href="https://facebook.github.io/jest/" target="_blank" rel="noopener">Jest</a>, <a href="https://github.com/cucumber/cucumber-js" target="_blank" rel="noopener">Cucumber</a>, <a href="https://github.com/DevExpress/testcafe" target="_blank" rel="noopener">TestCafe</a>, <a href="https://www.cypress.io/" target="_blank" rel="noopener">Cypress</a>)</p>
</li>
<li><p>提供断言：（<a href="http://chaijs.com/" target="_blank" rel="noopener">Chai</a>，<a href="http://jasmine.github.io/" target="_blank" rel="noopener">Jasmine</a>，<a href="https://facebook.github.io/jest/" target="_blank" rel="noopener">Jest</a>，<a href="http://unexpected.js.org/" target="_blank" rel="noopener">Unexpected</a>，<a href="https://github.com/DevExpress/testcafe" target="_blank" rel="noopener">TestCafe</a>，<a href="https://www.cypress.io/" target="_blank" rel="noopener">Cypress</a>）</p>
<p><strong>断言函数</strong>检查测试返回的结果是否符合预期</p>
</li>
<li><p>生成，展示测试结果（<a href="https://mochajs.org/" target="_blank" rel="noopener">Mocha</a>，<a href="http://jasmine.github.io/" target="_blank" rel="noopener">Jasmine</a>，<a href="https://facebook.github.io/jest/" target="_blank" rel="noopener">Jest</a>，<a href="https://karma-runner.github.io/" target="_blank" rel="noopener">Karma</a>，<a href="https://github.com/DevExpress/testcafe" target="_blank" rel="noopener">TestCafe</a>，<a href="https://www.cypress.io/" target="_blank" rel="noopener">Cypress</a>）</p>
</li>
<li><p>快照测试（<a href="https://facebook.github.io/jest/" target="_blank" rel="noopener">Jest</a>，<a href="https://github.com/avajs/ava" target="_blank" rel="noopener">Ava</a>）</p>
<p>快照测试(snapshot testing)，测试 UI 或数据结构是否和之前完全一致，通常 UI 测试不在单元测试中</p>
</li>
<li><p>提供仿真（<a href="http://sinonjs.org/" target="_blank" rel="noopener">Sinon</a>，<a href="http://jasmine.github.io/" target="_blank" rel="noopener">Jasmine</a>，<a href="http://airbnb.io/enzyme/docs/api/" target="_blank" rel="noopener">enzyme</a>，<a href="https://facebook.github.io/jest/" target="_blank" rel="noopener">Jest</a>，<a href="https://testdouble.com/" target="_blank" rel="noopener">testdouble</a>）</p>
<p>仿真(mocks, spies, and stubs)：获取方法的调用信息，模拟方法，模块，甚至服务器</p>
</li>
<li><p>生成测试覆盖率报告 (<a href="https://gotwarlost.github.io/istanbul/" target="_blank" rel="noopener">Istanbul</a>, <a href="https://facebook.github.io/jest/" target="_blank" rel="noopener">Jest</a>, <a href="http://blanketjs.org/" target="_blank" rel="noopener">Blanket</a>)</p>
</li>
<li><p>提供类浏览器环境(<a href="http://nightwatchjs.org/" target="_blank" rel="noopener">Nightwatch</a>, <a href="http://www.nightmarejs.org/" target="_blank" rel="noopener">Nightmare</a>, <a href="http://phantomjs.org/" target="_blank" rel="noopener">Phantom</a><strong>,</strong> <a href="https://github.com/GoogleChrome/puppeteer" target="_blank" rel="noopener">Puppeteer</a>, <a href="https://github.com/DevExpress/testcafe" target="_blank" rel="noopener">TestCafe</a>, <a href="https://www.cypress.io/" target="_blank" rel="noopener">Cypress</a>)</p>
</li>
<li><p>可视化回归工具(<a href="https://applitools.com/" target="_blank" rel="noopener">Applitools</a>, <a href="https://percy.io/" target="_blank" rel="noopener">Percy</a>, <a href="http://bbc-news.github.io/wraith/" target="_blank" rel="noopener">Wraith</a>, <a href="https://github.com/webdriverio-boneyard/webdrivercss" target="_blank" rel="noopener">WebdriverCSS</a>)</p>
</li>
</ul>
<h4 id="单元测试类工具"><a href="#单元测试类工具" class="headerlink" title="单元测试类工具"></a>单元测试类工具</h4><p>npm trends: <a href="https://www.npmtrends.com/mocha-vs-jest-vs-ava-vs-jasmine-core" target="_blank" rel="noopener">点击链接</a></p>
<p><img src="/blog/.io//image-20190706101634263.png" alt="image-20190706101634263"></p>
<p><strong>Karma</strong></p>
<p>Karma 是一个 Runner（即运行环境），具体详细的介绍见 <a href="#测试环境&帮手Karma">后面的章节 Karma</a></p>
<blockquote>
<p>A test runner is the library or tool that picks up an assembly (or a source code directory) that contains unit tests, and a bunch of settings, and then executes them and writes the test results to the console or log files.<br>there are many runners for different languages. See Nunit and MSTest for C#, or Junit for Java.</p>
</blockquote>
<p>karma 设计目标主要有下面四点：</p>
<blockquote>
<p>高效<br>扩展性<br>运行在真实设备<br>无缝的使用流程</p>
</blockquote>
<p>karma 是一个典型的 C/S 程序，包含 client 和 server ，通讯方式基于 Http ，通常情况下，客户端和服务端基本都运行在开发者本地机器上。</p>
<p>一个服务端实例对应一个项目，假如想同时运行多个项目，得同时开启多个服务端实例。</p>
<p>Karma 的<strong>优点</strong>是能通过插件和配置的方式集成大部分的主流的测试框架和前端库，能方便的一次在多浏览器环境执行测试用例，并集成了测试覆盖率生成功能，生成页面形式覆盖率报告并能导出不同形式的覆盖率报告数据。</p>
<p>它的<strong>缺点</strong>是，对测试页面环境的搭建和资源文件的加载不是常见的形式，最开始搭建环境时会有很多跟预期不一致的情况，配置不直观。</p>
<p><strong>Jasmine</strong></p>
<p>Jasmine 带有 assertions(断言)，spies (用来模拟函数的执行环境)和 mocks (mock 工具)，Jasmine 初始化设置简单，同时，如果你需要一些单元功能的时候你仍然可以加一些库进来。</p>
<p><strong>Mocha</strong></p>
<p>Mocha 是一个灵活的库，提供给开发者的只有一个基础测试结构。然后，其它功能性的功能如 assertions， spies 和 mocks，这些功能<strong>需要引用添加其它库</strong>/插件来完成。</p>
<p><strong>Jest</strong></p>
<p>被 Facebook 和各种 React 应用推荐和使用，Jest 得到了很好的支持。Jest 也被发现是一个非常快速的测试库在平行测试报告中。</p>
<p>对于小型项目来说你可能在开始的时候不用过多担心，而性能的提高，对于希望全天持续部署的大型应用 app 来说是非常之好的。</p>
<p>而开发人员主要是用 Jest 去测试 React 应用，Jest 可以很容易地集成到其它应用程序中充许你使用更独特的特性在其它地方</p>
<p>快照测试是一个非常好用的工具，去确保你的应用 UI 不会有超出预期的错误，在产品发布替换的期间发生。虽然大部分功能，专门设计都是使用在 React 上。</p>
<p>Jest 有着很广阔的 API 。</p>
<p><strong>AVA</strong></p>
<p>AVA 它的优势是 JavaScript 的异步特性和并发运行测试.</p>
<p>利用了 JavaScript 的异步特性优势，优化了在部署的时间等待</p>
<p>保留了简单的 API 为你提供你所需要的功能。</p>
<p>如果搭配 mocking 来使用它会显得更加友好，但是必须安装一个单独的库。</p>
<h4 id="E2E-测试类工具"><a href="#E2E-测试类工具" class="headerlink" title="E2E 测试类工具"></a>E2E 测试类工具</h4><p>npm trends: <a href="https://www.npmtrends.com/cypress-vs-nightmare-vs-nightwatch-vs-testcafe-vs-webdriverio" target="_blank" rel="noopener">点击链接</a></p>
<p><img src="/blog/.io//image-20190706100636750.png" alt="image-20190706100636750"></p>
<h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><p>测试有很多好处，但不代表一上来就要写出 100%场景覆盖的测试用例。</p>
<p><strong>最佳的实践：基于投入产出比来做测试</strong></p>
<p>由于维护测试用例也是一大笔开销（毕竟没有多少测试会专门帮前端写业务测试用例，而前端使用的流程自动化工具更是没有测试参与了）。</p>
<p>对于像基础组件、基础模型之类的不常变更且复用较多的部分，可以考虑去写测试用例来保证质量。个</p>
<p>先写少量的测试用例覆盖到 80%+的场景，保证覆盖主要使用流程。</p>
<p>一些极端场景出现的 bug 可以在迭代中形成测试用例沉淀，场景覆盖也将逐渐趋近 100%。</p>
<p>但对于迭代较快的业务逻辑以及生存时间不长的活动页面之类的就别花时间写测试用例了，维护测试用例的时间大了去了，成本太高。</p>
<p>大型项目，可以使用 Jest 快速形成配置并且开始单元测试。</p>
<p>需要测试快照，则可以选择 Jest 或者 Ava。</p>
<p>对于配置性要求高，对测试框架性能有要求的可以选择 mocha。</p>
<p>对模拟还原浏览器业务操作有很大的需求的，可以选择 nightmare</p>
<p>配合 CI 工具完成自动化测试、测试覆盖率、测试结果推送。</p>
<h2 id="喜欢简单，选择-Mocha"><a href="#喜欢简单，选择-Mocha" class="headerlink" title="喜欢简单，选择 Mocha"></a>喜欢简单，选择 Mocha</h2><p><a href="https://mochajs.org/" target="_blank" rel="noopener"><code>Mocha</code></a>（发音”摩卡”）诞生于 2011 年，是现在最流行的 JavaScript 测试框架之一，在浏览器和 Node 环境都可以使用。所谓”测试框架”，就是运行测试的工具。通过它，可以为 JavaScript 应用添加测试，从而保证代码的质量。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>全局安装 Mocha</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g mocha</span><br></pre></td></tr></table></figure>

<p>项目中也安装 Mocha</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev mocha</span><br></pre></td></tr></table></figure>

<p>在 package.json 中加入下面脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"test"</span>: <span class="string">"mocha"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Chai 是一个针对 Node.js 和浏览器的行为驱动测试和测试驱动测试的<strong>断言库</strong>，可与任何 JavaScript 测试框架集成。它是 Mocha 的好帮手~~</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev chai</span><br></pre></td></tr></table></figure>

<p>在 package.json 中加入下面脚本：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">    "test": "mocha"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="关于断言"><a href="#关于断言" class="headerlink" title="关于断言"></a>关于断言</h3><p><code>expect</code>断言的优点是很接近自然语言，下面是一些例子。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 相等或不相等</span></span><br><span class="line">expect(<span class="number">4</span> + <span class="number">5</span>).to.be.equal(<span class="number">9</span>);</span><br><span class="line">expect(<span class="number">4</span> + <span class="number">5</span>).to.be.not.equal(<span class="number">10</span>);</span><br><span class="line">expect(foo).to.be.deep.equal(&#123; <span class="attr">bar</span>: <span class="string">"baz"</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 布尔值为true</span></span><br><span class="line">expect(<span class="string">"everthing"</span>).to.be.ok;</span><br><span class="line">expect(<span class="literal">false</span>).to.not.be.ok;</span><br><span class="line"></span><br><span class="line"><span class="comment">// typeof</span></span><br><span class="line">expect(<span class="string">"test"</span>).to.be.a(<span class="string">"string"</span>);</span><br><span class="line">expect(&#123; <span class="attr">foo</span>: <span class="string">"bar"</span> &#125;).to.be.an(<span class="string">"object"</span>);</span><br><span class="line">expect(foo).to.be.an.instanceof(Foo);</span><br><span class="line"></span><br><span class="line"><span class="comment">// include</span></span><br><span class="line">expect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]).to.include(<span class="number">2</span>);</span><br><span class="line">expect(<span class="string">"foobar"</span>).to.contain(<span class="string">"foo"</span>);</span><br><span class="line">expect(&#123; <span class="attr">foo</span>: <span class="string">"bar"</span>, <span class="attr">hello</span>: <span class="string">"universe"</span> &#125;).to.include.keys(<span class="string">"foo"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// empty</span></span><br><span class="line">expect([]).to.be.empty;</span><br><span class="line">expect(<span class="string">""</span>).to.be.empty;</span><br><span class="line">expect(&#123;&#125;).to.be.empty;</span><br><span class="line"></span><br><span class="line"><span class="comment">// match</span></span><br><span class="line">expect(<span class="string">"foobar"</span>).to.match(<span class="regexp">/^foo/</span>);</span><br></pre></td></tr></table></figure>

<p>两种使用方式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// commonjs</span></span><br><span class="line"><span class="keyword">const</span> expect = <span class="built_in">require</span>(<span class="string">"chai"</span>).expect;</span><br><span class="line"></span><br><span class="line"><span class="comment">// es6</span></span><br><span class="line"><span class="keyword">import</span> &#123; expect &#125; <span class="keyword">from</span> <span class="string">"chai"</span>;</span><br></pre></td></tr></table></figure>

<h3 id="测试案例"><a href="#测试案例" class="headerlink" title="测试案例"></a>测试案例</h3><p>其中 index.js 为我们的被测试代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加法函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;第一个数&#125;</span> <span class="variable">a</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;第二个数&#125;</span> <span class="variable">b</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addNum</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = addNum;</span><br></pre></td></tr></table></figure>

<p>新建测试脚本<code>test/demo.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> expect = <span class="built_in">require</span>(<span class="string">'chai'</span>).expect;</span><br><span class="line"><span class="keyword">const</span> addNum = <span class="built_in">require</span>(<span class="string">'../src/index'</span>)</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'测试index.js'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  describe(<span class="string">'测试addNum函数'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    it(<span class="string">'两数相加结果为两个数字的和'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      expect(addNum(<span class="number">1</span>,<span class="number">2</span>)).to.be.equal(<span class="number">3</span>);</span><br><span class="line">      <span class="comment">// 以上语法为chai的expect语法，它还有should语法和asset语法。</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 等价的意思</span></span><br><span class="line"><span class="keyword">var</span> addNum=<span class="built_in">require</span>(<span class="string">'../src/index'</span>)</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'测试index.js'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  describe(<span class="string">'测试addNum函数'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    it(<span class="string">'两数相加结果为两个数字的和'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(addNum(<span class="number">1</span>,<span class="number">2</span>)!==<span class="number">3</span>)&#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"两数相加结果不为两个数字的和"</span>)；</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="Mocha-测试命令"><a href="#Mocha-测试命令" class="headerlink" title="Mocha 测试命令"></a>Mocha 测试命令</h3><p>如果想测试单一的测试 js，可以用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mocha <span class="built_in">test</span>/index.test.js</span><br></pre></td></tr></table></figure>

<p>或者多个 js</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mocha <span class="built_in">test</span>/index.test.js <span class="built_in">test</span>/add.test.js</span><br></pre></td></tr></table></figure>

<p>当然也可以用通配符测试某个文件夹下所有的 js 和 jsx：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># node 通配符</span></span><br><span class="line">mocha <span class="string">'test/some/*.@(js|jsx)'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># shell 通配符</span></span><br><span class="line">mocha <span class="built_in">test</span>/unit/*.js</span><br><span class="line"></span><br><span class="line">mocha spec/&#123;my,awesome&#125;.js</span><br></pre></td></tr></table></figure>

<h3 id="ES6-语法支持"><a href="#ES6-语法支持" class="headerlink" title="ES6 语法支持"></a>ES6 语法支持</h3><p>在上面我们用的并非是 ES6 的语法，那么让我们把其中的代码都改为 ES6 的语法。<br>其中 index.js 为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加法函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;第一个数&#125;</span> <span class="variable">a</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;第二个数&#125;</span> <span class="variable">b</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addNum</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; addNum &#125;;</span><br></pre></td></tr></table></figure>

<p>而 index.test.js 为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; expect &#125; <span class="keyword">from</span> <span class="string">"chai"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; addNum &#125; <span class="keyword">from</span> <span class="string">"../src/index"</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"测试index.js"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  describe(<span class="string">"测试addNum函数"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    it(<span class="string">"两个参数相加结果为两个数字的和"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      expect(addNum(<span class="number">1</span>, <span class="number">2</span>)).to.be.equal(<span class="number">3</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    it(<span class="string">"两个参数相加结果不为和以外的数"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      expect(addNum(<span class="number">1</span>, <span class="number">2</span>)).to.be.not.equal(<span class="number">4</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>此时直接运行 mocha 肯定是不行的，我们现需要安装一下 babel：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev @babel/cli @babel/core @babel/node @babel/register @babel/preset-env chai mocha nodemon</span><br></pre></td></tr></table></figure>

<p>然后，在项目目录下面，新建一个.babelrc 文件：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>: [<span class="string">"@babel/preset-env"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着讲 package.json 中的脚本改为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "test": "mocha --require @babel/register"</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>命令变得更加简单了</p>
<h3 id="更多用法"><a href="#更多用法" class="headerlink" title="更多用法"></a>更多用法</h3><h4 id="超时"><a href="#超时" class="headerlink" title="超时"></a>超时</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--timeout, -t, --timeouts  Specify <span class="built_in">test</span> timeout threshold (<span class="keyword">in</span> milliseconds)</span><br><span class="line">                                                      [number] [default: 2000]</span><br></pre></td></tr></table></figure>

<p>官方默认的超时是 2000 毫秒，即 2s。</p>
<p>有三种方式来修改超时：</p>
<p><code>--no-timeout</code>参数或者<code>debug</code>模式中，全局禁用了超时；</p>
<p><code>--timeout</code>后面接时间（毫秒），全局修改了本次执行测试用例的超时时间；</p>
<p>在测试用例里面，使用<code>this.timeout</code>方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">"should take less than 500ms"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.timeout(<span class="number">500</span>);</span><br><span class="line">  setTimeout(done, <span class="number">300</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在<a href="#钩子方法（生命周期函数）">钩子方法</a>里面使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">"a suite of tests"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  beforeEach(<span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.timeout(<span class="number">3000</span>); <span class="comment">// A very long environment setup.</span></span><br><span class="line">    setTimeout(done, <span class="number">2500</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>同样，可以使用``this.timeout(0)<code></code>去禁用超时。</p>
</blockquote>
<h4 id="钩子方法（生命周期函数）"><a href="#钩子方法（生命周期函数）" class="headerlink" title="钩子方法（生命周期函数）"></a>钩子方法（生命周期函数）</h4><p>Mocha 在 describe 块之中，提供测试用例的四个钩子：before()、after()、beforeEach()和 afterEach()。它们会在指定时间执行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">"测试index.js"</span>, () =&gt; &#123;</span><br><span class="line">  before(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.info(<span class="string">"在本区块的所有测试用例之前执行"</span>));</span><br><span class="line"></span><br><span class="line">  after(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.info(<span class="string">"在本区块的所有测试用例之后执行"</span>));</span><br><span class="line"></span><br><span class="line">  beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.info(<span class="string">"在本区块的每个测试用例之前执行"</span>));</span><br><span class="line"></span><br><span class="line">  afterEach(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.info(<span class="string">"在本区块的每个测试用例之后执行"</span>));</span><br><span class="line"></span><br><span class="line">  describe(<span class="string">"测试addNum函数"</span>, () =&gt; &#123;</span><br><span class="line">    it(<span class="string">"两数相加结果为两个数字的和"</span>, () =&gt; &#123;</span><br><span class="line">      assert.equal(addNum(<span class="number">1</span>, <span class="number">2</span>), <span class="number">3</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="异步测试"><a href="#异步测试" class="headerlink" title="异步测试"></a>异步测试</h4><p>Mocha 本身是支持异步测试的。只需要为<code>describe</code>回调函数添加一个<code>done</code>参数， 成功时调用<code>done()</code>，失败时调用<code>done(err)</code>。例如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> expect = <span class="built_in">require</span>(<span class="string">"chai"</span>).expect;</span><br><span class="line">describe(<span class="string">"db"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  it(<span class="string">"#get"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</span><br><span class="line">    db.get(<span class="string">"foo"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, foo</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) done(err);</span><br><span class="line">      expect(foo).to.equal(<span class="string">"bar"</span>);</span><br><span class="line">      done();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>如果未调用<code>done</code>函数，Mocha 会一直等待直到超时。</li>
<li>如果未添加<code>done</code>参数，Mocha 会直接返回成功，不会捕获到异步的断言失败。例如：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">"#get"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">2</span>);</span><br><span class="line">  &#125;, <span class="number">100</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>运行上述测试<a href="https://mochajs.org/" target="_blank" rel="noopener">Mocha</a>总会提示 Passing。</p>
<blockquote>
<p>Mocha 怎么知道是否要等待异步断言呢？因为 JavaScript 中的<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank" rel="noopener">Function</a>有一个<code>length</code>属性， 通过它可以获得该函数的形参个数。Mocha 通过传入回调的<code>length</code>来判断是否需要等待。</p>
</blockquote>
<p>或者，<code>done()</code>您可以返回<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank" rel="noopener">Promise</a>，而不是使用回调。如果您正在测试的 API 返回 promises 而不是回调，可以这样进行使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> db.clear().then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> db.save([tobi, loki, jane]);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"#find()"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  it(<span class="string">"respond with matching records"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> db.find(&#123; <span class="attr">type</span>: <span class="string">"User"</span> &#125;).should.eventually.have.length(<span class="number">3</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>同样，可以使用<a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Statements/async_function" target="_blank" rel="noopener">async / await</a>，您还可以编写如下的异步测试：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">await</span> db.clear();</span><br><span class="line">  <span class="keyword">await</span> db.save([tobi, loki, jane]);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"#find()"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  it(<span class="string">"responds with matching records"</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> users = <span class="keyword">await</span> db.find(&#123; <span class="attr">type</span>: <span class="string">"User"</span> &#125;);</span><br><span class="line">    users.should.have.length(<span class="number">3</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>需要 Babel 支持<del>~</del></p>
</blockquote>
<h3 id="示例项目"><a href="#示例项目" class="headerlink" title="示例项目"></a>示例项目</h3><h4 id="创建项目-amp-安装依赖"><a href="#创建项目-amp-安装依赖" class="headerlink" title="创建项目&amp;安装依赖"></a>创建项目&amp;安装依赖</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 初始化一个nodejs项目</span><br><span class="line">npm init -y</span><br><span class="line"></span><br><span class="line">// 安装依赖</span><br><span class="line">npm install --save-dev @babel/cli @babel/core @babel/node @babel/register @babel/preset-env chai mocha nodemon</span><br></pre></td></tr></table></figure>

<p>形成 package.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"projects"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"index.js"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">"keywords"</span>: [],</span><br><span class="line">  <span class="attr">"author"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="attr">"license"</span>: <span class="string">"ISC"</span>,</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"@babel/cli"</span>: <span class="string">"^7.5.0"</span>,</span><br><span class="line">    <span class="attr">"@babel/core"</span>: <span class="string">"^7.5.0"</span>,</span><br><span class="line">    <span class="attr">"@babel/node"</span>: <span class="string">"^7.5.0"</span>,</span><br><span class="line">    <span class="attr">"@babel/preset-env"</span>: <span class="string">"^7.5.0"</span>,</span><br><span class="line">    <span class="attr">"@babel/register"</span>: <span class="string">"^7.4.4"</span>,</span><br><span class="line">    <span class="attr">"chai"</span>: <span class="string">"^4.2.0"</span>,</span><br><span class="line">    <span class="attr">"mocha"</span>: <span class="string">"^6.1.4"</span>,</span><br><span class="line">    <span class="attr">"nodemon"</span>: <span class="string">"^1.19.1"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试过程"><a href="#测试过程" class="headerlink" title="测试过程"></a>测试过程</h4><p>新建一个待测试的方法<code>./src/index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sayHello = <span class="function"><span class="params">()</span> =&gt;</span> <span class="string">"Hello world!!!"</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(sayHello());</span><br><span class="line"></span><br><span class="line"><span class="comment">// ES6语法</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> sayHello;</span><br></pre></td></tr></table></figure>

<p>测试脚本<code>./test/index.spec.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; expect &#125; <span class="keyword">from</span> <span class="string">"chai"</span>;</span><br><span class="line"><span class="keyword">import</span> sayHello <span class="keyword">from</span> <span class="string">"../src/index"</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"index test"</span>, () =&gt; &#123;</span><br><span class="line">  describe(<span class="string">"sayHello function"</span>, () =&gt; &#123;</span><br><span class="line">    it(<span class="string">"should say Hello guys!"</span>, () =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> str = sayHello();</span><br><span class="line">      expect(str).to.equal(<span class="string">"Hello guys!"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><code>package.json</code>中的脚本：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  <span class="comment">// "start": "nodemon ./src/index.js",  // 针对ES5语法</span></span><br><span class="line">  "start:babel": "nodemon --exec babel-node ./src/index.js",</span><br><span class="line">  "test:watch": "mocha --require @babel/register --watch",</span><br><span class="line">  "test": "mocha --require @babel/register",</span><br><span class="line">  "build": "babel src --out-dir ./dist --source-maps",</span><br><span class="line">  "serve": "node ./dist/index.js",</span><br><span class="line">  "debug": "node --inspect-brk ./dist/index.js"</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>开始测试：<code>npm run test</code></p>
<p>报错了，因为期望的值与实际值不一致。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Hello world!!!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  index <span class="built_in">test</span></span><br><span class="line">    sayHello <span class="keyword">function</span></span><br><span class="line">      1) should say Hello guys!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  0 passing (9ms)</span><br><span class="line">  1 failing</span><br><span class="line"></span><br><span class="line">  1) index <span class="built_in">test</span></span><br><span class="line">       sayHello <span class="keyword">function</span></span><br><span class="line">         should say Hello guys!:</span><br><span class="line"></span><br><span class="line">      AssertionError: expected <span class="string">'Hello world!!!'</span> to equal <span class="string">'Hello guys!'</span></span><br><span class="line">      + expected - actual</span><br><span class="line"></span><br><span class="line">      -Hello world!!!</span><br><span class="line">      +Hello guys!</span><br><span class="line"></span><br><span class="line">      at Context.equal (<span class="built_in">test</span>/index.spec.js:9:22)</span><br></pre></td></tr></table></figure>

<p>修改测试脚本，或者修改 index.js 文件：</p>
<p>修改<code>./test/index.spec.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; expect &#125; <span class="keyword">from</span> <span class="string">"chai"</span>;</span><br><span class="line"><span class="keyword">import</span> sayHello <span class="keyword">from</span> <span class="string">"../src/index"</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"index test"</span>, () =&gt; &#123;</span><br><span class="line">  describe(<span class="string">"sayHello function"</span>, () =&gt; &#123;</span><br><span class="line">    it(<span class="string">"should say Hello world!!!"</span>, () =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> str = sayHello();</span><br><span class="line">      expect(str).to.equal(<span class="string">"Hello world!!!"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>再次测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; mocha --require @babel/register</span><br><span class="line"></span><br><span class="line">Hello world!!!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  index <span class="built_in">test</span></span><br><span class="line">    sayHello <span class="keyword">function</span></span><br><span class="line">      ✓ should say Hello world!!!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  1 passing (6ms)</span><br></pre></td></tr></table></figure>

<p>使用<code>mochawesome</code>展示你的测试结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev mochawesome</span><br></pre></td></tr></table></figure>

<p>然后在<code>package.json</code>的<code>scripts</code>中添加如下内容，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"report"</span>: <span class="string">"mocha --require @babel/register --reporter mochawesome"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run report</span><br></pre></td></tr></table></figure>

<p>形成出来的报告在浏览器中打开：</p>
<p><img src="/blog/.io//image-20190707212821248.png" alt="image-20190707212821248"></p>
<p>在 Vscode 中可以安装 Live Server 这个插件快速打开：</p>
<p><img src="/blog/.io//image-20190707212923919.png" alt="image-20190707212923919"></p>
<h2 id="开箱即用-Jest"><a href="#开箱即用-Jest" class="headerlink" title="开箱即用 Jest"></a>开箱即用 Jest</h2><p>Jest 是由 Facebook 发布的开源的、基于<a href="http://jasmine.github.io/" target="_blank" rel="noopener">Jasmine</a>的 JavaScript 单元测试框架。Jest 源于 Facebook 的构想，用于快速、可靠地测试 Web 聊天应用。它吸引了公司内部的兴趣，Facebook 的一名软件工程师 Jeff Morrison 半年前又重拾这个项目，改善它的性能，并将其开源。Jest 的目标是减少开始测试一个项目所要花费的时间和认知负荷，因此它提供了大部分你需要的现成工具：快速的命令行接口、Mock 工具集以及它的自动模块 Mock 系统。此外，如果你在寻找隔离工具例如 Mock 库，大部分其它工具将让你在测试中（甚至经常在你的主代码中）写一些不尽如人意的样板代码，以使其生效。Jest 与 Jasmine 框架的区别是在后者之上增加了一些层。最值得注意的是，运行测试时，Jest 会自动模拟依赖。Jest 自动为每个依赖的模块生成 Mock，并默认提供这些 Mock，这样就可以很容易地隔离模块的依赖。</p>
<p>Jest 支持 Babel，我们将很轻松的使用 ES6 的高级语法</p>
<p>Jest 支持 webpack，非常方便的使用它来管理我们的项目</p>
<p>Jest 支持 TypeScript，书写测试用例更加严谨</p>
<ol>
<li><p>简化 API</p>
<p>Jest 既简单又强大，内置支持以下功能：</p>
<ul>
<li>灵活的配置：比如，可以用文件名通配符来检测测试文件。</li>
<li>测试的事前步骤(Setup)和事后步骤(Teardown)，同时也包括测试范围。</li>
<li>匹配表达式(Matchers)：能使用期望<code>expect</code>句法来验证不同的内容。</li>
<li>测试异步代码：支持承诺(promise)数据类型和异步等待<code>async</code> / <code>await</code>功能。</li>
<li>模拟函数：可以修改或监查某个函数的行为。</li>
<li>手动模拟：测试代码时可以忽略模块的依存关系。</li>
<li>虚拟计时：帮助控制时间推移。</li>
</ul>
</li>
<li><p>性能与隔离</p>
<p>Jest 文档里写道：</p>
<p>Jest 能运用所有的工作部分，并列运行测试，使性能最大化。终端上的信息经过缓冲，最后与测试结果一起打印出来。沙盒中生成的测试文件，以及自动全局状态在每个测试里都会得到重置，这样就不会出现两个测试冲突的情况。</p>
<p>Mocha 用一个进程运行所有的测试，和它比较起来，Jest 则完全不同。要在测试之间模拟出隔离效果，我们必须要引入几个测试辅助函数来妥善管理清除工作。这种做法虽然不怎么理想，但 99%的情况都可以用，因为测试是按顺序进行的。</p>
</li>
<li><p>沉浸式监控模式</p>
<p>快速互动式监控模式可以监控到哪些测试文件有过改动，只运行与改动过的文件相关的测试，并且由于优化作用，能迅速放出监控信号。设置起来非常简单，而且还有一些别的选项，可以用文件名或测试名来过滤测试。我们用 Mocha 时也有监控模式，不过没有那么强大，要运行某个特定的测试文件夹或文件，就不得不自己创造解决方法，而这些功能 Jest 本身就已经提供了，不用花力气。</p>
</li>
<li><p>代码覆盖率&amp;测试报告</p>
<p>Jest 内置有代码覆盖率报告功能，设置起来易如反掌。可以在整个项目范围里收集代码覆盖率信息，包括未经受测试的文件。</p>
<p>要使完善 Circle CI 整合，只需要一个自定义报告功能。有了 Jest，用<a href="https://github.com/michaelleeallen/jest-junit-reporter" target="_blank" rel="noopener">jest-junit-reporter</a>就可以做到，其用法和 Mocha 几乎相同。</p>
</li>
<li><p>快照功能</p>
<p>快照测试的目的不是要替换现有的单元测试，而是要使之更有价值，让测试更轻松。在某些情况下，某些功能比如 React 组件功能，有了快照测试意味着无需再做单元测试，但同样这两者不是非此即彼。</p>
</li>
</ol>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><p>新建文件夹然后通过 npm 命令安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev jest</span><br></pre></td></tr></table></figure>

<p>或者通过 yarn 来安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add --dev jest</span><br></pre></td></tr></table></figure>

<p>然后就可以开始测试了</p>
<p>也可用<code>npm install -g jest</code>进行全局安装；并在 package.json 中指定 test 脚本：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"jest"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Jest 的测试脚本名形如<code>.test.js</code>，不论 Jest 是全局运行还是通过<code>npm test</code>运行，它都会执行当前目录下所有的<code>*.test.js</code> 或 <code>*.spec.js</code> 文件、完成测试。</p>
<p>ES6 语法支持：</p>
<ol>
<li>安装依赖</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add --dev babel-jest @babel/core @babel/preset-env</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置<code>.babelrc</code></li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>: [</span><br><span class="line">    [</span><br><span class="line">      <span class="string">"@babel/preset-env"</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"targets"</span>: &#123;</span><br><span class="line">          <span class="attr">"node"</span>: <span class="string">"current"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来就可以使用 ES6 的语法了<del>~</del></p>
<p>更多高阶的 ES6/7/8…语法，可以参见：<a href="https://babeljs.io/" target="_blank" rel="noopener">babel 官网</a></p>
<p>关于 Typescript 的支持，可以参见 ：<a href="https://jestjs.io/docs/en/getting-started#using-typescript" target="_blank" rel="noopener">Using Typescript</a></p>
<h3 id="举个例子"><a href="#举个例子" class="headerlink" title="举个例子"></a>举个例子</h3><p>关于 test suite 与 test case：</p>
<p><img src="/blog/.io//w80140jb42.jpg" alt="img"></p>
<p>describe 属于 test suite 的描述，而每个 test 或者 it 则描述了每个 test case。</p>
<p>例如：<code>math.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> add = <span class="function">(<span class="params">a, b</span>) =&gt;</span> a + b;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> multiple = <span class="function">(<span class="params">a, b</span>) =&gt;</span> a * b;</span><br></pre></td></tr></table></figure>

<p>测试脚本：<code>math.test.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> math = <span class="built_in">require</span>(<span class="string">"./src/math"</span>);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"math"</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> a;</span><br><span class="line">  <span class="keyword">let</span> b;</span><br><span class="line"></span><br><span class="line">  beforeEach(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    a = <span class="number">2</span>;</span><br><span class="line">    b = <span class="number">3</span>;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  test(<span class="string">"#should return result as a+b"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="comment">// test code</span></span><br><span class="line">    <span class="keyword">const</span> result = math.add(a, b);</span><br><span class="line">    expect(result).toEqual(<span class="number">5</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">"#should return result as a*b"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="comment">//test code</span></span><br><span class="line">    <span class="keyword">const</span> result = math.multiple(a, b);</span><br><span class="line">    expect(result).toEqual(<span class="number">6</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>test suite 可以进行嵌套：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">"foo"</span>, () =&gt; &#123;</span><br><span class="line">  describe(<span class="string">"bar"</span>, () =&gt; &#123;</span><br><span class="line">    it(<span class="string">"foo bar"</span>, () =&gt; &#123;</span><br><span class="line">      <span class="comment">//test code</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>test case 也可以脱离 test suite 独立运行：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hello.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">()</span> =&gt;</span> <span class="string">"Hello world"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// hello.test.js</span></span><br><span class="line"><span class="keyword">let</span> hello = <span class="built_in">require</span>(<span class="string">"hello.js"</span>);</span><br><span class="line"></span><br><span class="line">test(<span class="string">'should get "Hello world"'</span>, () =&gt; &#123;</span><br><span class="line">  expect(hello()).toBe(<span class="string">"Hello world"</span>); <span class="comment">// 测试成功</span></span><br><span class="line">  <span class="comment">// expect(hello()).toBe('Hello') // 测试失败</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="Mock-与-Spy"><a href="#Mock-与-Spy" class="headerlink" title="Mock 与 Spy"></a>Mock 与 Spy</h3><p><strong>mock</strong>测试就是在测试过程中，对于某些不容易构造或者不容易获取的对象，用一个虚拟的对象来创建以便测试的测试方法。</p>
<p>Mock 是单元测试中经常使用的一种技术。单元测试，顾名思义测试的重点是某个具体单元。但是在实际代码中，代码与代码之间，模块与模块之间总是会存在着相互引用。这个时候，剥离出这种单元的依赖，让测试更加独立，使用到的技术就是 Mock。</p>
<p><strong>为什么要使用 Mock 函数？</strong></p>
<p>在项目中，一个模块的方法内常常会去调用另外一个模块的方法。在单元测试中，我们可能并不需要关心内部调用的方法的执行过程和结果，只想知道它是否被正确调用即可，甚至会指定该函数的返回值。此时，使用 Mock 函数是十分有必要。</p>
<p>Mock 函数提供的以下三种特性，在我们写测试代码时十分有用：</p>
<ul>
<li>捕获函数调用情况</li>
<li>设置函数返回值</li>
<li>改变函数的内部实现</li>
</ul>
<p><img src="/blog/.io//8u3cp5kz2s.png" alt="img"></p>
<p>举个例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// math.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getFooResult = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// foo logic here</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getBarResult = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// bar logic here</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// caculate.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; getFooResult, getBarResult &#125; <span class="keyword">from</span> <span class="string">"./math"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getFooBarResult = <span class="function"><span class="params">()</span> =&gt;</span> getFooResult() + getBarResult();</span><br></pre></td></tr></table></figure>

<p>此时，getFooResult() 和 getBarResult() 就是 getFooBarResult 这个函数的依赖。如果我们关注的点是 getFooBarResult 这个函数，我们就应该把 getFooResult 和 getBarResult Mock 掉，剥离这种依赖。下面是一个使用 Jest 进行 Mock 的例子。</p>
<p><code>jest.fn()</code>是  创建 Mock 函数最简单的方式，如果没有定义函数内部的实现，<code>jest.fn()</code>会返回<code>undefined</code>作为返回值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">test(<span class="string">"测试jest.fn()调用"</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> mockFn = jest.fn();</span><br><span class="line">  <span class="keyword">let</span> result = mockFn(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 断言mockFn的执行后返回undefined</span></span><br><span class="line">  expect(result).toBeUndefined();</span><br><span class="line">  <span class="comment">// 断言mockFn被调用</span></span><br><span class="line">  expect(mockFn).toBeCalled();</span><br><span class="line">  <span class="comment">// 断言mockFn被调用了一次</span></span><br><span class="line">  expect(mockFn).toBeCalledTimes(<span class="number">1</span>);</span><br><span class="line">  <span class="comment">// 断言mockFn传入的参数为1, 2, 3</span></span><br><span class="line">  expect(mockFn).toHaveBeenCalledWith(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>情景一：设置函数 的返回值</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// calculate.test.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; getFooBarResult &#125; <span class="keyword">from</span> <span class="string">"./calculate"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> fooBar <span class="keyword">from</span> <span class="string">"./math"</span>;</span><br><span class="line"></span><br><span class="line">test(<span class="string">"getResult should return result getFooResult() + getBarResult()"</span>, () =&gt; &#123;</span><br><span class="line">  <span class="comment">// mock add方法和multiple方法</span></span><br><span class="line">  fooBar.getFooBarResult = jest.fn(<span class="function"><span class="params">()</span> =&gt;</span> <span class="number">10</span>);</span><br><span class="line">  fooBar.getBarResult = jest.fn(<span class="function"><span class="params">()</span> =&gt;</span> <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> result = getFooBarResult();</span><br><span class="line"></span><br><span class="line">  expect(result).toEqual(<span class="number">15</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Mock 其实就是一种 Spies，在 Jest 中使用 spies 来“spy”(窥探)一个函数的行为。</p>
<p><a href="https://jestjs.io/docs/en/mock-function-api.html#content" target="_blank" rel="noopener">Jest 文档</a>对于 spies 的解释:</p>
<blockquote>
<p>Mock 函数也称为“spies”，因为它们让你窥探一些由其他代码间接调用的函数的行为，而不仅仅是测试输出。你可以通过使用 <code>jest.fn()</code> 创建一个 mock 函数。</p>
</blockquote>
<p>简单来说，一个 spy 是另一个内置的能够记录对其调用细节的函数：调用它的次数，使用什么参数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// calculate.test.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; getFooBarResult &#125; <span class="keyword">from</span> <span class="string">"./calculate"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> fooBar <span class="keyword">from</span> <span class="string">"./math"</span>;</span><br><span class="line"></span><br><span class="line">test(<span class="string">"getResult should return result getFooResult() + getBarResult()"</span>, () =&gt; &#123;</span><br><span class="line">  <span class="comment">// mock add方法和multiple方法</span></span><br><span class="line">  fooBar.getFooResult = jest.fn(<span class="function"><span class="params">()</span> =&gt;</span> <span class="number">10</span>);</span><br><span class="line">  fooBar.getBarResult = jest.fn(<span class="function"><span class="params">()</span> =&gt;</span> <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> result = getFooBarResult();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 监控getFooResult和getBarResult的调用情况.</span></span><br><span class="line">  expect(fooBar.getFooResult).toHaveBeenCalled();</span><br><span class="line">  expect(fooBar.getBarResult).toHaveBeenCalled();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>情景二：捕获函数调用情况</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bot method</span></span><br><span class="line"><span class="keyword">const</span> bot = &#123;</span><br><span class="line">  sayHello: <span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Hello <span class="subst">$&#123;name&#125;</span>!`</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// test.js</span></span><br><span class="line">describe(<span class="string">"bot"</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">"should say hello"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> spy = jest.spyOn(bot, <span class="string">"sayHello"</span>);</span><br><span class="line"></span><br><span class="line">    bot.sayHello(<span class="string">"Michael"</span>);</span><br><span class="line"></span><br><span class="line">    expect(spy).toHaveBeenCalledWith(<span class="string">"Michael"</span>);</span><br><span class="line"></span><br><span class="line">    spy.mockRestore();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>我们通过 <code>jest.spyOn</code> 创建了一个监听 <code>bot</code> 对象的 <code>sayHello</code> 方法的 spy。它就像间谍一样监听了所有对 <code>bot#sayHello</code> 方法的调用。由于创建 spy 时，Jest 实际上修改了 <code>bot</code> 对象的 <code>sayHello</code> 属性，所以在断言完成后，我们还要通过 <code>mockRestore</code> 来恢复 <code>bot</code> 对象原本的 <code>sayHello</code>方法。</p>
<p>Jest 的<a href="https://jestjs.io/docs/en/jest-object#jestspyonobject-methodname" target="_blank" rel="noopener">spyOn 介绍</a></p>
<p><strong>情景三：修改函数的内容实现</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bot = &#123;</span><br><span class="line">  sayHello: <span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Hello <span class="subst">$&#123;name&#125;</span>!`</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"bot"</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">"should say hello"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> spy = jest.spyOn(bot, <span class="string">"sayHello"</span>).mockImplementation(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`Hello mix <span class="subst">$&#123;name&#125;</span>`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    bot.sayHello(<span class="string">"Michael"</span>);</span><br><span class="line"></span><br><span class="line">    expect(spy).toHaveBeenCalledWith(<span class="string">"Michael"</span>);</span><br><span class="line"></span><br><span class="line">    spy.mockRestore();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>使用 spyOn 方法，还可以去修改 Math.random 这样的函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jest.spyOn(<span class="built_in">Math</span>, <span class="string">"random"</span>).mockImplementation(<span class="function"><span class="params">()</span> =&gt;</span> <span class="number">0.9</span>);</span><br></pre></td></tr></table></figure>

<p>举个例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// getNum.js</span></span><br><span class="line"><span class="keyword">const</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getNum = <span class="function">(<span class="params">index</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (index) &#123;</span><br><span class="line">    <span class="keyword">return</span> arr[index % <span class="number">6</span>];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> arr[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">6</span>)];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// num.test.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; getNum &#125; <span class="keyword">from</span> <span class="string">"../src/getNum"</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"getNum"</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">"should select numbber based on index if provided"</span>, () =&gt; &#123;</span><br><span class="line">    expect(getNum(<span class="number">1</span>)).toBe(<span class="number">2</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">"should select a random number based on Math.random if skuId not available"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> spy = jest.spyOn(<span class="built_in">Math</span>, <span class="string">"random"</span>).mockImplementation(<span class="function"><span class="params">()</span> =&gt;</span> <span class="number">0.9</span>);</span><br><span class="line"></span><br><span class="line">    expect(getNum()).toBe(<span class="number">6</span>);</span><br><span class="line">    expect(spy).toHaveBeenCalled();</span><br><span class="line"></span><br><span class="line">    spy.mockRestore();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="CLI-命令"><a href="#CLI-命令" class="headerlink" title="CLI 命令"></a>CLI 命令</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">➜ npx jest <span class="comment">--help</span></span><br><span class="line">Usage: jest [<span class="comment">--config=&lt;pathToConfigFile&gt;] [TestPathPattern]</span></span><br><span class="line"></span><br><span class="line">选项：</span><br><span class="line">  <span class="comment">--help, -h                    显示帮助信息                              [布尔]</span></span><br><span class="line">  <span class="comment">--version, -v                 Print the version and exit                [布尔]</span></span><br><span class="line">  <span class="comment">--config, -c                  The path to a jest config file specifying how to</span></span><br><span class="line">                                find and <span class="keyword">execute</span> tests. <span class="keyword">If</span> <span class="keyword">no</span> rootDir <span class="keyword">is</span> <span class="keyword">set</span> <span class="keyword">in</span></span><br><span class="line">                                the config, the <span class="keyword">directory</span> containing the config</span><br><span class="line">                                <span class="keyword">file</span> <span class="keyword">is</span> assumed <span class="keyword">to</span> be the rootDir <span class="keyword">for</span> the</span><br><span class="line">                                project.This can also be a <span class="keyword">JSON</span> encoded <span class="keyword">value</span></span><br><span class="line">                                which Jest will <span class="keyword">use</span> <span class="keyword">as</span> configuration.   [字符串]</span><br><span class="line">  <span class="comment">--coverage                    Indicates that test coverage information should</span></span><br><span class="line">                                be collected <span class="keyword">and</span> reported <span class="keyword">in</span> the output.  [布尔]</span><br><span class="line">  <span class="comment">--timers                      Setting this value to fake allows the use of</span></span><br><span class="line">                                fake timers <span class="keyword">for</span> functions such <span class="keyword">as</span> setTimeout.</span><br><span class="line">                                                                        [字符串]</span><br><span class="line">  <span class="comment">--verbose                     Display individual test results with the test</span></span><br><span class="line">                                suite hierarchy.                          [布尔]</span><br><span class="line">  <span class="comment">--watch                       Watch files for changes and rerun tests related</span></span><br><span class="line">                                <span class="keyword">to</span> <span class="keyword">changed</span> files. <span class="keyword">If</span> you want <span class="keyword">to</span> re-run <span class="keyword">all</span></span><br><span class="line">                                tests <span class="keyword">when</span> a <span class="keyword">file</span> has <span class="keyword">changed</span>, <span class="keyword">use</span> the</span><br><span class="line">                                <span class="string">`--watchAll`</span> option.                      [布尔]</span><br><span class="line">  <span class="comment">--watchAll                    Watch files for changes and rerun all tests. If</span></span><br><span class="line">                                you want <span class="keyword">to</span> re-run <span class="keyword">only</span> the tests related <span class="keyword">to</span> the</span><br><span class="line">                                <span class="keyword">changed</span> files, <span class="keyword">use</span> the <span class="string">`--watch`</span> option.  [布尔]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>常见使用：</p>
<p><code>--verbose</code>显示详细的测试信息，包括测试 suite 和 case：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">➜ npx jest --verbose</span><br><span class="line"> PASS  <span class="built_in">test</span>/mock.test.js</span><br><span class="line">  bot</span><br><span class="line">    ✓ should say hello (7ms)</span><br><span class="line"></span><br><span class="line">  console.log <span class="built_in">test</span>/mock.test.js:10</span><br><span class="line">    Hello mix Michael</span><br><span class="line"></span><br><span class="line"> PASS  <span class="built_in">test</span>/domain.test.js</span><br><span class="line">  getImageDomain</span><br><span class="line">    ✓ should select domain based on skuId <span class="keyword">if</span> provided (1ms)</span><br><span class="line">    ✓ should select a random domain based on Math.random <span class="keyword">if</span> skuId not available (1ms)</span><br><span class="line"></span><br><span class="line">  console.log <span class="built_in">test</span>/sayhello.test.js:3</span><br><span class="line">    Hello Michael!</span><br><span class="line"></span><br><span class="line"> PASS  <span class="built_in">test</span>/sayhello.test.js</span><br><span class="line">  bot</span><br><span class="line">    ✓ should say hello (6ms)</span><br><span class="line"></span><br><span class="line"> PASS  <span class="built_in">test</span>/num.test.js</span><br><span class="line">  getNum</span><br><span class="line">    ✓ should select numbber based on index <span class="keyword">if</span> provided (1ms)</span><br><span class="line">    ✓ should select a random number based on Math.random <span class="keyword">if</span> skuId not available</span><br><span class="line"></span><br><span class="line"> PASS  <span class="built_in">test</span>/math.test.js</span><br><span class="line">  math</span><br><span class="line">    ✓ <span class="comment">#should return result as a+b (1ms)</span></span><br><span class="line">    ✓ <span class="comment">#should return result as a*b (4ms)</span></span><br><span class="line"></span><br><span class="line">Test Suites: 5 passed, 5 total</span><br><span class="line">Tests:       8 passed, 8 total</span><br><span class="line">Snapshots:   0 total</span><br><span class="line">Time:        1.075s</span><br><span class="line">Ran all <span class="built_in">test</span> suites.</span><br></pre></td></tr></table></figure>

<p><code>--watch</code>和<code>--watchAll</code>用来监听测试文件的变化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Ran all <span class="built_in">test</span> suites.</span><br><span class="line"></span><br><span class="line">Watch Usage</span><br><span class="line"> › Press f to run only failed tests.</span><br><span class="line"> › Press o to only run tests related to changed files.</span><br><span class="line"> › Press p to filter by a filename regex pattern.</span><br><span class="line"> › Press t to filter by a <span class="built_in">test</span> name regex pattern.</span><br><span class="line"> › Press q to quit watch mode.</span><br><span class="line"> › Press Enter to trigger a <span class="built_in">test</span> run.</span><br></pre></td></tr></table></figure>

<p><code>--coverage</code>用来形成测试覆盖率报告</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-----------|----------|----------|----------|----------|-------------------|</span><br><span class="line">File       |  % Stmts | % Branch |  % Funcs |  % Lines | Uncovered Line <span class="comment">#s |</span></span><br><span class="line">-----------|----------|----------|----------|----------|-------------------|</span><br><span class="line">All files  |      100 |      100 |      100 |      100 |                   |</span><br><span class="line"> getNum.js |      100 |      100 |      100 |      100 |                   |</span><br><span class="line"> math.js   |      100 |      100 |      100 |      100 |                   |</span><br><span class="line">-----------|----------|----------|----------|----------|-------------------|</span><br><span class="line"></span><br><span class="line">Test Suites: 5 passed, 5 total</span><br><span class="line">Tests:       8 passed, 8 total</span><br><span class="line">Snapshots:   0 total</span><br><span class="line">Time:        1.497s</span><br></pre></td></tr></table></figure>

<h3 id="Jest-在-React、Vue-项目中的应用"><a href="#Jest-在-React、Vue-项目中的应用" class="headerlink" title="Jest 在 React、Vue 项目中的应用"></a>Jest 在 React、Vue 项目中的应用</h3><p>在<code>create-react-app</code>中的应用：</p>
<p>安装对应的依赖：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span> react-<span class="keyword">test</span>-renderer enzyme enzyme-adapter-react-<span class="number">16</span></span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/airbnb/enzyme" target="_blank" rel="noopener">Enzyme</a>是一个非常棒的 React 组件测试测试库。</p>
<blockquote>
<p>Enzyme is a JavaScript Testing utility for React that makes it easier to test your React Components’ output. You can also manipulate, traverse, and in some ways simulate runtime given the output.</p>
<p>Enzyme’s API is meant to be intuitive and flexible by mimicking jQuery’s API for DOM manipulation and traversal</p>
</blockquote>
<p>需要注意的两点是：</p>
<ul>
<li>需要配置 Adapter，不同的 React 的 Adapter 不同</li>
</ul>
<p>| Enzyme Adapter Package      | React semver compatibility |<br>| ————————— | ————————– | — | —— |<br>| <code>enzyme-adapter-react-16</code>   | <code>^16.4.0-0</code>                |<br>| <code>enzyme-adapter-react-16.3</code> | <code>~16.3.0-0</code>                |<br>| <code>enzyme-adapter-react-16.2</code> | <code>~16.2</code>                    |<br>| <code>enzyme-adapter-react-16.1</code> | <code>~16.0.0-0                 |     | ~16.1</code> |<br>| <code>enzyme-adapter-react-15</code>   | <code>^15.5.0</code>                  |<br>| <code>enzyme-adapter-react-15.4</code> | <code>15.0.0-0 - 15.4.x</code>        |<br>| <code>enzyme-adapter-react-14</code>   | <code>^0.14.0</code>                  |<br>| <code>enzyme-adapter-react-13</code>   | <code>^0.13.0</code>                  |</p>
<ul>
<li><p>需要初始化配置<code>setUpTests.js</code></p>
<p>官方文档在 Package.json 中设置 jest 配置，已经过时，Jest 框架最新会默认加载文件<code>src/setUpTests.js</code></p>
</li>
<li><pre><code class="react">import { configure } from &apos;enzyme&apos;;
import Adapter from &apos;enzyme-adapter-react-16&apos;

configure({ adapter: new Adapter() })
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">在 vue 工程化项目中：</span><br><span class="line"></span><br><span class="line">```json</span><br><span class="line"><span class="string">"devDependencies"</span>: &#123;</span><br><span class="line">  <span class="string">"@vue/cli-plugin-unit-jest"</span>: <span class="string">"^3.9.0"</span>,</span><br><span class="line">  <span class="string">"@vue/test-utils"</span>: <span class="string">"1.0.0-beta.29"</span>,</span><br><span class="line">  <span class="string">"babel-core"</span>: <span class="string">"7.0.0-bridge.0"</span>,</span><br><span class="line">  <span class="string">"babel-eslint"</span>: <span class="string">"^10.0.1"</span>,</span><br><span class="line">  <span class="string">"babel-jest"</span>: <span class="string">"^23.6.0"</span>,</span><br><span class="line">  <span class="string">"babel-preset-env"</span>: <span class="string">"^1.7.0"</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<p>添加如上依赖，</p>
<p>配置 scripts:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"scripts"</span>: &#123;</span><br><span class="line">  <span class="string">"test"</span>: <span class="string">"vue-cli-service test:unit"</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>配置<code>jest.config.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 处理vue结尾的文件</span></span><br><span class="line">  moduleFileExtensions: [<span class="string">"js"</span>, <span class="string">"jsx"</span>, <span class="string">"json"</span>, <span class="string">"vue"</span>],</span><br><span class="line">  <span class="comment">// es6转义</span></span><br><span class="line">  transform: &#123;</span><br><span class="line">    <span class="string">"^.+\\.vue$"</span>: <span class="string">"vue-jest"</span>,</span><br><span class="line">    <span class="string">".+\\.(css|styl|less|sass|scss|svg|png|jpg|ttf|woff|woff2)$"</span>:</span><br><span class="line">      <span class="string">"jest-transform-stub"</span>,</span><br><span class="line">    <span class="string">"^.+\\.jsx?$"</span>: <span class="string">"babel-jest"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  transformIgnorePatterns: [<span class="string">"/node_modules/"</span>],</span><br><span class="line">  <span class="comment">// cli配置了webpack别名</span></span><br><span class="line">  moduleNameMapper: &#123;</span><br><span class="line">    <span class="string">"^@/(.*)$"</span>: <span class="string">"&lt;rootDir&gt;/src/$1"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  snapshotSerializers: [<span class="string">"jest-serializer-vue"</span>],</span><br><span class="line">  testMatch: [</span><br><span class="line">    <span class="string">"**/tests/unit/**/*.spec.(js|jsx|ts|tsx)|**/__tests__/*.(js|jsx|ts|tsx)"</span>,</span><br><span class="line">  ],</span><br><span class="line">  testURL: <span class="string">"http://localhost/"</span>,</span><br><span class="line">  watchPlugins: [</span><br><span class="line">    <span class="string">"jest-watch-typeahead/filename"</span>,</span><br><span class="line">    <span class="string">"jest-watch-typeahead/testname"</span>,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>写一个测试用例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="简约之美-AVA"><a href="#简约之美-AVA" class="headerlink" title="简约之美 AVA"></a>简约之美 AVA</h2><p>简单的说 ava 是 mocha 的替代品：</p>
<ul>
<li>es6 语法支持更好，对 aysnc/await 有支持</li>
<li>执行效率更高，使用 io 并发，就必须保证测试的原子性</li>
<li>语义上更简单，集众家之长</li>
</ul>
<p>虽然 JavaScript 是单线程，但在 Node.js 里由于其异步的特性使得 IO 可以并行。AVA 利用这个优点让你的测试可以并发执行，这对于 IO 繁重的测试特别有用。另外，测试文件可以在不同的进程里并行运行，让每一个测试文件可以获得更好的性能和独立的环境。</p>
<h3 id="AVA-特点"><a href="#AVA-特点" class="headerlink" title="AVA 特点"></a>AVA 特点</h3><ul>
<li><p>轻量和高效</p>
</li>
<li><p>简单的测试语法</p>
</li>
<li><p>并发运行测试</p>
</li>
<li><p>强制编写<strong>原子测试</strong></p>
<p>一旦开始，就一直运行到结束，中间不会切换到另一个测试</p>
</li>
<li><p>没有隐藏的全局变量</p>
</li>
<li><p>为每个测试文件隔离环境</p>
</li>
<li><p><strong>用 ES2015 编写测试</strong></p>
</li>
<li><p>支持 Promise</p>
</li>
<li><p>支持 Generator</p>
</li>
<li><p>支持 Async</p>
</li>
<li><p>支持 Observable</p>
</li>
<li><p>强化断言信息</p>
</li>
<li><p>可选的 TAP 输出显示</p>
<p><img src="/blog/.io//tap-reporter.png" alt="img"></p>
</li>
<li><p>简明的堆栈跟踪</p>
</li>
</ul>
<h3 id="安装-amp-开始"><a href="#安装-amp-开始" class="headerlink" title="安装&amp;开始"></a>安装&amp;开始</h3><p>情景一：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 创建一个ava项目</span><br><span class="line">npm init ava</span><br></pre></td></tr></table></figure>

<p>形成 package.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"awesome-package"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"ava"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"ava"</span>: <span class="string">"^1.0.0"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>情景二：（推荐）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm init -y</span><br><span class="line"></span><br><span class="line">// npm &amp; cnpm</span><br><span class="line">npm install -D ava</span><br><span class="line"></span><br><span class="line">// yarn</span><br><span class="line">yarn add ava -D</span><br></pre></td></tr></table></figure>

<p>测试 ava 正常安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜ npx ava --version</span><br><span class="line">2.2.0</span><br></pre></td></tr></table></figure>

<h3 id="第一个-ava-测试例子"><a href="#第一个-ava-测试例子" class="headerlink" title="第一个 ava 测试例子"></a>第一个 ava 测试例子</h3><p>流程：</p>
<ol>
<li>引用 ava 的测试 API</li>
<li>执行测试</li>
<li>使用断言</li>
</ol>
<p>创建<code>test.js</code>文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> test <span class="keyword">from</span> <span class="string">"ava"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> testfn = <span class="function">(<span class="params">a, b</span>) =&gt;</span> a + b;</span><br><span class="line"></span><br><span class="line">test(<span class="string">"hello ava"</span>, (t) =&gt; &#123;</span><br><span class="line">  t.pass();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">test(<span class="string">"my first test"</span>, <span class="keyword">async</span> (t) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> str = <span class="string">"hello ava!!!!"</span>;</span><br><span class="line">  t.is(str, <span class="string">"hello ava!!!!"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">test(<span class="string">"add method"</span>, <span class="keyword">async</span> (t) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> result = testfn(<span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line">  t.is(result, <span class="number">7</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>ava 自动搜索如下文件结尾的文件：</p>
<ul>
<li><code>**/test.js</code></li>
<li><code>**/test-*.js</code></li>
<li><code>**/*.spec.js</code></li>
<li><code>**/*.test.js</code></li>
<li><code>**/test/**/*.js</code></li>
<li><code>**/tests/**/*.js</code></li>
<li><code>**/__tests__/**/*.js</code></li>
</ul>
<p>ava 中的断言：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.pass([message])</span><br><span class="line">.fail([message])</span><br><span class="line">.assert(value, [message])</span><br><span class="line">.truthy(value, [message])</span><br><span class="line">.falsy(value, [message])</span><br><span class="line">.true(value, [message])</span><br><span class="line">.false(value, [message])</span><br><span class="line">.is(value, expected, [message])</span><br><span class="line">.not(value, expected, [message])</span><br><span class="line">.deepEqual(value, expected, [message])</span><br><span class="line">.notDeepEqual(value, expected, [message])</span><br><span class="line">.deepEqual()。</span><br><span class="line">.throws(fn, [expected, [message]])</span><br><span class="line">.throwsAsync(thrower, [expected, [message]])</span><br><span class="line">.notThrows(fn, [message])</span><br><span class="line">.notThrowsAsync(nonThrower, [message])</span><br><span class="line">.regex(contents, regex, [message])</span><br><span class="line">.notRegex(contents, regex, [message])</span><br><span class="line">.snapshot(expected, [message])</span><br><span class="line">.snapshot(expected, [options], [message])</span><br></pre></td></tr></table></figure>

<h3 id="CLI-命令-1"><a href="#CLI-命令-1" class="headerlink" title="CLI 命令"></a>CLI 命令</h3><p>使用<code>--help</code>命令去查看 ava 支持的 cli 参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">➜ npx ava --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">  Testing can be a drag. AVA helps you get it <span class="keyword">done</span>.</span><br><span class="line"></span><br><span class="line">  Usage</span><br><span class="line">    ava [&lt;file&gt; ...]</span><br><span class="line"></span><br><span class="line">  Options</span><br><span class="line">    --watch, -w             Re-run tests when tests and <span class="built_in">source</span> files change</span><br><span class="line">    --match, -m             Only run tests with matching title (Can be repeated)</span><br><span class="line">    --update-snapshots, -u  Update snapshots</span><br><span class="line">    --fail-fast             Stop after first <span class="built_in">test</span> failure</span><br><span class="line">    --timeout, -T           Set global timeout (milliseconds or human-readable, e.g. 10s, 2m)</span><br><span class="line">    --serial, -s            Run tests serially</span><br><span class="line">    --concurrency, -c       Max number of <span class="built_in">test</span> files running at the same time (Default: CPU cores)</span><br><span class="line">    --verbose, -v           Enable verbose output</span><br><span class="line">    --tap, -t               Generate TAP output</span><br><span class="line">    --color                 Force color output</span><br><span class="line">    --no-color              Disable color output</span><br><span class="line">    --reset-cache           Reset AVA<span class="string">'s compilation cache and exit</span></span><br><span class="line"><span class="string">    --config                JavaScript file for AVA to read its config from, instead of using package.json</span></span><br><span class="line"><span class="string">                            or ava.config.js files</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  Examples</span></span><br><span class="line"><span class="string">    ava</span></span><br><span class="line"><span class="string">    ava test.js test2.js</span></span><br><span class="line"><span class="string">    ava test-*.js</span></span><br><span class="line"><span class="string">    ava test</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  The above relies on your shell expanding the glob patterns.</span></span><br><span class="line"><span class="string">  Without arguments, AVA uses the following patterns:</span></span><br><span class="line"><span class="string">    **/test.js **/test-*.js **/*.spec.js **/*.test.js **/test/**/*.js **/tests/**/*.js **/__tests__/**/*.js</span></span><br></pre></td></tr></table></figure>

<h4 id="文件匹配"><a href="#文件匹配" class="headerlink" title="文件匹配"></a>文件匹配</h4><p>使用<code>match</code>指令，匹配对应需要测试的文件：</p>
<p>匹配标题以<code>foo</code>：结尾</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">npx </span><span class="string">ava </span><span class="built_in">--match</span> =<span class="string">'* foo'</span></span><br></pre></td></tr></table></figure>

<p>匹配标题以<code>foo</code>：</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">npx </span><span class="string">ava </span><span class="built_in">--match</span> =<span class="string">'foo *'</span></span><br></pre></td></tr></table></figure>

<p>匹配标题包含<code>foo</code>：</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">npx </span><span class="string">ava </span><span class="built_in">--match</span> =<span class="string">'* foo *'</span></span><br></pre></td></tr></table></figure>

<p>匹配是完全相同 <code>foo</code>：</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">npx </span><span class="string">ava </span><span class="built_in">--match</span> =<span class="string">'foo'</span></span><br></pre></td></tr></table></figure>

<p>匹配标题不包含<code>foo</code>：</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">npx </span><span class="string">ava </span><span class="built_in">--match</span> =<span class="string">'！* foo *'</span></span><br></pre></td></tr></table></figure>

<p>匹配以下<code>foo</code>结尾的标题<code>bar</code>：</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">npx </span><span class="string">ava </span><span class="built_in">--match</span> =<span class="string">'foo * bar'</span></span><br></pre></td></tr></table></figure>

<p>匹配<code>foo</code>以<code>bar</code>：开头或结尾的标题：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx ava --<span class="keyword">match</span> =<span class="string">'foo *'</span> -  <span class="keyword">match</span> =<span class="string">'* bar'</span></span><br></pre></td></tr></table></figure>

<h4 id="关于-reporter"><a href="#关于-reporter" class="headerlink" title="关于 reporter"></a>关于 reporter</h4><p>默认情况下，AVA 使用最小的报告：</p>
<p><a href="https://github.com/avajs/ava/blob/master/media/mini-reporter.gif" target="_blank" rel="noopener"><img src="/blog/.io//mini-reporter.gif" alt="img"></a></p>
<p>使用该<code>--verbose</code>标志启用详细的报告者。除非启用 TAP 报告，否则始终在 CI 环境中使用此选项。</p>
<p><a href="https://github.com/avajs/ava/blob/master/media/verbose-reporter.png" target="_blank" rel="noopener"><img src="/blog/.io//verbose-reporter.png" alt="img"></a></p>
<p><strong>TAP 报告（推荐）</strong></p>
<p>AVA 支持 TAP 格式，因此与任何 TAP 报告器兼容。使用该<code>--tap</code>标志启用 TAP 输出。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npx ava --tap | npx tap-nyan</span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/avajs/ava/blob/master/media/tap-reporter.png" target="_blank" rel="noopener"><img src="/blog/.io//tap-reporter-20190709154342692.png" alt="img"></a></p>
<p>这里有一些格式：</p>
<ul>
<li><a href="https://github.com/scottcorgan/tap-dot" target="_blank" rel="noopener">tap-dot</a> - Dotted output.</li>
<li><a href="https://github.com/scottcorgan/tap-spec" target="_blank" rel="noopener">tap-spec</a> - Mocha-like spec reporter.</li>
<li><a href="https://github.com/calvinmetcalf/tap-nyan" target="_blank" rel="noopener">tap-nyan</a> - Nyan cat.</li>
<li><a href="https://github.com/gummesson/tap-min" target="_blank" rel="noopener">tap-min</a> - Minimal output.</li>
<li><a href="https://github.com/namuol/tap-difflet" target="_blank" rel="noopener">tap-difflet</a> - Minimal output with diffing.</li>
<li><a href="https://github.com/axross/tap-diff" target="_blank" rel="noopener">tap-diff</a> - Human-friendly output with diffing.</li>
<li><a href="https://github.com/joeybaker/tap-simple" target="_blank" rel="noopener">tap-simple</a> - Simple output.</li>
<li><a href="https://github.com/substack/faucet" target="_blank" rel="noopener">faucet</a> - Human-readable summarizer.</li>
<li><a href="https://github.com/isaacs/tap-mocha-reporter" target="_blank" rel="noopener">tap-mocha-reporter</a> - Use any of the <a href="https://github.com/isaacs/tap-mocha-reporter/tree/master/lib/reporters" target="_blank" rel="noopener">Mocha reporters</a>.</li>
<li><a href="https://github.com/zoubin/tap-summary" target="_blank" rel="noopener">tap-summary</a> - Summarized output.</li>
<li><a href="https://github.com/clux/tap-pessimist" target="_blank" rel="noopener">tap-pessimist</a> - Only shows failed tests.</li>
<li><a href="https://github.com/toolness/tap-prettify" target="_blank" rel="noopener">tap-prettify</a> - Nice readable output with diffing.</li>
<li><a href="https://github.com/substack/tap-colorize" target="_blank" rel="noopener">tap-colorize</a> - Colorize the output while preserving machine-readability.</li>
<li><a href="https://github.com/juliangruber/tap-bail" target="_blank" rel="noopener">tap-bail</a> - Bail out when the first test fails.</li>
<li><a href="https://github.com/axross/tap-notify" target="_blank" rel="noopener">tap-notify</a> - Notifier for macOS, Linux and Windows.</li>
<li><a href="https://github.com/gummesson/tap-json" target="_blank" rel="noopener">tap-json</a> - JSON output.</li>
<li><a href="https://github.com/yovasx2/ava-tap-json" target="_blank" rel="noopener">ava-tap-json</a> - JSON output with AVA compatibility.</li>
<li><a href="https://github.com/aghassemi/tap-xunit" target="_blank" rel="noopener">tap-xunit</a> - xUnit output.</li>
<li><a href="https://github.com/smockle/tap-teamcity" target="_blank" rel="noopener">tap-teamcity</a> - Output for TeamCity.</li>
</ul>
<h4 id="快照功能"><a href="#快照功能" class="headerlink" title="快照功能"></a>快照功能</h4><p>ava 自动进行项目测试快照，如果文件放置在<code>test</code>或者<code>tests</code>目录，则快照会放置在<code>snapshots</code>目录。如果测试放置在<code>__test__</code>目录，则快照放置在<code>__snapshots__</code>目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ava --update-snapshots</span><br></pre></td></tr></table></figure>

<p>可以指定一个固定位置，以便在 AVA 的<code>package.json</code>配置中存储快照文件：</p>
<p><strong>package.json：</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	 "ava"：&#123;</span><br><span class="line">		 "snapshotDir"："自定义目录"</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="设置超时"><a href="#设置超时" class="headerlink" title="设置超时"></a>设置超时</h4><p>AVA 中的超时行为与其他测试框架中的行为不同。AVA 在每次测试后重置计时器，如果在指定的超时内没有收到新的测试结果，则强制测试退出。这可用于处理停滞的测试。</p>
<p><em>没有默认超时。</em></p>
<p>您可以配置使用超时<code>--timeout</code> 命令行选项，或配置文件中设置。它们可以以人类可读的方式设置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 10秒</span></span><br><span class="line">npx ava --timeout = 10s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2分钟</span></span><br><span class="line">npx ava --timeout = 2m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 100毫秒</span></span><br><span class="line">npx ava --timeout = 100</span><br></pre></td></tr></table></figure>

<p>还可以为每个测试单独设置超时。每次进行断言时都会重置这些超时。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">test(<span class="string">"foo"</span>, (t) =&gt; &#123;</span><br><span class="line">  t.timeout(<span class="number">100</span>); <span class="comment">// 100 milliseconds</span></span><br><span class="line">  <span class="comment">// Write your assertions here</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="其他-ava-设置相关"><a href="#其他-ava-设置相关" class="headerlink" title="其他 ava 设置相关"></a>其他 ava 设置相关</h3><h4 id="ESLint"><a href="#ESLint" class="headerlink" title="ESLint"></a>ESLint</h4><p>如果使用了 ESLint，请添加<a href="https://github.com/avajs/eslint-plugin-ava" target="_blank" rel="noopener">eslint-plugin-ava</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"plugins"</span>: [<span class="string">"ava"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="异步相关"><a href="#异步相关" class="headerlink" title="异步相关"></a>异步相关</h4><p>如果异步操作使用 promises，则应返回 promise：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">test(<span class="string">"fetches foo"</span>, (t) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> fetch().then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    t.is(data, <span class="string">"foo"</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>更好的是，使用<code>async</code>/ <code>await</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">test(<span class="string">"fetches foo"</span>, <span class="keyword">async</span> (t) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> fetch();</span><br><span class="line">  t.is(data, <span class="string">"foo"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="测试环境-amp-帮手-Karma"><a href="#测试环境-amp-帮手-Karma" class="headerlink" title="测试环境&amp;帮手 Karma"></a>测试环境&amp;帮手 Karma</h2><p>Karma 是一个基于 Node.js 的 JavaScript 测试执行过程管理工具（Test Runner）。该工具可用于测试所有主流 Web 浏览器，也可以集成到 CI（Continuous integration）工具，还可以和其他代码编辑器一起使用。</p>
<p>Karma 会监控配置文件中所指定的每一个文件，每当文件发生改变，它都会向测试服务器发送信号，来通知所有的浏览器再次运行测试代码。此时，浏览器会重新加载源文件，并执行测试代码。其结果会传递回服务器，并以某种形式显示给开发者。</p>
<p>访问浏览器执行结果，可通过以下的方式</p>
<ul>
<li>手工方式 - 通过浏览器</li>
<li>自动方式 - 让 karma 来启动对应的浏览器</li>
</ul>
<h3 id="工作原理简介"><a href="#工作原理简介" class="headerlink" title="工作原理简介"></a>工作原理简介</h3><p><code>karma</code> 是一个典型的 <code>C/S</code> 程序，包含 client 和 server ，通讯方式基于 <code>Http</code> ，通常情况下，客户端和服务端基本都运行在开发者本地机器上。</p>
<p>一个服务端实例对应一个项目，假如想同时运行多个项目，得同时开启多个服务端实例。</p>
<p><strong>Server</strong></p>
<p><code>Server</code> 是框架的主要组成部分之一，它内部保存了所有的程序运行状态，比如 client 连接，当前运行的单测文件，根据这些数据状态，它提供了下面几个功能， 下图是 server 的结构</p>
<p><img src="/blog/.io//TB13X9xLXXXXXXoaXXXDUoU9pXX-902-329.png" alt="karma_server"></p>
<ul>
<li>监听文件</li>
<li>与 client 进行通讯</li>
<li>向开发者输出测试结果</li>
<li>提供 client 端所需的资源文件</li>
</ul>
<p><strong>Client</strong></p>
<p>client 是单测最终运行的地方，类似一个 web app ， 跟 server 端通讯利用 <code>socket.io</code>， 执行单测在一个独立的 <code>iframe</code> 中。下面是它的结构图</p>
<p><img src="/blog/.io//TB1jTKwLXXXXXX.aXXX0KhCSFXX-619-472.png" alt="karma_impl_client"></p>
<p>client 和 server 端通讯采用 <code>socket.io</code></p>
<ul>
<li>client 端会发送这些消息</li>
</ul>
<p><img src="/blog/.io//TB1XXuILXXXXXcAXFXX.hdJKpXX-918-179.png" alt="karma_impl_client_message_c"></p>
<ul>
<li>server 端会发送这些消息</li>
</ul>
<p><img src="/blog/.io//TB1PvisLXXXXXcqaXXXEHlCNpXX-896-103.png" alt="karma_impl_client_message_s"></p>
<h3 id="安装-Karma"><a href="#安装-Karma" class="headerlink" title="安装 Karma"></a>安装 Karma</h3><p>对于 Nodejs 版本的要求：</p>
<blockquote>
<p>Karma currently works on Node.js <strong>6.x</strong>, <strong>8.x</strong>, and <strong>10.x</strong>. See <a href="https://karma-runner.github.io/4.0/intro/faq.html" target="_blank" rel="noopener">FAQ</a> for more info.</p>
</blockquote>
<ol>
<li><p>全局安装</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">$npm</span> install -g karma</span></span><br></pre></td></tr></table></figure>

<p>安装 Karma 命令会到全局的 <code>node_modules</code> 目录下，我们可以在任何位置直接运行 karma 命令。</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g karma-<span class="keyword">cli</span></span><br></pre></td></tr></table></figure>

<p>此命令用来安装 <code>karma-cli</code>，它会在当前目录下寻找 karma 的可执行文件。这样我们就可以在一个系统内运行多个版本的 Karma。</p>
</li>
<li><p>本地安装</p>
<figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install karma --<span class="built_in">save</span>-<span class="built_in">dev</span></span><br></pre></td></tr></table></figure>

<p>安装 Karma 命令到当前 <code>node_modules</code> 目录下，此时，如果需要执行 karma 命令，就需要这样</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./node_modules/.bin/karma</span></span><br><span class="line"></span><br><span class="line">npx karma <span class="params">--version</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="配置-Karma"><a href="#配置-Karma" class="headerlink" title="配置 Karma"></a>配置 Karma</h3><p>karma 配置文件可以用 JavaScript，CoffeeScript 或 TypeScript 编写，并作为常规 Node.js 模块加载。</p>
<p>除非作为参数提供，否则 Karma CLI 将在以下位置以该顺序(从上至下)查找配置文件</p>
<ul>
<li><code>./karma.conf.js</code></li>
<li><code>./karma.conf.coffee</code></li>
<li><code>./karma.conf.ts</code></li>
<li><code>./.config/karma.conf.js</code></li>
<li><code>./.config/karma.conf.coffee</code></li>
<li><code>./.config/karma.conf.ts</code></li>
</ul>
<p>在配置文件中，配置代码通过设置<code>module.exports</code>指向一个接受一个参数的函数：配置对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// karma.conf.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">config</span>) </span>&#123;</span><br><span class="line">  config.set(&#123;</span><br><span class="line">    basePath: <span class="string">'../..'</span>,</span><br><span class="line">    frameworks: [<span class="string">'jasmine'</span>],</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"># karma.conf.coffee</span><br><span class="line"><span class="built_in">module</span>.exports = (config) -&gt;</span><br><span class="line">  config.set</span><br><span class="line">    basePath: <span class="string">'../..'</span></span><br><span class="line">    frameworks: [<span class="string">'jasmine'</span>]</span><br><span class="line">    # ...</span><br><span class="line"><span class="comment">// karma.conf.ts</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">config</span>) =&gt;</span> &#123;</span><br><span class="line">  config.set(&#123;</span><br><span class="line">    basePath: <span class="string">'../..'</span>,</span><br><span class="line">    frameworks: [<span class="string">'jasmine'</span>],</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>关于 typescript 的支持，需要使用到<code>ts-node</code>，配置 ts-node 以使用<code>commonjs</code>模块格</p>
</blockquote>
<p>配置文件中的基本的属性介绍：<a href="https://karma-runner.github.io/4.0/config/configuration-file.html" target="_blank" rel="noopener">Overview</a></p>
<p>使用 CLI 工具，快速创建配置</p>
<p>开始配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">~/Downloads/Demo is 📦 v1.0.0 via ⬢ v10.16.0</span><br><span class="line">➜ npx karma init</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果在应用中用到了其它的测试框架，那就需要我们安装它们所对应的插件，并在配置文件中标注它们（详见 karma.conf.js 中的 plugins 项）</span></span><br><span class="line">Which testing framework <span class="keyword">do</span> you want to use ?</span><br><span class="line">Press tab to list possible options. Enter to move to the next question.</span><br><span class="line">&gt; jasmine</span><br><span class="line"><span class="comment"># mocha</span></span><br><span class="line"><span class="comment"># qunit</span></span><br><span class="line"><span class="comment"># nodeunit</span></span><br><span class="line"><span class="comment"># nunit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Require.js 是异步加载规范（AMD）的实现。常被作为基础代码库，应用在了很多的项目与框架之中，例如 Dojo, AngularJs 等</span></span><br><span class="line">Do you want to use Require.js ?</span><br><span class="line">This will add Require.js plugin.</span><br><span class="line">Press tab to list possible options. Enter to move to the next question.</span><br><span class="line">&gt; no</span><br><span class="line"><span class="comment"># yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 选择需要运行测试用例的浏览器。需要注意的就是，必须保证所对应的浏览器插件已经安装成功。</span></span><br><span class="line">Do you want to capture any browsers automatically ?</span><br><span class="line">Press tab to list possible options. Enter empty string to move to the next question.</span><br><span class="line">&gt; Chrome</span><br><span class="line"><span class="comment"># ChromeHeadless</span></span><br><span class="line"><span class="comment"># ChromeCanary</span></span><br><span class="line"><span class="comment"># Firefox</span></span><br><span class="line"><span class="comment"># Safari</span></span><br><span class="line"><span class="comment"># PhantomJS</span></span><br><span class="line"><span class="comment"># Opera</span></span><br><span class="line"><span class="comment"># IE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 选择测试用例所在的目录位置。Karma 支持通配符的方式配置文件或目录，例如 *.js, test/**/*.js 等。如果目录或文件使用相对位置，要清楚地是，此时的路径是相对于当前运行 karma 命令时所在的目录。</span></span><br><span class="line">What is the location of your <span class="built_in">source</span> and <span class="built_in">test</span> files ?</span><br><span class="line">You can use glob patterns, eg. <span class="string">"js/*.js"</span> or <span class="string">"test/**/*Spec.js"</span>.</span><br><span class="line">Enter empty string to move to the next question.</span><br><span class="line">&gt; src/*js</span><br><span class="line"></span><br><span class="line"><span class="comment"># 目录中不包括的那些文件。</span></span><br><span class="line">Should any of the files included by the previous patterns be excluded ?</span><br><span class="line">You can use glob patterns, eg. <span class="string">"**/*.swp"</span>.</span><br><span class="line">Enter empty string to move to the next question.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否需要 Karma 自动监听文件？并且文件一旦被修改，就重新运行测试用例？</span></span><br><span class="line">Do you want Karma to watch all the files and run the tests on change ?</span><br><span class="line">Press tab to list possible options.</span><br><span class="line">&gt; yes</span><br></pre></td></tr></table></figure>

<p>生成了一个<code>karma.conf.js</code>文件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Karma configuration</span></span><br><span class="line"><span class="comment">// Generated on Wed Jul 10 2019 22:46:32 GMT+0800 (GMT+08:00)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">config</span>) </span>&#123;</span><br><span class="line">  config.set(&#123;</span><br><span class="line">    <span class="comment">// base path that will be used to resolve all patterns (eg. files, exclude)</span></span><br><span class="line">    basePath: <span class="string">""</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// frameworks to use</span></span><br><span class="line">    <span class="comment">// available frameworks: https://npmjs.org/browse/keyword/karma-adapter</span></span><br><span class="line">    frameworks: [<span class="string">"mocha"</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// list of files / patterns to load in the browser</span></span><br><span class="line">    files: [<span class="string">"src/*js"</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// list of files / patterns to exclude</span></span><br><span class="line">    exclude: [],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// preprocess matching files before serving them to the browser</span></span><br><span class="line">    <span class="comment">// available preprocessors: https://npmjs.org/browse/keyword/karma-preprocessor</span></span><br><span class="line">    preprocessors: &#123;&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// test results reporter to use</span></span><br><span class="line">    <span class="comment">// possible values: 'dots', 'progress'</span></span><br><span class="line">    <span class="comment">// available reporters: https://npmjs.org/browse/keyword/karma-reporter</span></span><br><span class="line">    reporters: [<span class="string">"progress"</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// web server port</span></span><br><span class="line">    port: <span class="number">9876</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// enable / disable colors in the output (reporters and logs)</span></span><br><span class="line">    colors: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// level of logging</span></span><br><span class="line">    <span class="comment">// possible values: config.LOG_DISABLE || config.LOG_ERROR || config.LOG_WARN || config.LOG_INFO || config.LOG_DEBUG</span></span><br><span class="line">    logLevel: config.LOG_INFO,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// enable / disable watching file and executing tests whenever any file changes</span></span><br><span class="line">    autoWatch: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// start these browsers</span></span><br><span class="line">    <span class="comment">// available browser launchers: https://npmjs.org/browse/keyword/karma-launcher</span></span><br><span class="line">    browsers: [<span class="string">"Chrome"</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Continuous Integration mode</span></span><br><span class="line">    <span class="comment">// if true, Karma captures browsers, runs the tests and exits</span></span><br><span class="line">    singleRun: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Concurrency level</span></span><br><span class="line">    <span class="comment">// how many browser should be started simultaneous</span></span><br><span class="line">    concurrency: <span class="literal">Infinity</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="karma-示例"><a href="#karma-示例" class="headerlink" title="karma 示例"></a>karma 示例</h3><p>目标 ：</p>
<ul>
<li>babel 支持，ES6 语法支持</li>
<li>mocha 与 chai 支持</li>
<li>karma 与 chrome、webpack 对接</li>
</ul>
<p>说明：</p>
<p>Karma 对 babel 支持的，一个可选项：<a href="https://github.com/babel/karma-babel-preprocessor" target="_blank" rel="noopener">karma-babel-preprocessor</a>，但是：</p>
<blockquote>
<p>babel and karma-babel-preprocessor only convert ES6 modules to CommonJS/AMD/SystemJS/UMD<strong>. If you choose CommonJS, you still need to resolve and concatenate CommonJS modules on your own</strong>. We recommend <strong>karma-browserify + babelify</strong> or <strong>webpack + babel-loader</strong> in such cases.</p>
</blockquote>
<p>所以，我们选择了 webpack</p>
<ol>
<li><p>安装依赖</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install </span>@<span class="keyword">babel/core </span>@<span class="keyword">babel/preset-env </span>chai mocha webpack webpack-cli <span class="keyword">babel-loader </span>-D</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装 karma 的适配器</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span> karma-webpack karma-chrome-launcher karma-mocha karma-chai -D</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置<code>karma.config.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Karma configuration</span></span><br><span class="line"><span class="comment">// Generated on Thu Jul 11 2019 23:23:44 GMT+0800 (GMT+08:00)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">config</span>) </span>&#123;</span><br><span class="line">  config.set(&#123;</span><br><span class="line">    <span class="comment">// base path that will be used to resolve all patterns (eg. files, exclude)</span></span><br><span class="line">    basePath: <span class="string">""</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// frameworks to use</span></span><br><span class="line">    <span class="comment">// available frameworks: https://npmjs.org/browse/keyword/karma-adapter</span></span><br><span class="line">    frameworks: [<span class="string">"mocha"</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// list of files / patterns to load in the browser</span></span><br><span class="line">    files: [<span class="string">"src/**/*.js"</span>, <span class="string">"test/**/*.js"</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// preprocess matching files before serving them to the browser</span></span><br><span class="line">    <span class="comment">// available preprocessors: https://npmjs.org/browse/keyword/karma-preprocessor</span></span><br><span class="line">    preprocessors: &#123;</span><br><span class="line">      <span class="string">"src/**/*.js"</span>: [<span class="string">"webpack"</span>],</span><br><span class="line">      <span class="string">"test/**/*.js"</span>: [<span class="string">"webpack"</span>],</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    webpack: &#123;</span><br><span class="line">      mode: <span class="string">"none"</span>,</span><br><span class="line">      node: &#123;</span><br><span class="line">        fs: <span class="string">"empty"</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="built_in">module</span>: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">          &#123;</span><br><span class="line">            test: <span class="regexp">/\.js?$/</span>,</span><br><span class="line">            loader: <span class="string">"babel-loader"</span>,</span><br><span class="line">            options: &#123; <span class="attr">presets</span>: [<span class="string">"@babel/env"</span>] &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line"></span><br><span class="line">    plugins: [</span><br><span class="line">      <span class="string">"karma-mocha"</span>,</span><br><span class="line">      <span class="string">"karma-chai"</span>,</span><br><span class="line">      <span class="string">"karma-chrome-launcher"</span>,</span><br><span class="line">      <span class="string">"karma-webpack"</span>,</span><br><span class="line">    ],</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>书写测试用例<code>test.js</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; describe &#125; <span class="keyword">from</span> <span class="string">"mocha"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; expect &#125; <span class="keyword">from</span> <span class="string">"chai"</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"first test"</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">"hello mocha and karma"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"hello mocha"</span>);</span><br><span class="line">    expect(<span class="literal">true</span>).to.be.equal(<span class="literal">true</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>开始测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx karma start</span><br></pre></td></tr></table></figure>

<p>添加到<code>package.json</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "karma": "karma start"</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>然后使用，<code>npm run karma</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">➜ npx karma start</span><br><span class="line">ℹ ｢wdm｣: Hash: 9d2c943b68425fd58dd0</span><br><span class="line">Version: webpack 4.35.3</span><br><span class="line">Time: 53ms</span><br><span class="line">Built at: 2019-07-12 5:07:49 PM</span><br><span class="line">ℹ ｢wdm｣: Compiled successfully.</span><br><span class="line">ℹ ｢wdm｣: Compiling...</span><br><span class="line">⚠ ｢wdm｣: Hash: cca8316f4bd5855fc4de</span><br><span class="line">Version: webpack 4.35.3</span><br><span class="line">Time: 2414ms</span><br><span class="line">Built at: 2019-07-12 5:07:52 PM</span><br><span class="line">       Asset      Size  Chunks             Chunk Names</span><br><span class="line">src/index.js  3.62 KiB       0  [emitted]  src/index</span><br><span class="line"><span class="built_in">test</span>/test.js  1010 KiB       1  [emitted]  <span class="built_in">test</span>/<span class="built_in">test</span></span><br><span class="line">Entrypoint src/index = src/index.js</span><br><span class="line">Entrypoint <span class="built_in">test</span>/<span class="built_in">test</span> = <span class="built_in">test</span>/test.js</span><br><span class="line">  [0] ./src/index.js 27 bytes &#123;0&#125; [built]</span><br><span class="line">  [1] ./<span class="built_in">test</span>/test.js 223 bytes &#123;1&#125; [built]</span><br><span class="line">  [2] ./node_modules/mocha/browser-entry.js 4.19 KiB &#123;1&#125; [built]</span><br><span class="line">  [3] ./node_modules/process/browser.js 4.96 KiB &#123;1&#125; [built]</span><br><span class="line">  [4] (webpack)/buildin/global.js 878 bytes &#123;1&#125; [built]</span><br><span class="line">  [5] ./node_modules/browser-stdout/index.js 662 bytes &#123;1&#125; [built]</span><br><span class="line">  [6] ./node_modules/stream-browserify/index.js 3.53 KiB &#123;1&#125; [built]</span><br><span class="line"> [36] ./node_modules/util/util.js 19 KiB &#123;1&#125; [built]</span><br><span class="line"> [38] ./node_modules/mocha/lib/mocha.js 21.8 KiB &#123;1&#125; [built]</span><br><span class="line"> [39] (webpack)/buildin/module.js 552 bytes &#123;1&#125; [built]</span><br><span class="line"> [40] ./node_modules/escape-string-regexp/index.js 230 bytes &#123;1&#125; [built]</span><br><span class="line"> [41] path (ignored) 15 bytes &#123;1&#125; [built]</span><br><span class="line"> [42] ./node_modules/mocha/lib/reporters/index.js 945 bytes &#123;1&#125; [built]</span><br><span class="line">[105] ./node_modules/chai/index.js 39 bytes &#123;1&#125; [built]</span><br><span class="line">[106] ./node_modules/chai/lib/chai.js 1.22 KiB &#123;1&#125; [built]</span><br><span class="line">    + 128 hidden modules</span><br><span class="line"></span><br><span class="line">WARNING <span class="keyword">in</span> ./node_modules/mocha/lib/mocha.js 217:20-37</span><br><span class="line">Critical dependency: the request of a dependency is an expression</span><br><span class="line"> @ ./node_modules/mocha/browser-entry.js</span><br><span class="line"> @ ./<span class="built_in">test</span>/test.js</span><br><span class="line"></span><br><span class="line">WARNING <span class="keyword">in</span> ./node_modules/mocha/lib/mocha.js 222:24-70</span><br><span class="line">Critical dependency: the request of a dependency is an expression</span><br><span class="line"> @ ./node_modules/mocha/browser-entry.js</span><br><span class="line"> @ ./<span class="built_in">test</span>/test.js</span><br><span class="line"></span><br><span class="line">WARNING <span class="keyword">in</span> ./node_modules/mocha/lib/mocha.js 266:24-35</span><br><span class="line">Critical dependency: the request of a dependency is an expression</span><br><span class="line"> @ ./node_modules/mocha/browser-entry.js</span><br><span class="line"> @ ./<span class="built_in">test</span>/test.js</span><br><span class="line"></span><br><span class="line">WARNING <span class="keyword">in</span> ./node_modules/mocha/lib/mocha.js 313:35-48</span><br><span class="line">Critical dependency: the request of a dependency is an expression</span><br><span class="line"> @ ./node_modules/mocha/browser-entry.js</span><br><span class="line"> @ ./<span class="built_in">test</span>/test.js</span><br><span class="line"></span><br><span class="line">WARNING <span class="keyword">in</span> ./node_modules/mocha/lib/mocha.js 329:23-44</span><br><span class="line">Critical dependency: the request of a dependency is an expression</span><br><span class="line"> @ ./node_modules/mocha/browser-entry.js</span><br><span class="line"> @ ./<span class="built_in">test</span>/test.js</span><br><span class="line">ℹ ｢wdm｣: Compiled with warnings.</span><br><span class="line">12 07 2019 17:07:52.761:WARN [karma]: No captured browser, open http://localhost:9876/</span><br><span class="line">12 07 2019 17:07:52.770:INFO [karma-server]: Karma v4.1.0 server started at http://0.0.0.0:9876/</span><br><span class="line">12 07 2019 17:07:52.770:INFO [launcher]: Launching browsers Chrome with concurrency unlimited</span><br><span class="line">12 07 2019 17:07:52.773:INFO [launcher]: Starting browser Chrome</span><br><span class="line">12 07 2019 17:07:54.135:INFO [Chrome 75.0.3770 (Mac OS X 10.14.5)]: Connected on socket R9R31QB1GtR_kayNAAAA with id 55412577</span><br><span class="line">Chrome 75.0.3770 (Mac OS X 10.14.5) LOG: <span class="string">'hello karma'</span></span><br><span class="line"></span><br><span class="line">LOG: <span class="string">'hello mocha'</span></span><br><span class="line">Chrome 75.0.3770 (Mac OS X 10.14.5): Executed 1 of 1 SUCCESS (0 secs / 0.001 secs</span><br><span class="line">~/Downloads/karma-demo is 📦 v1.0.0 via ⬢ v10.16.0</span><br><span class="line">➜ npm run karma</span><br><span class="line"></span><br><span class="line">&gt; karma-demo@1.0.0 karma /Users/huasheng/Downloads/karma-demo</span><br><span class="line">&gt; karma start</span><br><span class="line"></span><br><span class="line">ℹ ｢wdm｣: Hash: 9d2c943b68425fd58dd0</span><br><span class="line">Version: webpack 4.35.3</span><br><span class="line">Time: 48ms</span><br><span class="line">Built at: 2019-07-12 5:24:02 PM</span><br><span class="line">ℹ ｢wdm｣: Compiled successfully.</span><br><span class="line">ℹ ｢wdm｣: Compiling...</span><br><span class="line">⚠ ｢wdm｣: Hash: cca8316f4bd5855fc4de</span><br><span class="line">Version: webpack 4.35.3</span><br><span class="line">Time: 2307ms</span><br><span class="line">Built at: 2019-07-12 5:24:04 PM</span><br><span class="line">       Asset      Size  Chunks             Chunk Names</span><br><span class="line">src/index.js  3.62 KiB       0  [emitted]  src/index</span><br><span class="line"><span class="built_in">test</span>/test.js  1010 KiB       1  [emitted]  <span class="built_in">test</span>/<span class="built_in">test</span></span><br><span class="line">Entrypoint src/index = src/index.js</span><br><span class="line">Entrypoint <span class="built_in">test</span>/<span class="built_in">test</span> = <span class="built_in">test</span>/test.js</span><br><span class="line">  [0] ./src/index.js 27 bytes &#123;0&#125; [built]</span><br><span class="line">  [1] ./<span class="built_in">test</span>/test.js 223 bytes &#123;1&#125; [built]</span><br><span class="line">  [2] ./node_modules/mocha/browser-entry.js 4.19 KiB &#123;1&#125; [built]</span><br><span class="line">  [3] ./node_modules/process/browser.js 4.96 KiB &#123;1&#125; [built]</span><br><span class="line">  [4] (webpack)/buildin/global.js 878 bytes &#123;1&#125; [built]</span><br><span class="line">  [5] ./node_modules/browser-stdout/index.js 662 bytes &#123;1&#125; [built]</span><br><span class="line">  [6] ./node_modules/stream-browserify/index.js 3.53 KiB &#123;1&#125; [built]</span><br><span class="line"> [36] ./node_modules/util/util.js 19 KiB &#123;1&#125; [built]</span><br><span class="line"> [38] ./node_modules/mocha/lib/mocha.js 21.8 KiB &#123;1&#125; [built]</span><br><span class="line"> [39] (webpack)/buildin/module.js 552 bytes &#123;1&#125; [built]</span><br><span class="line"> [40] ./node_modules/escape-string-regexp/index.js 230 bytes &#123;1&#125; [built]</span><br><span class="line"> [41] path (ignored) 15 bytes &#123;1&#125; [built]</span><br><span class="line"> [42] ./node_modules/mocha/lib/reporters/index.js 945 bytes &#123;1&#125; [built]</span><br><span class="line">[105] ./node_modules/chai/index.js 39 bytes &#123;1&#125; [built]</span><br><span class="line">[106] ./node_modules/chai/lib/chai.js 1.22 KiB &#123;1&#125; [built]</span><br><span class="line">    + 128 hidden modules</span><br><span class="line"></span><br><span class="line">WARNING <span class="keyword">in</span> ./node_modules/mocha/lib/mocha.js 217:20-37</span><br><span class="line">Critical dependency: the request of a dependency is an expression</span><br><span class="line"> @ ./node_modules/mocha/browser-entry.js</span><br><span class="line"> @ ./<span class="built_in">test</span>/test.js</span><br><span class="line"></span><br><span class="line">WARNING <span class="keyword">in</span> ./node_modules/mocha/lib/mocha.js 222:24-70</span><br><span class="line">Critical dependency: the request of a dependency is an expression</span><br><span class="line"> @ ./node_modules/mocha/browser-entry.js</span><br><span class="line"> @ ./<span class="built_in">test</span>/test.js</span><br><span class="line"></span><br><span class="line">WARNING <span class="keyword">in</span> ./node_modules/mocha/lib/mocha.js 266:24-35</span><br><span class="line">Critical dependency: the request of a dependency is an expression</span><br><span class="line"> @ ./node_modules/mocha/browser-entry.js</span><br><span class="line"> @ ./<span class="built_in">test</span>/test.js</span><br><span class="line"></span><br><span class="line">WARNING <span class="keyword">in</span> ./node_modules/mocha/lib/mocha.js 313:35-48</span><br><span class="line">Critical dependency: the request of a dependency is an expression</span><br><span class="line"> @ ./node_modules/mocha/browser-entry.js</span><br><span class="line"> @ ./<span class="built_in">test</span>/test.js</span><br><span class="line"></span><br><span class="line">WARNING <span class="keyword">in</span> ./node_modules/mocha/lib/mocha.js 329:23-44</span><br><span class="line">Critical dependency: the request of a dependency is an expression</span><br><span class="line"> @ ./node_modules/mocha/browser-entry.js</span><br><span class="line"> @ ./<span class="built_in">test</span>/test.js</span><br><span class="line">ℹ ｢wdm｣: Compiled with warnings.</span><br><span class="line">12 07 2019 17:24:04.905:WARN [karma]: No captured browser, open http://localhost:9876/</span><br><span class="line">12 07 2019 17:24:04.914:INFO [karma-server]: Karma v4.1.0 server started at http://0.0.0.0:9876/</span><br><span class="line">12 07 2019 17:24:04.914:INFO [launcher]: Launching browsers Chrome with concurrency unlimited</span><br><span class="line">12 07 2019 17:24:04.922:INFO [launcher]: Starting browser Chrome</span><br><span class="line">12 07 2019 17:24:06.289:INFO [Chrome 75.0.3770 (Mac OS X 10.14.5)]: Connected on socket EbCCSbQRPbxHbq3OAAAA with id 92342032</span><br><span class="line">Chrome 75.0.3770 (Mac OS X 10.14.5) LOG: <span class="string">'hello karma'</span></span><br><span class="line"></span><br><span class="line">LOG: <span class="string">'hello mocha'</span></span><br><span class="line">Chrome 75.0.3770 (Mac OS X 10.14.5): Executed 1 of 1 SUCCESS (0 secs / 0.001 secs</span><br><span class="line">Chrome 75.0.3770 (Mac OS X 10.14.5): Executed 1 of 1 SUCCESS (0.006 secs / 0.001</span><br><span class="line">secs)</span><br><span class="line">TOTAL: 1 SUCCESS</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="UI-测试利器-Nightmare"><a href="#UI-测试利器-Nightmare" class="headerlink" title="UI 测试利器 Nightmare"></a>UI 测试利器 Nightmare</h2><p>Nightmare 是<a href="https://segment.com/" target="_blank" rel="noopener">Segment</a>的高级浏览器自动化库。</p>
<p>目标是公开一些模仿用户操作（例如<code>goto</code>，<code>type</code>和<code>click</code>）的简单方法，使用对每个脚本块感觉同步的 API，而不是深层嵌套的回调。它最初设计用于在没有 API 的站点之间自动执行任务，但最常用于 UI 测试和爬网。</p>
<p>它使用<a href="http://electron.atom.io/" target="_blank" rel="noopener">Electron</a>，它与<a href="http://phantomjs.org/" target="_blank" rel="noopener">PhantomJS</a>类似，但大约<a href="https://github.com/segmentio/nightmare/issues/484#issuecomment-184519591" target="_blank" rel="noopener">快两倍</a>，更现代。</p>
<h3 id="安装与起步"><a href="#安装与起步" class="headerlink" title="安装与起步"></a>安装与起步</h3><ol>
<li><p>安装<code>nightmare</code></p>
</li>
<li><pre><code>// 初始化项目
npm init -y

npm install --save-dev nightmare

<figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">npm install --<span class="built_in">save</span>-<span class="built_in">dev</span> mocha</span><br></pre></td></tr></table></figure></code></pre></li>
<li><p>淘宝源加速</p>
</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 使用淘宝源加速 electron 的安装</span></span><br><span class="line"><span class="keyword">export</span> ELECTRON_MIRROR=<span class="string">"https://npm.taobao.org/mirrors/electron/"</span></span><br><span class="line"></span><br><span class="line">`</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>起步测试：</li>
</ol>
<p>​```js<br>const Nightmare = require(‘nightmare’)<br>const assert = require(‘assert’)</p>
<p>describe(‘Load a Page’, function () {<br>  // Recommended: 5s locally, 10s to remote server, 30s from airplane ¯_(ツ)_/¯<br>  this.timeout(‘30s’)</p>
<p>  let nightmare = null<br>  beforeEach(() =&gt; {<br>    nightmare = new Nightmare()<br>  })</p>
<p>  describe(‘/ (Home Page)’, () =&gt; {<br>    it(‘should load without error’, done =&gt; {<br>      // your actual testing urls will likely be <code>http://localhost:port/path</code><br>      nightmare.goto(‘<a href="https://www.baidu.com&#39;" target="_blank" rel="noopener">https://www.baidu.com&#39;</a>)<br>        .end()<br>        .then(function (result) {<br>          done()<br>        })<br>        .catch(done)<br>    })<br>  })<br>})</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### nightmare 配合 mocha 测试</span><br><span class="line"></span><br><span class="line">nightmare 可以进行网页的抓取，配合 mocha 进行页面的测试：</span><br><span class="line"></span><br><span class="line">安装&#96;mocha&#96;</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;bash</span><br><span class="line">npm install --save-dev mocha</span><br></pre></td></tr></table></figure>

<blockquote>
<p>还可以安装一些断言库，如：<code>chai</code></p>
</blockquote>
<p>新建测试：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Nightmare = <span class="built_in">require</span>(<span class="string">"nightmare"</span>);</span><br><span class="line"><span class="keyword">const</span> assert = <span class="built_in">require</span>(<span class="string">"assert"</span>);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"Search nightmare"</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">this</span>.timeout(<span class="string">"30s"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> nightmare = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    nightmare = <span class="keyword">new</span> Nightmare();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">"should load with result nightmare"</span>, (done) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> selector = <span class="string">"em"</span>;</span><br><span class="line">    nightmare</span><br><span class="line">      .goto(<span class="string">"https://www.baidu.com"</span>)</span><br><span class="line">      .type(<span class="string">"#kw"</span>, <span class="string">"nightmare"</span>)</span><br><span class="line">      .click(<span class="string">"#su"</span>)</span><br><span class="line">      .wait(<span class="string">"em"</span>)</span><br><span class="line">      .evaluate(<span class="function">(<span class="params">selector</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// now we're executing inside the browser scope.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">document</span>.querySelector(selector).innerText;</span><br><span class="line">      &#125;, selector) <span class="comment">// &lt;-- that's how you pass parameters from Node scope to browser scope</span></span><br><span class="line">      .end()</span><br><span class="line">      .then(<span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(result);</span><br><span class="line">        assert.equal(result, <span class="string">"nightmare"</span>);</span><br><span class="line">        done();</span><br><span class="line">      &#125;)</span><br><span class="line">      .catch(done);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>将 mocha 作为测试脚本添加到您的 <code>package.json</code>：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "test": "mocha"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="API-介绍"><a href="#API-介绍" class="headerlink" title="API 介绍"></a>API 介绍</h3><h4 id="nightmare-的配置项"><a href="#nightmare-的配置项" class="headerlink" title="nightmare 的配置项"></a>nightmare 的配置项</h4><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">waitTimeout</span> (<span class="attribute">default</span>: <span class="number">30s</span>)</span><br><span class="line"><span class="selector-tag">gotoTimeout</span> (<span class="attribute">default</span>: <span class="number">30s</span>)</span><br><span class="line"><span class="selector-tag">loadTimeout</span> (<span class="attribute">default</span>: infinite)</span><br><span class="line"><span class="selector-tag">executionTimeout</span> (<span class="attribute">default</span>: <span class="number">30s</span>)</span><br><span class="line"><span class="selector-tag">paths</span></span><br><span class="line"><span class="selector-tag">switches</span></span><br><span class="line"><span class="selector-tag">electronPath</span></span><br><span class="line"><span class="selector-tag">dock</span></span><br><span class="line"><span class="selector-tag">openDevTools</span></span><br><span class="line"><span class="selector-tag">typeInterval</span> (<span class="attribute">default</span>: <span class="number">100ms</span>)</span><br><span class="line"><span class="selector-tag">pollInterval</span> (<span class="attribute">default</span>: <span class="number">250ms</span>)</span><br><span class="line"><span class="selector-tag">maxAuthRetries</span> (<span class="attribute">default</span>: <span class="number">3</span>)</span><br><span class="line"><span class="selector-tag">certificateSubjectName</span></span><br><span class="line"><span class="selector-class">.engineVersions</span>()</span><br><span class="line"><span class="selector-class">.useragent</span>(useragent)</span><br><span class="line"><span class="selector-class">.authentication</span>(user, password)</span><br><span class="line"><span class="selector-class">.authentication</span>(user, password)</span><br><span class="line"><span class="selector-class">.halt</span>(error, done)</span><br></pre></td></tr></table></figure>

<p>配置链接：<a href="https://github.com/segmentio/nightmare#nightmareoptions" target="_blank" rel="noopener">https://github.com/segmentio/nightmare#nightmareoptions</a></p>
<h4 id="页面交互相关"><a href="#页面交互相关" class="headerlink" title="页面交互相关"></a>页面交互相关</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.back</span>()</span><br><span class="line"><span class="selector-class">.forward</span>()</span><br><span class="line"><span class="selector-class">.refresh</span>()</span><br><span class="line"><span class="selector-class">.click</span>(<span class="selector-tag">selector</span>)</span><br><span class="line"><span class="selector-class">.mousedown</span>(<span class="selector-tag">selector</span>)</span><br><span class="line"><span class="selector-class">.mouseup</span>(<span class="selector-tag">selector</span>)</span><br><span class="line"><span class="selector-class">.mouseover</span>(<span class="selector-tag">selector</span>)</span><br><span class="line"><span class="selector-class">.mouseout</span>(<span class="selector-tag">selector</span>)</span><br><span class="line"><span class="selector-class">.type</span>(<span class="selector-tag">selector</span><span class="selector-attr">[, text]</span>)</span><br><span class="line"><span class="selector-class">.insert</span>(<span class="selector-tag">selector</span><span class="selector-attr">[, text]</span>)</span><br><span class="line"><span class="selector-class">.check</span>(<span class="selector-tag">selector</span>)</span><br><span class="line"><span class="selector-class">.uncheck</span>(<span class="selector-tag">selector</span>)</span><br><span class="line"><span class="selector-class">.select</span>(<span class="selector-tag">selector</span>, <span class="selector-tag">option</span>)</span><br><span class="line"><span class="selector-class">.scrollTo</span>(<span class="selector-tag">top</span>, <span class="selector-tag">left</span>)</span><br><span class="line"><span class="selector-class">.viewport</span>(<span class="selector-tag">width</span>, <span class="selector-tag">height</span>)</span><br><span class="line"><span class="selector-class">.inject</span>(<span class="selector-tag">type</span>, <span class="selector-tag">file</span>)</span><br><span class="line"><span class="selector-class">.evaluate</span>(<span class="selector-tag">fn</span><span class="selector-attr">[, arg1, arg2,...]</span>)</span><br><span class="line"><span class="selector-class">.wait</span>(<span class="selector-tag">ms</span>)</span><br><span class="line"><span class="selector-class">.wait</span>(<span class="selector-tag">selector</span>)</span><br><span class="line"><span class="selector-class">.wait</span>(<span class="selector-tag">fn</span><span class="selector-attr">[, arg1, arg2,...]</span>)</span><br><span class="line"><span class="selector-class">.header</span>(<span class="selector-tag">header</span>, <span class="selector-tag">value</span>)</span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/segmentio/nightmare#interact-with-the-page" target="_blank" rel="noopener">配置参考链接</a></p>
<h4 id="页面提取"><a href="#页面提取" class="headerlink" title="页面提取"></a>页面提取</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.exists</span>(<span class="selector-tag">selector</span>)</span><br><span class="line"><span class="selector-class">.visible</span>(<span class="selector-tag">selector</span>)</span><br><span class="line"><span class="selector-class">.on</span>(<span class="selector-tag">event</span>, <span class="selector-tag">callback</span>)</span><br><span class="line"><span class="selector-class">.once</span>(<span class="selector-tag">event</span>, <span class="selector-tag">callback</span>)</span><br><span class="line"><span class="selector-class">.removeListener</span>(<span class="selector-tag">event</span>, <span class="selector-tag">callback</span>)</span><br><span class="line"><span class="selector-class">.screenshot</span>(<span class="selector-attr">[path]</span><span class="selector-attr">[, clip]</span>)</span><br><span class="line"><span class="selector-class">.html</span>(<span class="selector-tag">path</span>, <span class="selector-tag">saveType</span>)</span><br><span class="line"><span class="selector-class">.pdf</span>(<span class="selector-tag">path</span>, <span class="selector-tag">options</span>)</span><br><span class="line"><span class="selector-class">.title</span>()</span><br><span class="line"><span class="selector-class">.url</span>()</span><br><span class="line"><span class="selector-class">.path</span>()</span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/segmentio/nightmare#extract-from-the-page" target="_blank" rel="noopener">配置参考链接</a></p>
<h2 id="其他相关"><a href="#其他相关" class="headerlink" title="其他相关"></a>其他相关</h2><h3 id="补充资料"><a href="#补充资料" class="headerlink" title="补充资料"></a>补充资料</h3><h4 id="软件测试的分类"><a href="#软件测试的分类" class="headerlink" title="软件测试的分类"></a>软件测试的分类</h4><p><strong>第一部分：软件测试的分类</strong></p>
<ul>
<li><p>按测试执行阶段划分</p>
<p>单元测试、集成测试、系统测试、验收测试（正式验收测试、Alpha 测试、Beta 测试）</p>
</li>
<li><p>按测试技术划分</p>
<p>白盒测试、黑盒测试、灰盒测试</p>
</li>
<li><p>被测试对象是否运行划分</p>
<p>动态测试、静态测试（文档检查、代码走查、界面检查）</p>
</li>
<li><p>按不同的测试手段划分</p>
<p>手工测试、自动化测试</p>
</li>
<li><p>按测试包含的内容划分</p>
<p>功能测试、界面测试、安全测试、兼容性测试、易用性测试、性能测试、压力测试、负载测试、恢复测试</p>
</li>
<li><p>其他测试</p>
<p>冒烟测试、回归测试、探索性测试/自由测试（测试思维）</p>
</li>
</ul>
<p><strong>第二部分：接下来对软件测试分类进行一个说明</strong></p>
<p><strong>第三部分：测试工具</strong></p>
<p>SVN，Git——&gt;版本控制管理工具</p>
<p>禅道——&gt;Bug 管理工具</p>
<p>Fiddler——&gt;抓包，定位问题你</p>
<p>postman，jmeter，soapui——&gt;接口测试</p>
<p>Loadrunner，Jmeter——&gt;性能，压力测试</p>
<h4 id="2019-年-Javascript-测试概览"><a href="#2019-年-Javascript-测试概览" class="headerlink" title="2019 年 Javascript 测试概览"></a>2019 年 Javascript 测试概览</h4><p><a href="https://medium.com/welldone-software/an-overview-of-javascript-testing-in-2019-264e19514d0a" target="_blank" rel="noopener">https://medium.com/welldone-software/an-overview-of-javascript-testing-in-2019-264e19514d0a</a></p>
<p>这是一篇非常好的国外的博文，同时也是 2018 年 Javascript 测试概览的作者。这里有 2018 年的译文：</p>
<p><a href="https://zhuanlan.zhihu.com/p/32702421" target="_blank" rel="noopener">展望 2018 年 JavaScript Testing</a></p>
<p>在文中很好介绍到了测试类型，并举了大量的例子，非常全面。</p>
<h4 id="什么是-TDD？"><a href="#什么是-TDD？" class="headerlink" title="什么是 TDD？"></a>什么是 TDD？</h4><p><a href="https://juejin.im/post/5c3e73876fb9a049d37f5db1" target="_blank" rel="noopener">测试驱动开发（TDD）总结——原理篇</a></p>
<p>TDD （Test Driven Development） 在不同的圈子、不同的角色的认知中可能会有不同的理解，有人可能会理解成 ATDD（Acceptance Test Driven Development），也有人可能会理解成 UTDD（Unit Test Driven Development），为了避免产生歧义，<strong>文章涉及到 TDD 专指 UTDD（Unit Test Driven Development），即 「单元测试驱动开发」</strong>。</p>
<p>TDD 的目标</p>
<blockquote>
<p>Kent Beck 在他的著作《Test-Driven Development》一书中提到：“<strong>代码简洁可用</strong>这句言简意赅的话，正是 TDD 所追求的目标”。</p>
</blockquote>
<p><strong>对于如何保证“代码简洁可用”可以使用分而治之的方法，先达到“可用”目标，再追求“简洁”目标。</strong></p>
<p><strong>可用：</strong> 保证代码通过自动化测试。</p>
<p><strong>代码简洁：</strong> 在不同阶段人们对简洁的理解程度也不一样，不过遵循的原则差不多，例如 OOD 的 SOLID 原则，Kent Beck 的 Simple Design 原则等。</p>
<p>虽然有很多因素妨碍我们得到整洁的代码，甚至可用的代码，无需征求太多意见，只需要采用 TDD 的开发方式来驱动出简洁可用的代码。</p>
<h4 id="Karma-的前世今生"><a href="#Karma-的前世今生" class="headerlink" title="Karma 的前世今生"></a>Karma 的前世今生</h4><p>2016 年的文章，由淘宝前端团队书写：<a href="http://taobaofed.org/blog/2016/01/08/karma-origin/" target="_blank" rel="noopener">http://taobaofed.org/blog/2016/01/08/karma-origin/</a></p>
<p>通篇介绍了 karma 的工作原理及实现原理，非常有价值的文章。</p>
<h3 id="ava-框架的配置文件"><a href="#ava-框架的配置文件" class="headerlink" title="ava 框架的配置文件"></a>ava 框架的配置文件</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"ava"</span>: &#123;</span><br><span class="line">    <span class="attr">"files"</span>: [</span><br><span class="line">      <span class="string">"test/**/*"</span>,</span><br><span class="line">      <span class="string">"!test/exclude-files-in-this-directory"</span>,</span><br><span class="line">      <span class="string">"!**/exclude-files-with-this-name.*"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"helpers"</span>: [<span class="string">"**/helpers/**/*"</span>],</span><br><span class="line">    <span class="attr">"sources"</span>: [<span class="string">"src/**/*"</span>],</span><br><span class="line">    <span class="attr">"match"</span>: [<span class="string">"*oo"</span>, <span class="string">"!foo"</span>],</span><br><span class="line">    <span class="attr">"cache"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"concurrency"</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">"failFast"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"failWithoutAssertions"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"environmentVariables"</span>: &#123;</span><br><span class="line">      <span class="attr">"MY_ENVIRONMENT_VARIABLE"</span>: <span class="string">"some value"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"tap"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"verbose"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"compileEnhancements"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"require"</span>: [<span class="string">"@babel/register"</span>],</span><br><span class="line">    <span class="attr">"babel"</span>: &#123;</span><br><span class="line">      <span class="attr">"extensions"</span>: [<span class="string">"js"</span>, <span class="string">"jsx"</span>],</span><br><span class="line">      <span class="attr">"testOptions"</span>: &#123;</span><br><span class="line">        <span class="attr">"babelrc"</span>: <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>files</code>：用于选择测试文件的 glob 模式数组。带有下划线前缀的文件将被忽略。默认情况下，仅选择具有<code>js</code>扩展名的文件，即使该模式与其他文件匹配。指定<code>extensions</code>并<code>babel.extensions</code>允许其他文件扩展名</li>
<li><code>helpers</code>：用于选择帮助文件的 glob 模式数组。这里匹配的文件永远不会被视为测试。默认情况下，仅选择具有<code>js</code>扩展名的文件，即使该模式与其他文件匹配。指定<code>extensions</code>并<code>babel.extensions</code>允许其他文件扩展名</li>
<li><code>sources</code>：一组 glob 模式，用于匹配文件，这些文件在更改时会导致重新运行测试（在监视模式下）。有关详细信息，<a href="https://github.com/avajs/ava/blob/master/docs/recipes/watch-mode.md#source-files-and-test-files" target="_blank" rel="noopener">请参阅</a></li>
<li><code>match</code>：通常在<code>package.json</code>配置中没用，但等同于在 CLI 上指定<code>--match</code></li>
<li><code>cache</code>：缓存编译的测试和帮助文件<code>node_modules/.cache/ava</code>。如果<code>false</code>，文件缓存在临时目录中</li>
<li><code>failFast</code>：一旦测试失败，停止运行进一步的测试</li>
<li><code>failWithoutAssertions</code>：如果设置成<code>false</code>，那么如果没有运行断言，则测试失败</li>
<li><code>environmentVariables</code>：指定要供测试使用的环境变量。此处定义的环境变量会覆盖其中的环境变量<code>process.env</code></li>
<li><code>tap</code>：设置成 <code>true</code>，启用 TAP 报告</li>
<li><code>verbose</code>：设置成 <code>true</code>，启用详细输出</li>
<li><code>snapshotDir</code>：指定用于存储快照文件的固定位置。如果快照最终位于错误的位置，请使用此选项</li>
<li><code>compileEnhancements</code>：设置成 <code>false</code>，禁用了 <a href="https://github.com/avajs/ava/blob/master/docs/03-assertions.md#enhanced-assertion-messages" target="_blank" rel="noopener"><code>power-assert</code></a>，否则有助于提供更具描述性的错误消息， 并检测<code>t.throws()</code>断言的不当使用</li>
<li><code>extensions</code>：未使用 AVA 的 Babel 预设进行预编译的测试文件的扩展名。请注意，文件仍然会被编译为启用<code>power-assert</code>和其他功能，因此您可能还需要设置<code>compileEnhancements</code>为<code>false</code>文件是否为有效的 JavaScript。设置此<code>&quot;js&quot;</code>值会覆盖默认值，因此请确保在列表中包含该扩展名，只要它不包含在内<code>babel.extensions</code></li>
<li><code>require</code>：在运行测试之前需要额外的模块。工作进程中需要模块</li>
<li><code>babel</code>：测试文件特定的 Babel 选项。有关详细信息，请参阅<a href="https://github.com/avajs/ava/blob/master/docs/recipes/babel.md#configuring-babel" target="_blank" rel="noopener">Babel 配置</a></li>
<li><code>babel.extensions</code>：将使用 AVA 的 Babel 预设进行预编译的测试文件的扩展。设置此选项会覆盖默认<code>&quot;js&quot;</code>值，因此请确保在列表中包含该扩展名。</li>
<li><code>timeout</code>：AVA 中的超时行为与其他测试框架中的行为不同。AVA 在每次测试后重置计时器，如果在指定的超时内没有收到新的测试结果，则强制测试退出。这可用于处理停滞的测试。请参阅我们的<a href="https://github.com/avajs/ava/blob/master/docs/07-test-timeouts.md" target="_blank" rel="noopener">超时文档</a>以获取更多选</li>
</ul>
<p>请注意，在 CLI 上提供文件会覆盖该<code>files</code>选项。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://zhuanlan.zhihu.com/p/47009664" target="_blank" rel="noopener">使用 Jest 测试 JavaScript(Mock 篇)</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://supertinypeanut.github.io/blog/2021/01/25/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" data-id="ckmm8vad1002q85qsapqx5nxy" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96/" rel="tag">前端工程化</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-async-validator基本使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2020/12/27/async-validator%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/" class="article-date">
  <time datetime="2020-12-27T17:10:10.000Z" itemprop="datePublished">2020-12-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2020/12/27/async-validator%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/">async-validator基本使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="业务需求"><a href="#业务需求" class="headerlink" title="业务需求"></a>业务需求</h2><p>最近公司业务需求，需要实现一个表单设计器。在编写和保存时都需要进行schema校验，组件库使用 antdv，所以首选<code>async-validator</code>作为表单校验库并配合 antdv 使用。在学习过程中，并整理一下所学知识方便查阅。</p>
<p>##async-validator</p>
<p>一个用于表单异步校验的库，参考了 <a href="https://github.com/freeformsystems/async-validate" target="_blank" rel="noopener">https://github.com/freeformsystems/async-validate</a></p>
<h3 id="Usage-使用方法"><a href="#Usage-使用方法" class="headerlink" title="Usage 使用方法"></a>Usage 使用方法</h3><p>基本的使用方法：定义一个 descriptor，将它传入 schema，得到一个 validator。将需要校验的对象和回调传入 validator.validate 方法中。</p>
<p>注：descriptor 是对校验规则的描述，validator 是根据校验规则得到的校验器</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> schema = <span class="built_in">require</span>(<span class="string">'async-validator'</span>);</span><br><span class="line"><span class="keyword">var</span> descriptor = &#123;</span><br><span class="line">  name: &#123;</span><br><span class="line">    type: <span class="string">"string"</span>,</span><br><span class="line">    required: <span class="literal">true</span>,</span><br><span class="line">    validator: <span class="function">(<span class="params">rule, value</span>) =&gt;</span> value === <span class="string">'Peanut'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> validator = <span class="keyword">new</span> schema(descriptor);</span><br><span class="line">validator.validate(&#123;<span class="attr">name</span>: <span class="string">"Peanut"</span>&#125;, (errors, fields) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span>(errors) &#123;</span><br><span class="line">    <span class="comment">// validation failed, errors is an array of all errors</span></span><br><span class="line">    <span class="comment">// fields is an object keyed by field name with an array of</span></span><br><span class="line">    <span class="comment">// errors per field</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验未通过的情况，errors 是所有错误的数组</span></span><br><span class="line">    <span class="comment">// fields 是一个 object，以字段作为 key 值，该字段对应的错误数组作为 value</span></span><br><span class="line">    <span class="comment">// （其实 fields 就是把 errors 按照原对象的 key 值分组）</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> handleErrors(errors, fields);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// validation passed</span></span><br><span class="line">  <span class="comment">// 这里说明校验已通过</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// PROMISE USAGE</span></span><br><span class="line"><span class="comment">// Promise 式用法</span></span><br><span class="line"></span><br><span class="line">validator.validate(&#123;</span><br><span class="line">  name: <span class="string">"Peanut"</span>,</span><br><span class="line">  asyncValidator: <span class="function">(<span class="params">rule, value</span>) =&gt;</span> axios.post(<span class="string">'/nameValidator'</span>, &#123; <span class="attr">name</span>: value &#125;),</span><br><span class="line">&#125;, (errors, fields) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span>(errors) &#123;</span><br><span class="line">    <span class="comment">// validation failed, errors is an array of all errors</span></span><br><span class="line">    <span class="comment">// fields is an object keyed by field name with an array of</span></span><br><span class="line">    <span class="comment">// errors per field</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验未通过的情况，errors 和 fields 同上</span></span><br><span class="line">    <span class="keyword">return</span> handleErrors(errors, fields);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// validation passed</span></span><br><span class="line">  <span class="comment">// 校验通过</span></span><br><span class="line">&#125;)</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// validation passed</span></span><br><span class="line">	<span class="comment">// 校验通过</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function">(<span class="params">&#123; errors, fields &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> handleErrors(errors, fields);</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<h4 id="Validate-方法参数"><a href="#Validate-方法参数" class="headerlink" title="Validate 方法参数"></a>Validate 方法参数</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">source, [options], callback</span>): <span class="title">Promise</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>source</code>: 需要校验的对象（必填）.</li>
<li><code>options</code>: 校验选项（可选）.</li>
<li><code>callback</code>: 校验完成时的回调（必填）.</li>
</ul>
<hr>
<p>方法返回一个 Promise 对象:</p>
<ul>
<li><code>then()</code>，说明校验通过</li>
<li><code>catch({ errors, fields })</code>，校验未通过，errors, fields 含义见前面示例</li>
</ul>
<hr>
<h3 id="Options-选项"><a href="#Options-选项" class="headerlink" title="Options 选项"></a>Options 选项</h3><ul>
<li><code>first</code>: Boolean, 遇见第一个未通过校验的值时便调用 <code>callback</code> 回调，不再继续校验剩余规则。<br>适用情况：校验涉及到多个异步调用，比如数据库查询，而你只需要获取首个校验错误时</li>
<li><code>firstFields</code>: Boolean|String[], 对于指定字段，遇见第一条未通过的校验规则时便调用 <code>callback</code> 回调，而不再校验该字段的其他规则 ，传入 <code>true</code> 代表所有字段。</li>
</ul>
<hr>
<h3 id="Rules"><a href="#Rules" class="headerlink" title="Rules"></a>Rules</h3><blockquote>
<p>Rules 也可以是用于校验的函数</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">rule, value, callback, source, options</span>)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>rule</code>: 当前校验字段在 descriptor 中所对应的校验规则，其中的 field 属性是当前正在校验字段的名称</li>
<li><code>value</code>: 当前校验字段的值</li>
<li><code>callback</code>: 在校验完成时的回调，传入 <code>Error</code> [或者是一个数组] 代表校验失败，如果校验是同步的话，直接返回 <code>false</code> 或 <code>Error</code> 或 <code>Error</code> 数组也可以（注：异步校验通过时直接不带参数调用 <code>callback()</code>，代表没有错误）</li>
<li><code>source</code>: 传入 <code>validate</code> 方法的 object，也就是需要校验的对象</li>
<li><code>options</code>: 传入的额外选项</li>
<li><code>options.messages</code>: 对象包含的校验错误提示信息，会被合并到默认的提示信息中</li>
</ul>
<hr>
<p>传入 <code>validate</code> 或 <code>asyncValidate</code> 的 options 被带到了校验函数中，以便你可以在校验函数中拿到数据（比如 model 引用）。然而，option中部分属性名是被保留的，你如果使用了的话会被覆盖掉，其中包括 <code>messages</code>, <code>exception</code> 和 <code>error</code>。</p>
<hr>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> schema = <span class="built_in">require</span>(<span class="string">'async-validator'</span>);</span><br><span class="line"><span class="keyword">var</span> descriptor = &#123;</span><br><span class="line">  name(rule, value, callback, source, options) &#123;</span><br><span class="line">    <span class="keyword">var</span> errors = [];</span><br><span class="line">    <span class="keyword">if</span>(!<span class="regexp">/^[a-z0-9]+$/</span>.test(value)) &#123;</span><br><span class="line">      errors.push(</span><br><span class="line">        <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">          util.format(<span class="string">"%s must be lowercase alphanumeric characters"</span>,</span><br><span class="line">            rule.field)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> errors;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> validator = <span class="keyword">new</span> schema(descriptor);</span><br><span class="line">validator.validate(&#123;<span class="attr">name</span>: <span class="string">"Firstname"</span>&#125;, (errors, fields) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span>(errors) &#123;</span><br><span class="line">    <span class="keyword">return</span> handleErrors(errors, fields);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// validation passed</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在需要对一个字段设置多条校验规则时，可以把规则设为一个数组，比如</p>
<hr>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> descriptor = &#123;</span><br><span class="line">  email: [</span><br><span class="line">    &#123;<span class="attr">type</span>: <span class="string">"string"</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">pattern</span>: schema.pattern.email&#125;,</span><br><span class="line">    &#123;validator(rule, value, callback, source, options) &#123;</span><br><span class="line">      <span class="keyword">var</span> errors = [];</span><br><span class="line">      <span class="comment">// test if email address already exists in a database</span></span><br><span class="line">      <span class="comment">// and add a validation error to the errors array if it does</span></span><br><span class="line">      <span class="keyword">return</span> errors;</span><br><span class="line">    &#125;&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Type-内置类型"><a href="#Type-内置类型" class="headerlink" title="Type 内置类型"></a>Type 内置类型</h4><p>下列是 <code>type</code> 可用的值：</p>
<ul>
<li><code>string</code>: 必须是 <code>string</code>. <code>This is the default type.</code></li>
<li><code>number</code>: 必须是 <code>number</code>.</li>
<li><code>boolean</code>: 必须是 <code>boolean</code>.</li>
<li><code>method</code>: 必须是 <code>function</code>.</li>
<li><code>regexp</code>: 必须是正则或者是在调用 <code>new RegExp</code> 时不报错的字符串.</li>
<li><code>integer</code>: 整数.</li>
<li><code>float</code>: 浮点数.</li>
<li><code>array</code>: 必须是数组，通过 <code>Array.isArray</code> 判断.</li>
<li><code>object</code>: 是对象且不为数组.</li>
<li><code>enum</code>: 值必须出现在 <code>enmu</code> 枚举值中.</li>
<li><code>date</code>: 合法的日期，使用 <code>Date</code> 判断</li>
<li><code>url</code>: url.</li>
<li><code>hex</code>: 16进制.</li>
<li><code>email</code>: 邮箱地址.</li>
</ul>
<hr>
<p><strong>Required</strong></p>
<p><code>required</code> 属性代表这个字段必须出现在对象中</p>
<hr>
<p><strong>Pattern</strong></p>
<p><code>pattern</code> 属性代表需要符合的正则</p>
<hr>
<p><strong>Range</strong></p>
<p>使用 <code>min</code> 和 <code>max</code> 属性定义范围，对于字符串和数组会与 <code>value.length</code> 比较，对于数字会直接与值比较</p>
<hr>
<p><strong>Length</strong></p>
<p>使用 <code>len</code> 属性直接指定长度，会与字符串和数组的 <code>value.length</code> 比较相等，对于数字会直接与值比较是否相等<br>如果 <code>len</code> 与 <code>min</code> 和 <code>max</code> 同时使用， <code>len</code> 优先。</p>
<hr>
<p><strong>Enumerable</strong></p>
<p>可枚举值</p>
<p>对于可以枚举出所有情况的类型，可以使用枚举校验，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> descriptor = &#123;</span><br><span class="line">  role: &#123;<span class="attr">type</span>: <span class="string">"enum"</span>, <span class="attr">enum</span>: [<span class="string">'admin'</span>, <span class="string">'user'</span>, <span class="string">'guest'</span>]&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>Whitespace</strong></p>
<p>把仅包含空格的字段视为错误是很典型的做法，为了额外测试字段是否只有空格，添加 <code>whitespace</code> 属性并设为true。这个属性要求字段必须为 <code>string</code> 类型。</p>
<p>如果你想要修正用户的输入而不是测试有无空格，查看 <a href="https://www.cnblogs.com/wozho/p/10955525.html#transform" target="_blank" rel="noopener">transform</a> 中去除空格的例子。</p>
<hr>
<p><strong>Deep Rules 深层规则</strong></p>
<p>如果需要校验一个深层的对象，你需要使用 <code>fields</code> 属性来设置嵌套的规则</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> descriptor = &#123;</span><br><span class="line">  address: &#123;</span><br><span class="line">    type: <span class="string">"object"</span>, <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">    fields: &#123;</span><br><span class="line">      street: &#123;<span class="attr">type</span>: <span class="string">"string"</span>, <span class="attr">required</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">      city: &#123;<span class="attr">type</span>: <span class="string">"string"</span>, <span class="attr">required</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">      zip: &#123;<span class="attr">type</span>: <span class="string">"string"</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">len</span>: <span class="number">8</span>, <span class="attr">message</span>: <span class="string">"invalid zip"</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  name: &#123;<span class="attr">type</span>: <span class="string">"string"</span>, <span class="attr">required</span>: <span class="literal">true</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> validator = <span class="keyword">new</span> schema(descriptor);</span><br><span class="line">validator.validate(&#123; <span class="attr">address</span>: &#123;&#125; &#125;, (errors, fields) =&gt; &#123;</span><br><span class="line">  <span class="comment">// errors for address.street, address.city, address.zip</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>需要注意的是，如果没有在父规则上指定 <code>required</code> 属性，在校验对象中不存在这个属性是完全合法的，嵌套的深层规则也不会运行。</p>
<p>深层规则提供了直接一个定义嵌套规则的方式，让你可以简化传递给 <code>schema.validate()</code> 的 <code>options</code> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> descriptor = &#123;</span><br><span class="line">  address: &#123;</span><br><span class="line">    type: <span class="string">"object"</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">options</span>: &#123;<span class="attr">single</span>: <span class="literal">true</span>, <span class="attr">first</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">    fields: &#123;</span><br><span class="line">      street: &#123;<span class="attr">type</span>: <span class="string">"string"</span>, <span class="attr">required</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">      city: &#123;<span class="attr">type</span>: <span class="string">"string"</span>, <span class="attr">required</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">      zip: &#123;<span class="attr">type</span>: <span class="string">"string"</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">len</span>: <span class="number">8</span>, <span class="attr">message</span>: <span class="string">"invalid zip"</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  name: &#123;<span class="attr">type</span>: <span class="string">"string"</span>, <span class="attr">required</span>: <span class="literal">true</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> validator = <span class="keyword">new</span> schema(descriptor);</span><br><span class="line"></span><br><span class="line">validator.validate(&#123; <span class="attr">address</span>: &#123;&#125; &#125;)</span><br><span class="line">  .catch(<span class="function">(<span class="params">&#123; errors, fields &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// now only errors for street and name    </span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>如果你像下面这样写，父规则也会被校验</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> descriptor = &#123;</span><br><span class="line">  roles: &#123;</span><br><span class="line">    type: <span class="string">"array"</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">len</span>: <span class="number">3</span>,</span><br><span class="line">    fields: &#123;</span><br><span class="line">      <span class="number">0</span>: &#123;<span class="attr">type</span>: <span class="string">"string"</span>, <span class="attr">required</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">      <span class="number">1</span>: &#123;<span class="attr">type</span>: <span class="string">"string"</span>, <span class="attr">required</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">      <span class="number">2</span>: &#123;<span class="attr">type</span>: <span class="string">"string"</span>, <span class="attr">required</span>: <span class="literal">true</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比如用于 <code>{roles: [&quot;admin&quot;, &quot;user&quot;]}</code> 会产生两个错误，一个是数组长度不匹配，一个是缺少了索引为 <code>2</code> 的元素</p>
<h4 id="defaultField-默认字段"><a href="#defaultField-默认字段" class="headerlink" title="defaultField 默认字段"></a>defaultField 默认字段</h4><p><code>defaultField</code> 属性可以在 <code>array</code> 和 <code>object</code> 类型中用于校验所有的值，它可以是一个包含有校验规则的对象或数组。 例子如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> descriptor = &#123;</span><br><span class="line">  urls: &#123;</span><br><span class="line">    type: <span class="string">"array"</span>, <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">    defaultField: &#123;<span class="attr">type</span>: <span class="string">"url"</span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，<code>defaultField</code> 是 <code>fields</code> 的扩展，见 <a href="https://www.cnblogs.com/wozho/p/10955525.html#deep-rules" target="_blank" rel="noopener">deep rules</a>.</p>
<h4 id="Transform-变换"><a href="#Transform-变换" class="headerlink" title="Transform 变换"></a>Transform 变换</h4><p>有时候需要在校验前修改值，强制修改为特定格式。 为此在校验规则中添加了 <code>transform</code>， 这个属性会在校验前执行，以适当的方式改变原始对象的值。（也就是返回值会作用在原始对象的值上）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> schema = <span class="built_in">require</span>(<span class="string">'async-validator'</span>);</span><br><span class="line"><span class="keyword">var</span> sanitize = <span class="built_in">require</span>(<span class="string">'validator'</span>).sanitize;</span><br><span class="line"><span class="keyword">var</span> descriptor = &#123;</span><br><span class="line">  name: &#123;</span><br><span class="line">    type: <span class="string">"string"</span>,</span><br><span class="line">    required: <span class="literal">true</span>, <span class="attr">pattern</span>: <span class="regexp">/^[a-z]+$/</span>,</span><br><span class="line">    transform(value) &#123;</span><br><span class="line">      <span class="keyword">return</span> sanitize(value).trim();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> validator = <span class="keyword">new</span> schema(descriptor);</span><br><span class="line"><span class="keyword">var</span> source = &#123;<span class="attr">name</span>: <span class="string">" user  "</span>&#125;;</span><br><span class="line">validator.validate(source)</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> assert.equal(source.name, <span class="string">"user"</span>));</span><br></pre></td></tr></table></figure>

<p>如果没有 <code>transform</code> 函数校验会失败因为前后空格导致正则与输入不符，但在添加了 <code>transform</code> 函数后便可通过因为字段已经被清洗了（或者翻译为使输入值符合预期格式）</p>
<h3 id="Messages-提示信息"><a href="#Messages-提示信息" class="headerlink" title="Messages 提示信息"></a>Messages 提示信息</h3><p>在某些需求下，你可能需要格式化支持或者想要不同校验错误信息。</p>
<p>最简单的方式就是直接为 <code>message</code> 属性赋值：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">name</span>:&#123;<span class="attr">type</span>: <span class="string">"string"</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">"Name is required"</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>消息可以是任意类型的，比如 <code>JSX</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">name</span>:&#123;<span class="attr">type</span>: <span class="string">"string"</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="xml"><span class="tag">&lt;<span class="name">b</span>&gt;</span>Name is required<span class="tag">&lt;/<span class="name">b</span>&gt;</span></span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>也可以是函数，比如使用 vue-i18n 时：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">name</span>:&#123;<span class="attr">type</span>: <span class="string">"string"</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.$t( <span class="string">'name is required'</span> )&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>有时候你只是需要对相同的校验规则定义不同语言的提示信息，在这种情况下为各种语言重复定义信息就显得很多余。</p>
<p>你也可以采取这个方案：定义你自己的提示信息并赋值给 <code>schema</code> ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> schema = <span class="built_in">require</span>(<span class="string">'async-validator'</span>);</span><br><span class="line"><span class="keyword">var</span> cn = &#123;</span><br><span class="line">  required: <span class="string">'%s 必填'</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> descriptor = &#123;<span class="attr">name</span>:&#123;<span class="attr">type</span>: <span class="string">"string"</span>, <span class="attr">required</span>: <span class="literal">true</span>&#125;&#125;;</span><br><span class="line"><span class="keyword">var</span> validator = <span class="keyword">new</span> schema(descriptor);</span><br><span class="line"><span class="comment">// deep merge with defaultMessages</span></span><br><span class="line">validator.messages(cn);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>如果你要定义自己的校验函数，最好将提示信息赋值给消息对象，并在校验函数中通过 <code>options.messages</code> 访问消息。（说实话我没看懂是什么意思，应该是指不要把消息硬编码写在校验函数里面而是通过option传递，以便修改）</p>
<h3 id="asyncValidator-异步校验函数"><a href="#asyncValidator-异步校验函数" class="headerlink" title="asyncValidator 异步校验函数"></a>asyncValidator 异步校验函数</h3><p>你可以对指定的字段自定义包含异步操作的校验函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fields = &#123;</span><br><span class="line">  asyncField:&#123;</span><br><span class="line">    asyncValidator(rule,value,callback)&#123;</span><br><span class="line">      ajax(&#123;</span><br><span class="line">        url:<span class="string">'xx'</span>,</span><br><span class="line">        value:value</span><br><span class="line">      &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        callback();</span><br><span class="line">      &#125;,<span class="function"><span class="keyword">function</span>(<span class="params">error</span>)</span>&#123;</span><br><span class="line">        callback(<span class="keyword">new</span> <span class="built_in">Error</span>(error))</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  promiseField:&#123;</span><br><span class="line">    asyncValidator(rule, value)&#123;</span><br><span class="line">      <span class="keyword">return</span> ajax(&#123;</span><br><span class="line">        url:<span class="string">'xx'</span>,</span><br><span class="line">        value:value</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="validator-校验函数"><a href="#validator-校验函数" class="headerlink" title="validator 校验函数"></a>validator 校验函数</h3><p>你也可像下面这样自定义校验函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fields = &#123;</span><br><span class="line">  field:&#123;</span><br><span class="line">    validator(rule,value,callback)&#123;</span><br><span class="line">      <span class="keyword">return</span> value === <span class="string">'test'</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    message: <span class="string">'Value is not equal to "test".'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  field2:&#123;</span><br><span class="line">    validator(rule,value,callback)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`'<span class="subst">$&#123;value&#125;</span> is not equal to "test".'`</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"> </span><br><span class="line">  arrField:&#123;</span><br><span class="line">    validator(rule, value)&#123;</span><br><span class="line">      <span class="keyword">return</span> [</span><br><span class="line">        <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Message 1'</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Message 2'</span>),</span><br><span class="line">      ];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><h3 id="How-to-avoid-warning-如何关闭警告"><a href="#How-to-avoid-warning-如何关闭警告" class="headerlink" title="How to avoid warning 如何关闭警告"></a>How to avoid warning 如何关闭警告</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Schema = <span class="built_in">require</span>(<span class="string">'async-validator'</span>);</span><br><span class="line">Schema.warning = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://supertinypeanut.github.io/blog/2020/12/27/async-validator%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/" data-id="ckmm8va6y001n85qsfu3nhimt" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/" rel="tag">问题解决</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-CommonJS、ESModule、AMD和CMD模块化区别" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2020/09/01/CommonJS%E3%80%81ESModule%E3%80%81AMD%E5%92%8CCMD%E6%A8%A1%E5%9D%97%E5%8C%96%E5%8C%BA%E5%88%AB/" class="article-date">
  <time datetime="2020-09-01T10:10:10.000Z" itemprop="datePublished">2020-09-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2020/09/01/CommonJS%E3%80%81ESModule%E3%80%81AMD%E5%92%8CCMD%E6%A8%A1%E5%9D%97%E5%8C%96%E5%8C%BA%E5%88%AB/">CommonJS、ESModule、AMD和CMD模块化区别</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="CommonJS"><a href="#CommonJS" class="headerlink" title="CommonJS"></a>CommonJS</h2><ul>
<li>对于基本数据类型，属于复制。即会被模块缓存。同时，在另一个模块可以对该模块输出的变量重新赋值。</li>
<li>对于复杂数据类型，属于浅拷贝。由于两个模块引用的对象指向同一个内存空间，因此对该模块的值做修改时会影响另一个模块。</li>
<li>当使用 require 命令加载某个模块时，就会运行整个模块的代码。</li>
<li>当使用 require 命令加载同一个模块时，不会再执行该模块，而是取到缓存之中的值。也就是说，CommonJS 模块无论加载多少次，都只会在第一次加载时运行一次，以后再加载，就返回第一次运行的结果，除非手动清除系统缓存。</li>
<li>循环加载时，属于加载时执行。即脚本代码在 require 的时候，就会全部执行。一旦出现某个模块被”循环加载”，就只输出已经执行的部分，还未执行的部分不会输出。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// b.js</span></span><br><span class="line">exports.done = <span class="literal">false</span></span><br><span class="line"><span class="keyword">let</span> a = <span class="built_in">require</span>(<span class="string">'./a.js'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'b.js-1'</span>, a.done)</span><br><span class="line">exports.done = <span class="literal">true</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'b.js-2'</span>, <span class="string">'执行完毕'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// a.js</span></span><br><span class="line">exports.done = <span class="literal">false</span></span><br><span class="line"><span class="keyword">let</span> b = <span class="built_in">require</span>(<span class="string">'./b.js'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'a.js-1'</span>, b.done)</span><br><span class="line">exports.done = <span class="literal">true</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'a.js-2'</span>, <span class="string">'执行完毕'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// c.js</span></span><br><span class="line"><span class="keyword">let</span> a = <span class="built_in">require</span>(<span class="string">'./a.js'</span>)</span><br><span class="line"><span class="keyword">let</span> b = <span class="built_in">require</span>(<span class="string">'./b.js'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'c.js-1'</span>, <span class="string">'执行完毕'</span>, a.done, b.done)</span><br><span class="line"></span><br><span class="line">node c.js</span><br><span class="line">b.js<span class="number">-1</span> <span class="literal">false</span></span><br><span class="line">b.js<span class="number">-2</span> 执行完毕</span><br><span class="line">a.js<span class="number">-1</span> <span class="literal">true</span></span><br><span class="line">a.js<span class="number">-2</span> 执行完毕</span><br><span class="line">c.js<span class="number">-1</span> 执行完毕 <span class="literal">true</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="ES-Module"><a href="#ES-Module" class="headerlink" title="ES Module"></a>ES Module</h2><ul>
<li>ES Module 中的值属于动态只读引用， 不可修改（修改即报错）。复杂数据类型可修改其属性</li>
<li>循环加载时，ES6 模块是动态引用。只要两个模块之间存在某个引用，代码就能够执行。</li>
<li>ES6 模块化采用静态编译，使得编译时就能确定模块的依赖关系，以及输入和输出的变量。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// b.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;foo&#125; <span class="keyword">from</span> <span class="string">'./a.js'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'bar'</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Math</span>.random() &gt; <span class="number">0.5</span>) &#123;</span><br><span class="line">    foo();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// a.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;bar&#125; <span class="keyword">from</span> <span class="string">'./b.js'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'foo'</span>);</span><br><span class="line">  bar();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'执行完毕'</span>);</span><br><span class="line">&#125;</span><br><span class="line">foo();</span><br><span class="line"></span><br><span class="line">babel-node a.js</span><br><span class="line">foo</span><br><span class="line">bar</span><br><span class="line">执行完毕</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行结果也有可能是</span></span><br><span class="line">foo</span><br><span class="line">bar</span><br><span class="line">foo</span><br><span class="line">bar</span><br><span class="line">执行完毕</span><br><span class="line">执行完毕</span><br></pre></td></tr></table></figure>

<h2 id="AMD"><a href="#AMD" class="headerlink" title="AMD"></a>AMD</h2><p>基于 commonJS 规范的 nodeJS 出来以后，服务端的模块概念已经形成，很自然地，大家就想要客户端模块。而且最好两者能够兼容，一个模块不用修改，在服务器和浏览器都可以运行。但是，由于一个重大的局限，<strong>使得 CommonJS 规范不适用于浏览器环境</strong>。</p>
<p><strong>浏览器端的模块，不能采用”同步加载”（synchronous），只能采用”异步加载”（asynchronous）。这就是 AMD 规范诞生的背景。</strong></p>
<p><strong>它采用异步方式加载模块，模块的加载不影响它后面语句的运行。所有依赖这个模块的语句，都定义在一个回调函数中，等到加载完成之后，这个回调函数才会运行。</strong></p>
<ul>
<li>异步加载模块</li>
<li>依赖前置</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">define([依赖...],<span class="function"><span class="keyword">function</span>(<span class="params">变量...</span>)</span>&#123;&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h2><ul>
<li>没有依赖前置，即用即返</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">defind(<span class="function"><span class="keyword">function</span> (<span class="params">require, exports, module</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="built_in">require</span>(<span class="string">"./a"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>CommonJS 为服务端规范，ESModule、AMD(requireJS)和 CMD(seaJS)均为浏览器端规范</li>
<li>CommonJS 同一模块只会被加载一次，第二次便只会取首次的缓存结果；ESModule 只要引入就会执行导入模块</li>
<li>CommonJS、CMD 为同步导入，ESModule、AMD 为异步导入</li>
<li>CommonJS 导入支持动态导入 require(<code>${path}/xx.js</code>)，ES6 模块化导入不支持</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://supertinypeanut.github.io/blog/2020/09/01/CommonJS%E3%80%81ESModule%E3%80%81AMD%E5%92%8CCMD%E6%A8%A1%E5%9D%97%E5%8C%96%E5%8C%BA%E5%88%AB/" data-id="ckmm8va4e000085qsdks47m1l" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/JavaScript/" rel="tag">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-了解HTTPS与HTTP区别" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2020/08/31/%E4%BA%86%E8%A7%A3HTTPS%E4%B8%8EHTTP%E5%8C%BA%E5%88%AB/" class="article-date">
  <time datetime="2020-08-31T17:10:10.000Z" itemprop="datePublished">2020-08-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2020/08/31/%E4%BA%86%E8%A7%A3HTTPS%E4%B8%8EHTTP%E5%8C%BA%E5%88%AB/">了解HTTPS、HTTP（HTTP2.0）区别</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="HTTP与HTTPS"><a href="#HTTP与HTTPS" class="headerlink" title="HTTP与HTTPS"></a>HTTP与HTTPS</h2><p>HTTPS相对于HTTP，可以说是安全以及认证的加强版。更通俗的说，HTTPS = HTTP + 加密 + 认证 +完整性检查</p>
<h3 id="HTTP和HTTPS的基本概念"><a href="#HTTP和HTTPS的基本概念" class="headerlink" title="HTTP和HTTPS的基本概念"></a>HTTP和HTTPS的基本概念</h3><p>　　HTTP：是互联网上应用最为广泛的一种网络协议，是一个客户端和服务器端请求和应答的标准（TCP），用于从WWW服务器传输超文本到本地浏览器的传输协议，它可以使浏览器更加高效，使网络传输减少。</p>
<p>　　HTTPS：是以安全为目标的HTTP通道，简单讲是HTTP的安全版，即HTTP下加入SSL层，HTTPS的安全基础是SSL，因此加密的详细内容就需要SSL。</p>
<p>　　HTTPS协议的主要作用可以分为两种：一种是建立一个信息安全通道，来保证数据传输的安全；另一种就是确认网站的真实性。</p>
<h3 id="HTTP与HTTPS有什么区别"><a href="#HTTP与HTTPS有什么区别" class="headerlink" title="HTTP与HTTPS有什么区别"></a>HTTP与HTTPS有什么区别</h3><p>　　HTTP协议传输的数据都是未加密的，也就是明文的，因此使用HTTP协议传输隐私信息非常不安全，为了保证这些隐私数据能加密传输，于是网景公司设计了SSL（Secure Sockets Layer）协议用于对HTTP协议传输的数据进行加密，从而就诞生了HTTPS。简单来说，HTTPS协议是由SSL/TLS+HTTP协议构建的可进行加密传输、身份认证的网络协议，要比http协议安全。</p>
<p>　　HTTPS和HTTP的区别主要如下：</p>
<p>　　1、https协议需要到ca申请证书，一般免费证书较少，因而需要一定费用。</p>
<p>　　2、http是超文本传输协议，信息是明文传输，https则是具有安全性的ssl加密传输协议。</p>
<p>　　3、http和https使用的是完全不同的连接方式，用的端口也不一样，前者是80，后者是443。</p>
<p>　　4、http的连接很简单，是无状态的；HTTPS协议是由SSL/TLS+HTTP协议构建的可进行加密传输、身份认证的网络协议，比http协议安全。</p>
<h3 id="HTTPS的工作原理"><a href="#HTTPS的工作原理" class="headerlink" title="HTTPS的工作原理"></a>HTTPS的工作原理</h3><p>在HTTPS中，采用的加密机制是 <strong>混合加密机制</strong>。在交换密钥阶段采用的是 <strong>公开密钥加密（非对称加密）</strong>，而交换完密钥之后采取的是 <strong>共享密钥加密（对称加密）</strong>。</p>
<p>为什么要采取混合加密的方式：对于非对称加密来说，虽然安全但是需要的时间和消耗会比较大；而对于对称加密来说，虽然时间快但是安全性不够，一旦密钥被窃取那就会引发安全问题。</p>
<ul>
<li><p>客户使用https的URL访问Web服务器，要求与Web服务器建立SSL连接。</p>
</li>
<li><p>Web服务器收到客户端请求后，会将网站的证书信息（证书中包含公钥）传送一份给客户端。</p>
</li>
<li><p>客户端的浏览器与Web服务器开始协商SSL连接的安全等级，也就是信息加密的等级。</p>
</li>
<li><p>客户端的浏览器根据双方同意的安全等级，建立会话密钥，然后利用网站的公钥将会话密钥加密（对称密钥），并传送给网站。</p>
</li>
<li><p>Web服务器利用自己的私钥解密出会话密钥（非对称加密）。</p>
</li>
<li><p>Web服务器利用会话密钥加密与客户端之间的通信（对称加密）。</p>
<p>个人对对称与非对称加密的理解为：两端都是使用私钥加密解密即为对称；使用公钥加密私钥解，私钥加密公钥解即为非对称。</p>
</li>
</ul>
<h3 id="HTTPS的优点"><a href="#HTTPS的优点" class="headerlink" title="HTTPS的优点"></a>HTTPS的优点</h3><p>　　尽管HTTPS并非绝对安全，掌握根证书的机构、掌握加密算法的组织同样可以进行中间人形式的攻击，但HTTPS仍是现行架构下最安全的解决方案，主要有以下几个好处：</p>
<p>　　（1）使用HTTPS协议可认证用户和服务器，确保数据发送到正确的客户机和服务器；</p>
<p>　　（2）HTTPS协议是由SSL+HTTP协议构建的可进行加密传输、身份认证的网络协议，要比http协议安全，可防止数据在传输过程中不被窃取、改变，确保数据的完整性。</p>
<p>　　（3）HTTPS是现行架构下最安全的解决方案，虽然不是绝对安全，但它大幅增加了中间人攻击的成本。</p>
<p>　　（4）谷歌曾在2014年8月份调整搜索引擎算法，并称“比起同等HTTP网站，采用HTTPS加密的网站在搜索结果中的排名将会更高”。</p>
<h3 id="HTTPS的缺点"><a href="#HTTPS的缺点" class="headerlink" title="HTTPS的缺点"></a>HTTPS的缺点</h3><p>　　虽然说HTTPS有很大的优势，但其相对来说，还是存在不足之处的：</p>
<p>　　（1）HTTPS协议握手阶段比较费时，会使页面的加载时间延长近50%，增加10%到20%的耗电；</p>
<p>　　（2）HTTPS连接缓存不如HTTP高效，会增加数据开销和功耗，甚至已有的安全措施也会因此而受到影响；</p>
<p>　　（3）SSL证书需要钱，功能越强大的证书费用越高，个人网站、小网站没有必要一般不会用。</p>
<p>　  （4）SSL证书通常需要绑定IP，不能在同一IP上绑定多个域名，IPv4资源不可能支撑这个消耗。</p>
<p>　　（5）HTTPS协议的加密范围也比较有限，在黑客攻击、拒绝服务攻击、服务器劫持等方面几乎起不到什么作用（防劫持DNS劫持需要使用HTTPDNS）。最关键的，SSL证书的信用链体系并不安全，特别是在某些国家可以控制CA根证书的情况下，中间人攻击一样可行。</p>
<h2 id="HTTP1-0与HTTP2-0"><a href="#HTTP1-0与HTTP2-0" class="headerlink" title="HTTP1.0与HTTP2.0"></a>HTTP1.0与HTTP2.0</h2><p><strong>消除或减少不必要的网络延迟</strong>，<strong>将需要传输的数据压缩至最少</strong>。HTTP2.0就是为了做这些优化而出现的。</p>
<h3 id="新的二进制格式（Binary-Format）"><a href="#新的二进制格式（Binary-Format）" class="headerlink" title="新的二进制格式（Binary Format）"></a>新的二进制格式（Binary Format）</h3><p>HTTP1.x的解析是基于文本。基于文本协议的格式解析存在天然缺陷，文本的表现形式有多样性，要做到健壮性考虑的场景必然很多，二进制则不同，只认0和1的组合。基于这种考虑HTTP2.0的协议解析决定采用二进制格式，实现方便且健壮。</p>
<h3 id="多路复用（MultiPlexing）"><a href="#多路复用（MultiPlexing）" class="headerlink" title="多路复用（MultiPlexing）"></a>多路复用（MultiPlexing）</h3><p>即连接共享，即每一个request都是是用作连接共享机制的。一个request对应一个id，这样一个连接上可以有多个request，每个连接的request可以随机的混杂在一起，接收方可以根据request的 id将request再归属到各自不同的服务端请求里面。</p>
<ul>
<li>HTTP/1.* 一次请求-响应，建立一个连接，用完关闭；每一个请求都要建立一个连接；</li>
<li>HTTP/1.1 Pipeling解决方式为，若干个请求排队串行化单线程处理，后面的请求等待前面请求的返回才能获得执行机会，一旦有某请求超时等，后续请求只能被阻塞，毫无办法，也就是人们常说的线头阻塞；</li>
<li>HTTP/2多个请求可同时在一个连接上并行执行。某个请求任务耗时严重，不会影响到其它连接的正常执行；</li>
<li>HTTP 性能优化的关键并不在于高带宽，而是低延迟。TCP 连接会随着时间进行自我「调谐」，起初会限制连接的最大速度，如果数据成功传输，会随着时间的推移提高传输的速度。这种调谐则被称为 TCP 慢启动。由于这种原因，让原本就具有突发性和短时性的 HTTP 连接变的十分低效。<br>HTTP/2 通过让所有数据流共用同一个连接，可以更有效地使用 TCP 连接，让高带宽也能真正的服务于 HTTP 的性能提升。</li>
</ul>
<h3 id="头部压缩"><a href="#头部压缩" class="headerlink" title="头部压缩"></a>头部压缩</h3><p>HTTP1.x的header带有大量信息，而且每次都要重复发送，HTTP2.0使用encoder来减少需要传输的header大小，通讯双方各自cache一份header fields表，既避免了重复header的传输，又减小了需要传输的大小。</p>
<ul>
<li>假定一个页面有100个资源需要加载（这个数量对于今天的Web而言还是挺保守的）, 而每一次请求都有1kb的消息头（这同样也并不少见，因为Cookie和引用等东西的存在）, 则至少需要多消耗100kb来获取这些消息头。HTTP2.0可以维护一个字典，差量更新HTTP头部，大大降低因头部传输产生的流量。</li>
</ul>
<h3 id="服务端推送（server-push）"><a href="#服务端推送（server-push）" class="headerlink" title="服务端推送（server push）"></a>服务端推送（server push）</h3><p>同SPDY一样，HTTP2.0也具有server push功能。</p>
<ul>
<li>服务端推送能把客户端所需要的资源伴随着index.html一起发送到客户端，省去了客户端重复请求的步骤。正因为没有发起请求，建立连接等操作，所以静态资源通过服务端推送的方式可以极大地提升速度。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>http相比https而言更加的安全，基本可以防止90%以上的恶意攻击，但是没办法防止DNS劫持，不过可以使用HTTPDNS可以解决劫持问题。https建立连接的时长更长、网络资源和两端资源消耗更大，而且好的证书成本更高，所以是否使用https应当权量一下利弊。例如：https有利于SEO，但是时长又会降低SEO。</p>
<p>http2.0相比与http1.x而言主要就是消除或减少不必要的网络延迟<strong>，</strong>将需要传输的数据压缩至最少，主要通过多路复用、头部压缩、服务端推送来实现。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://supertinypeanut.github.io/blog/2020/08/31/%E4%BA%86%E8%A7%A3HTTPS%E4%B8%8EHTTP%E5%8C%BA%E5%88%AB/" data-id="ckmm8va74001x85qsf4n765t8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/web-%E5%AE%89%E5%85%A8/" rel="tag">web 安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Redux基本原理实现" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2020/08/31/Redux%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E5%AE%9E%E7%8E%B0/" class="article-date">
  <time datetime="2020-08-31T10:10:10.000Z" itemprop="datePublished">2020-08-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2020/08/31/Redux%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E5%AE%9E%E7%8E%B0/">Redux基本原理实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Redux基本组成"><a href="#Redux基本组成" class="headerlink" title="Redux基本组成"></a>Redux基本组成</h2><p>Redux是将整个应用状态存储到一个地方上称为<strong>store</strong>,里面保存着一个状态树<strong>store tree</strong>,组件可以派发(dispatch)行为(action)给store,而不是直接通知其他组件，组件内部通过订阅<strong>store</strong>中的状态<strong>state</strong>来刷新自己的视图。</p>
<h3 id="State（初始化数据）"><a href="#State（初始化数据）" class="headerlink" title="State（初始化数据）"></a>State（初始化数据）</h3><p>state就是store里面存储的数据，store里面可以拥有多个state，Redux规定一个state对应一个View,只要state相同，view就是一样的，反过来也是一样的，可以通过<strong>store.getState( )</strong>获取。</p>
<h3 id="Action（行为）"><a href="#Action（行为）" class="headerlink" title="Action（行为）"></a>Action（行为）</h3><p>定制行为，或传递参数给reducer中使用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 无需传递参数</span></span><br><span class="line"><span class="keyword">const</span> action = &#123;</span><br><span class="line">  type: <span class="string">'ADD_TODO'</span>,</span><br><span class="line">  params: <span class="string">'1'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需传递参数</span></span><br><span class="line"><span class="keyword">const</span> action = <span class="function">(<span class="params">...params</span>) =&gt;</span> &#123;</span><br><span class="line">  type: <span class="string">'ADD_TODO'</span>,</span><br><span class="line">  ...params,</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 异步action (需要引入thunk中间件，createStore(reducer, applyMiddleware(thunk)))</span></span><br><span class="line">  <span class="keyword">const</span> sub = <span class="function">(<span class="params">...params</span>)=&gt;</span>&#123;</span><br><span class="line">    type: <span class="string">'SUB_TODO'</span>,</span><br><span class="line">    ...params,</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> action = <span class="function">(<span class="params">...params</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>)=&gt;</span>&#123;</span><br><span class="line">      dispatch(sub(...params))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Reducer（执行行为，纯函数）"><a href="#Reducer（执行行为，纯函数）" class="headerlink" title="Reducer（执行行为，纯函数）"></a>Reducer（执行行为，纯函数）</h3><p>Store收到Action以后，必须给出一个新的state，这样view才会发生变化。这种<strong>state的计算过程</strong>就叫做Reducer。Reducer是一个纯函数，他接收Action和当前state作为参数，返回一个新的state</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> state <span class="keyword">from</span> <span class="string">'../state'</span></span><br><span class="line"><span class="keyword">import</span> actionType <span class="keyword">from</span> <span class="string">'../action/actionType.js'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">oldState = state, action</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> actionType.ADD_NUM:</span><br><span class="line">            <span class="keyword">const</span> newState1 = <span class="built_in">Object</span>.assign(&#123;&#125;, oldState)</span><br><span class="line">            newState1[action.params]++</span><br><span class="line">            <span class="keyword">return</span> newState1</span><br><span class="line">        <span class="keyword">case</span> actionType.SUB_NUM:</span><br><span class="line">            <span class="keyword">const</span> newState2 = <span class="built_in">Object</span>.assign(&#123;&#125;, oldState)</span><br><span class="line">            newState2[action.params]--</span><br><span class="line">            <span class="keyword">return</span> newState2</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> oldState</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> reducer</span><br></pre></td></tr></table></figure>

<h3 id="Store"><a href="#Store" class="headerlink" title="Store"></a>Store</h3><p>以上state、action和reducer均为自己实现，只不过是根据Redux风格约定，只要能实现上述功能，名称其实并没有很强约束。Redux只不过是帮我们将action与reducer函数相关联而已，所以redux原理主要实现createStore函数即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span></span><br><span class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">'redux-thunk'</span></span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">'./reducer'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> createStore(reducer, applyMiddleware(thunk))</span><br></pre></td></tr></table></figure>

<h2 id="CreateStore原理实现"><a href="#CreateStore原理实现" class="headerlink" title="CreateStore原理实现"></a>CreateStore原理实现</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> createStore = <span class="function">(<span class="params">reducer</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> state;</span><br><span class="line">    <span class="comment">//获取状态对象</span></span><br><span class="line">    <span class="comment">//存放所有的监听函数</span></span><br><span class="line">    <span class="keyword">let</span> listeners = [];</span><br><span class="line">    <span class="keyword">let</span> getState = <span class="function"><span class="params">()</span> =&gt;</span> state;</span><br><span class="line">    <span class="comment">//提供一个方法供外部调用派发action</span></span><br><span class="line">    <span class="keyword">let</span> dispath = <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//调用管理员reducer得到新的state</span></span><br><span class="line">        state = reducer(state, action);</span><br><span class="line">        <span class="comment">//执行所有的监听函数</span></span><br><span class="line">        listeners.forEach(<span class="function">(<span class="params">l</span>) =&gt;</span> l())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//订阅状态变化事件，当状态改变发生之后执行监听函数</span></span><br><span class="line">    <span class="keyword">let</span> subscribe = <span class="function">(<span class="params">listener</span>) =&gt;</span> &#123;</span><br><span class="line">        listeners.push(listener);</span><br><span class="line">    &#125;</span><br><span class="line">    dispath();</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        getState,</span><br><span class="line">        dispath,</span><br><span class="line">        subscribe</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> combineReducers=<span class="function">(<span class="params">renducers</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//传入一个renducers管理组，返回的是一个renducer</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">state=&#123;&#125;,action=&#123;&#125;</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> newState=&#123;&#125;;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> attr <span class="keyword">in</span> renducers)&#123;</span><br><span class="line">            newState[attr]=renducers[attr](state[attr],action)</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newState;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> &#123;createStore,combineReducers&#125;;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://supertinypeanut.github.io/blog/2020/08/31/Redux%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E5%AE%9E%E7%8E%B0/" data-id="ckmm8va4v000585qs4cts21xr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/React/" rel="tag">React</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-前端性能优化" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2020/08/27/%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="article-date">
  <time datetime="2020-08-27T17:10:10.000Z" itemprop="datePublished">2020-08-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2020/08/27/%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">前端性能优化</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>我们提要的优化知识点主要来自 Chrome 和 V8 引擎，使用者众多</p>
<p>如何优化</p>
<ol>
<li><p>第一位不是具体手段，而是先收集数据</p>
</li>
<li><p>收集数据之前需要了解页面从加载到呈现的步骤（越详细越好）</p>
</li>
<li><p>有了数据可以很清晰的了解我们的短板</p>
</li>
<li><p>如果不确定哪里是短板可以参考别家的数据</p>
</li>
<li><p>结合我们的产品形态制定目标和基准</p>
</li>
<li><p>根据目标“寻找”具体手段进行“优化”</p>
</li>
</ol>
<p>这是可能诸位经常碰到的一个棘手的问题，当然 它也是一道面试高频题，很多人处理或者回答这个问题的时候，第一反应就是优化手段，诸如：压缩图片、合并资源、减少请求、SSR 等等。如果你有实战过前端优化的化，可能就不是这个答案了。这并不是说上述的优化手段有问题，具体手段当然很重要，但没有任何相关性能数据收集的话，一切都是浮云，我们很难知道性能短板在哪里。平时开发工作比较繁重，补丁摞补丁加班比雨后春笋还多，虽然这不是一个性能低下烂代码的理由，但这是客观存在的问题…</p>
<p>因此我们在开发业务的时候除了架构设计要合理、注重代码逻辑清晰简洁高效之外，很难了解页面整体的性能情况，所以比较正常的思路是：找到合理的性能统计方法并且收集具体的数据，对症下药。当然了，在收集数据之前，我们需要先了解一些浏览器的渲染原理和一些概念，否则很容易吃错药，出现头痛医脚的情况。</p>
<h3 id="浏览器展示原理"><a href="#浏览器展示原理" class="headerlink" title="浏览器展示原理"></a>浏览器展示原理</h3><p>旁白</p>
<p>这又是一个基础知识，当然也是个面试高频题。我很喜欢这个问题，知识点几乎是可以无限扩充的，基本知识点都掌握了，基本上也就了解优化的奥义了。首先先从宏观的角度看一下，用户输入 url 之后，页面是如何呈现的，先看看这张图</p>
<p>数据加载步骤</p>
<ol>
<li><p>如果当前页面有正在显示的文档话，则卸载当前页面</p>
</li>
<li><p>同时检测有没有缓存，这里的缓存指的是离线缓存(manifest)或者 PWA 设置的缓存并不是咱们平时提到的浏览器强制或者协商缓存，有则读取缓存，否则继续 DNS 解析（这里多说一句：关于这部分缓存可以看一下的<a href="https://html.spec.whatwg.org/multipage/offline.html#application-cache" target="_blank" rel="noopener">WHATWG 的离线缓存规范</a>，WHATWG == Web Hypertext Application Technology Working Group 即网页超文本应用技术工作小组，<a href="https://www.w3.org/blog/news/archives/7753" target="_blank" rel="noopener">W3C 宣布与 WHATWG 达成协议</a>，HTML 和 DOM 标准都以 WHATWG 为准，也就是说以后只有一套 HTML 标准了）</p>
</li>
<li><p>DNS 解析</p>
</li>
<li><p>建立 TCP 链接，由于网络层的 IP 协议是无状态的，协议只负责把数据包发送到指定 IP，不会考虑前面是否已经发送过数据包，也不考虑后面还会不会发送数据包。和渣男一样哈，三不原则，不主动、不拒绝、不负责，当然应用层的 UDP 也继承这个行为。不过 TCP 就不同了，是个负责的协议，为了保证传输就要建立连接。如果你要是使用 HTTPS 的话，当然这一步里还藏着个安全连接的握手过程</p>
</li>
<li><p>浏览器发送请求</p>
</li>
<li><p>服务器接到请求处理，返回给浏览器数据，这一步从浏览器角度来看也叫做数据下载</p>
</li>
<li><p>最后就是浏览器获取数据后处理数据渲染页面了</p>
</li>
</ol>
<p>具体渲染步骤</p>
<p>由于已经有前人栽树了，我就乘个凉，借花献佛了<a href="https://bytedance.feishu.cn/docs/doccnm3ZdWS9kQTLXUSAPPQ1bUg" target="_blank" rel="noopener">浏览器渲染原理</a>，这个是已经离开我们多时的一位前端同学的一篇浏览器渲染文章，以前这个同学也分享过。所以粗略的说一下，浏览器渲染又分为：</p>
<ol>
<li><p>把 HTML 结构字符串解析转换为 DOM 树，构建 DOM 树完成后，触发 DomContendLoaded 事件。</p>
</li>
<li><p>下载并解析 CSS 产生 CSS Rule Tree</p>
</li>
<li><p>下载 JS 并通过 DOM API 和 CSSOM API 来操作 DOM Tree 和 CSS Rule Tree</p>
</li>
<li><p>解析完后，浏览器引擎会通过 DOM Tree 和 CSS Rule Tree 来构造 Rendering Tree</p>
</li>
</ol>
<ul>
<li><ul>
<li>这里要注意一下，还是老生常谈的问题：</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>在标签没有设置 async/defer 属性时，JS 会阻塞 DOM 的生成</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>JS 文件不只是阻塞 DOM 的构建，它会导致 CSSOM 也阻塞 DOM 的构建</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>当然他们最终也是会阻塞整个页面的渲染，如果是在页面打开的第一次就会出现所谓”白屏“的问题</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol>
<li><p>布局 Rendering Tree（Layout/reflow），负责各元素尺寸、位置的计算</p>
</li>
<li><p>绘制 Rendering Tree（Paint），绘制页面像素信息</p>
</li>
<li><p>浏览器会将各层的信息发送给 GPU（GPU 进程：最多一个，用于 3D 绘制等），GPU 会将各层合成（composite），显示在屏幕上</p>
</li>
</ol>
<p>由于 JavaScript 代码运行在浏览器的主线程上，与此同时，浏览器的主线程还负责样式计算、布局、绘制的工作，如果 JavaScript 代码运行时间过长，就会阻塞其他渲染工作，Composite 是个例外，如果你开启 GPU 加速的话，这部分会在 GPU 进程去运行。阻塞和渲染的原理就说的这里，感兴趣的同学可以好好翻翻这篇文章，学习一下。</p>
<p>JS 引擎工作原理</p>
<p><strong>词法分析</strong></p>
<p><strong>语法分析</strong></p>
<p><strong>生成字节码</strong></p>
<p><strong>即时编译（JIT</strong>）</p>
<ul>
<li><p><strong>词法分析：</strong>字节流解码器会先从代码字节流中创建 令牌 （token），每当一个 令牌 创建后，就会被传递给 解析器（parser）</p>
</li>
<li><p><strong>语法分析：</strong>解析器便会根据传过来的令牌创建出 抽象语法树 （Abstract Syntax Tree）</p>
</li>
<li><p><strong>字节码：</strong>AST 被生成之后，接下来就要交给 解释器（interpreter） 了。解释器会遍历整个 AST，并生成 字节码。当字节码生成后，AST 便会被删除以节省内存空间。最终我们得到了更贴近 机器码 的 字节码。这里的 字节码 是介于 AST 和 机器码 之间的一种代码，它还是需要通过 解释器 将其转换为 机器码 后才能执行</p>
</li>
<li><p><strong>即时编译：</strong>尽管 字节码 很快，但是它还可以更快！解释器在逐条解释执行字节码时，会分析是否有某段代码被多次执行，这样的代码被称为 热点代码。热点代码 和生成的 类型反馈 （type feedback） 会被发送到一个称为 优化编译器 的东西中，然后由它转换为可以直接被电脑执行的 机器码，这样在下次执行这段代码的时候就不需要再编译了，从而大大提升了代码的执行效率。</p>
</li>
<li><p>感兴趣的话可以看看<a href="https://dev.to/lydiahallie/javascript-visualized-the-javascript-engine-4cdf" target="_blank" rel="noopener">这篇文章</a></p>
</li>
</ul>
<p>事件循环</p>
<p>由于 JS 是个单线程语言，单线程就意味着，所有任务需要排队，前一个任务结束，才会执行后一个任务。如果前一个任务耗时很长，后一个任务就不得不一直等着。为了解决这个问题 Eventloop 事件循环机制就诞生，这里面分为同步任务和异步任务。<strong>同步任务</strong>是调用立即得到结果的任务，同步任务在主线程上排队执行的任务，只有前一个任务执行完毕，才能执行后一个任务；<strong>异步任务</strong>是调用无法立即得到结果，需要额外的操作才能预期结果的任务，异步任务不进入主线程、而进入”任务队列”（task queue）的任务，只有”任务队列”通知主线程，某个异步任务可以执行了，该任务才会进入主线程执行。</p>
<p>需要注意的是，虽然异步任务分为<strong>宏任务和微任务</strong>，但上面提到异步任务是<strong>宏任务</strong>，微任务没有这个功效。宏任务包括了：</p>
<ol>
<li><p>浏览器加载的 JS 脚本</p>
</li>
<li><p>事件处理函数</p>
</li>
<li><p>定时任务（setTimout，setInterval ，setImmediate）</p>
</li>
<li><p>IO 处理（网络请求、磁盘读写）</p>
</li>
<li><p>UI 渲染；</p>
</li>
</ol>
<p>而微任务是 JavaScript 引擎在执行每一个宏任务之后，会立刻执行微任务队列中<strong>所有任务</strong>之后，再执行宏队列中的其它任务或者进行渲染，因次对于渲染来说，微任务并没有什么帮助，微任务重了，依然解决不了主线程阻塞的问题。那关于事件循环的具体知识点可以看看 B 站这个<a href="https://www.bilibili.com/video/BV1K4411D7Jb/" target="_blank" rel="noopener">熟肉</a>。</p>
<p>收集数据</p>
<p>数据加载耗时：单点+用户收集</p>
<p>上面就是比较宏观的浏览器知识和概念，全都了解过原理之后我们再看一下具体的指标和概念就非常好理解了。回到之前看过的图</p>
<p>这个图描述的是<a href="http://www.w3.org/2010/webperf/" target="_blank" rel="noopener">W3C Web 性能工作组</a>带来的 PerformanceTiming，一个 W3C 的<a href="https://www.w3.org/TR/navigation-timing/#sec-navigation-timing-interface" target="_blank" rel="noopener">规范</a>，我们可以通过浏览器的<a href="https://developer.mozilla.org/en-US/docs/Web/API/PerformanceTiming" target="_blank" rel="noopener">API</a>，去获取这些数据。根据上图描述，我们可以计算出资源加载在网络上的一些耗时</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">**let** dns = domainLookupEnd - domainLookupStart,<span class="string">//dns</span>耗时</span><br><span class="line">  tcp = <span class="keyword">connect</span>End - <span class="keyword">connect</span>Sta</span><br><span class="line">  ttfb = r0.responseStart - startTime,<span class="string">//</span>获取首字节耗时</span><br><span class="line">  ssl = secureConnectionStart？<span class="keyword">connect</span>End - secureConnectionStart ： 0；<span class="string">//https</span>握手耗时</span><br></pre></td></tr></table></figure>

<p>*参考资料</p>
<table>
<thead>
<tr>
<th><strong>指标</strong></th>
<th><strong>含义</strong></th>
</tr>
</thead>
<tbody><tr>
<td>navigationStart</td>
<td>当卸载提示在同一浏览上下文中的上一个文档终止时. 如果没有以前的文档，则此值将与 PerformanceTiming.fetchStart 相同</td>
</tr>
<tr>
<td>unloadEventStart</td>
<td>引发了 unload &gt;事件后，指示窗口中上一个文档开始卸载的时间. 如果没有先前的文档，或者先前的文档或所需的重定向之一不是同一来源，则返回的值为 0</td>
</tr>
<tr>
<td>unloadEventEnd</td>
<td>unload 事件处理程序完成时. 如果没有先前的文档，或者先前的文档或所需的重定向之一不是同一来源，则返回的值为 0</td>
</tr>
<tr>
<td>redirectStart</td>
<td>当第一个 HTTP 重定向开始时. 如果没有重定向，或者其中一个重定向源不同，则返回值为 0</td>
</tr>
<tr>
<td>redirectEnd</td>
<td>当最后一个 HTTP 重定向完成时，即已收到 HTTP 响应的最后一个字节. 如果没有重定向，或者其中一个重定向源不同，则返回值为 0</td>
</tr>
<tr>
<td>fetchStart</td>
<td>当浏览器准备好使用 HTTP 请求获取文档时. 此刻在检查任何应用程序缓存之前</td>
</tr>
<tr>
<td>domainLookupStart</td>
<td>域查找开始时. 如果使用持久连接，或者信息存储在缓存或本地资源中，则该值将与 PerformanceTiming.fetchStart 相同</td>
</tr>
<tr>
<td>domainLookupEnd</td>
<td>域查找完成后. 如果使用持久连接，或者信息存储在缓存或本地资源中，则该值将与 PerformanceTiming.fetchStart 相同.</td>
</tr>
<tr>
<td>connectStart</td>
<td>当打开连接的请求发送到网络时. 如果传输层报告错误，并且连接建立再次开始，则给出最后的连接建立开始时间. 如果使用持久连接，则该值将与 PerformanceTiming.fetchStart 相同</td>
</tr>
<tr>
<td>connectEnd</td>
<td>打开连接网络时. 如果传输层报告错误，并且连接建立再次开始，则给出最后的连接建立结束时间. 如果使用持久连接，则该值将与 PerformanceTiming.fetchStart 相同. 当所有安全连接握手或 SOCKS 身份验证终止时，连接被视为已打开</td>
</tr>
<tr>
<td>secureConnectionStart</td>
<td>安全连接握手开始时. 如果不请求此类连接，则返回 0</td>
</tr>
<tr>
<td>responseStart</td>
<td>当浏览器从服务器从缓存或本地资源接收到响应的第一个字节时</td>
</tr>
<tr>
<td>responseEnd</td>
<td>当浏览器收到响应的最后一个字节时，或者如果第一次发生则关闭连接时，包括来自服务器，缓存或本地资源</td>
</tr>
<tr>
<td>domLoading</td>
<td>解析器开始工作时，即其 Document.readyState 更改为’loading’并且引发了相应的 readystatechange 事件</td>
</tr>
<tr>
<td>domInteractive</td>
<td>解析器完成对主文档的工作时，即其 Document.readyState 更改为’interactive’并且引发了相应的 readystatechange 事件</td>
</tr>
<tr>
<td>domContentLoadedEventStart</td>
<td>DOM 解析完成后，在解析器发送 DOMContentLoaded 事件之前，网页内资源开始加载的时间</td>
</tr>
<tr>
<td>domContentLoadedEventEnd</td>
<td>DOM 解析完成后，在所有需要尽快执行的脚本（无论是否按顺序执行）之后</td>
</tr>
<tr>
<td>domComplete</td>
<td>解析器完成对主文档的工作时，即其 Document.readyState 更改为’complete’并且引发了相应的 readystatechange 事件</td>
</tr>
<tr>
<td>loadEventStart</td>
<td>为当前文档发送 load 事件的时间. 如果尚未发送此事件，则返回 0</td>
</tr>
<tr>
<td>loadEventEnd</td>
<td>当 load 事件处理程序终止时，即加载事件完成时. 如果此事件尚未发送或尚未完成，则返回 0</td>
</tr>
</tbody></table>
<p>前端性能耗时：单点收集</p>
<p>参考资料</p>
<ul>
<li><p>总概念</p>
</li>
<li><ul>
<li>蓝色(Loading)：网络通信和 HTML 解析</li>
</ul>
</li>
<li><ul>
<li>黄色(Scripting)：JavaScript 执行</li>
</ul>
</li>
<li><ul>
<li>紫色(Rendering)：样式计算和布局，即重排</li>
</ul>
</li>
<li><ul>
<li>绿色(Painting)：重绘</li>
</ul>
</li>
<li><ul>
<li>灰色(other)：其它事件花费的时间</li>
</ul>
</li>
<li><ul>
<li>白色(Idle)：空闲时间</li>
</ul>
</li>
</ul>
<p>-</p>
<p>无法复制加载中的内容</p>
<ul>
<li><p>详细</p>
</li>
<li><ul>
<li>Interactions：交互</li>
</ul>
</li>
<li><ul>
<li>Main：主线程</li>
</ul>
</li>
<li><ul>
<li>Worker：web work 线程</li>
</ul>
</li>
<li><ul>
<li>Raster：光栅图像（也称为“位图”）</li>
</ul>
</li>
<li><ul>
<li>GPU：GPU 渲染</li>
</ul>
</li>
<li><ul>
<li>Chrome_ChildIOThread：用来接受来自其它进程的 IPC 消息和派发自身消息到其它进程</li>
</ul>
</li>
<li><ul>
<li>Compositor：合成</li>
</ul>
</li>
</ul>
<p>当然你英文不好的话，可以下载使用微软最新版本的<a href="https://www.microsoft.com/zh-cn/edge" target="_blank" rel="noopener">edge</a>，目前最新版本的 Win10 俗称 sp2 的 20H1 版本月底将要 rtm 了，也是内置这个版本的 edge，这个版本的 edge 最大的优点可以理解为===chrome，并且还是个全汉化版本，当然他汉化了你也不一定能看到懂，他的画风是这样的。</p>
<p>chrome 官方文档：<a href="https://developers.google.com/web/tools/chrome-devtools/evaluate-performance/reference" target="_blank" rel="noopener">https://developers.google.com/web/tools/chrome-devtools/evaluate-performance/reference</a></p>
<p>旁白</p>
<p>目前前端和 SRE 一起开发的 EA 全链路监控系统前端 sdk 部分就是根据这个 api 去开发的，感兴趣的同学可以看一下这篇文章：<a href="https://hotoo.github.io/blog/post/resource-timing-practical-tips" target="_blank" rel="noopener">https://hotoo.github.io/blog/post/resource-timing-practical-tips</a></p>
<p>大家注意到上面那张图还有条红线，红线前半部分是网络耗时，后面的是浏览器解析 HTML 文档的耗时，不过后面 Load 和 DOMContentLoaded 等事件并不能真正的体现页面加载的性能，因为它们并不是与用户在屏幕上看到的相对应，我们需要更用户的一些的数据，因此可以使用 Chrome 自带的 Performance 工具来查看</p>
<p>*名词解释：FP、FCP、DCL、L、FMP、LCP、TTI、FID 😑</p>
<ul>
<li><p>FP（First Paint）: 页面在导航后首次呈现出不同于导航前内容的时间点，FP 事件在图层进行绘制的时候触发，而不是文本、图片或 Canvas 出现的时候</p>
</li>
<li><p>FCP（First Contentful Paint）：这是当用户看见一些“内容”元素被绘制在页面上的时间点。和白屏是不一样的，它可以是文本的首次出现，或者 SVG 的首次出现，或者 Canvas 的首次出现等等</p>
</li>
<li><p><strong>注意：</strong>只有首次绘制文本、图片（包含背景图）、非白色的 canvas 或 SVG 时才被算作 FCP。FP 与 FCP 这两个指标之间的主要区别是：FP 是当浏览器开始绘制内容到屏幕上的时候，只要在视觉上开始发生变化，无论是什么内容触发的视觉变化，在这一刻，这个时间点，叫做 FP。相比之下，FCP 指的是浏览器首次绘制来自 DOM 的内容。例如：文本，图片，SVG，canvas 元素等，这个时间点叫 FCP。FP 和 FCP 可能是相同的时间，也可能是先 FP 后 FCP。</p>
</li>
<li><p>DCL(DomContentloaded): 当 HTML 文档被完全加载和解析完成之后，DOMContentLoaded 事件被触发，无需等待样式表、图像和子框架的完成加载.</p>
</li>
<li><p>L(onLoad), 当依赖的资源, 全部加载完毕之后才会触发.</p>
</li>
<li><p>FMP(First Meaningful Paint):基于 Chromium 的实现，这个绘制是使用 LayoutAnalyzer 进行计算的，它会收集所有的布局变化，当布局发生最大变化时得出时间，而这个时间就是 FMP，本质上是通过一个算法来猜测某个时间点可能是 FMP，所以有时候不准。</p>
</li>
<li><p>LCP：了解和测量网站真实的性能其实非常困难，像 load 和 DOMContentLoaded 不会告诉我们用户什么时候可以在屏幕上看到内容。而 FP 和 FCP 又只能捕获整个渲染过程的最开始，FMP 更好一点，但是它的算法比较复杂，而且前面说了，有时候不准。根据 W3C Web 性能工作组的讨论和 Google 的研究，发现测量页面主要内容的可见时间有一种更精准且简单的方法是查看什么时候渲染最大元素，LCP 等于这个元素开始渲染的时间</p>
</li>
<li><p>TTI (Time to Interactive) 可交互时间: 指标用于标记应用已进行视觉渲染并能可靠响应用户输入的时间点</p>
</li>
</ul>
<p><strong>摘自：</strong><a href="https://web.dev/lcp/" target="_blank" rel="noopener"><strong>https://web.dev/lcp/</strong></a></p>
<ul>
<li>FID (First Input Delay) 首次输入延迟: 指标衡量的是从用户首次与您的网站进行交互（即当他们单击链接，点击按钮等）到浏览器实际能够访问之间的时间</li>
</ul>
<p>寻找短板</p>
<p>制定目标</p>
<p>从业务和用户体验的角度确认<strong>关键路径</strong>，<strong>非关键路径</strong>让路</p>
<p><strong>首页</strong></p>
<p><strong>播放页</strong></p>
<p><strong>审批页</strong></p>
<p>我入行以来，参与过很多次优化，其中大兴土木的有 3 次：</p>
<ul>
<li><p>视频网站首页和播放页的优化</p>
</li>
<li><p>视频 App 启动优化（android）</p>
</li>
<li><p>咱们现在的审批优化</p>
</li>
</ul>
<p>不同的性质的项目，从业务和用户体验的角度来看要求肯定是不一样的，所以目标也是完全不同的，不过也有相似点，给关键路径让路。</p>
<p>比如上面提到的视频网站首页，关键路径是让用户尽快看到第一屏的焦点图和推荐内容，其他信息可以让路；播放页用户肯定关注的视频，所以其他内容可以让路；视频 App 套路也一样，不过 app 现在首屏广告位是一大收入，那广告就要第一时间显示，我之前东家就有一项专利，在电视启动的时候，先来一发广告，本身这只是为了在 android 启动的时候替换启动系统带来的无聊时间，类似 windows 的启动画面，结果这个方案已经被滥用到，广告时间严重超过启动时间了，万恶的商人；我们的审批页重点是让用户最先看到关键审批信息并可以操作审批按钮。</p>
<p>关于关键路径再多说一句，一个页面的元素很多，逻辑也不少，要找准重要流程，对症下药。制定关键路径的时候一定要对用户行为进行分析，因为关键路径的优化势必影响非关键路径的展现或操作，换句话来说也就是对于某些逻辑就是要有意识的略化，正所谓鱼翅熊掌不能兼得。比如小米手机现在的急速启动方案，看起来启动确实快了，但你会发现手机启动之后诸如 nfc 等后台程序并没有一起加载，而是延后了很久。我就是上了这个当，因为每天乘地铁上班，用手机刷公交卡，有一次手机重启，我溜溜在闸机旁边等了 1 分多种，最后才发现其实还可以手动加载。但是这种关键路径已经满足了大多数人的需求，我这个遭遇相对小众，所以这么做无可厚非。回来再说我们的优化，不同的目标也就意味着我们要梳理重要流程的逻辑，指定好大多数人的关键路径上，把好钢用在韧上。比如上面提到的视频网站播放页的优化，页面刚加载的时候无论是网络还是 cpu 都很忙，我们要忙中偷闲，把资源留给重要的流程，所以页面上如评论区、内容介绍，推荐区等等其他的都需要给视频第一帧让步。同样我们的审批页也是如此，比如合同审批页面，从用户角度来说看到审批内容，操作审批按钮是重要的事情，其他的诸如审批流程、讨论区等等相对不是重要流程，因此可以给关键路径让让路，躲一躲。</p>
<p>具体手段</p>
<p>网络传输：减少体积，善用缓存</p>
<p>*连接池限制：同时 6 个，多了等待</p>
<p>参考资料</p>
<p>浏览器 HTTP 1.1HTTP 1.0IE 6, 724IE 8, 966Firefox 1366Chrome 206?Safari 5.1.76?Opera 11.648?</p>
<p><a href="https://source.chromium.org/chromium/chromium/src/+/master:net/socket/client_socket_pool_manager.cc" target="_blank" rel="noopener">https://source.chromium.org/chromium/chromium/src/+/master:net/socket/client_socket_pool_manager.cc</a></p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Default to allow up to 6 connections per host. Experiment and tuning may</span></span><br><span class="line"><span class="comment">// try other values (greater than 0).  Too large may cause many problems, such</span></span><br><span class="line"><span class="comment">// as home routers blocking the connections!?!?  See http://crbug.com/12066.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// WebSocket connections are long-lived, and should be treated differently</span></span><br><span class="line"><span class="comment">// than normal other connections. Use a limit of 255, so the limit for wss will</span></span><br><span class="line"><span class="comment">// be the same as the limit for ws. Also note that Firefox uses a limit of 200.</span></span><br><span class="line"><span class="comment">// See http://crbug.com/486800</span></span><br><span class="line"><span class="built_in">int</span> g_max_sockets_per_group[] = &#123;</span><br><span class="line">  <span class="number">6</span>,  <span class="comment">// NORMAL_SOCKET_POOL</span></span><br><span class="line">  <span class="number">255</span>  <span class="comment">// WEBSOCKET_SOCKET_POOL</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>为了解决这个问题我们需要把一些太过细碎的资源请求合并，解决连接池阻塞的问题，所以</p>
<ol>
<li><p>合并接口</p>
</li>
<li><p>合并静态资源</p>
</li>
</ol>
<p>合并之后还有的好处，可以利用 TCP（HTTP）慢启动特性</p>
<p>旁白</p>
<ol>
<li><p>由于 TCP 协议的限制，PC 端只有 65536 个端口可用以向外部发出连接，而操作系统对半开连接数也有限制以保护操作系统的 TCP\IP 协议栈资源不被迅速耗尽，因此浏览器不好发出太多的 TCP 连接，而是采取用完了之后再重复利用 TCP 连接或者干脆重新建立 TCP 连接的方法。</p>
</li>
<li><p>如果采用阻塞的套接字模型来建立连接，同时发出多个连接会导致浏览器不得不多开几个线程，而线程有时候算不得是轻量级资源，毕竟做一次上下文切换开销不小。</p>
</li>
<li><p>这是浏览器作为一个有良知的客户端在保护服务器。就像以太网的冲突检测机制，客户端在使用公共资源的时候必须要自行决定一个等待期。当超过 2 个客户端要使用公共资源时，强势的那个邪恶的客户端可能会导致弱势的客户端完全无法访问公共资源。从前迅雷被喷就是因为它不是一个有良知的客户端，它作为 HTTP 协议客户端没有考虑到服务器的压力，作为 BT 客户端没有考虑到自己回馈上传量的义务。</p>
</li>
</ol>
<p>*TCP 特性：越下越快</p>
<p>慢启动：最初的 TCP 在连接建立成功后会向网络中发送大量的数据包，这样很容易导致网络中路由器缓存空间耗尽，从而发生拥塞。因此新建立的连接不能够一开始就大量发送数据包，而只能根据网络情况逐步增加每次发送的数据量，以避免上述现象的发生。具体来说，当新建连接时，cwnd 初始化为 1 个最大报文段(MSS)大小，发送端开始按照拥塞窗口大小发送数据，每当有一个报文段被确认，cwnd 就增加 1 个 MSS 大小。这样 cwnd 的值就随着网络往返时间(Round Trip Time,RTT)呈指数级增长，事实上，慢启动的速度一点也不慢，只是它的起点比较低一点而已。我们可以简单计算下：</p>
<table>
<thead>
<tr>
<th>开始</th>
<th>cwnd = 1</th>
</tr>
</thead>
<tbody><tr>
<td>经过 1 个 RTT</td>
<td>cwnd = 2*1 = 2</td>
</tr>
<tr>
<td>经过 2 个 RTT</td>
<td>cwnd = 2*2= 4</td>
</tr>
<tr>
<td>经过 3 个 RTT</td>
<td>cwnd = 4*2 = 8</td>
</tr>
</tbody></table>
<p>旁白</p>
<p>这么看来是不是都放在一起更好呢，并不是~首先你并不能确认每个服务器下载速度都能&gt;=你的全速带</p>
<p>宽，再考虑到丢包重试问题，以及浏览器的多线程下载，而且数据下载完才能解析，而浏览器运行是多线程，这部分一直在下载，其他线程在空闲也是不合理的，所以要权衡，因此回到之前的说法，给重要的路径来让路。我们可以把跟关键的资源放在一起，非必要的资源切分。一句话概括，以业务逻辑为主该合并的合并，该切分的切分。不过现在我们用到的 vue 有一个比较麻烦的地方，渲染逻辑和交互逻辑都放在一起了，只能合并打包。理想的情况是是模版和交互逻辑分离，预先模板加载。比如以前比较古老的 JQuery 开发方式就可以很好的分离。不过我们依然可以从展示的角度，把目前的关键路径组件隔离出来优先加载执行。这里再说一下，关于如何合并可以做到极致也不用太过纠结，目前我们现在数量最多的浏览器是 chrome，他是支持 http2 协议的，而 H2 协议有链路复用的功能</p>
<p>*HTTP2：多路复用</p>
<p><a href="https://www.nginx.com/blog/7-tips-for-faster-http2-performance/" target="_blank" rel="noopener">https://www.nginx.com/blog/7-tips-for-faster-http2-performance/</a></p>
<p>所以这部分可以不用特别极致，反而稍微多一些比大一些更好，按照关键路径理顺就成了。</p>
<p>减少体积：刚性优化</p>
<p>减少体积俗称减肥，感谢这个时代，我们有了 webpack，他有一些非常好用的减肥药，比如：webpack-bundle-analyzer。</p>
<p>旁白</p>
<p>这个插件，可以分析我们每个入口 js 文件的依赖。据此，我们可以了解到每块资源的大小和依赖关系，看看我们引用的组件是否全都用到了，没有的话就去除，为了个很小的功能引入的话可以考虑局部模块引入，如果非得全部引入的话，就得考虑我们或者第三方组件设计问题了，这时就需要手动拆卸出逻辑引入了。我之前整理项目曾经看到过为了一个时间格式化功能，引入了一个整个包含多国语言包的 moment.js，这基本上就是为了用捡到个鼠标垫买了台电脑的思路。</p>
<p>缓存：减少下载</p>
<ul>
<li><p>协商缓存</p>
</li>
<li><p>强制缓存</p>
</li>
<li><ul>
<li>自动</li>
</ul>
</li>
<li><ul>
<li>手动</li>
</ul>
</li>
</ul>
<p>旁白</p>
<p>浏览器缓存分为强制缓存和协商缓存两种，强制缓存不需要直接从本地磁盘或内存读取，而协商缓存 ETag/if-None-Match 和 Last-Modified/if-Modify-Since 虽然不需要下载，但还是要建立 TCP 连接去获取资源更新信息，因此我们尽量使用强制缓存。而强制缓存还可以分为浏览器自动强制缓存，自动指的是浏览器自身的策略，我们可以在服务器上设置资源返回的 ResponseHeader，Cache-Control: max-age=时间(秒)即可，只要设置得当基本上可以满足大多数需求，不过要是想极致一些就考虑手动方案了，具体实现方式有：</p>
<ul>
<li><p>localStorage：把一些要路径的代码以字符串的方式存到本地，使用时获取</p>
</li>
<li><p>Application Cache：做一个缓存清单，浏览器根据清单的指示进行读取</p>
</li>
<li><p>Progressive Web App（PWA）：PWA 其实不止缓存这么简单，还可以做诸如信息推送等功能，而且缓存内容代码可控</p>
</li>
</ul>
<p>目前从我们的浏览器统计来看，PWA 可以大规模应用了，字节内部的网站很多都用到了这个功能，当然我们做审批优化的时候也做了，不过目前只是缓存了静态资源，终极方案可以把 HTML 文档全都缓存，基本上就可以理解为是个 APP 了，完全没有任何态资源加载，只有运行和接口加载的耗时了。当然这也是个双刃刀，像小程序和 APP 一样，需要做一些发版更新策略，可能有些用户体验上的问题，这也是我们迟迟未上的原因</p>
<p>逻辑顺序调整：Loading、异步加载、预加载</p>
<ul>
<li><p>从体验上讲，看到白屏确实不好，不过这时候可以让用户“愉快”的等待：loading 图片或骨架屏，不管哪种方式，都需要加载资源。这部分资源可能包含 js css 和 图片，就建议写在 html 文档里了。试想如果你把这部分资源打到 js 里，岂不是用户还得走之前的下载解析过程，要白屏了？万一比业务代码还慢呢？</p>
</li>
<li><p>代码加载（业务逻辑）顺序依然可以用这个工具检查一波，把非关键路径上的业务异步化。根据业务逻辑，异步分为主动异步和被动异步。比如我们的审批页面，就可以把讨论区和流程显示部分组件和数据加载异步化。主动异步的意思是在没有用户操作的情况下进行异步加载，比如用户停留在这个页面上，不进行任何操作，浏览器发现目前计算资源空闲了，就可以加载了。还可以被动异步，用户滚动页面时候，检测到用户可见区域就去加载一下数据。<a href="https://www.toutiao.com/" target="_blank" rel="noopener">https://www.toutiao.com/</a></p>
</li>
<li><p>最后就是预加载了，简单来说，就是把本次要做的事情放在更早去做，比如<a href="https://bytedance.feishu.cn/docs/doccn6c1HsLSn943QbvH5BgfVGh" target="_blank" rel="noopener">Fast API 方案简述</a> ，或者目前做的审批预加载</p>
</li>
</ul>
<p>*其他问题常规思路</p>
<ul>
<li><p>Chrome 自带的工具</p>
</li>
<li><p>减少主线程单次任务复杂度</p>
</li>
<li><p>少回流、少重绘、能合成就合成</p>
</li>
</ul>
<p>旁白</p>
<p>除了上面说的优化之外，还有些纯前端性能的优化，比如解决卡顿或者操作不流畅问题。这些问题还得需要用到最开始提到 Chrome 的火焰图工具，看看时序图有没有什么问题，恭喜你现在事件循环和浏览器渲染的知识全都用到了。首先看看有没有 long task，这上面带红色三角的就是 chrome 认为过长的任务，会在主线程阻塞渲染，先看看为什么长，看一下 js 的堆栈信息，如果有代码运算大的情况先考虑是否有不合理的地方可以优化，再者就是切分任务了，把一个过长的任务切分成多个，解决主线程耗时过长的问题。比如 React16 的 fiber 虽然实现策略是挺复杂的，但根本原理还是就是把任务切分了。除了 task 之外还可以从布局、渲染部分进行优化，原则很简单：少回流、少重绘、能合成就合成，万一避免不了回流，可以考虑经常回流的层独立，用局部回流的方式降低整体回流的消耗。</p>
<p>*不要迷信：比如 SSR</p>
<ul>
<li><p>最后要说的就是，千万不要迷信优化方法，一定要收集完整的数据，找准目标，再做打算，切勿盲目入手。比如现在比较流行的 SSR，也就是服务端渲染，这和以前 JSP 原理一样，不同的时候可以大部分复用相同的前端代码用 Nodejs 在服务端页面 html 渲染好，直接输出到前端。我们可以分析一下这种优化要解决什么问题，在什么情况下才能起到优化的效果。</p>
</li>
<li><p>浏览器端程序无法”流式“加载（非绝对），浏览器中 HTML 就是流式加载的代表：边下载边解析边展示</p>
</li>
<li><p>数据和模板特别复杂，运算量非常大，受众的客户端机能浏览器性能很差，用户端渲染非常慢</p>
</li>
<li><p>第一个场景，如果我们是个长内容网站，内容数据量远远大于我们的静态资源，那么这种方案就很合适，服务端输出的 HTML 内容可以流式加载，不用拿到全量数据就能把第一屏数据及早的展示给用户。但对于我们现在的审批页面，要渲染的内容才几 k，静态资源远远大于内容，这种方式显然就没有什么意义，况且该加载的前端资源一点儿也没少， 渲染部分每个人的输出内容还不同，还丧失了用户端的缓存功能，非常的不划算。</p>
</li>
<li><p>第二个场景，对我们来说意义也不一定很大，首先目前我们的工作电脑配置还可以而且用户以高性能的 Chrome 为主，浏览器端渲染并不是大问题，我们还可以把模版和资源做缓存，如果缓存没有刷新，下次用户在再次开的话就不用重新下载了，看起来效果会更好一些。</p>
</li>
</ul>
<p>持续监控</p>
<ul>
<li>上面这些都是具体执行的手段，如果碰到解决就好了，但如果要想做到持续优化约束，就要指定基准，如果不达到基准不能算测试通过。基准最好前后端分开指定，这样可以有针对性的进行持续自动化测试。这里先说说前端吧，定义基准数据前一定也要把测试机的基准配置定定义好，否则针对端的基准数据就没有任何意义了，一台在奔三 800 定义的基准在 i9-10900K 没有任何意义，反之也毅然，要想有效测试最好在同等配置相同操作系统相同版本相同负载的机器上做。我们再根据实际情况定义好各个指标的数据，比如：scripting、reflow、reapint，自动化测试获取数据，看看每次是否达到预定的要求</li>
</ul>
<p>非前端优化</p>
<ul>
<li>上面说的都是前端的优化，除此之外就是后端接口本身业务逻辑耗时以及网络本身因素的影响。不管前端如何优化，如果上面那两部分有问题的话，从整体上来看仍然很难达到预期的目标。当然这个问题还是需要信息收集。我们就要用到最开始介绍的概念了，通过 performance 接口收集这些数据进行分析，看数据加载到底慢在哪个步骤了，本来我司有 Tea 和 Slardar 工具，不过都无法达到我们细致分析的目的，因此有了全量数据收集服务的想法，凑巧和 SRE 的 OWL 联系起来，于是就有了我们 EA 的全链路监控方案，用这套方案可以定位到很具体的问题，继续对症下药。比如我们可以定位到是否为后端本身业务慢，后端可以做一些的优化：比如前置处理并缓存，把要实时计算的东西，找个再早的时机，计算出结果放在缓存里，像审批来说，可以上一节点审批完就可以把下一节点计算好放在缓存里前端直接获取；或者异步化提交，也就是用户提交操作后立刻把数据返回给前端，后端再去离线处理；以前有个弹幕的项目，不需要时实行很高，我们直接把热弹幕放在 cdn 上了，既减轻了服务端的压力，又能用到 CDN 的布点优势，当然我这些都是从逻辑上的技术想法，后端同学做这些还有处理巨多的业务问题，可能就需要个后端优化分享了。再说说网络，用目前的全链路工具也能看出用户本身网络问题，不过还不太能定位具体情况，毕竟 C 端的情况太复杂了。比如用户设备建设本身速度慢，中间经过的链路过长，WIFI 信号不好等等，这些问题就太复杂了，估计就得需要 SRE 的同学来处理了。我还记得在前司，很多同学都私搭烂建自己的 WIFI 热点，搞得物理 WIFI 信号串扰严重，特别影响用户体验。但是我们还可以根据地域方式把这些数据继续细分，找出些端倪，以前做 C 端的时候，运维同学每个月绩效全指着这些数据呢，比如看到重庆慢了，布个点，刷一下速度就上来了，后天云南慢了等等。所以数据越详细越能挖掘出问题，粒度太粗的话，很难定位的。</li>
</ul>
<p>参考手段</p>
<p>WebWorker</p>
<p>WebAssembly</p>
<p>TreeSharking</p>
<p>接口合并（BFF）</p>
<p>设置服务器缓存</p>
<p>耗时任务切片执行</p>
<p>开启服务器压缩（如 gzip 等）</p>
<p>requestIdleCallback</p>
<p>requestAnimationFrame</p>
<p>开启 HTTP2</p>
<p>dns-prefetch、Preload、Prerender、Preconnect</p>
<p>固定类型的函数</p>
<p>CSS transform</p>
<p>代码压缩</p>
<p>减少 JSON 里的空 Key</p>
<p>media 属性指定加载样式的条件</p>
<p>异步加载</p>
<p>多次操作 DOM 时可以尝试，首先克隆整个 DOM 节点更加高效，操作克隆后的节点，然后替换</p>
<p>合并资源</p>
<p>压缩图片（渐进式、webp）</p>
<p>loading=“lazy”</p>
<p>节流和防抖</p>
<p>减少 base64</p>
<p>一些脑洞</p>
<p>WebRTC 资源 P2P</p>
<p>Websocket 长连接精简数据量和连接数量</p>
<p>Sass less 代码本地转换（PWA）</p>
<p>Http2 push</p>
<p>vue 渲染业务分离</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://supertinypeanut.github.io/blog/2020/08/27/%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" data-id="ckmm8vaaj002f85qs8aun2hwn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/" rel="tag">问题解决</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-sentry使用及原理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2020/08/27/sentry%E4%BD%BF%E7%94%A8%E5%8F%8A%E5%8E%9F%E7%90%86/" class="article-date">
  <time datetime="2020-08-27T17:10:10.000Z" itemprop="datePublished">2020-08-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2020/08/27/sentry%E4%BD%BF%E7%94%A8%E5%8F%8A%E5%8E%9F%E7%90%86/">sentry使用及原理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="搭建-sentry"><a href="#搭建-sentry" class="headerlink" title="搭建 sentry"></a>搭建 sentry</h2><p>如何搭建 sentry 大家可以阅读该篇文章（<a href="http://sinhub.cn/2019/07/getting-started-guide-of-sentry/" target="_blank" rel="noopener">Sentry 入门实战</a>），在此就不做过多介绍。</p>
<p>本文直接使用官方 sentry 账号进行前端的错误监控。<a href="https://sentry.io/" target="_blank" rel="noopener">https://sentry.io/</a></p>
<h2 id="使用-sentry"><a href="#使用-sentry" class="headerlink" title="使用 sentry"></a>使用 sentry</h2><h3 id="注册-sentry-账号"><a href="#注册-sentry-账号" class="headerlink" title="注册 sentry 账号"></a>注册 sentry 账号</h3><p><img src="/blog/.io//image-20200827175753635.png" alt="image-20200827175753635"></p>
<h3 id="创建一个项目"><a href="#创建一个项目" class="headerlink" title="创建一个项目"></a>创建一个项目</h3><p>大家可以根据自己项目的技术栈创建对应的 sentry 项目，由于项目我的项目技术栈为 Vue，所以我创建 Vue 的项目。</p>
<p><img src="/blog/.io//image-20200827180126891.png" alt="image-20200827180126891"></p>
<h3 id="查看对应配置"><a href="#查看对应配置" class="headerlink" title="查看对应配置"></a>查看对应配置</h3><p><img src="/blog/.io//image-20200827180649660.png" alt="image-20200827180649660"></p>
<h3 id="查看配置文档"><a href="#查看配置文档" class="headerlink" title="查看配置文档"></a>查看配置文档</h3><p>根据对应的配置文档进行引入配置即可，文档已经将该项目的 dsn 已经初始化好了直接 copy。<img src="/blog/.io//image-20200827181117982.png" alt="image-20200827181117982"></p>
<p><code>详细配置</code>：<a href="https://docs.sentry.io/product/performance/getting-started/" target="_blank" rel="noopener">https://docs.sentry.io/product/performance/getting-started/</a></p>
<h3 id="查看警告"><a href="#查看警告" class="headerlink" title="查看警告"></a>查看警告</h3><p>你可以在开发环境，故意写错一个在运行时会发生的 bug 测试一下，当看到自己收到警告通知时便是引入成功了。</p>
<p><img src="/blog/.io//image-20200827181716092.png" alt="image-20200827181716092"></p>
<h3 id="使用注意"><a href="#使用注意" class="headerlink" title="使用注意"></a>使用注意</h3><h4 id="生产环境引入"><a href="#生产环境引入" class="headerlink" title="生产环境引入"></a>生产环境引入</h4><p>当然平时我们并不需监控开发环境，所以我们通过环境变量进行判断引入，在生产打包时引入。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">"production"</span>) &#123;</span><br><span class="line">  Sentry.init(&#123;</span><br><span class="line">    dsn:</span><br><span class="line">      <span class="string">"https://3014f57eb2dc490ba8c6ffe191690781@o434427.ingest.sentry.io/5391506"</span>,</span><br><span class="line">    integrations: [<span class="keyword">new</span> VueIntegration(&#123; Vue, attachProps: <span class="literal">true</span> &#125;)],</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="指定分支"><a href="#指定分支" class="headerlink" title="指定分支"></a>指定分支</h4><p>我们可以指定上线分支配置，详细分支配置：<a href="https://docs.sentry.io/product/releases/" target="_blank" rel="noopener">https://docs.sentry.io/product/releases/</a></p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Sentry.init(&#123;</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">	release: <span class="string">"my-project-name@2.3.12"</span>,</span><br><span class="line">	<span class="params">...</span></span><br><span class="line"> &#125;)</span><br></pre></td></tr></table></figure>

<h4 id="上传-Source-Map"><a href="#上传-Source-Map" class="headerlink" title="上传 Source Map"></a>上传 Source Map</h4><p><a href="https://docs.sentry.io/platforms/javascript/guides/vue/config/sourcemaps/" target="_blank" rel="noopener">https://docs.sentry.io/platforms/javascript/guides/vue/config/sourcemaps/</a></p>
<p>webpack 引入插件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev @sentry/webpack-plugin</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> SentryWebpackPlugin = <span class="built_in">require</span>(<span class="string">"@sentry/webpack-plugin"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// other configuration</span></span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> SentryWebpackPlugin(&#123;</span><br><span class="line">      include: <span class="string">"."</span>,</span><br><span class="line">      ignoreFile: <span class="string">".sentrycliignore"</span>,</span><br><span class="line">      ignore: [<span class="string">"node_modules"</span>, <span class="string">"webpack.config.js"</span>],</span><br><span class="line">      configFile: <span class="string">"sentry.properties"</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>当然我们还需要配置一下<code>~/.sentryclirc</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[auth]</span></span><br><span class="line"><span class="attr">token</span>=your-auth-token</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以指定到自己的服务器，默认情况下sentry-cli将连接到sentry.io</span></span><br><span class="line"><span class="section">[defaults]</span></span><br><span class="line"><span class="attr">url</span> = https://mysentry.invalid/</span><br></pre></td></tr></table></figure>

<p>环境变量设置<code>.env</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SENTRY_AUTH_TOKEN=your-auth-token</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以指定到自己的服务器，默认情况下sentry-cli将连接到sentry.io</span></span><br><span class="line">SENTRY_URL=https://mysentry.invalid/</span><br></pre></td></tr></table></figure>

<h2 id="监控原理"><a href="#监控原理" class="headerlink" title="监控原理"></a>监控原理</h2><h3 id="window-onerror-劫持"><a href="#window-onerror-劫持" class="headerlink" title="window.onerror 劫持"></a>window.onerror 劫持</h3><p>每当代码在 runtime 时发生错误时，JavaScript 引擎就会抛出一个 Error 对象，并且触发 window.onerror 函数。</p>
<p>Sentry 对 window.onerror 函数进行了改写，在这里实现了错误监控的逻辑，添加了很多运行时信息帮助进行错误定位，对错误处理进行跨浏览器的兼容等等。</p>
<p>在这里 Sentry 使用了 TraceKit 来帮助它劫持 window.onerror 函数。TraceKit 主要是用来进行抹平各浏览器之间的差异，使得错误处理的逻辑统一。</p>
<h3 id="监听-unhandledrejection-事件"><a href="#监听-unhandledrejection-事件" class="headerlink" title="监听 unhandledrejection 事件"></a>监听 unhandledrejection 事件</h3><p>在我们使用 Promise 的时候，如果发生错误而我们没有去 catch 的话，window.onerror 是不能监控到这个错误的。但是这个时候，JavaScript 引擎会触发 unhandledrejection 事件，只要我们监听这个事件，那么就能够监控到 Promise 产生的错误。</p>
<p>_attachPromiseRejectionHandler 的实现很简单，就是为 unhandledrejection 事件挂载一个事件处理函数。这里最核心的逻辑其实是 captureException 函数。</p>
<ol>
<li>如果接收到的是一个 ErrorEvent 对象，那么直接取出它的 error 属性即可，这就是对应的 error 对象。</li>
<li>如果接收到的是一个 DOMError 或者 DOMException，那么直接解析出 name 和 message 即可，因为这类错误通常是使用了已经废弃的 DOMAPI 导致的，并不会附带上错误堆栈信息。</li>
<li>如果接收到的是一个标准的错误对象，不做处理</li>
<li>如果接收到的是一个普通的 JavaScript 对象</li>
</ol>
<p>Sentry 会将这个对象的 Key 序列化为字符串，然后会触发报错</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"Non-Error exception captured with keys: "</span> + serializeKeysForMessage(exKeys);</span><br></pre></td></tr></table></figure>

<p>所以触发报错，是因为在代码当中，Promise 进行 reject 时并没有传入一个错误对象，而是传入了一个普通对象。</p>
<p>错误代码大致上是这样</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javascript reject(json)// json =&gt; &#123;data:&#123;&#125;,result:&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>以上都不是，那么证明这就是一个普通的字符串，直接作为 message 即可。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://supertinypeanut.github.io/blog/2020/08/27/sentry%E4%BD%BF%E7%94%A8%E5%8F%8A%E5%8E%9F%E7%90%86/" data-id="ckmm8va5h000q85qs9w3hgaje" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/web-%E5%AE%89%E5%85%A8/" rel="tag">web 安全</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/blog/page/2/">2</a><a class="page-number" href="/blog/page/3/">3</a><a class="page-number" href="/blog/page/4/">4</a><a class="extend next" rel="next" href="/blog/page/2/">下一页 &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/ECMAScript-6/" rel="tag">ECMAScript 6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Git/" rel="tag">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Lint/" rel="tag">Lint</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/React/" rel="tag">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/TypeScript/" rel="tag">TypeScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Vue/" rel="tag">Vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Webpack/" rel="tag">Webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/npm/" rel="tag">npm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/web-%E5%AE%89%E5%85%A8/" rel="tag">web 安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96/" rel="tag">前端工程化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/" rel="tag">问题解决</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/ECMAScript-6/" style="font-size: 12.5px;">ECMAScript 6</a> <a href="/blog/tags/Git/" style="font-size: 15px;">Git</a> <a href="/blog/tags/JavaScript/" style="font-size: 20px;">JavaScript</a> <a href="/blog/tags/Lint/" style="font-size: 10px;">Lint</a> <a href="/blog/tags/React/" style="font-size: 12.5px;">React</a> <a href="/blog/tags/TypeScript/" style="font-size: 12.5px;">TypeScript</a> <a href="/blog/tags/Vue/" style="font-size: 17.5px;">Vue</a> <a href="/blog/tags/Webpack/" style="font-size: 10px;">Webpack</a> <a href="/blog/tags/npm/" style="font-size: 10px;">npm</a> <a href="/blog/tags/web-%E5%AE%89%E5%85%A8/" style="font-size: 15px;">web 安全</a> <a href="/blog/tags/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96/" style="font-size: 12.5px;">前端工程化</a> <a href="/blog/tags/%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/" style="font-size: 15px;">问题解决</a> <a href="/blog/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 12.5px;">面试</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/01/">一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/12/">十二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/04/">四月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/11/">十一月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2021/03/23/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E4%B8%8E%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2/">持续集成与持续部署</a>
          </li>
        
          <li>
            <a href="/blog/2021/03/07/Promise%E5%AE%9E%E7%8E%B0/">Promise实现</a>
          </li>
        
          <li>
            <a href="/blog/2021/03/03/ES6%E9%9D%A2%E8%AF%95%E9%A2%98/">ES6面试题</a>
          </li>
        
          <li>
            <a href="/blog/2021/01/25/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/">自动化测试</a>
          </li>
        
          <li>
            <a href="/blog/2020/12/27/async-validator%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/">async-validator基本使用</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Super Peanut<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">

  
<script src="/blog/fancybox/jquery.fancybox.pack.js"></script>




<script src="/blog/js/script.js"></script>




  </div>
</body>
</html>